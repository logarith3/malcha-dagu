This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.claude/settings.local.json
.env.example
.gitignore
backend/config/__init__.py
backend/config/asgi.py
backend/config/backupsettings.py
backend/config/celery.py
backend/config/middleware.py
backend/config/settings/__init__.py
backend/config/settings/base.py
backend/config/settings/prod.py
backend/config/urls.py
backend/config/wsgi.py
backend/dagu/__init__.py
backend/dagu/admin.py
backend/dagu/apps.py
backend/dagu/authentication.py
backend/dagu/config.py
backend/dagu/exceptions.py
backend/dagu/filters.py
backend/dagu/management/__init__.py
backend/dagu/management/commands/__init__.py
backend/dagu/management/commands/import_instruments.py
backend/dagu/migrations/__init__.py
backend/dagu/migrations/0001_initial.py
backend/dagu/migrations/0002_alter_instrument_image_url_alter_instrument_name_and_more.py
backend/dagu/migrations/0003_alter_useritem_source.py
backend/dagu/migrations/0004_useritem_extended_at_useritem_owner_id.py
backend/dagu/migrations/0005_add_report_fields.py
backend/dagu/migrations/0006_allow_anonymous_reports.py
backend/dagu/migrations/0007_add_search_query.py
backend/dagu/migrations/0008_itemclick.py
backend/dagu/migrations/0009_alter_instrument_category.py
backend/dagu/migrations/0010_searchmisslog.py
backend/dagu/migrations/0011_brand_alter_instrument_brand_instrument_brand_obj.py
backend/dagu/migrations/0012_instrument_parent.py
backend/dagu/models.py
backend/dagu/permissions.py
backend/dagu/serializers.py
backend/dagu/services.py
backend/dagu/services/__init__.py
backend/dagu/services/ai.py
backend/dagu/services/item_service.py
backend/dagu/services/naver.py
backend/dagu/services/search.py
backend/dagu/services/utils.py
backend/dagu/tasks.py
backend/dagu/tests.py
backend/dagu/urls.py
backend/dagu/views.py
backend/data/inst.csv
backend/data/instruments_sample-copy.csv
backend/data/instruments_sample-copy2.csv
backend/data/instruments_sample.csv
backend/Dockerfile
backend/manage.py
backend/populate_brands.py
backend/run_migrations.py
backend/SEARCH_LOGIC.md
check_output.txt
check_user_items.py
dagu_malcha.txt
debug_db.py
debug_result.txt
frontend/.gitignore
frontend/Dockerfile
frontend/eslint.config.js
frontend/index.html
frontend/nginx.conf
frontend/package.json
frontend/public/favicon.ico
frontend/public/vite.svg
frontend/README.md
frontend/repomix-output.xml
frontend/src/App.css
frontend/src/App.tsx
frontend/src/assets/daguLoading.gif
frontend/src/assets/react.svg
frontend/src/components/CategoryHeader.tsx
frontend/src/components/ItemCard.tsx
frontend/src/components/MatchaBounceLoader.tsx
frontend/src/components/SearchBar.tsx
frontend/src/components/VSComparisonLayout.tsx
frontend/src/hooks/useAuth.ts
frontend/src/hooks/useSearch.ts
frontend/src/index.css
frontend/src/main.tsx
frontend/src/pages/CategoryPage.tsx
frontend/src/pages/HomePage.tsx
frontend/src/pages/SearchResultPage.tsx
frontend/src/services/api.ts
frontend/src/types/index.ts
frontend/tsconfig.app.json
frontend/tsconfig.json
frontend/tsconfig.node.json
frontend/vite.config.ts
icon-beta.ico
package.json
Procfile
requirements.txt
run_server.bat
runtime.txt
src/icon-beta.ico
test_api.py
test_prod.py
verify_malcha_cookie.py
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="backend/dagu/services/item_service.py">
"""
Item Service
ë§¤ë¬¼(UserItem) ê´€ë ¨ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
"""
import logging
from urllib.parse import urlparse
from django.db import models
from ..models import Instrument, UserItem
from .utils import (
    normalize_brand, tokenize_query, expand_query_with_aliases,
    find_best_matching_instruments, extract_brand
)

logger = logging.getLogger(__name__)

# í—ˆìš©ëœ ì¤‘ê³ ê±°ë˜ ì‚¬ì´íŠ¸ ë„ë©”ì¸
ALLOWED_DOMAINS = [
    'mule.co.kr',           # ë®¬
    'bunjang.co.kr',        # ë²ˆê°œì¥í„°
    'daangn.com',           # ë‹¹ê·¼ë§ˆì¼“
    'danggeun.com',         # ë‹¹ê·¼ë§ˆì¼“ (êµ¬ ë„ë©”ì¸)
    'cafe.naver.com',       # ì¤‘ê³ ë‚˜ë¼ (ë„¤ì´ë²„ ì¹´í˜)
    'joongna.com',          # ì¤‘ê³ ë‚˜ë¼
    'secondhand.co.kr',     # ì„¸ì»¨í•¸ë“œ
]

def is_allowed_link(link: str) -> bool:
    """
    í—ˆìš©ëœ ë„ë©”ì¸ ë° í”„ë¡œí† ì½œ í™•ì¸ (XSS/Open Redirect ë°©ì§€)
    """
    try:
        parsed = urlparse(link.lower())
        # í”„ë¡œí† ì½œ ê²€ì¦: http/httpsë§Œ í—ˆìš©
        if parsed.scheme not in ['http', 'https']:
            logger.warning(f"Invalid protocol detected: {parsed.scheme}")
            return False
        
        # ë„ë©”ì¸ ê²€ì¦
        domain = parsed.netloc
        if not domain:
            return False
        
        return any(allowed in domain for allowed in ALLOWED_DOMAINS)
    except Exception as e:
        logger.warning(f"URL parsing error: {e}")
        return False


def resolve_and_standardize_item(title: str, instrument_id: str | int | None = None) -> tuple[Instrument | None, str]:
    """
    ë§¤ë¬¼ ë“±ë¡ ì‹œ ì•…ê¸°ë¥¼ ê²°ì •í•˜ê³  ì œëª©ì„ í‘œì¤€í™”í•©ë‹ˆë‹¤.
    
    Returns:
        (matched_instrument, standardized_title) íŠœí”Œ
    """
    instrument = None

    # [Debug] ë§¤ë¬¼ ë“±ë¡ ì‹œë„ ì •ë³´ ë¡œê¹…
    detected_brand = extract_brand(title)
    logger.error(f"========== [ë§¤ë¬¼ë“±ë¡ ì‹œë„] Title: '{title}' | Detected Brand: '{detected_brand}' ==========")

    # 1. instrument IDê°€ ì „ë‹¬ë˜ë©´ ë°”ë¡œ ì‚¬ìš©
    if instrument_id:
        instrument = Instrument.objects.filter(id=instrument_id).first()
        if instrument:
            logger.info(f"[ë§¤ë¬¼ ë“±ë¡] instrument ID ì‚¬ìš©: {instrument}")

    # 2. IDê°€ ì—†ìœ¼ë©´ titleë¡œ ìë™ ë§¤ì¹­
    if not instrument and title:
        search_query = normalize_brand(title)
        query_tokens = tokenize_query(search_query)
        expanded_queries = expand_query_with_aliases(search_query)

        candidate_filter = models.Q()
        for token in query_tokens:
            if len(token) >= 2:
                candidate_filter |= models.Q(name__icontains=token)
                candidate_filter |= models.Q(brand__icontains=token)
        for expanded in expanded_queries:
            candidate_filter |= models.Q(name__icontains=expanded)

        candidates = Instrument.objects.filter(candidate_filter).exclude(
            brand__iexact='unknown'
        )[:30]

        if candidates.exists():
            scored_matches = find_best_matching_instruments(
                query=title,
                instruments_qs=candidates,
                min_score=0.4,
            )
            if scored_matches:
                instrument = scored_matches[0][0]
                logger.info(
                    f"[ë§¤ë¬¼ ë“±ë¡] title ë§¤ì¹­: '{title}' -> "
                    f"'{instrument.brand} {instrument.name}' (score={scored_matches[0][1]:.2f})"
                )

    # 3. ì œëª© í‘œì¤€í™” (Brand + Name)
    final_title = title
    if instrument:
        # ë¸Œëœë“œê°€ ì´ë¦„ì— í¬í•¨ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ë³‘í•© (ì¤‘ë³µ ë°©ì§€)
        if instrument.brand and instrument.brand.lower() not in instrument.name.lower():
            final_title = f"{instrument.brand} {instrument.name}"
        else:
            final_title = instrument.name
        
        if final_title != title:
            logger.info(f"[ë§¤ë¬¼ ë“±ë¡] ì œëª© í‘œì¤€í™”: '{title}' -> '{final_title}'")

    return instrument, final_title
</file>

<file path="backend/config/__init__.py">
# This will make sure the app is always imported when
# Django starts so that shared_task will use this app.
from .celery import app as celery_app

__all__ = ('celery_app',)
</file>

<file path="backend/config/asgi.py">
"""
ASGI config for config project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_asgi_application()
</file>

<file path="backend/config/backupsettings.py">
"""
Django settings for MALCHA-DAGU project.
Production-ready configuration with environment variables.
"""

import os
from datetime import timedelta
from pathlib import Path

import environ

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# Initialize environ
env = environ.Env(
    DEBUG=(bool, False),
    ALLOWED_HOSTS=(list, ['localhost', '127.0.0.1']),
)

# Read .env file if it exists
env_file = BASE_DIR.parent / '.env'
if env_file.exists():
    environ.Env.read_env(str(env_file))

# =============================================================================
# Core Settings
# =============================================================================

# SSO: Malchaì™€ ë™ì¼í•œ SECRET_KEY ì‚¬ìš© (JWT ì„œëª… ê²€ì¦)
# í”„ë¡œë•ì…˜ì—ì„œëŠ” SHARED_SECRET_KEY í™˜ê²½ë³€ìˆ˜ í•„ìˆ˜
SECRET_KEY = env('SHARED_SECRET_KEY', default=env('SECRET_KEY', default='django-insecure-dev-key-change-in-production'))
DEBUG = env('DEBUG')
ALLOWED_HOSTS = env('ALLOWED_HOSTS')

# =============================================================================
# Application definition
# =============================================================================

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    # Third-party
    'rest_framework',
    'rest_framework_simplejwt',  # SSO: JWT ê²€ì¦
    'corsheaders',
    # Local apps
    'dagu',
]

# Add celery beat if available (production)
try:
    import django_celery_beat
    INSTALLED_APPS.append('django_celery_beat')
except ImportError:
    pass

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',  # Must be before CommonMiddleware
    'django.middleware.security.SecurityMiddleware',
    'config.middleware.SecurityHeadersMiddleware',  # ì»¤ìŠ¤í…€ ë³´ì•ˆ í—¤ë”
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'config.middleware.RequestLoggingMiddleware',  # ë³´ì•ˆ ë¡œê¹…
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'

# =============================================================================
# Database
# =============================================================================

# Use DATABASE_URL if available, otherwise default to SQLite for development
DATABASES = {
    'default': env.db('DATABASE_URL', default=f'sqlite:///{BASE_DIR / "db.sqlite3"}')
}

# =============================================================================
# Cache (Redis or Local Memory)
# =============================================================================

REDIS_URL = env('REDIS_URL', default='redis://localhost:6379/0')

# Use Redis if available, otherwise fallback to local memory cache
try:
    import django_redis
    CACHES = {
        'default': {
            'BACKEND': 'django_redis.cache.RedisCache',
            'LOCATION': REDIS_URL,
            'OPTIONS': {
                'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            }
        }
    }
except ImportError:
    CACHES = {
        'default': {
            'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
            'LOCATION': 'unique-snowflake',
        }
    }

# =============================================================================
# Celery Configuration
# =============================================================================

CELERY_BROKER_URL = REDIS_URL
CELERY_RESULT_BACKEND = REDIS_URL
CELERY_ACCEPT_CONTENT = ['json']
CELERY_TASK_SERIALIZER = 'json'
CELERY_RESULT_SERIALIZER = 'json'
CELERY_TIMEZONE = 'Asia/Seoul'
CELERY_BEAT_SCHEDULER = 'django_celery_beat.schedulers:DatabaseScheduler'

# =============================================================================
# REST Framework
# =============================================================================

REST_FRAMEWORK = {
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
    ],
    'DEFAULT_PARSER_CLASSES': [
        'rest_framework.parsers.JSONParser',
    ],
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 20,
    # Rate Limiting (í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ API ë‚¨ìš© ë°©ì§€)
    'DEFAULT_THROTTLE_CLASSES': [
        'rest_framework.throttling.AnonRateThrottle',
        'rest_framework.throttling.UserRateThrottle',
    ],
    'DEFAULT_THROTTLE_RATES': {
        'anon': '100/hour',      # ë¹„ì¸ì¦ ì‚¬ìš©ì: ì‹œê°„ë‹¹ 100íšŒ
        'user': '1000/hour',     # ì¸ì¦ ì‚¬ìš©ì: ì‹œê°„ë‹¹ 1000íšŒ
        'search': '60/minute',   # ê²€ìƒ‰ API: ë¶„ë‹¹ 60íšŒ
    },
    # ì „ì—­ ì˜ˆì™¸ í•¸ë“¤ëŸ¬ (í‘œì¤€í™”ëœ ì—ëŸ¬ ì‘ë‹µ)
    'EXCEPTION_HANDLER': 'dagu.exceptions.custom_exception_handler',
}

# Add BrowsableAPI in debug mode
if DEBUG:
    REST_FRAMEWORK['DEFAULT_RENDERER_CLASSES'].append(
        'rest_framework.renderers.BrowsableAPIRenderer'
    )

# =============================================================================
# SSO: JWT ì¿ í‚¤ ì¸ì¦ ì„¤ì • (Malcha ë°œê¸‰ JWT ê²€ì¦)
# =============================================================================

# ì„œë¸Œë„ë©”ì¸ ì¿ í‚¤ ê³µìœ ë¥¼ ìœ„í•œ ë„ë©”ì¸ ì„¤ì • (ì (.) ì ‘ë‘ì‚¬ í•„ìˆ˜)
COOKIE_DOMAIN = '.malchalab.com' if not DEBUG else None

# SimpleJWT ì„¤ì • (Malchaì™€ ë™ì¼í•œ ì„¤ì •ìœ¼ë¡œ ê²€ì¦)
SIMPLE_JWT = {
    "ACCESS_TOKEN_LIFETIME": timedelta(minutes=30),
    "REFRESH_TOKEN_LIFETIME": timedelta(days=7),
    "ALGORITHM": "HS256",
    "SIGNING_KEY": SECRET_KEY,  # Malchaì™€ ë™ì¼í•œ í‚¤
    "AUTH_HEADER_TYPES": ("Bearer",),
    # SSO: Malchaê°€ ë°œê¸‰í•œ ì¿ í‚¤ëª…
    "AUTH_COOKIE": "malcha-access-token",
    "AUTH_COOKIE_DOMAIN": COOKIE_DOMAIN,
    "AUTH_COOKIE_SECURE": not DEBUG,
    "AUTH_COOKIE_HTTP_ONLY": True,
    "AUTH_COOKIE_SAMESITE": "Lax",

    # SSO ë³´ì•ˆ: í† í° ë°œê¸‰ì/ìˆ˜ì‹ ì ê²€ì¦ (Malcha ì„¤ì •ê³¼ ì¼ì¹˜í•´ì•¼ í•¨)
    "ISSUER": "malchalab.com",  # í† í° ë°œê¸‰ì ê²€ì¦
    "AUDIENCE": "dagu.malchalab.com",  # Daguê°€ í—ˆìš©ëœ ìˆ˜ì‹ ìì¸ì§€ í™•ì¸

    # ì¶”ê°€ ë³´ì•ˆ ì„¤ì •
    "JTI_CLAIM": "jti",
    "TOKEN_TYPE_CLAIM": "token_type",
    "USER_ID_CLAIM": "user_id",
}

# JWT ì¿ í‚¤ ì¸ì¦ í´ë˜ìŠ¤ ì¶”ê°€
REST_FRAMEWORK['DEFAULT_AUTHENTICATION_CLASSES'] = [
    'dagu.authentication.JWTCookieAuthentication',
]

# =============================================================================
# CORS Settings
# =============================================================================

# í™˜ê²½ ë³€ìˆ˜ì—ì„œ CORS ë„ë©”ì¸ ë¡œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„)
# ì˜ˆ: CORS_ORIGINS=https://example.com,https://www.example.com
_cors_origins_env = env('CORS_ORIGINS', default='')
_cors_origins_from_env = [origin.strip() for origin in _cors_origins_env.split(',') if origin.strip()]

# ê¸°ë³¸ ê°œë°œ í™˜ê²½ ë„ë©”ì¸ + í™˜ê²½ ë³€ìˆ˜ ë„ë©”ì¸
CORS_ALLOWED_ORIGINS = [
    'http://localhost:3000',
    'http://localhost:5173',
    'http://127.0.0.1:3000',
    'http://127.0.0.1:5173',
] + _cors_origins_from_env

# í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ê°œë°œ ë„ë©”ì¸ ì œê±°
if not DEBUG:
    CORS_ALLOWED_ORIGINS = _cors_origins_from_env if _cors_origins_from_env else CORS_ALLOWED_ORIGINS

CORS_ALLOW_CREDENTIALS = True

# CORS preflight ìºì‹± (ì„±ëŠ¥ ìµœì í™”)
CORS_PREFLIGHT_MAX_AGE = 86400  # 24ì‹œê°„

# =============================================================================
# Password validation
# =============================================================================

AUTH_PASSWORD_VALIDATORS = [
    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},
    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},
    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},
    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},
]

# =============================================================================
# Internationalization
# =============================================================================

LANGUAGE_CODE = 'ko-kr'
TIME_ZONE = 'Asia/Seoul'
USE_I18N = True
USE_TZ = True

# =============================================================================
# Static files
# =============================================================================

STATIC_URL = 'static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'

# =============================================================================
# Default primary key field type
# =============================================================================

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# =============================================================================
# External API Keys
# =============================================================================

NAVER_CLIENT_ID = env('NAVER_CLIENT_ID', default='')
NAVER_CLIENT_SECRET = env('NAVER_CLIENT_SECRET', default='')
OPENAI_API_KEY = env('OPENAI_API_KEY', default='')

# =============================================================================
# Security Settings (Production)
# =============================================================================

# SSO: ì„œë¸Œë„ë©”ì¸ ì¿ í‚¤ ê³µìœ 
SESSION_COOKIE_DOMAIN = COOKIE_DOMAIN
CSRF_COOKIE_DOMAIN = COOKIE_DOMAIN

# CSRF ì‹ ë¢° ì¶œì²˜ (SSO)
if DEBUG:
    CSRF_TRUSTED_ORIGINS = [
        'http://localhost:5173', 'http://127.0.0.1:5173',  # Malcha frontend
        'http://localhost:3000', 'http://127.0.0.1:3000',  # Dagu frontend
    ]
else:
    CSRF_TRUSTED_ORIGINS = [
        'https://malchalab.com',
        'https://www.malchalab.com',
        'https://dagu.malchalab.com',
    ]

if not DEBUG:
    # HTTPS ê°•ì œ
    SECURE_SSL_REDIRECT = True
    SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')

    # HSTS (HTTP Strict Transport Security)
    SECURE_HSTS_SECONDS = 31536000  # 1ë…„
    SECURE_HSTS_INCLUDE_SUBDOMAINS = True
    SECURE_HSTS_PRELOAD = True

    # Cookie ë³´ì•ˆ
    SESSION_COOKIE_SECURE = True
    CSRF_COOKIE_SECURE = True
    SESSION_COOKIE_HTTPONLY = True
    CSRF_COOKIE_HTTPONLY = True

    # XSS ë°©ì§€
    SECURE_BROWSER_XSS_FILTER = True
    SECURE_CONTENT_TYPE_NOSNIFF = True

    # Clickjacking ë°©ì§€
    X_FRAME_OPTIONS = 'DENY'

# =============================================================================
# Logging
# =============================================================================

LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {message}',
            'style': '{',
        },
        'simple': {
            'format': '{levelname} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
            'formatter': 'verbose',
        },
    },
    'root': {
        'handlers': ['console'],
        'level': 'INFO',
    },
    'loggers': {
        'dagu': {
            'handlers': ['console'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'dagu.services': {
            'handlers': ['console'],
            'level': 'INFO',
            'propagate': False,
        },
        'dagu.filters': {
            'handlers': ['console'],
            'level': 'DEBUG',  # í•„í„° íƒˆë½ ë¡œê·¸ í™œì„±í™”
            'propagate': False,
        },
    },
}
</file>

<file path="backend/config/celery.py">
"""
Celery configuration for MALCHA-DAGU project.
"""

import os

from celery import Celery

# Set the default Django settings module
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

app = Celery('config')

# Load config from Django settings
app.config_from_object('django.conf:settings', namespace='CELERY')

# Auto-discover tasks from all installed apps
app.autodiscover_tasks()


@app.task(bind=True, ignore_result=True)
def debug_task(self):
    print(f'Request: {self.request!r}')
</file>

<file path="backend/config/middleware.py">
"""
Security middleware for MALCHA-DAGU.
Adds additional security headers to all responses.
"""

import logging

logger = logging.getLogger(__name__)


class SecurityHeadersMiddleware:
    """
    ì¶”ê°€ ë³´ì•ˆ í—¤ë”ë¥¼ ëª¨ë“  ì‘ë‹µì— ì¶”ê°€í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´.

    ì¶”ê°€ë˜ëŠ” í—¤ë”:
    - X-Content-Type-Options: nosniff (MIME íƒ€ì… ìŠ¤ë‹ˆí•‘ ë°©ì§€)
    - X-Frame-Options: DENY (í´ë¦­ì¬í‚¹ ë°©ì§€)
    - Referrer-Policy: strict-origin-when-cross-origin
    - Permissions-Policy: ë¶ˆí•„ìš”í•œ ë¸Œë¼ìš°ì € ê¸°ëŠ¥ ë¹„í™œì„±í™”
    - Cache-Control: API ì‘ë‹µ ìºì‹œ ë°©ì§€ (ë¯¼ê°í•œ ë°ì´í„°)
    """

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        response = self.get_response(request)

        # MIME íƒ€ì… ìŠ¤ë‹ˆí•‘ ë°©ì§€
        response['X-Content-Type-Options'] = 'nosniff'

        # í´ë¦­ì¬í‚¹ ë°©ì§€ (iframe ì‚½ì… ì°¨ë‹¨)
        response['X-Frame-Options'] = 'DENY'

        # Referrer ì •ì±… (ì™¸ë¶€ ì‚¬ì´íŠ¸ì— URL ë…¸ì¶œ ì œí•œ)
        response['Referrer-Policy'] = 'strict-origin-when-cross-origin'

        # Permissions-Policy (ë¶ˆí•„ìš”í•œ ë¸Œë¼ìš°ì € API ë¹„í™œì„±í™”)
        response['Permissions-Policy'] = (
            "accelerometer=(), "
            "camera=(), "
            "geolocation=(), "
            "gyroscope=(), "
            "magnetometer=(), "
            "microphone=(), "
            "payment=(), "
            "usb=()"
        )

        # API ì‘ë‹µì€ ìºì‹œí•˜ì§€ ì•ŠìŒ (ë¯¼ê°í•œ ë°ì´í„° ë³´í˜¸)
        if request.path.startswith('/api/'):
            response['Cache-Control'] = 'no-store, no-cache, must-revalidate, private'
            response['Pragma'] = 'no-cache'

        return response


class RequestLoggingMiddleware:
    """
    ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ì„ ìœ„í•œ ìš”ì²­ ë¡œê¹… ë¯¸ë“¤ì›¨ì–´.

    ë¡œê¹… í•­ëª©:
    - ì¸ì¦ ì‹¤íŒ¨ ìš”ì²­
    - ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ìš”ì²­ íŒ¨í„´
    - Rate limit ê·¼ì ‘ ìš”ì²­
    """

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        response = self.get_response(request)

        # ì¸ì¦ ì‹¤íŒ¨ ì‘ë‹µ ë¡œê¹… (401, 403)
        if response.status_code in [401, 403]:
            client_ip = self._get_client_ip(request)
            logger.warning(
                f"Auth failure: {request.method} {request.path} "
                f"status={response.status_code} ip={client_ip} "
                f"user_agent={request.META.get('HTTP_USER_AGENT', 'unknown')[:100]}"
            )

        # Rate limit ì‘ë‹µ ë¡œê¹… (429)
        if response.status_code == 429:
            client_ip = self._get_client_ip(request)
            logger.warning(
                f"Rate limit exceeded: {request.method} {request.path} "
                f"ip={client_ip}"
            )

        return response

    def _get_client_ip(self, request) -> str:
        """í´ë¼ì´ì–¸íŠ¸ IP ì¶”ì¶œ (í”„ë¡ì‹œ ê³ ë ¤)"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            return x_forwarded_for.split(',')[0].strip()
        return request.META.get('REMOTE_ADDR', 'unknown')
</file>

<file path="backend/config/settings/__init__.py">

</file>

<file path="backend/dagu/__init__.py">

</file>

<file path="backend/dagu/apps.py">
from django.apps import AppConfig


class DaguConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'dagu'
</file>

<file path="backend/dagu/exceptions.py">
"""
Custom exception handling for MALCHA-DAGU API.
í‘œì¤€í™”ëœ ì—ëŸ¬ ì‘ë‹µ í˜•ì‹ ì œê³µ.
"""

import logging

from django.core.exceptions import PermissionDenied, ValidationError
from django.http import Http404
from rest_framework import status
from rest_framework.exceptions import APIException, Throttled
from rest_framework.response import Response
from rest_framework.views import exception_handler

logger = logging.getLogger(__name__)


def custom_exception_handler(exc, context):
    """
    DRF ì „ì—­ ì˜ˆì™¸ í•¸ë“¤ëŸ¬.

    í‘œì¤€í™”ëœ ì—ëŸ¬ ì‘ë‹µ í˜•ì‹:
    {
        "error": {
            "code": "ERROR_CODE",
            "message": "ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€",
            "detail": "ìƒì„¸ ì •ë³´ (ê°œë°œìš©)"
        }
    }
    """
    # ê¸°ë³¸ DRF ì˜ˆì™¸ í•¸ë“¤ëŸ¬ í˜¸ì¶œ
    response = exception_handler(exc, context)

    # ìš”ì²­ ì •ë³´ ë¡œê¹…
    request = context.get('request')
    view = context.get('view')
    view_name = view.__class__.__name__ if view else 'Unknown'

    if response is not None:
        # DRF ì˜ˆì™¸ ì²˜ë¦¬ë¨
        error_response = format_error_response(exc, response)
        response.data = error_response

        # ë¡œê¹… (500 ì—ëŸ¬ëŠ” ERROR, ê·¸ ì™¸ëŠ” WARNING)
        if response.status_code >= 500:
            logger.error(
                f"API Error [{response.status_code}] {view_name}: {exc}",
                extra={'request': request}
            )
        else:
            logger.warning(
                f"API Warning [{response.status_code}] {view_name}: {exc}",
                extra={'request': request}
            )

        return response

    # DRFì—ì„œ ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì˜ˆì™¸
    if isinstance(exc, Http404):
        return Response(
            format_error_response(exc, None, code='NOT_FOUND', message='ìš”ì²­í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'),
            status=status.HTTP_404_NOT_FOUND
        )

    if isinstance(exc, PermissionDenied):
        return Response(
            format_error_response(exc, None, code='PERMISSION_DENIED', message='ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'),
            status=status.HTTP_403_FORBIDDEN
        )

    if isinstance(exc, ValidationError):
        return Response(
            format_error_response(exc, None, code='VALIDATION_ERROR', message='ì…ë ¥ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'),
            status=status.HTTP_400_BAD_REQUEST
        )

    # ì˜ˆìƒì¹˜ ëª»í•œ ì˜ˆì™¸ (500 ì—ëŸ¬)
    logger.exception(f"Unhandled exception in {view_name}: {exc}")
    return Response(
        {
            'error': {
                'code': 'INTERNAL_ERROR',
                'message': 'ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
            }
        },
        status=status.HTTP_500_INTERNAL_SERVER_ERROR
    )


def format_error_response(exc, response, code=None, message=None):
    """ì—ëŸ¬ ì‘ë‹µ í˜•ì‹ í‘œì¤€í™”"""

    # Rate Limit ì´ˆê³¼
    if isinstance(exc, Throttled):
        return {
            'error': {
                'code': 'RATE_LIMIT_EXCEEDED',
                'message': f'ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. {exc.wait}ì´ˆ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                'retry_after': exc.wait,
            }
        }

    # ê¸°ë³¸ ì—ëŸ¬ ì½”ë“œ ì¶”ì¶œ
    if code is None:
        code = getattr(exc, 'default_code', 'ERROR')
        if hasattr(exc, 'status_code'):
            code = {
                400: 'BAD_REQUEST',
                401: 'UNAUTHORIZED',
                403: 'FORBIDDEN',
                404: 'NOT_FOUND',
                405: 'METHOD_NOT_ALLOWED',
                429: 'RATE_LIMIT_EXCEEDED',
                500: 'INTERNAL_ERROR',
            }.get(exc.status_code, code)

    # ë©”ì‹œì§€ ì¶”ì¶œ
    if message is None:
        if hasattr(exc, 'detail'):
            message = str(exc.detail)
        else:
            message = str(exc)

    return {
        'error': {
            'code': code.upper() if isinstance(code, str) else 'ERROR',
            'message': message,
        }
    }
</file>

<file path="backend/dagu/management/__init__.py">

</file>

<file path="backend/dagu/management/commands/__init__.py">

</file>

<file path="backend/dagu/management/commands/import_instruments.py">
"""
ì•…ê¸° ë°ì´í„° CSV Import ì»¤ë§¨ë“œ.

Usage:
    python manage.py import_instruments data/instruments.csv
    python manage.py import_instruments data/instruments.csv --update
    python manage.py import_instruments data/instruments.csv --dry-run
"""

import csv
from django.core.management.base import BaseCommand, CommandError
from dagu.models import Instrument


class Command(BaseCommand):
    help = 'CSV íŒŒì¼ì—ì„œ ì•…ê¸° ë°ì´í„° import'

    def add_arguments(self, parser):
        parser.add_argument(
            'csv_file',
            type=str,
            help='CSV íŒŒì¼ ê²½ë¡œ'
        )
        parser.add_argument(
            '--update',
            action='store_true',
            help='ê¸°ì¡´ ë°ì´í„° ì—…ë°ì´íŠ¸ (ê¸°ë³¸: ì¤‘ë³µ ìŠ¤í‚µ)'
        )
        parser.add_argument(
            '--dry-run',
            action='store_true',
            help='ì‹¤ì œ ì €ì¥ ì—†ì´ í…ŒìŠ¤íŠ¸ë§Œ ìˆ˜í–‰'
        )

    def handle(self, *args, **options):
        csv_file = options['csv_file']
        update_existing = options['update']
        dry_run = options['dry_run']

        if dry_run:
            self.stdout.write(self.style.WARNING('ğŸ” DRY RUN ëª¨ë“œ (ì‹¤ì œ ì €ì¥ ì•ˆ í•¨)\n'))

        try:
            with open(csv_file, 'r', encoding='utf-8-sig') as f:
                reader = csv.DictReader(f)

                # í•„ìˆ˜ ì»¬ëŸ¼ ì²´í¬
                required = {'brand', 'name'}
                if not required.issubset(reader.fieldnames or []):
                    raise CommandError(f'í•„ìˆ˜ ì»¬ëŸ¼ ëˆ„ë½: {required - set(reader.fieldnames or [])}')

                stats = {'created': 0, 'updated': 0, 'skipped': 0, 'errors': 0}

                for row_num, row in enumerate(reader, start=2):
                    try:
                        result = self._process_row(row, update_existing, dry_run)
                        stats[result] += 1
                    except Exception as e:
                        stats['errors'] += 1
                        self.stdout.write(
                            self.style.ERROR(f'âŒ í–‰ {row_num}: {e}')
                        )

                self._print_summary(stats)

        except FileNotFoundError:
            raise CommandError(f'íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {csv_file}')
        except UnicodeDecodeError:
            raise CommandError('íŒŒì¼ ì¸ì½”ë”© ì˜¤ë¥˜. UTF-8ë¡œ ì €ì¥í•´ì£¼ì„¸ìš”.')

    def _process_row(self, row, update_existing, dry_run):
        """ë‹¨ì¼ í–‰ ì²˜ë¦¬"""
        brand = row['brand'].strip().lower()
        name = row['name'].strip().lower()

        if not brand or not name:
            raise ValueError('brandì™€ nameì€ í•„ìˆ˜ì…ë‹ˆë‹¤')

        # ì¹´í…Œê³ ë¦¬ ìœ íš¨ì„± ê²€ì‚¬
        category = row.get('category', 'guitar').strip().lower()
        valid_categories = dict(Instrument.CATEGORY_CHOICES).keys()
        if category not in valid_categories:
            category = 'guitar'

        # ê°€ê²© íŒŒì‹± (ì½¤ë§ˆ ì œê±°)
        price_str = row.get('reference_price', '0').replace(',', '').strip()
        reference_price = int(price_str) if price_str.isdigit() else 0

        data = {
            'category': category,
            'reference_price': reference_price,
            'image_url': row.get('image_url', '').strip(),
            'description': row.get('description', '').strip(),
        }

        existing = Instrument.objects.filter(brand=brand, name=name).first()

        if existing:
            if update_existing:
                if not dry_run:
                    for key, value in data.items():
                        setattr(existing, key, value)
                    existing.save()
                self.stdout.write(f'ğŸ”„ ì—…ë°ì´íŠ¸: {brand} {name}')
                return 'updated'
            else:
                self.stdout.write(self.style.WARNING(f'â­ï¸  ìŠ¤í‚µ (ì´ë¯¸ ì¡´ì¬): {brand} {name}'))
                return 'skipped'
        else:
            if not dry_run:
                Instrument.objects.create(brand=brand, name=name, **data)
            self.stdout.write(self.style.SUCCESS(f'âœ… ìƒì„±: {brand} {name}'))
            return 'created'

    def _print_summary(self, stats):
        """ê²°ê³¼ ìš”ì•½ ì¶œë ¥"""
        self.stdout.write('\n' + '=' * 50)
        self.stdout.write(self.style.SUCCESS(f"âœ… ìƒì„±: {stats['created']}ê°œ"))
        self.stdout.write(self.style.WARNING(f"ğŸ”„ ì—…ë°ì´íŠ¸: {stats['updated']}ê°œ"))
        self.stdout.write(f"â­ï¸  ìŠ¤í‚µ: {stats['skipped']}ê°œ")
        if stats['errors']:
            self.stdout.write(self.style.ERROR(f"âŒ ì˜¤ë¥˜: {stats['errors']}ê°œ"))
        self.stdout.write('=' * 50)
</file>

<file path="backend/dagu/migrations/__init__.py">

</file>

<file path="backend/dagu/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2026-01-15 03:58

import dagu.models
import django.db.models.deletion
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Instrument',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=200, verbose_name='ëª¨ë¸ëª…')),
                ('brand', models.CharField(max_length=100, verbose_name='ë¸Œëœë“œ')),
                ('category', models.CharField(choices=[('guitar', 'ê¸°íƒ€'), ('bass', 'ë² ì´ìŠ¤'), ('keyboard', 'í‚¤ë³´ë“œ/ì‹ ë””'), ('drum', 'ë“œëŸ¼/í¼ì»¤ì…˜'), ('effect', 'ì´í™í„°'), ('amp', 'ì•°í”„'), ('acoustic', 'ì–´ì¿ ìŠ¤í‹±'), ('other', 'ê¸°íƒ€ ì•…ê¸°')], default='guitar', max_length=50, verbose_name='ì¹´í…Œê³ ë¦¬')),
                ('image_url', models.URLField(blank=True, verbose_name='ëŒ€í‘œ ì´ë¯¸ì§€ URL')),
                ('reference_price', models.PositiveIntegerField(default=0, help_text='ì‹ í’ˆ ì •ê°€ (ì›)', verbose_name='ì‹ í’ˆ ê¸°ì¤€ê°€')),
                ('description', models.TextField(blank=True, verbose_name='ì„¤ëª…')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'ì•…ê¸°',
                'verbose_name_plural': 'ì•…ê¸° ëª©ë¡',
                'ordering': ['brand', 'name'],
                'indexes': [models.Index(fields=['brand'], name='dagu_instru_brand_9bf97b_idx'), models.Index(fields=['category'], name='dagu_instru_categor_0dc989_idx'), models.Index(fields=['name'], name='dagu_instru_name_1f8469_idx')],
            },
        ),
        migrations.CreateModel(
            name='UserItem',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('price', models.PositiveIntegerField(verbose_name='íŒë§¤ê°€')),
                ('link', models.URLField(verbose_name='íŒë§¤ ë§í¬')),
                ('source', models.CharField(choices=[('bunjang', 'ë²ˆê°œì¥í„°'), ('joonggonara', 'ì¤‘ê³ ë‚˜ë¼'), ('danggn', 'ë‹¹ê·¼ë§ˆì¼“'), ('other', 'ê¸°íƒ€')], default='other', max_length=50, verbose_name='ì¶œì²˜')),
                ('title', models.CharField(blank=True, max_length=300, verbose_name='ë§¤ë¬¼ ì œëª©')),
                ('is_active', models.BooleanField(default=True, verbose_name='í™œì„± ìƒíƒœ')),
                ('expired_at', models.DateTimeField(db_index=True, default=dagu.models.default_expiry, verbose_name='ë§Œë£Œ ì‹œê°„')),
                ('click_count', models.PositiveIntegerField(default=0, verbose_name='í´ë¦­ ìˆ˜')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('instrument', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='user_items', to='dagu.instrument', verbose_name='ì•…ê¸°')),
            ],
            options={
                'verbose_name': 'ì¤‘ê³  ë§¤ë¬¼',
                'verbose_name_plural': 'ì¤‘ê³  ë§¤ë¬¼ ëª©ë¡',
                'ordering': ['price', '-created_at'],
                'indexes': [models.Index(fields=['is_active', 'expired_at'], name='dagu_userit_is_acti_d17b95_idx'), models.Index(fields=['price'], name='dagu_userit_price_56eff5_idx')],
            },
        ),
    ]
</file>

<file path="backend/dagu/migrations/0002_alter_instrument_image_url_alter_instrument_name_and_more.py">
# Generated by Django 5.2.8 on 2026-01-15 06:01

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('dagu', '0001_initial'),
    ]

    operations = [
        migrations.AlterField(
            model_name='instrument',
            name='image_url',
            field=models.URLField(blank=True, max_length=2000, verbose_name='ëŒ€í‘œ ì´ë¯¸ì§€ URL'),
        ),
        migrations.AlterField(
            model_name='instrument',
            name='name',
            field=models.CharField(max_length=500, verbose_name='ëª¨ë¸ëª…'),
        ),
        migrations.AlterField(
            model_name='useritem',
            name='link',
            field=models.URLField(max_length=2000, verbose_name='íŒë§¤ ë§í¬'),
        ),
    ]
</file>

<file path="backend/dagu/migrations/0003_alter_useritem_source.py">
# Generated by Django 5.2.8 on 2026-01-15 06:05

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('dagu', '0002_alter_instrument_image_url_alter_instrument_name_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='useritem',
            name='source',
            field=models.CharField(choices=[('bunjang', 'ë²ˆê°œì¥í„°'), ('joonggonara', 'ì¤‘ê³ ë‚˜ë¼'), ('danggn', 'ë‹¹ê·¼ë§ˆì¼“'), ('mule', 'ë®¬'), ('other', 'ê¸°íƒ€')], default='other', max_length=50, verbose_name='ì¶œì²˜'),
        ),
    ]
</file>

<file path="backend/dagu/migrations/0004_useritem_extended_at_useritem_owner_id.py">
# Generated by Django 5.2.8 on 2026-01-16 09:43

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('dagu', '0003_alter_useritem_source'),
    ]

    operations = [
        migrations.AddField(
            model_name='useritem',
            name='extended_at',
            field=models.DateTimeField(blank=True, null=True, verbose_name='ì—°ì¥ ì‹œì '),
        ),
        migrations.AddField(
            model_name='useritem',
            name='owner_id',
            field=models.IntegerField(blank=True, db_index=True, null=True, verbose_name='ë“±ë¡ì ID'),
        ),
    ]
</file>

<file path="backend/dagu/migrations/0005_add_report_fields.py">
# Generated by Django 5.2.8 on 2026-01-16 14:55

import django.db.models.deletion
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('dagu', '0004_useritem_extended_at_useritem_owner_id'),
    ]

    operations = [
        migrations.AddField(
            model_name='useritem',
            name='is_under_review',
            field=models.BooleanField(default=False, verbose_name='ê²€í†  ì¤‘'),
        ),
        migrations.AddField(
            model_name='useritem',
            name='report_count',
            field=models.PositiveIntegerField(default=0, verbose_name='ì‹ ê³  íšŸìˆ˜'),
        ),
        migrations.CreateModel(
            name='ItemReport',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('reporter_id', models.IntegerField(db_index=True, verbose_name='ì‹ ê³ ì ID')),
                ('reason', models.CharField(choices=[('wrong_price', 'ê°€ê²©ì´ ë‹¤ë¦…ë‹ˆë‹¤'), ('sold_out', 'ì´ë¯¸ íŒë§¤ì™„ë£Œëœ ë§¤ë¬¼ì…ë‹ˆë‹¤'), ('fake', 'í—ˆìœ„/ì‚¬ê¸° ë§¤ë¬¼ì…ë‹ˆë‹¤'), ('inappropriate', 'ë¶€ì ì ˆí•œ ë‚´ìš©ì…ë‹ˆë‹¤'), ('other', 'ê¸°íƒ€')], default='other', max_length=50, verbose_name='ì‹ ê³  ì‚¬ìœ ')),
                ('detail', models.TextField(blank=True, verbose_name='ìƒì„¸ ë‚´ìš©')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('item', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='reports', to='dagu.useritem', verbose_name='ë§¤ë¬¼')),
            ],
            options={
                'verbose_name': 'ë§¤ë¬¼ ì‹ ê³ ',
                'verbose_name_plural': 'ë§¤ë¬¼ ì‹ ê³  ëª©ë¡',
                'ordering': ['-created_at'],
                'unique_together': {('item', 'reporter_id')},
            },
        ),
    ]
</file>

<file path="backend/dagu/migrations/0006_allow_anonymous_reports.py">
# Generated by Django 5.2.8 on 2026-01-16 15:09

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('dagu', '0005_add_report_fields'),
    ]

    operations = [
        migrations.AlterUniqueTogether(
            name='itemreport',
            unique_together=set(),
        ),
        migrations.AddField(
            model_name='itemreport',
            name='session_key',
            field=models.CharField(blank=True, db_index=True, max_length=40, null=True, verbose_name='ì„¸ì…˜ í‚¤'),
        ),
        migrations.AlterField(
            model_name='itemreport',
            name='reporter_id',
            field=models.IntegerField(blank=True, db_index=True, null=True, verbose_name='ì‹ ê³ ì ID'),
        ),
    ]
</file>

<file path="backend/dagu/migrations/0007_add_search_query.py">
# Generated by Django 5.2.8 on 2026-01-17 05:38

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('dagu', '0006_allow_anonymous_reports'),
    ]

    operations = [
        migrations.CreateModel(
            name='SearchQuery',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('query', models.CharField(db_index=True, max_length=200, verbose_name='ê²€ìƒ‰ì–´')),
                ('search_count', models.PositiveIntegerField(default=1, verbose_name='ê²€ìƒ‰ íšŸìˆ˜')),
                ('last_searched_at', models.DateTimeField(auto_now=True, verbose_name='ë§ˆì§€ë§‰ ê²€ìƒ‰')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
            options={
                'verbose_name': 'ê²€ìƒ‰ì–´',
                'verbose_name_plural': 'ê²€ìƒ‰ì–´ ëª©ë¡',
                'ordering': ['-search_count', '-last_searched_at'],
            },
        ),
    ]
</file>

<file path="backend/dagu/migrations/0008_itemclick.py">
# Generated by Django 5.2.8 on 2026-01-18 02:45

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('dagu', '0007_add_search_query'),
    ]

    operations = [
        migrations.CreateModel(
            name='ItemClick',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('clicked_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('item', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='clicks', to='dagu.useritem', verbose_name='ë§¤ë¬¼')),
            ],
            options={
                'verbose_name': 'í´ë¦­ ë¡œê·¸',
                'verbose_name_plural': 'í´ë¦­ ë¡œê·¸ ëª©ë¡',
                'indexes': [models.Index(fields=['clicked_at'], name='dagu_itemcl_clicked_9c4c75_idx')],
            },
        ),
    ]
</file>

<file path="backend/dagu/migrations/0009_alter_instrument_category.py">
# Generated by Django 5.2.8 on 2026-01-18 12:09

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('dagu', '0008_itemclick'),
    ]

    operations = [
        migrations.AlterField(
            model_name='instrument',
            name='category',
            field=models.CharField(choices=[('guitar', 'ê¸°íƒ€'), ('bass', 'ë² ì´ìŠ¤'), ('keyboard', 'í‚¤ë³´ë“œ/ì‹ ë””'), ('drum', 'ë“œëŸ¼/í¼ì»¤ì…˜'), ('effect', 'ì´í™í„°'), ('amp', 'ì•°í”„'), ('acoustic', 'ì–´ì¿ ìŠ¤í‹±'), ('mic', 'ë§ˆì´í¬'), ('other', 'ê¸°íƒ€ ì•…ê¸°')], default='guitar', max_length=50, verbose_name='ì¹´í…Œê³ ë¦¬'),
        ),
    ]
</file>

<file path="backend/dagu/migrations/0010_searchmisslog.py">
# Generated by Django 5.2.8 on 2026-01-18 13:32

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('dagu', '0009_alter_instrument_category'),
    ]

    operations = [
        migrations.CreateModel(
            name='SearchMissLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('query', models.CharField(db_index=True, max_length=200, verbose_name='ê²€ìƒ‰ì–´')),
                ('normalized_query', models.CharField(db_index=True, help_text='ì†Œë¬¸ì, ê³µë°± ì •ë¦¬ëœ ê²€ìƒ‰ì–´', max_length=200, verbose_name='ì •ê·œí™”ëœ ê²€ìƒ‰ì–´')),
                ('search_count', models.PositiveIntegerField(default=1, verbose_name='ê²€ìƒ‰ íšŸìˆ˜')),
                ('last_searched_at', models.DateTimeField(auto_now=True, verbose_name='ë§ˆì§€ë§‰ ê²€ìƒ‰')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('is_resolved', models.BooleanField(default=False, verbose_name='ì²˜ë¦¬ ì™„ë£Œ')),
                ('resolved_at', models.DateTimeField(blank=True, null=True, verbose_name='ì²˜ë¦¬ ì‹œì ')),
                ('resolved_instrument', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='resolved_misses', to='dagu.instrument', verbose_name='ë“±ë¡ëœ ì•…ê¸°')),
            ],
            options={
                'verbose_name': 'ë¯¸ë“±ë¡ ê²€ìƒ‰ì–´',
                'verbose_name_plural': 'ë¯¸ë“±ë¡ ê²€ìƒ‰ì–´ ëª©ë¡',
                'ordering': ['-search_count', '-last_searched_at'],
            },
        ),
    ]
</file>

<file path="backend/dagu/migrations/0011_brand_alter_instrument_brand_instrument_brand_obj.py">
# Generated by Django 5.2.8 on 2026-01-19 09:17

import django.db.models.deletion
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('dagu', '0010_searchmisslog'),
    ]

    operations = [
        migrations.CreateModel(
            name='Brand',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=100, unique=True, verbose_name='ë¸Œëœë“œëª… (ì •ì‹)')),
                ('slug', models.SlugField(max_length=100, unique=True, verbose_name='URL ìŠ¬ëŸ¬ê·¸')),
                ('logo_url', models.URLField(blank=True, max_length=2000, verbose_name='ë¡œê³  URL')),
                ('description', models.TextField(blank=True, verbose_name='ë¸Œëœë“œ ì„¤ëª…')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'ë¸Œëœë“œ',
                'verbose_name_plural': 'ë¸Œëœë“œ ëª©ë¡',
                'ordering': ['name'],
            },
        ),
        migrations.AlterField(
            model_name='instrument',
            name='brand',
            field=models.CharField(max_length=100, verbose_name='ë¸Œëœë“œ (Legacy)'),
        ),
        migrations.AddField(
            model_name='instrument',
            name='brand_obj',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='instruments', to='dagu.brand', verbose_name='ë¸Œëœë“œ (Relation)'),
        ),
    ]
</file>

<file path="backend/dagu/migrations/0012_instrument_parent.py">
# Generated by Django 5.2.8 on 2026-01-21 04:55

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('dagu', '0011_brand_alter_instrument_brand_instrument_brand_obj'),
    ]

    operations = [
        migrations.AddField(
            model_name='instrument',
            name='parent',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='children', to='dagu.instrument', verbose_name='ìƒìœ„ ì•…ê¸° (ë¶€ëª¨)'),
        ),
    ]
</file>

<file path="backend/dagu/permissions.py">
"""
Custom permissions for MALCHA-DAGU.
"""

from rest_framework import permissions


class IsOwnerOrReadOnly(permissions.BasePermission):
    """
    ê°ì²´ì˜ ì†Œìœ ìë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥.
    ì½ê¸°(GET, HEAD, OPTIONS)ëŠ” ëª¨ë‘ í—ˆìš©.
    
    IDOR(Insecure Direct Object Reference) ê³µê²© ë°©ì§€.
    """
    
    def has_object_permission(self, request, view, obj):
        # ì½ê¸° ê¶Œí•œì€ ëª¨ë‘ í—ˆìš© (GET, HEAD, OPTIONS)
        if request.method in permissions.SAFE_METHODS:
            return True
        
        # ì“°ê¸° ê¶Œí•œì€ owner_idê°€ í˜„ì¬ ìœ ì €ì™€ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ë§Œ í—ˆìš©
        # owner_idê°€ Noneì´ë©´ (ìµëª… ë“±ë¡) ê±°ë¶€
        if not hasattr(obj, 'owner_id') or obj.owner_id is None:
            return False
            
        return obj.owner_id == request.user.id
</file>

<file path="backend/dagu/services/__init__.py">
"""
Services package for MALCHA-DAGU.

This package contains the core business logic split into focused modules:
- naver: Naver Shopping API integration
- search: Search aggregation service
- ai: AI description generation
- utils: Search utility functions
"""

from .naver import NaverShoppingService
from .search import SearchAggregatorService
# from .ai import AIDescriptionService  # ì„ì‹œ ë¹„í™œì„±í™”
from .utils import (
    normalize_search_term,
    expand_query_with_aliases,
    tokenize_query,
    calculate_instrument_match_score,
    find_best_matching_instruments,
)

__all__ = [
    # Services
    'NaverShoppingService',
    'SearchAggregatorService',
    # 'AIDescriptionService',  # ì„ì‹œ ë¹„í™œì„±í™”
    # Utilities
    'normalize_search_term',
    'expand_query_with_aliases',
    'tokenize_query',
    'calculate_instrument_match_score',
    'find_best_matching_instruments',
]
</file>

<file path="backend/dagu/services/ai.py">
"""
AI Description Service for MALCHA-DAGU.

Generates instrument descriptions using OpenAI API with
prompt engineering to prevent hallucinations.
"""

import logging

import requests
from django.conf import settings

logger = logging.getLogger(__name__)


class AIDescriptionService:
    """
    AI ì•…ê¸° ì„¤ëª… ìƒì„± ì„œë¹„ìŠ¤.
    í• ë£¨ì‹œë„¤ì´ì…˜ ë°©ì§€ë¥¼ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ ì ìš©.
    """

    def __init__(self):
        self.api_key = settings.OPENAI_API_KEY
        self.api_url = 'https://api.openai.com/v1/chat/completions'

    def generate_description(
        self,
        model_name: str,
        brand: str,
        category: str
    ) -> dict[str, str]:
        """
        ì•…ê¸° ì„¤ëª… ìƒì„± (í• ë£¨ì‹œë„¤ì´ì…˜ ë°©ì§€ ì ìš©).

        Returns:
            {'summary': str, 'check_point': str}
        """
        if not self.api_key:
            logger.warning("OpenAI API key not configured")
            return {
                'summary': f'{brand} {model_name} - ë¯¿ì„ ìˆ˜ ìˆëŠ” ì„ íƒ',
                'check_point': '',
            }

        # í• ë£¨ì‹œë„¤ì´ì…˜ ë°©ì§€ í”„ë¡¬í”„íŠ¸
        system_prompt = """ë„ˆëŠ” ì•…ê¸° ì „ë¬¸ê°€ì´ì íŒ©íŠ¸ ì²´í¬ì— ì—„ê²©í•œ ì—ë””í„°ë‹¤.
ì‚¬ìš©ìê°€ ìš”ì²­í•œ ì•…ê¸°ì— ëŒ€í•œ 'í•œ ì¤„ í‰'ê³¼ 'êµ¬ë§¤ ê°€ì´ë“œ'ë¥¼ ì‘ì„±í•˜ë¼.

# Rules (Strict)
1. **No Hallucination:** Input Dataì™€ ë„ˆì˜ ì§€ì‹ ë² ì´ìŠ¤ê°€ 100% ì¼ì¹˜í•˜ëŠ” íŒ©íŠ¸ë§Œ ì„œìˆ í•˜ë¼.
   ì¶œì‹œ ì—°ë„ë‚˜ ì„¸ë¶€ ìŠ¤í™ì´ í™•ì‹¤í•˜ì§€ ì•Šìœ¼ë©´ ì ˆëŒ€ ì–¸ê¸‰í•˜ì§€ ë§ê³  í†¤/ìŒìƒ‰ íŠ¹ì§• ìœ„ì£¼ë¡œ ì„œìˆ í•˜ë¼.
2. **Tone:** "ì´ ì•…ê¸°ëŠ”~" ì²˜ëŸ¼ ì§€ë£¨í•˜ê²Œ ì‹œì‘í•˜ì§€ ë§ˆë¼.
   "ë”°ëœ»í•œ ë°°ìŒì´ ë§¤ë ¥ì ì…ë‹ˆë‹¤", "ì…ë¬¸ìš©ìœ¼ë¡œ ìµœê³ ì˜ ì„ íƒì…ë‹ˆë‹¤" ê°™ì´ í•µì‹¬ë¶€í„° ì°Œë¥´ëŠ” ê°„ê²°í•œ ë¬¸ì²´ë¥¼ ì¨ë¼.
3. **Structure:**
   - [summary]: 20ì ì´ë‚´ ì„íŒ©íŠ¸ ìˆëŠ” ë¬¸êµ¬.
   - [check_point]: ì¤‘ê³  ê±°ë˜ ì‹œ ë°˜ë“œì‹œ í™•ì¸í•´ì•¼ í•  ê³ ì§ˆë³‘(ë…¸ë¸Œ ì¡ìŒ, ë„¥ íœ¨ ë“±) 1ê°€ì§€. ëª¨ë¥´ë©´ ë¹ˆ ë¬¸ìì—´.

JSON í˜•ì‹ìœ¼ë¡œ { "summary": "...", "check_point": "..." } ë§Œ ì¶œë ¥í•˜ë¼."""

        user_prompt = f"""# Input Data
- ëª¨ë¸ëª…: {model_name}
- ë¸Œëœë“œ: {brand}
- ì¹´í…Œê³ ë¦¬: {category}"""

        try:
            import json
            response = requests.post(
                self.api_url,
                headers={
                    'Authorization': f'Bearer {self.api_key}',
                    'Content-Type': 'application/json',
                },
                json={
                    'model': 'gpt-4o-mini',
                    'messages': [
                        {'role': 'system', 'content': system_prompt},
                        {'role': 'user', 'content': user_prompt},
                    ],
                    'temperature': 0.2,  # ì°½ì˜ì„± ë‚®ì¶¤ (íŒ©íŠ¸ ìœ„ì£¼)
                    'max_tokens': 200,
                },
                timeout=10,
            )
            response.raise_for_status()

            data = response.json()
            content = data['choices'][0]['message']['content']

            # JSON íŒŒì‹±
            result = json.loads(content)
            return {
                'summary': result.get('summary', ''),
                'check_point': result.get('check_point', ''),
            }

        except Exception as e:
            logger.exception(f"AI description generation error: {e}")
            return {
                'summary': f'{brand} {model_name}',
                'check_point': '',
            }
</file>

<file path="backend/dagu/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/data/inst.csv">
brand,name,category,reference_price,image_url,description
fender,guitar,guitar,2200000,,íœë” ì¼ë ‰ ê¸°íƒ€
fender,stratocaster,guitar,2400000,,íœë” ìŠ¤íŠ¸ë¼í† ìºìŠ¤í„°
fender,telecaster,guitar,2300000,,íœë” í…”ë ˆìºìŠ¤í„°
fender,jazzmaster,guitar,2500000,,íœë” ì¬ì¦ˆë§ˆìŠ¤í„°
fender,jaguar,guitar,2500000,,íœë” ì¬ê·œì–´
fender,bass,bass,2400000,,íœë” ë² ì´ìŠ¤ ê¸°íƒ€
fender,jazz bass,bass,2500000,,íœë” ì¬ì¦ˆ ë² ì´ìŠ¤
fender,precision bass,bass,2400000,,íœë” í”„ë ˆì‹œì „ ë² ì´ìŠ¤
fender,amp,amp,1500000,,íœë” ê¸°íƒ€ ì•°í”„
gibson,guitar,guitar,3800000,,ê¹ìŠ¨ ì¼ë ‰ ê¸°íƒ€
gibson,les paul,guitar,3800000,,ê¹ìŠ¨ ë ˆìŠ¤í´
gibson,sg,guitar,2400000,,ê¹ìŠ¨ SG
gibson,es-335,guitar,5500000,,ê¹ìŠ¨ ì„¸ë¯¸í• ë¡œìš° ê¸°íƒ€
gibson,explorer,guitar,2800000,,ê¹ìŠ¨ ìµìŠ¤í”Œë¡œëŸ¬
gibson,flying v,guitar,2800000,,ê¹ìŠ¨ í”Œë¼ì‰ V
gibson,acoustic,acoustic,3500000,,ê¹ìŠ¨ ì–´ì¿ ìŠ¤í‹± ê¸°íƒ€
prs,guitar,guitar,3500000,,PRS ì¼ë ‰ ê¸°íƒ€
prs,custom 24,guitar,5500000,,PRS ì»¤ìŠ¤í…€ 24
prs,silver sky,guitar,3200000,,PRS ì‹¤ë²„ìŠ¤ì¹´ì´
ibanez,guitar,guitar,1500000,,ì•„ì´ë°”ë„¤ì¦ˆ ì¼ë ‰ ê¸°íƒ€
ibanez,rg,guitar,1300000,,ì•„ì´ë°”ë„¤ì¦ˆ RG ì‹œë¦¬ì¦ˆ
ibanez,az,guitar,2600000,,ì•„ì´ë°”ë„¤ì¦ˆ AZ ì‹œë¦¬ì¦ˆ
ibanez,bass,bass,1100000,,ì•„ì´ë°”ë„¤ì¦ˆ ë² ì´ìŠ¤ ê¸°íƒ€
cort,guitar,guitar,600000,,ì½œíŠ¸ ì¼ë ‰ ê¸°íƒ€
cort,bass,bass,700000,,ì½œíŠ¸ ë² ì´ìŠ¤ ê¸°íƒ€
cort,acoustic,acoustic,400000,,ì½œíŠ¸ ì–´ì¿ ìŠ¤í‹± ê¸°íƒ€
yamaha,guitar,guitar,900000,,ì•¼ë§ˆí•˜ ì¼ë ‰ ê¸°íƒ€
yamaha,bass,bass,850000,,ì•¼ë§ˆí•˜ ë² ì´ìŠ¤ ê¸°íƒ€
yamaha,acoustic,acoustic,700000,,ì•¼ë§ˆí•˜ ì–´ì¿ ìŠ¤í‹± ê¸°íƒ€
yamaha,amp,amp,450000,,ì•¼ë§ˆí•˜ ê¸°íƒ€ ì•°í”„
epiphone,guitar,guitar,850000,,ì—í”¼í° ì¼ë ‰ ê¸°íƒ€
epiphone,les paul,guitar,900000,,ì—í”¼í° ë ˆìŠ¤í´
squier,guitar,guitar,600000,,ìŠ¤ì½°ì´ì–´ ì¼ë ‰ ê¸°íƒ€
squier,stratocaster,guitar,600000,,ìŠ¤ì½°ì´ì–´ ìŠ¤íŠ¸ë¼í† ìºìŠ¤í„°
suhr,guitar,guitar,4800000,,ì¨ ì¼ë ‰ ê¸°íƒ€
suhr,classic s,guitar,4800000,,ì¨ í´ë˜ì‹ S
musicman,guitar,guitar,4500000,,ë®¤ì§ë§¨ ì¼ë ‰ ê¸°íƒ€
musicman,stingray,bass,3500000,,ë®¤ì§ë§¨ ìŠ¤íŒ…ë ˆì´ ë² ì´ìŠ¤
gretsch,guitar,guitar,2500000,,ê·¸ë ˆì¹˜ ì¼ë ‰ ê¸°íƒ€
martin,acoustic,acoustic,4500000,,ë§ˆí‹´ ì–´ì¿ ìŠ¤í‹± ê¸°íƒ€
taylor,acoustic,acoustic,4000000,,í…Œì¼ëŸ¬ ì–´ì¿ ìŠ¤í‹± ê¸°íƒ€
marshall,amp,amp,1500000,,ë§ˆìƒ¬ ê¸°íƒ€ ì•°í”„
vox,amp,amp,1200000,,ë³µìŠ¤ ê¸°íƒ€ ì•°í”„
orange,amp,amp,1100000,,ì˜¤ë Œì§€ ê¸°íƒ€ ì•°í”„
boss,effect,effect,200000,,ë³´ìŠ¤ ì´í™í„°
boss,distortion,effect,120000,,ë³´ìŠ¤ ë””ìŠ¤í† ì…˜
boss,overdrive,effect,150000,,ë³´ìŠ¤ ì˜¤ë²„ë“œë¼ì´ë¸Œ
boss,delay,effect,250000,,ë³´ìŠ¤ ë”œë ˆì´
boss,reverb,effect,280000,,ë³´ìŠ¤ ë¦¬ë²„ë¸Œ
strymon,effect,effect,600000,,ìŠ¤íŠ¸ë¼ì´ëª¬ ì´í™í„°
strymon,reverb,effect,680000,,ìŠ¤íŠ¸ë¼ì´ëª¬ ë¦¬ë²„ë¸Œ
strymon,delay,effect,650000,,ìŠ¤íŠ¸ë¼ì´ëª¬ ë”œë ˆì´
mxr,effect,effect,180000,,MXR ì´í™í„°
ehx,effect,effect,150000,,ì¼ë ‰íŠ¸ë¡œ í•˜ëª¨ë‹‰ìŠ¤ ì´í™í„°
line 6,effect,effect,1200000,,ë¼ì¸6 ì´í™í„°
line 6,helix,effect,2400000,,ë¼ì¸6 íë¦­ìŠ¤
shure,mic,mic,300000,,ìŠˆì–´ ë§ˆì´í¬
sennheiser,mic,mic,350000,,ì  í•˜ì´ì € ë§ˆì´í¬
</file>

<file path="backend/data/instruments_sample-copy.csv">
brand,name,category,reference_price,image_url,description
fender,american professional ii stratocaster hss,guitar,2500000,,íœë” ì•„ë©”ë¦¬ì¹¸ í”„ë¡œí˜ì…”ë„ II HSS
fender,american ultra telecaster,guitar,3200000,,íœë” ì•„ë©”ë¦¬ì¹¸ ìš¸íŠ¸ë¼ í…”ë ˆìºìŠ¤í„°
fender,vintera ii 50s noconcaster,guitar,1650000,,íœë” ë¹ˆí…Œë¼ II 50s ë…¸ìºìŠ¤í„°
fender,player plus stratocaster,guitar,1400000,,íœë” í”Œë ˆì´ì–´ í”ŒëŸ¬ìŠ¤ ìŠ¤íŠ¸ë¼í† ìºìŠ¤í„°
fender,gold foil jazzmaster,guitar,2100000,,íœë” ê³¨ë“œ í¬ì¼ ì¬ì¦ˆë§ˆìŠ¤í„°
gibson,les paul standard 50s p90,guitar,3600000,,ê¹ìŠ¨ ë ˆìŠ¤í´ ìŠ¤íƒ ë‹¤ë“œ 50s P90
gibson,les paul modern,guitar,3900000,,ê¹ìŠ¨ ë ˆìŠ¤í´ ëª¨ë˜
gibson,sg standard classic white,guitar,2400000,,ê¹ìŠ¨ SG ìŠ¤íƒ ë‹¤ë“œ í™”ì´íŠ¸
gibson,explorer antique natural,guitar,2800000,,ê¹ìŠ¨ ìµìŠ¤í”Œë¡œëŸ¬
gibson,flying v antique natural,guitar,2800000,,ê¹ìŠ¨ í”Œë¼ì‰ V
prs,ce 24 semi-hollow,guitar,3500000,,PRS CE 24 ì„¸ë¯¸í• ë¡œìš°
prs,s2 custom 24,guitar,2500000,,PRS S2 ì»¤ìŠ¤í…€ 24
prs,se dgt,guitar,1300000,,PRS SE ë°ì´ë¹„ë“œ ê·¸ë¦¬ì„¬ ì‹œê·¸ë‹ˆì²˜
prs,se swamp ash special,guitar,1200000,,PRS SE ìŠ¤ì›œí”„ ì• ì‰¬ ìŠ¤í˜ì…œ
ibanez,rg370ahmz,guitar,750000,,ì•„ì´ë°”ë„¤ì¦ˆ RG370 ì…ë¬¸ìš©
ibanez,s670qm,guitar,950000,,ì•„ì´ë°”ë„¤ì¦ˆ S ì‹œë¦¬ì¦ˆ
ibanez,q52,guitar,1400000,,ì•„ì´ë°”ë„¤ì¦ˆ Q ì‹œë¦¬ì¦ˆ í—¤ë“œë¦¬ìŠ¤
ibanez,js24p,guitar,2200000,,ì•„ì´ë°”ë„¤ì¦ˆ ì¡° ì‚¬íŠ¸ë¦¬ì•„ë‹ˆ í”„ë¦¬ë¯¸ì—„
schecter,reaper-6,guitar,1100000,,ì‰‘í„° ë¦¬í¼-6
schecter,sun valley super shredder,guitar,1300000,,ì‰‘í„° ì¬ ë°¸ë¦¬ ìŠˆí¼ ìŠˆë ˆë”
esp,e-ii m-ii nt,guitar,2900000,,ESP E-II M-II ìŠ¤ë£¨ë„¥
ltd,ec-256,guitar,650000,,LTD ì…ë¬¸ìš© ë ˆìŠ¤í´ íƒ€ì…
ltd,sn-1000,guitar,1500000,,LTD ìŠ¤ë‚´í¼ íƒ€ì…
charvel,pro-mod san dimas style 1,guitar,1400000,,ìƒ¤ë²¨ ì‚° ë””ë§ˆìŠ¤
charvel,pro-mod so-cal style 1,guitar,1400000,,ìƒ¤ë²¨ ì†Œì¹¼
jackson,pro series dinky dk2,guitar,1300000,,ì­ìŠ¨ í”„ë¡œ ì‹œë¦¬ì¦ˆ ë”©í‚¤
jackson,js series dinky js11,guitar,250000,,ì­ìŠ¨ ì…ë¬¸ìš© ë”©í‚¤
epiphone,sg muse,guitar,650000,,ì—í”¼í° SG ë®¤ì¦ˆ
epiphone,les paul prophecy,guitar,1200000,,ì—í”¼í° ë ˆìŠ¤í´ í”„ë¡œí˜ì‹œ
gretsch,g2622 streamliner,guitar,650000,,ê·¸ë ˆì¹˜ ìŠ¤íŠ¸ë¦¼ë¼ì´ë„ˆ ì„¼í„°ë¸”ë¡
gretsch,g5422tg,guitar,1400000,,ê·¸ë ˆì¹˜ ì¼ë ‰íŠ¸ë¡œë§¤í‹± í• ë¡œìš°ë°”ë””
musicman,st. vincent,guitar,4500000,,ë®¤ì§ë§¨ ì„¸ì¸íŠ¸ ë¹ˆì„¼íŠ¸
sterling,ct50hss,guitar,850000,,ìŠ¤í„¸ë§ ì»¤í‹€ë¼ìŠ¤ HSS
fender,american ultra jazz bass,bass,3500000,,íœë” ì•„ë©”ë¦¬ì¹¸ ìš¸íŠ¸ë¼ ì¬ì¦ˆë² ì´ìŠ¤
fender,american vintage ii 1966 jazz bass,bass,3300000,,íœë” ì•„ë©”ë¦¬ì¹¸ ë¹ˆí‹°ì§€ II 1966 ì¬ì¦ˆë² ì´ìŠ¤
fender,player plus precision bass,bass,1600000,,íœë” í”Œë ˆì´ì–´ í”ŒëŸ¬ìŠ¤ í”„ë ˆì‹œì „ ë² ì´ìŠ¤
sire,v10 dx,bass,1800000,,ì‚¬ì´ì–´ V10 ìµœê³ ê¸‰í˜•
sire,m5,bass,850000,,ì‚¬ì´ì–´ M5 í—˜ë²„ì»¤ ë² ì´ìŠ¤
sire,u5,bass,650000,,ì‚¬ì´ì–´ U5 ìˆìŠ¤ì¼€ì¼ ë² ì´ìŠ¤
ibanez,sr300e,bass,550000,,ì•„ì´ë°”ë„¤ì¦ˆ ì…ë¬¸ìš© SR ë² ì´ìŠ¤
ibanez,btb845,bass,1500000,,ì•„ì´ë°”ë„¤ì¦ˆ BTB 5í˜„ ë² ì´ìŠ¤
warwick,rockbass streamer lx,bass,1100000,,ì›Œìœ… ë½ë² ì´ìŠ¤ ìŠ¤íŠ¸ë¦¬ë¨¸
spector,ns ethic 4,bass,1600000,,ìŠ¤í™í„° NS ì—í‹±
sandberg,california tt,bass,2800000,,ìƒŒë“œë²„ê·¸ ìº˜ë¦¬í¬ë‹ˆì•„ ì¬ì¦ˆë² ì´ìŠ¤ íƒ€ì…
dingwall,d-roc standard,bass,2600000,,ë”©ì›” D-ROC ë©€í‹°ìŠ¤ì¼€ì¼
lakland,skyline 44-64,bass,1800000,,ë½ëœë“œ ìŠ¤ì¹´ì´ë¼ì¸ í”„ë ˆì‹œì „ íƒ€ì…
bacchus,universe series bjb-1r,bass,350000,,ë°”ì»¤ìŠ¤ ì…ë¬¸ìš© ì¬ì¦ˆë² ì´ìŠ¤
cort,a4 plus fmmh,bass,900000,,ì½œíŠ¸ ì•„í‹°ì‚° ì‹œë¦¬ì¦ˆ
</file>

<file path="backend/data/instruments_sample-copy2.csv">
brand,name,category,reference_price,image_url,description
boss,rv-6,effect,240000,,BOSS ë¦¬ë²„ë¸Œì˜ í‘œì¤€
boss,dd-3t,effect,200000,,BOSS ë””ì§€í„¸ ë”œë ˆì´ í´ë˜ì‹
boss,sd-1,effect,80000,,BOSS ìŠˆí¼ ì˜¤ë²„ë“œë¼ì´ë¸Œ
boss,ns-2,effect,150000,,BOSS ë…¸ì´ì¦ˆ ì„œí”„ë ˆì„œ
boss,tu-3,effect,140000,,BOSS í¬ë¡œë§¤í‹± íŠœë„ˆ
mxr,m102 dyna comp,effect,130000,,MXR ë‹¤ì´ë‚˜ ì»´í”„ ì»´í”„ë ˆì„œ
mxr,m108s 10 band eq,effect,220000,,MXR 10ë°´ë“œ ê·¸ë˜í”½ ì´í€„ë¼ì´ì €
mxr,m169 carbon copy,effect,220000,,MXR ì¹´ë³¸ ì¹´í”¼ ì•„ë‚ ë¡œê·¸ ë”œë ˆì´
electro-harmonix,canyon,effect,250000,,EHX ìºë…„ ë”œë ˆì´ ë¦¬ë²„ë¸Œ
electro-harmonix,soul food,effect,150000,,EHX ì†Œìš¸ í‘¸ë“œ (í´ë¡  íƒ€ì…)
electro-harmonix,oceans 11,effect,260000,,EHX ì˜¤ì…˜ìŠ¤ 11 ë¦¬ë²„ë¸Œ
tc electronic,spark booster,effect,100000,,TC ìŠ¤íŒŒí¬ ë¶€ìŠ¤í„°
tc electronic,mojomojo,effect,80000,,TC ëª¨ì¡°ëª¨ì¡° ì˜¤ë²„ë“œë¼ì´ë¸Œ
wampler,tumnus,effect,250000,,ì™í”ŒëŸ¬ í…€ë„ˆìŠ¤ (ë¯¸ë‹ˆ í´ë¡ )
wampler,pinnacle deluxe v2,effect,350000,,ì™í”ŒëŸ¬ í”¼ë‚˜í´ (ë¸Œë¼ìš´ ì‚¬ìš´ë“œ)
jhs,3 series reverb,effect,150000,,JHS 3 ì‹œë¦¬ì¦ˆ ë¦¬ë²„ë¸Œ
jhs,the kilt v2,effect,320000,,JHS ë” í‚¬íŠ¸ (ë“œë¼ì´ë¸Œ/ë¶€ìŠ¤íŠ¸)
walrus audio,eras,effect,320000,,ì›”ëŸ¬ìŠ¤ ì˜¤ë””ì˜¤ ì—ë¼ìŠ¤ ë””ìŠ¤í† ì…˜
walrus audio,eb-10,effect,350000,,ì›”ëŸ¬ìŠ¤ ì˜¤ë””ì˜¤ í”„ë¦¬ì•°í”„ EQ
strymon,nightsky,effect,750000,,ìŠ¤íŠ¸ë¼ì´ëª¬ ë‚˜ì´íŠ¸ìŠ¤ì¹´ì´ íƒ€ì„ ì›Œí”„ ë¦¬ë²„ë¸Œ
strymon,volante,effect,650000,,ìŠ¤íŠ¸ë¼ì´ëª¬ ë³¼ë€í…Œ ë§ˆê·¸ë„¤í‹± ì—ì½”
universal audio,starlight,effect,550000,,UAFX ìŠ¤íƒ€ë¼ì´íŠ¸ ì—ì½” ìŠ¤í…Œì´ì…˜
universal audio,astra,effect,550000,,UAFX ì•„ìŠ¤íŠ¸ë¼ ëª¨ë“ˆë ˆì´ì…˜
xotic,xw-1 wah,effect,420000,,ì—‘ì¡°í‹± XW-1 í•˜ì´ì—”ë“œ ì™€ìš°
dunlop,tm95 tak matsumoto wah,effect,350000,,ë˜ë¡­ íƒ ë§ˆì¸ ëª¨í†  ì‹œê·¸ë‹ˆì²˜ ì™€ìš°
keeley,d&m drive,effect,350000,,í‚¬ë¦¬ D&M ë“œë¼ì´ë¸Œ (ëŒ€ë‹ˆ&ë¯¹)
darkglass,microtubes b7k v2,effect,450000,,ë‹¤í¬ê¸€ë˜ìŠ¤ B7K ë² ì´ìŠ¤ í”„ë¦¬ì•°í”„
darkglass,exponent 500,amp,1200000,,ë‹¤í¬ê¸€ë˜ìŠ¤ ì—‘ìŠ¤í¬ë„ŒíŠ¸ ì•°í”„ í—¤ë“œ
fender,rumble 40 v3,amp,350000,,íœë” ëŸ¼ë¸” ë² ì´ìŠ¤ ì•°í”„
fender,tone master deluxe reverb,amp,1600000,,íœë” í†¤ ë§ˆìŠ¤í„° ë””ì§€í„¸ ì•°í”„
marshall,origin 50c,amp,1100000,,ë§ˆìƒ¬ ì˜¤ë¦¬ì§„ 50W ì½¤ë³´
marshall,code 50,amp,450000,,ë§ˆìƒ¬ ì½”ë“œ ë””ì§€í„¸ ëª¨ë¸ë§ ì•°í”„
vox,vt20x,amp,250000,,ë³µìŠ¤ ë°œë² íŠ¸ë¡œë‹‰ìŠ¤ í•˜ì´ë¸Œë¦¬ë“œ ì•°í”„
orange,super crush 100,amp,850000,,ì˜¤ë Œì§€ ìŠˆí¼ í¬ëŸ¬ì‰¬ ì†”ë¦¬ë“œ ìŠ¤í…Œì´íŠ¸
orange,micro dark,amp,280000,,ì˜¤ë Œì§€ ë§ˆì´í¬ë¡œ ë‹¤í¬ í•˜ì´ë¸Œë¦¬ë“œ í—¤ë“œ
blackstar,silverline special,amp,750000,,ë¸”ë™ìŠ¤íƒ€ ì‹¤ë²„ë¼ì¸ ì½¤ë³´
positive grid,spark go,amp,220000,,í¬ì§€í‹°ë¸Œ ê·¸ë¦¬ë“œ ìŠ¤íŒŒí¬ ê³  (ì´ˆì†Œí˜•)
line 6,catalyst 60,amp,450000,,ë¼ì¸6 ì¹´íƒˆë¦¬ìŠ¤íŠ¸ ëª¨ë¸ë§ ì•°í”„
yamaha,thr5,amp,280000,,ì•¼ë§ˆí•˜ THR5 ë°ìŠ¤í¬íƒ‘ ì•°í”„
boss,katana-air,amp,650000,,BOSS ì¹´íƒ€ë‚˜ ì—ì–´ ë¬´ì„  ì•°í”„
</file>

<file path="backend/data/instruments_sample.csv">
brand,name,category,reference_price,image_url,description
fender,american professional ii stratocaster,guitar,2400000,,íœë” ì•„ë©”ë¦¬ì¹¸ í”„ë¡œí˜ì…”ë„ II ìŠ¤íŠ¸ë¼í† ìºìŠ¤í„°
fender,american professional ii telecaster,guitar,2400000,,íœë” ì•„ë©”ë¦¬ì¹¸ í”„ë¡œí˜ì…”ë„ II í…”ë ˆìºìŠ¤í„°
fender,american ultra stratocaster,guitar,3200000,,íœë” ì•„ë©”ë¦¬ì¹¸ ìš¸íŠ¸ë¼ ìŠ¤íŠ¸ë¼í† ìºìŠ¤í„°
fender,american vintage ii 1961 stratocaster,guitar,3300000,,íœë” ì•„ë©”ë¦¬ì¹¸ ë¹ˆí‹°ì§€ II 1961 ìŠ¤íŠ¸ë¼í† ìºìŠ¤í„°
fender,player stratocaster,guitar,1100000,,íœë” í”Œë ˆì´ì–´ ìŠ¤íŠ¸ë¼í† ìºìŠ¤í„°
fender,player telecaster,guitar,1100000,,íœë” í”Œë ˆì´ì–´ í…”ë ˆìºìŠ¤í„°
fender,vintera ii 60s stratocaster,guitar,1600000,,íœë” ë¹ˆí…Œë¼ II 60s ìŠ¤íŠ¸ë¼í† ìºìŠ¤í„°
fender,american performer stratocaster,guitar,1800000,,íœë” ì•„ë©”ë¦¬ì¹¸ í¼í¬ë¨¸ ìŠ¤íŠ¸ë¼í† ìºìŠ¤í„°
fender,custom shop 1960 stratocaster relic,guitar,6500000,,íœë” ì»¤ìŠ¤í…€ìƒµ 1960 ìŠ¤íŠ¸ë¼í† ìºìŠ¤í„° ë ë¦­
gibson,les paul standard 50s,guitar,3600000,,ê¹ìŠ¨ ë ˆìŠ¤í´ ìŠ¤íƒ ë‹¤ë“œ 50s
gibson,les paul standard 60s,guitar,3600000,,ê¹ìŠ¨ ë ˆìŠ¤í´ ìŠ¤íƒ ë‹¤ë“œ 60s
gibson,les paul classic,guitar,2800000,,ê¹ìŠ¨ ë ˆìŠ¤í´ í´ë˜ì‹
gibson,les paul studio,guitar,2200000,,ê¹ìŠ¨ ë ˆìŠ¤í´ ìŠ¤íŠœë””ì˜¤
gibson,sg standard 61,guitar,2600000,,ê¹ìŠ¨ SG ìŠ¤íƒ ë‹¤ë“œ 61
gibson,es-335 figured,guitar,5500000,,ê¹ìŠ¨ ES-335 í”¼ê²¨ë“œ
gibson,custom shop 1959 les paul standard,guitar,9000000,,ê¹ìŠ¨ ì»¤ìŠ¤í…€ìƒµ 1959 ë ˆìŠ¤í´ ìŠ¤íƒ ë‹¤ë“œ (R9)
prs,core custom 24,guitar,5500000,,PRS ì½”ì–´ ì»¤ìŠ¤í…€ 24
prs,ce 24,guitar,3200000,,PRS CE 24
prs,s2 mccarty 594,guitar,2600000,,PRS S2 ë§¤ì¹´í‹° 594
prs,silver sky se,guitar,1100000,,PRS ì‹¤ë²„ìŠ¤ì¹´ì´ SE
prs,se custom 24,guitar,1150000,,PRS SE ì»¤ìŠ¤í…€ 24
prs,se standard 24,guitar,850000,,PRS SE ìŠ¤íƒ ë‹¤ë“œ 24
ibanez,az2204,guitar,2600000,,ì•„ì´ë°”ë„¤ì¦ˆ AZ2204 í”„ë ˆìŠ¤í‹°ì§€
ibanez,az2402,guitar,2600000,,ì•„ì´ë°”ë„¤ì¦ˆ AZ2402 í”„ë ˆìŠ¤í‹°ì§€
ibanez,rg550,guitar,1400000,,ì•„ì´ë°”ë„¤ì¦ˆ RG550 ì œë„¤ì‹œìŠ¤
ibanez,jem7vp,guitar,2300000,,ì•„ì´ë°”ë„¤ì¦ˆ JEM7VP ìŠ¤í‹°ë¸Œë°”ì´
ibanez,pia3761,guitar,4500000,,ì•„ì´ë°”ë„¤ì¦ˆ PIA3761
suhr,classic s antique,guitar,4800000,,ì¨ í´ë˜ì‹ S ì•¤í‹°í¬
suhr,modern plus,guitar,4500000,,ì¨ ëª¨ë˜ í”ŒëŸ¬ìŠ¤
tom anderson,drop top classic,guitar,5500000,,íƒì•¤ë”ìŠ¨ ë“œë¡­íƒ‘ í´ë˜ì‹
james tyler,studio elite hd,guitar,6500000,,ì œì„ìŠ¤íƒ€ì¼ëŸ¬ ìŠ¤íŠœë””ì˜¤ ì—˜ë¦¬íŠ¸ HD
musicman,majesty,guitar,4800000,,ë®¤ì§ë§¨ ë§ˆì œìŠ¤í‹° (ì¡´ í˜íŠ¸ë£¨ì¹˜)
epiphone,les paul custom,guitar,950000,,ì—í”¼í° ë ˆìŠ¤í´ ì»¤ìŠ¤í…€
epiphone,casino,guitar,850000,,ì—í”¼í° ì¹´ì§€ë…¸
squier,classic vibe 50s stratocaster,guitar,650000,,ìŠ¤ì½°ì´ì–´ í´ë˜ì‹ë°”ì´ë¸Œ 50s ìŠ¤íŠ¸ë¼í† ìºìŠ¤í„°
squier,classic vibe 60s jazz bass,bass,700000,,ìŠ¤ì½°ì´ì–´ í´ë˜ì‹ë°”ì´ë¸Œ 60s ì¬ì¦ˆë² ì´ìŠ¤
squier,affinity stratocaster,guitar,400000,,ìŠ¤ì½°ì´ì–´ ì–´í”¼ë‹ˆí‹° ìŠ¤íŠ¸ë¼í† ìºìŠ¤í„°
yamaha,pacifica 612vii,guitar,900000,,ì•¼ë§ˆí•˜ í¼ì‹œí”¼ì¹´ 612
yamaha,pacifica professional,guitar,2500000,,ì•¼ë§ˆí•˜ í¼ì‹œí”¼ì¹´ í”„ë¡œí˜ì…”ë„
cort,g290 fat,guitar,600000,,ì½œíŠ¸ G290 FAT
cort,g300 pro,guitar,850000,,ì½œíŠ¸ G300 Pro
swing,s-100 plus,guitar,350000,,ìŠ¤ìœ™ S-100 Plus
swing,g1,guitar,250000,,ìŠ¤ìœ™ G1
gopherwood,g100,acoustic,200000,,ê³ í¼ìš°ë“œ G100
gopherwood,k330,acoustic,450000,,ê³ í¼ìš°ë“œ K330
crafter,kgae-27,acoustic,750000,,í¬ë˜í”„í„° KGAE-27 í”„ë ˆìŠ¤í‹°ì§€
crafter,godinus,acoustic,850000,,í¬ë˜í”„í„° ê°“ì¸ì–´ìŠ¤
martin,d-28 standard,acoustic,4300000,,ë§ˆí‹´ D-28 ìŠ¤íƒ ë‹¤ë“œ
martin,om-28 standard,acoustic,4300000,,ë§ˆí‹´ OM-28 ìŠ¤íƒ ë‹¤ë“œ
martin,d-18 standard,acoustic,3800000,,ë§ˆí‹´ D-18 ìŠ¤íƒ ë‹¤ë“œ
martin,000-15m,acoustic,2300000,,ë§ˆí‹´ 000-15M
martin,lx1,acoustic,650000,,ë§ˆí‹´ ë¦¬í‹€ë§ˆí‹´ LX1
taylor,314ce v-class,acoustic,3200000,,í…Œì¼ëŸ¬ 314ce V-Class
taylor,814ce v-class,acoustic,5500000,,í…Œì¼ëŸ¬ 814ce V-Class
taylor,gs mini-e koa,acoustic,1300000,,í…Œì¼ëŸ¬ GS Mini-e ì½”ì•„
taylor,114ce,acoustic,1400000,,í…Œì¼ëŸ¬ 114ce
yamaha,ll16 are,acoustic,1100000,,ì•¼ë§ˆí•˜ LL16 ARE
yamaha,fg830,acoustic,500000,,ì•¼ë§ˆí•˜ FG830
fender,american professional ii jazz bass,bass,2500000,,íœë” ì•„ë©”ë¦¬ì¹¸ í”„ë¡œí˜ì…”ë„ II ì¬ì¦ˆë² ì´ìŠ¤
fender,american professional ii precision bass,bass,2500000,,íœë” ì•„ë©”ë¦¬ì¹¸ í”„ë¡œí˜ì…”ë„ II í”„ë ˆì‹œì „ ë² ì´ìŠ¤
fender,player jazz bass,bass,1200000,,íœë” í”Œë ˆì´ì–´ ì¬ì¦ˆë² ì´ìŠ¤
sire,v7 vintage 2nd gen,bass,750000,,ì‚¬ì´ì–´ V7 ë¹ˆí‹°ì§€ 2ì„¸ëŒ€
sire,v5,bass,600000,,ì‚¬ì´ì–´ V5
sire,p5,bass,600000,,ì‚¬ì´ì–´ P5
musicman,stingray special,bass,3500000,,ë®¤ì§ë§¨ ìŠ¤íŒ…ë ˆì´ ìŠ¤í˜ì…œ 4í˜„
yamaha,trbx304,bass,450000,,ì•¼ë§ˆí•˜ TRBX304
yamaha,bb434,bass,700000,,ì•¼ë§ˆí•˜ BB434
boss,ds-1w,effect,200000,,BOSS DS-1w ì™€ì í¬ë˜í”„íŠ¸
boss,sd-1w,effect,200000,,BOSS SD-1w ì™€ì í¬ë˜í”„íŠ¸
boss,bd-2w,effect,220000,,BOSS BD-2w ì™€ì í¬ë˜í”„íŠ¸
boss,ce-2w,effect,280000,,BOSS CE-2w ì½”ëŸ¬ìŠ¤ ì™€ì í¬ë˜í”„íŠ¸
boss,dm-2w,effect,240000,,BOSS DM-2w ë”œë ˆì´
boss,mt-2w,effect,220000,,BOSS MT-2w ë©”íƒˆì¡´
boss,gt-1000,effect,1400000,,BOSS GT-1000 ë©€í‹°ì´í™í„°
boss,gt-1000core,effect,900000,,BOSS GT-1000CORE
boss,gx-100,effect,800000,,BOSS GX-100
boss,me-90,effect,500000,,BOSS ME-90
strymon,bigsky,effect,680000,,ìŠ¤íŠ¸ë¼ì´ëª¬ ë¹…ìŠ¤ì¹´ì´
strymon,timeline,effect,680000,,ìŠ¤íŠ¸ë¼ì´ëª¬ íƒ€ì„ë¼ì¸
strymon,mobius,effect,680000,,ìŠ¤íŠ¸ë¼ì´ëª¬ ëª¨ë¹„ìš°ìŠ¤
strymon,cloudburst,effect,400000,,ìŠ¤íŠ¸ë¼ì´ëª¬ í´ë¼ìš°ë“œë²„ìŠ¤íŠ¸
strymon,bluesky v2,effect,550000,,ìŠ¤íŠ¸ë¼ì´ëª¬ ë¸”ë£¨ìŠ¤ì¹´ì´ V2
strymon,el capistan v2,effect,550000,,ìŠ¤íŠ¸ë¼ì´ëª¬ ì—˜ ì¹´í”¼ìŠ¤íƒ„ V2
strymon,deco v2,effect,550000,,ìŠ¤íŠ¸ë¼ì´ëª¬ ë°ì½” V2
strymon,iridium,effect,580000,,ìŠ¤íŠ¸ë¼ì´ëª¬ ì´ë¦¬ë“
universal audio,dream 65,effect,550000,,UAFX Dream 65 ë¦¬ë²„ë¸Œ ì•°í”„
universal audio,ruby 63,effect,550000,,UAFX Ruby 63 íƒ‘ ë¶€ìŠ¤íŠ¸
universal audio,lion 68,effect,550000,,UAFX Lion 68 ìŠˆí¼ ë¦¬ë“œ
chase bliss,mood mkii,effect,600000,,ì²´ì´ìŠ¤ ë¸”ë¦¬ìŠ¤ ë¬´ë“œ MKII
chase bliss,blooper,effect,700000,,ì²´ì´ìŠ¤ ë¸”ë¦¬ìŠ¤ ë¸”ë£¨í¼
vemuram,jan ray,effect,580000,,ë² ë¬´ëŒ ì”ë ˆì´
vemuram,myriad fuzz,effect,600000,,ë² ë¬´ëŒ ë¯¸ë¦¬ì•„ë“œ í¼ì¦ˆ
klon,centaur,effect,5000000,,í´ë¡  ì„¼íƒ€ìš°ë¥´ (ë¹ˆí‹°ì§€/ë ˆì–´)
analogman,king of tone,effect,1200000,,ì•„ë‚ ë¡œê·¸ë§¨ í‚¹ì˜¤ë¸Œí†¤ (ëŒ€ê¸° 5ë…„)
analogman,prince of tone,effect,400000,,ì•„ë‚ ë¡œê·¸ë§¨ í”„ë¦°ìŠ¤ì˜¤ë¸Œí†¤
xotic,ep booster,effect,160000,,ì—‘ì¡°í‹± EP ë¶€ìŠ¤í„°
xotic,sp compressor,effect,180000,,ì—‘ì¡°í‹± SP ì»´í”„ë ˆì„œ
xotic,bb preamp,effect,250000,,ì—‘ì¡°í‹± BB í”„ë¦¬ì•°í”„
paul cochrane,timmy v3,effect,250000,,í´ ì½”í¬ë€ íŒ€ë¯¸ V3
fulltone,ocd v2,effect,220000,,í’€í†¤ OCD V2
electro-harmonix,big muff pi,effect,140000,,ì¼ë ‰íŠ¸ë¡œ í•˜ëª¨ë‹‰ìŠ¤ ë¹…ë¨¸í”„ Pi
electro-harmonix,op-amp big muff,effect,150000,,EHX ì˜¤í”¼ì•°í”„ ë¹…ë¨¸í”„ (ìŠ¤ë§¤ì‹±íŒí‚¨ìŠ¤)
electro-harmonix,pog2,effect,550000,,EHX POG2 ì˜¥íƒ€ë²„
tc electronic,polytune 3,effect,140000,,TC ì¼ë ‰íŠ¸ë¡œë‹‰ í´ë¦¬íŠ  3
tc electronic,hall of fame 2,effect,200000,,TC ì¼ë ‰íŠ¸ë¡œë‹‰ í™€ì˜¤ë¸Œí˜ì„ 2
tc electronic,flashback 2,effect,220000,,TC ì¼ë ‰íŠ¸ë¡œë‹‰ í”Œë˜ì‹œë°± 2
tc electronic,ditto looper,effect,150000,,TC ì¼ë ‰íŠ¸ë¡œë‹‰ ë””í†  ë£¨í¼
line 6,helix floor,effect,2300000,,ë¼ì¸6 íë¦­ìŠ¤ í”Œë¡œì–´
line 6,helix lt,effect,1600000,,ë¼ì¸6 íë¦­ìŠ¤ LT
line 6,hx stomp,effect,950000,,ë¼ì¸6 HX ìŠ¤í†°í”„
line 6,hx stomp xl,effect,1100000,,ë¼ì¸6 HX ìŠ¤í†°í”„ XL
line 6,pod go,effect,700000,,ë¼ì¸6 POD Go
neural dsp,quad cortex,effect,2600000,,ë‰´ëŸ´ DSP ì¿¼ë“œ ì½”í…ìŠ¤
kemper,profiler stage,effect,2400000,,ì¼í¼ í”„ë¡œíŒŒì¼ëŸ¬ ìŠ¤í…Œì´ì§€
kemper,profiler head,effect,2600000,,ì¼í¼ í”„ë¡œíŒŒì¼ëŸ¬ í—¤ë“œ
fractal,fm3,effect,1800000,,í”„ë™íƒˆ ì˜¤ë””ì˜¤ FM3
fractal,fm9,effect,2800000,,í”„ë™íƒˆ ì˜¤ë””ì˜¤ FM9
fractal,axe-fx iii,effect,4000000,,í”„ë™íƒˆ Axe-Fx III
zoom,ms-50g,effect,130000,,ì¤Œ MS-50G ë©€í‹°ìŠ¤í†°í”„
zoom,g1four,effect,100000,,ì¤Œ G1 Four
nux,mg-30,effect,350000,,ëˆ…ìŠ¤ MG-30
nux,mighty plug pro,effect,150000,,ëˆ…ìŠ¤ ë§ˆì´í‹° í”ŒëŸ¬ê·¸ í”„ë¡œ
valeton,gp-200,effect,400000,,ë°œë ˆí†¤ GP-200
mooer,ge200,effect,300000,,ë¬´ì–´ GE200
marshall,dsl40cr,amp,1100000,,ë§ˆìƒ¬ DSL40CR ì½¤ë³´
marshall,sv20h,amp,1600000,,ë§ˆìƒ¬ ìŠ¤íŠœë””ì˜¤ ë¹ˆí‹°ì§€ SV20H (í”Œë ‰ì‹œ)
marshall,sc20h,amp,1600000,,ë§ˆìƒ¬ ìŠ¤íŠœë””ì˜¤ í´ë˜ì‹ SC20H (JCM800)
marshall,mg15gfx,amp,200000,,ë§ˆìƒ¬ MG15GFX
fender,65 twin reverb,amp,2600000,,íœë” 65 íŠ¸ìœˆ ë¦¬ë²„ë¸Œ ë¦¬ì´ìŠˆ
fender,65 deluxe reverb,amp,2200000,,íœë” 65 ë””ëŸ­ìŠ¤ ë¦¬ë²„ë¸Œ ë¦¬ì´ìŠˆ
fender,blues junior iv,amp,1100000,,íœë” ë¸”ë£¨ìŠ¤ ì£¼ë‹ˆì–´ IV
fender,mustang lt25,amp,250000,,íœë” ë¨¸ìŠ¤íƒ± LT25
vox,ac15c1,amp,1100000,,ë³µìŠ¤ AC15C1
vox,ac30c2,amp,1600000,,ë³µìŠ¤ AC30C2
vox,pathfinder 10,amp,100000,,ë³µìŠ¤ íŒ¨ìŠ¤íŒŒì¸ë” 10
orange,crush 20,amp,180000,,ì˜¤ë Œì§€ í¬ëŸ¬ì‰¬ 20
orange,terror stamp,amp,250000,,ì˜¤ë Œì§€ í…ŒëŸ¬ ìŠ¤íƒ¬í”„
yamaha,thr10ii,amp,450000,,ì•¼ë§ˆí•˜ THR10II
yamaha,thr30ii wireless,amp,750000,,ì•¼ë§ˆí•˜ THR30II Wireless
positive grid,spark 40,amp,400000,,í¬ì§€í‹°ë¸Œ ê·¸ë¦¬ë“œ ìŠ¤íŒŒí¬ 40
positive grid,spark mini,amp,330000,,í¬ì§€í‹°ë¸Œ ê·¸ë¦¬ë“œ ìŠ¤íŒŒí¬ ë¯¸ë‹ˆ
blackstar,fly 3,amp,100000,,ë¸”ë™ìŠ¤íƒ€ FLY 3 ë¯¸ë‹ˆ ì•°í”„
roland,jc-120,amp,1600000,,ë¡¤ëœë“œ JC-120 ì¬ì¦ˆ ì½”ëŸ¬ìŠ¤
boss,katana-50 mkii,amp,350000,,BOSS ì¹´íƒ€ë‚˜-50 MkII
boss,katana-100 mkii,amp,550000,,BOSS ì¹´íƒ€ë‚˜-100 MkII
mesa boogie,dual rectifier head,amp,3500000,,ë©”ì‚¬ë¶€ê¸° ë“€ì–¼ ë ‰í‹°íŒŒì´ì–´ í—¤ë“œ
mesa boogie,mark v 35,amp,3000000,,ë©”ì‚¬ë¶€ê¸° ë§ˆí¬ 5:35
brand,name,category,reference_price,image_url,description
walrus audio,julia v2,effect,280000,,ì›”ëŸ¬ìŠ¤ ì˜¤ë””ì˜¤ ì¤„ë¦¬ì•„ V2 ì½”ëŸ¬ìŠ¤
walrus audio,slÃ¶,effect,290000,,ì›”ëŸ¬ìŠ¤ ì˜¤ë””ì˜¤ ìŠ¬ë¡œ ë¦¬ë²„ë¸Œ
walrus audio,arp-87,effect,280000,,ì›”ëŸ¬ìŠ¤ ì˜¤ë””ì˜¤ ARP-87 ë”œë ˆì´
walrus audio,acs1,effect,560000,,ì›”ëŸ¬ìŠ¤ ì˜¤ë””ì˜¤ ACS1 ì•°í”„ ì‹œë®¬ë ˆì´í„°
earthquaker devices,plumes,effect,160000,,EQD í”Œë£¸ìŠ¤ ì˜¤ë²„ë“œë¼ì´ë¸Œ
earthquaker devices,dispatch master v3,effect,290000,,EQD ë””ìŠ¤íŒ¨ì¹˜ ë§ˆìŠ¤í„° ë”œë ˆì´ ë¦¬ë²„ë¸Œ
earthquaker devices,afterneath v3,effect,320000,,EQD ì• í”„í„°ë‹ˆìŠ¤ V3 ë¦¬ë²„ë¸Œ
earthquaker devices,hizumitas,effect,240000,,EQD íˆì¦ˆë¯¸íƒ€ìŠ¤ í¼ì¦ˆ
jhs,morning glory v4,effect,290000,,JHS ëª¨ë‹ ê¸€ë¡œë¦¬ V4
jhs,bonsai,effect,350000,,JHS ë³¸ì‚¬ì´ (9ê°€ì§€ íŠœë¸ŒìŠ¤í¬ë¦¬ë¨¸)
jhs,packrat,effect,350000,,JHS íŒ©ë« (9ê°€ì§€ RAT)
jhs,muffuletta,effect,350000,,JHS ë¨¸í’€ë ˆíƒ€ (6ê°€ì§€ ë¹…ë¨¸í”„)
jhs,angry charlie v3,effect,290000,,JHS ì•µê·¸ë¦¬ ì°°ë¦¬ V3
keeley,compressor plus,effect,220000,,í‚¬ë¦¬ ì»´í”„ë ˆì„œ í”ŒëŸ¬ìŠ¤
keeley,caverns v2,effect,280000,,í‚¬ë¦¬ ì¹´ë²ˆìŠ¤ ë”œë ˆì´ ë¦¬ë²„ë¸Œ
keeley,halo,effect,450000,,í‚¬ë¦¬ í—¤ì¼ë¡œ ì•¤ë”” í‹°ëª¬ìŠ¤ ë”œë ˆì´
source audio,collider,effect,520000,,ì†ŒìŠ¤ ì˜¤ë””ì˜¤ ì½œë¼ì´ë” ë”œë ˆì´ ë¦¬ë²„ë¸Œ
source audio,ventris,effect,620000,,ì†ŒìŠ¤ ì˜¤ë””ì˜¤ ë²¤íŠ¸ë¦¬ìŠ¤ ë“€ì–¼ ë¦¬ë²„ë¸Œ
source audio,nemesis,effect,450000,,ì†ŒìŠ¤ ì˜¤ë””ì˜¤ ë„¤ë©”ì‹œìŠ¤ ë”œë ˆì´
hologram electronics,microcosm,effect,800000,,í™€ë¡œê·¸ë¨ ë§ˆì´í¬ë¡œì½”ì¦˜ (ê¸€ë¦¬ì¹˜/ë£¨í¼)
meris,polymoon,effect,450000,,ë©”ë¦¬ìŠ¤ í´ë¦¬ë¬¸ ë”œë ˆì´
meris,mercury7,effect,450000,,ë©”ë¦¬ìŠ¤ ë¨¸íë¦¬7 ë¦¬ë²„ë¸Œ
empress effects,zoia,effect,750000,,ì— í”„ë ˆìŠ¤ ì¡°ì´ì•„ (ëª¨ë“ˆëŸ¬ ì´í™í„°)
empress effects,compressor mkii,effect,380000,,ì— í”„ë ˆìŠ¤ ì»´í”„ë ˆì„œ MkII
boss,sy-1,effect,250000,,BOSS SY-1 ì‹ ë””ì‚¬ì´ì € í˜ë‹¬
boss,sy-200,effect,450000,,BOSS SY-200 ì‹ ë””ì‚¬ì´ì €
boss,rc-500,effect,480000,,BOSS RC-500 ë£¨í”„ ìŠ¤í…Œì´ì…˜
boss,dm-101,effect,650000,,BOSS DM-101 ì•„ë‚ ë¡œê·¸ ë”œë ˆì´ ë¨¸ì‹ 
boss,bp-1w,effect,250000,,BOSS BP-1w ë¶€ìŠ¤í„° í”„ë¦¬ì•°í”„
origin effects,cali76 compact deluxe,effect,480000,,ì˜¤ë¦¬ì§„ ì´í™íŠ¸ ì¹¼ë¦¬76 ì»´í”„ë ˆì„œ
origin effects,revival drive compact,effect,550000,,ì˜¤ë¦¬ì§„ ì´í™íŠ¸ ë¦¬ë°”ì´ë²Œ ë“œë¼ì´ë¸Œ
digitech,whammy 5,effect,350000,,ë””ì§€í… ì™€ë¯¸ 5
digitech,drop,effect,250000,,ë””ì§€í… ë“œë (ë‹¤ìš´íŠœë‹)
mxr,phase 90,effect,120000,,MXR í˜ì´ì¦ˆ 90
mxr,carbon copy,effect,200000,,MXR ì¹´ë³¸ ì¹´í”¼ ì•„ë‚ ë¡œê·¸ ë”œë ˆì´
mxr,dyna comp,effect,110000,,MXR ë‹¤ì´ë‚˜ ì»´í”„
mxr,m80 bass di,effect,220000,,MXR M80 ë² ì´ìŠ¤ DI+
mxr,talk box,effect,250000,,MXR í† í¬ë°•ìŠ¤
tech 21,sansamp bass driver di v2,effect,320000,,í…Œí¬21 ì‚°ìŠ¤ì•°í”„ ë² ì´ìŠ¤ ë“œë¼ì´ë²„ DI
darkglass,alpha omega ultra,effect,580000,,ë‹¤í¬ê¸€ë˜ìŠ¤ ì•ŒíŒŒ ì˜¤ë©”ê°€ ìš¸íŠ¸ë¼
darkglass,b7k ultra v2,effect,580000,,ë‹¤í¬ê¸€ë˜ìŠ¤ B7K ìš¸íŠ¸ë¼ V2
darkglass,adam,effect,750000,,ë‹¤í¬ê¸€ë˜ìŠ¤ ì•„ë‹´ (ì˜¤ë””ì˜¤ ì¸í„°í˜ì´ìŠ¤ ë‚´ì¥)
esp,e-ii horizon fr,guitar,2800000,,ESP E-II í˜¸ë¼ì´ì¦Œ FR
esp,e-ii eclipse,guitar,2800000,,ESP E-II ì´í´ë¦½ìŠ¤
ltd,ec-1000,guitar,1400000,,LTD EC-1000 ë””ëŸ­ìŠ¤
ltd,mh-1000,guitar,1400000,,LTD MH-1000
schecter,hellraiser c-1,guitar,1300000,,ì‰‘í„° í—¬ë ˆì´ì € C-1
schecter,c-1 sls elite,guitar,1800000,,ì‰‘í„° C-1 SLS ì—˜ë¦¬íŠ¸
schecter,nick johnston traditional,guitar,1100000,,ì‰‘í„° ë‹‰ ì¡´ìŠ¤í„´ íŠ¸ë˜ë””ì…”ë„
schecter,mv-6,guitar,1200000,,ì‰‘í„° MV-6
strandberg,boden original 6,guitar,2800000,,ìŠ¤íŠ¸ëœë“œë²„ê·¸ ë³´ë“  ì˜¤ë¦¬ì§€ë„ 6
strandberg,boden metal 6,guitar,2900000,,ìŠ¤íŠ¸ëœë“œë²„ê·¸ ë³´ë“  ë©”íƒˆ 6
strandberg,boden essential,guitar,1600000,,ìŠ¤íŠ¸ëœë“œë²„ê·¸ ë³´ë“  ì—ì„¼ì…œ
mayones,duvell elite 6,guitar,4500000,,ë§ˆìš”ë„¤ì¦ˆ ë“€ë²¨ ì—˜ë¦¬íŠ¸ 6
mayones,regius 6,guitar,5500000,,ë§ˆìš”ë„¤ì¦ˆ ë ˆì§€ìš°ìŠ¤ 6
aristides,060,guitar,5000000,,ì•„ë¦¬ìŠ¤í‹°ë°ìŠ¤ 060 (ì‹ ì†Œì¬ ê¸°íƒ€)
solar guitars,a1.6,guitar,1500000,,ì†”ë¼ ê¸°íƒ€ A1.6 (ì˜¬ë¼ ì‰ê¸€ëœë“œ)
kiesel,delos,guitar,2500000,,í‚¤ì ¤ ë¸ë¡œìŠ¤
kiesel,zeus,guitar,2800000,,í‚¤ì ¤ ì œìš°ìŠ¤ (í—¤ë“œë¦¬ìŠ¤)
musicman,axis,guitar,4200000,,ë®¤ì§ë§¨ ì•¡ì‹œìŠ¤ (ì—ë”” ë°˜ í—¤ì¼ëŸ°)
musicman,luke iii,guitar,4500000,,ë®¤ì§ë§¨ ë£¨í¬3 (ìŠ¤í‹°ë¸Œ ë£¨ì¹´ì„œ)
sterling,majesty,guitar,1800000,,ìŠ¤í„¸ë§ ë§ˆì œìŠ¤í‹°
charvel,dk24 hss,guitar,1600000,,ìƒ¤ë²¨ í”„ë¡œëª¨ë“œ DK24 HSS
charvel,guthrie govan signature,guitar,5000000,,ìƒ¤ë²¨ ê±°ìŠ¤ë¦¬ ê³ ë°˜ ì‹œê·¸ë‹ˆì²˜
jackson,soloist sl2,guitar,1800000,,ì­ìŠ¨ ì†”ë¡œì´ìŠ¤íŠ¸ SL2
jackson,rhoads rr1,guitar,4500000,,ì­ìŠ¨ ë¡œì¦ˆ RR1 USA
gretsch,g6120,guitar,4500000,,ê·¸ë ˆì¹˜ G6120 ë‚´ì‰¬ë¹Œ
gretsch,white falcon,guitar,5500000,,ê·¸ë ˆì¹˜ í™”ì´íŠ¸ íŒ”ì½˜
gretsch,g5420t,guitar,1200000,,ê·¸ë ˆì¹˜ ì¼ë ‰íŠ¸ë¡œë§¤í‹± G5420T
rickenbacker,330,guitar,3500000,,ë¦¬ì¼„ë² ì»¤ 330
rickenbacker,4003,bass,3800000,,ë¦¬ì¼„ë² ì»¤ 4003 ë² ì´ìŠ¤
dingwall,ng3 5string,bass,3200000,,ë”©ì›” NG3 5í˜„ (ì•„ë‹´ ë†€ë¦¬)
dingwall,combustion 5,bass,2800000,,ë”©ì›” ì½¤ë²„ìŠ¤ì²œ 5í˜„
spector,euro 4 lx,bass,3500000,,ìŠ¤í™í„° ìœ ë¡œ 4 LX
spector,ns pulse ii,bass,1800000,,ìŠ¤í™í„° NS í„ìŠ¤ II
warwick,thumb bo 4,bass,2800000,,ì›Œìœ… ì¸ ë² ì´ìŠ¤ BO 4í˜„ (ë…ì¼)
warwick,streamer lx,bass,3000000,,ì›Œìœ… ìŠ¤íŠ¸ë¦¬ë¨¸ LX
warwick,rockbass corvette,bass,1200000,,ì›Œìœ… ë½ë² ì´ìŠ¤ ì½”ë¥´ë²³
sandberg,california tm4,bass,2800000,,ìƒŒë“œë²„ê·¸ ìº˜ë¦¬í¬ë‹ˆì•„ TM4
lakland,skyline 55-02,bass,2200000,,ë½ëœë“œ ìŠ¤ì¹´ì´ë¼ì¸ 55-02
fender,flea jazz bass,bass,2000000,,íœë” í”Œë¦¬ ì¬ì¦ˆë² ì´ìŠ¤ (RHCP)
fender,geddy lee jazz bass,bass,1800000,,íœë” ê²Œë”” ë¦¬ ì¬ì¦ˆë² ì´ìŠ¤
yamaha,bb p34,bass,2200000,,ì•¼ë§ˆí•˜ BB P34 (Made in Japan)
ibanez,ehb1005,bass,1600000,,ì•„ì´ë°”ë„¤ì¦ˆ EHB1005 í—¤ë“œë¦¬ìŠ¤ ë² ì´ìŠ¤
ibanez,sr5000,bass,2800000,,ì•„ì´ë°”ë„¤ì¦ˆ SR5000 í”„ë ˆìŠ¤í‹°ì§€
gibson,j-45 standard,acoustic,3800000,,ê¹ìŠ¨ J-45 ìŠ¤íƒ ë‹¤ë“œ
gibson,hummingbird standard,acoustic,5500000,,ê¹ìŠ¨ í—ˆë°ë²„ë“œ ìŠ¤íƒ ë‹¤ë“œ
gibson,sj-200,acoustic,7000000,,ê¹ìŠ¨ SJ-200 (ì ë³´ë°”ë””)
taylor,k24ce,acoustic,7500000,,í…Œì¼ëŸ¬ K24ce ì½”ì•„
taylor,914ce,acoustic,7000000,,í…Œì¼ëŸ¬ 914ce
martin,hd-28,acoustic,4500000,,ë§ˆí‹´ HD-28
martin,d-45,acoustic,13000000,,ë§ˆí‹´ D-45 (ëíŒì™•)
lowden,f-35,acoustic,8500000,,ë¡œìš°ë“  F-35 (í•‘ê±°ìŠ¤íƒ€ì¼)
lowden,o-25,acoustic,6500000,,ë¡œìš°ë“  O-25
lakewood,m-32 cp,acoustic,5500000,,ë ˆì´í¬ìš°ë“œ M-32 CP (ì •ì„±í•˜)
maton,ebg808te,acoustic,3800000,,ë©”ì´íŠ¼ EBG808TE (í† ë¯¸ ì— ë§ˆë‰´ì—˜)
cole clark,angel 2,acoustic,2800000,,ì½œí´ë½ ì—”ì ¤ 2
yamaha,ls16 are,acoustic,1100000,,ì•¼ë§ˆí•˜ LS16 ARE
yamaha,apx600,acoustic,450000,,ì•¼ë§ˆí•˜ APX600
cort,gold-a6,acoustic,750000,,ì½œíŠ¸ ê³¨ë“œ A6
cort,earth 100,acoustic,350000,,ì½œíŠ¸ ì–´ìŠ¤ 100
sigma,dr-28,acoustic,650000,,ì‹œê·¸ë§ˆ DR-28 (ë§ˆí‹´ ì¹´í”¼)
marshall,jvm410h,amp,2800000,,ë§ˆìƒ¬ JVM410H í—¤ë“œ
marshall,1959slp,amp,3500000,,ë§ˆìƒ¬ 1959SLP í”Œë ‰ì‹œ ë¦¬ì´ìŠˆ
engl,fireball 25,amp,1500000,,ì•µê¸€ íŒŒì´ì–´ë³¼ 25
engl,powerball ii,amp,2800000,,ì•µê¸€ íŒŒì›Œë³¼ II
diezel,vh4,amp,5500000,,ë””ì ¤ VH4 í—¤ë“œ (íˆ´/ë©”íƒˆë¦¬ì¹´)
bogner,ecstasy 3534,amp,3200000,,ë³´ê·¸ë„ˆ ì—‘ìŠ¤í„°ì‹œ 3534
friedman,be-100 deluxe,amp,5500000,,í”„ë¦¬ë“œë§Œ BE-100 ë””ëŸ­ìŠ¤
friedman,jj junior,amp,2500000,,í”„ë¦¬ë“œë§Œ JJ ì£¼ë‹ˆì–´ (ì œë¦¬ ìº”íŠ¸ë )
soldano,slo-100,amp,6000000,,ì†”ë‹¤ë…¸ SLO-100
peavey,6505 plus,amp,1800000,,í”¼ë¹„ 6505+ í—¤ë“œ
evh,5150 iii 50w,amp,1800000,,EVH 5150 III 50W
orange,rockerverb 50 mkiii,amp,2800000,,ì˜¤ë Œì§€ ë¡œì»¤ë²„ë¸Œ 50 MkIII
hughes & kettner,grandmeister deluxe 40,amp,1800000,,íœ´ê±°ìŠ¤ì•¤ì¼€íŠ¸ë„ˆ ê·¸ëœë“œë§ˆì´ìŠ¤í„° 40
shure,sm57,recording,130000,,ìŠˆì–´ SM57 ë‹¤ì´ë‚˜ë¯¹ ë§ˆì´í¬
shure,sm58,recording,130000,,ìŠˆì–´ SM58 ë³´ì»¬ ë§ˆì´í¬
shure,sm7b,recording,600000,,ìŠˆì–´ SM7B ë°©ì†¡ìš© ë§ˆì´í¬
sennheiser,e906,recording,250000,,ì  í•˜ì´ì € e906 (ê¸°íƒ€ ì•°í”„ ë§ˆì´í‚¹ìš©)
universal audio,apollo twin x duo,recording,1400000,,ìœ ë‹ˆë²„ì„¤ ì˜¤ë””ì˜¤ ì•„í´ë¡œ íŠ¸ìœˆ X ë“€ì˜¤
focusrite,scarlett 2i2 4th gen,recording,280000,,í¬ì»¤ìŠ¤ë¼ì´íŠ¸ ìŠ¤ì¹¼ë › 2i2 4ì„¸ëŒ€
rme,babyface pro fs,recording,1300000,,RME ë² ì´ë¹„í˜ì´ìŠ¤ í”„ë¡œ FS
neumann,tlm 102,recording,1000000,,ë…¸ì´ë§Œ TLM 102 ì½˜ë´ì„œ ë§ˆì´í¬
cloud,cloudlifter cl-1,recording,200000,,í´ë¼ìš°ë“œë¦¬í”„í„° CL-1 (ë§ˆì´í¬ í”„ë¦¬ì•°í”„)
two notes,torpedo captor x,effect,850000,,íˆ¬ë…¸ì¸  í† í”¼ë„ ìº¡í„° X (ë¡œë“œë°•ìŠ¤)
suhr,reactive load ir,effect,950000,,ì¨ ë¦¬ì•¡í‹°ë¸Œ ë¡œë“œ IR
seymour duncan,sh-4 jb,parts,120000,,ì„¸ì´ëª¨ì–´ ë˜ì»¨ SH-4 JB í”½ì—…
seymour duncan,sh-1 59,parts,120000,,ì„¸ì´ëª¨ì–´ ë˜ì»¨ SH-1 59 í”½ì—…
dimarzio,tone zone,parts,110000,,ë””ë§ˆì§€ì˜¤ í†¤ì¡´ í”½ì—…
emg,81,parts,130000,,EMG 81 ì•¡í‹°ë¸Œ í”½ì—…
emg,85,parts,130000,,EMG 85 ì•¡í‹°ë¸Œ í”½ì—…
fishman,fluence modern,parts,300000,,í”¼ì‰¬ë§¨ í”Œë£¨ì–¸ìŠ¤ ëª¨ë˜ ì„¸íŠ¸
cioks,dc7,parts,320000,,ì‹œì˜¤ìŠ¤ DC7 íŒŒì›Œ ì„œí”Œë¼ì´
strymon,zuma,parts,350000,,ìŠ¤íŠ¸ë¼ì´ëª¬ ì£¼ë§ˆ íŒŒì›Œ ì„œí”Œë¼ì´
voodoo lab,pedal power 3 plus,parts,350000,,ë¶€ë‘ë© í˜ë‹¬ íŒŒì›Œ 3 í”ŒëŸ¬ìŠ¤
monoprice,stage right 15w,amp,150000,,ëª¨ë…¸í”„ë¼ì´ìŠ¤ 15W íŠœë¸Œ ì•°í”„ (ê°€ì„±ë¹„)
joyo,american sound,effect,450000,,ì¡°ìš” ì•„ë©”ë¦¬ì¹¸ ì‚¬ìš´ë“œ (ê°€ì„±ë¹„ ì•°í”„ì‹¬)
donner,yellow fall,effect,35000,,ë„ë„ˆ ì˜ë¡œìš° í´ ë”œë ˆì´
nux,atlantic,effect,160000,,ëˆ…ìŠ¤ ì•„í‹€ë€í‹± ë”œë ˆì´ ë¦¬ë²„ë¸Œ
caline,pure sky,effect,40000,,ì¹¼ë¦° í“¨ì–´ ìŠ¤ì¹´ì´ (í‹°ë¯¸ ì¹´í”¼)
mosky,golden horse,effect,30000,,ëª¨ìŠ¤í‚¤ ê³¨ë“  í˜¸ìŠ¤ (í´ë¡  ì¹´í”¼)
</file>

<file path="backend/SEARCH_LOGIC.md">
# DAGU ê²€ìƒ‰ ë¡œì§ ë¬¸ì„œ

## ê°œìš”
DAGU ê²€ìƒ‰ ì‹œìŠ¤í…œì€ **Instrument(ì•…ê¸°) ì¤‘ì‹¬**ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.  
ì‚¬ìš©ìê°€ ëª¨ë¸ëª…ì´ë‚˜ ë¸Œëœë“œë¥¼ ê²€ìƒ‰í•˜ë©´, DBì—ì„œ ë§¤ì¹­ë˜ëŠ” ì•…ê¸°ë¥¼ ë¨¼ì € ì°¾ê³ ,  
ê·¸ ì•…ê¸°ì˜ ì •í™•í•œ ë¸Œëœë“œ+ëª¨ë¸ëª…ìœ¼ë¡œ ë„¤ì´ë²„ APIë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.

---

## ê²€ìƒ‰ íë¦„

```
ì‚¬ìš©ì ì…ë ¥: "ds-1" ë˜ëŠ” "boss ds-1" ë˜ëŠ” "ë³´ìŠ¤ ds-1"
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. DB Instrument ê²€ìƒ‰                                    â”‚
â”‚    - name ë˜ëŠ” brandì— ê²€ìƒ‰ì–´ í¬í•¨ëœ ì•…ê¸° ì°¾ê¸°            â”‚
â”‚    - 'Unknown' ë¸Œëœë“œëŠ” ì œì™¸                             â”‚
â”‚    - ì˜ˆ: 'ds-1' â†’ DBì—ì„œ 'BOSS DS-1' ì•…ê¸° ë°œê²¬           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ê²€ìƒ‰ì–´ ê²°ì •                                           â”‚
â”‚    - ë§¤ì¹­ëœ ì•…ê¸° ìˆìŒ â†’ "{ë¸Œëœë“œ} {ëª¨ë¸ëª…}" ì‚¬ìš©          â”‚
â”‚      ì˜ˆ: "BOSS DS-1"                                     â”‚
â”‚    - ë§¤ì¹­ ì—†ìŒ â†’ ì›ë³¸ ê²€ìƒ‰ì–´ ì‚¬ìš© (í•œê¸€â†’ì˜ì–´ ë³€í™˜)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ë„¤ì´ë²„ API ê²€ìƒ‰                                       â”‚
â”‚    - ê²°ì •ëœ ê²€ìƒ‰ì–´ë¡œ ë„¤ì´ë²„ ì‡¼í•‘ ê²€ìƒ‰                     â”‚
â”‚    - í•„í„°ë§ ì ìš©:                                        â”‚
â”‚      â€¢ ê°€ê²© í•„í„° (í˜ë‹¬: 5ë§Œì›+, ê¸°íƒ€: 20ë§Œì›+)            â”‚
â”‚      â€¢ ë¸”ë™ë¦¬ìŠ¤íŠ¸ (ë¶€í’ˆ, ì¼€ì´ìŠ¤ ë“± ì œì™¸)                  â”‚
â”‚      â€¢ ë¸Œëœë“œ ë¬´ê²°ì„± ì²´í¬                                 â”‚
â”‚      â€¢ ì¹´í…Œê³ ë¦¬ ì²´í¬                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ìœ ì € ë§¤ë¬¼ ê²€ìƒ‰ (UserItem)                             â”‚
â”‚    - ë§¤ì¹­ëœ Instrumentì˜ UserItemë“¤ ì§ì ‘ ì¡°íšŒ            â”‚
â”‚    - ë˜ëŠ” ê²€ìƒ‰ì–´ë¡œ ì œëª©/ë¸Œëœë“œ ê²€ìƒ‰                       â”‚
â”‚    - ë¸”ë™ë¦¬ìŠ¤íŠ¸ í•„í„°ë§Œ ì ìš© (ê°€ê²© í•„í„° ì—†ìŒ)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            ë„¤ì´ë²„ ê²°ê³¼ + ìœ ì € ë§¤ë¬¼ ì¢…í•© â†’ ê°€ê²©ìˆœ ì •ë ¬ â†’ ë°˜í™˜
```

---

## í•µì‹¬ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `services.py` | ê²€ìƒ‰ ë¡œì§ ë©”ì¸ (SearchAggregatorService) |
| `config.py` | ì„¤ì •ê°’ (ê°€ê²©, ë¸”ë™ë¦¬ìŠ¤íŠ¸, ë¸Œëœë“œ ë§¤í•‘ ë“±) |
| `filters.py` | í•„í„°ë§ í•¨ìˆ˜ë“¤ (ê°€ê²©, ë¸”ë™ë¦¬ìŠ¤íŠ¸, ë¸Œëœë“œ ë“±) |
| `models.py` | Instrument, UserItem ëª¨ë¸ ì •ì˜ |

---

## ì£¼ìš” ì„¤ì • (config.py)

### ê°€ê²© í•„í„°
- `MIN_PRICE_KRW = 200000` (ì•…ê¸°: 20ë§Œì› ì´ìƒ)
- `MIN_PRICE_PEDAL = 50000` (í˜ë‹¬: 5ë§Œì› ì´ìƒ)

### ì¹´í…Œê³ ë¦¬ ì¸ì‹ í‚¤ì›Œë“œ
- `PEDAL_KEYWORDS`: boss, ds-1, overdrive, distortion ë“±
- `AMP_KEYWORDS`: amp, cabinet, head, combo ë“±
- `ACOUSTIC_KEYWORDS`: acoustic, martin, taylor ë“±

### í•œê¸€ ë¸Œëœë“œ ë§¤í•‘
```python
BRAND_NAME_MAPPING = {
    'íœë”': 'fender',
    'ê¹ìŠ¨': 'gibson',
    'ë³´ìŠ¤': 'boss',
    'ë§ˆìƒ¬': 'marshall',
    # ...
}
```

---

## ê²€ìƒ‰ ì˜ˆì‹œ

| ì‚¬ìš©ì ì…ë ¥ | DB ë§¤ì¹­ | ë„¤ì´ë²„ ê²€ìƒ‰ì–´ | ê²°ê³¼ |
|-------------|---------|---------------|------|
| `ds-1` | BOSS DS-1 | "BOSS DS-1" | í˜ë‹¬ ê²°ê³¼ âœ… |
| `boss ds-1` | BOSS DS-1 | "BOSS DS-1" | í˜ë‹¬ ê²°ê³¼ âœ… |
| `ë³´ìŠ¤ ds-1` | BOSS DS-1 | "boss DS-1" | í˜ë‹¬ ê²°ê³¼ âœ… |
| `stratocaster` | (ë¯¸ë“±ë¡) | "stratocaster" | ê¸°íƒ€ ê²°ê³¼ âœ… |

---

## ìƒˆ ì•…ê¸° ì¶”ê°€ ë°©ë²•

1. Django Adminì—ì„œ **Instrument** ì¶”ê°€
2. ë¸Œëœë“œ, ëª¨ë¸ëª…, ì¹´í…Œê³ ë¦¬, ê¸°ì¤€ê°€ ì…ë ¥
3. ìë™ìœ¼ë¡œ ê²€ìƒ‰ì— ë°˜ì˜ë¨ (ì½”ë“œ ìˆ˜ì • ë¶ˆí•„ìš”)

---

## ìºì‹±

- ë„¤ì´ë²„ API ê²°ê³¼ëŠ” **1ì‹œê°„** ìºì‹±
- ìºì‹œ í‚¤: ì •ê·œí™”ëœ ê²€ìƒ‰ì–´ + display ìˆ˜
- í•„í„°ë§ì€ ë§¤ ìš”ì²­ë§ˆë‹¤ ì ìš©
</file>

<file path="check_output.txt">
Checking UserItems significantly related to 'sm57'...
Matching Instruments: 1
 - Found Instrument: shure sm57 (ID: cfffc56d-6165-4a3f-952a-b63edf8a381b)

Query Filter: (OR: ('instrument__name__icontains', 'sm57'), ('instrument__brand__icontains', 'sm57'), ('title__icontains', 'sm57'), ('instrument__in', <QuerySet [<Instrument: shure sm57>]>))

Total UserItems matching query: 0

=== LATEST 5 USER ITEMS INSPECTION ===
[Item ID: 5e293855-d312-4bba-8640-a3d85518f3de]
 - Title: BOSS DS-1
 - Instrument: boss ds-1 (ID: b7029484-c661-4adc-9524-f66e056ee48e)
 - Included in Matching IDs? False
 - Text match with 'sm57'? False
 - Is Active: True
--------------------------------
[Item ID: 9ff69d28-700f-42a5-ac46-6a1b6d9c1aa8]
 - Title: BOSS DS-1
 - Instrument: boss ds-1 (ID: b7029484-c661-4adc-9524-f66e056ee48e)
 - Included in Matching IDs? False
 - Text match with 'sm57'? False
 - Is Active: True
--------------------------------
[Item ID: 0ecf7a72-0dab-432a-a9fa-1af6888b7807]
 - Title: BOSS DS-1
 - Instrument: boss ds-1 (ID: b7029484-c661-4adc-9524-f66e056ee48e)
 - Included in Matching IDs? False
 - Text match with 'sm57'? False
 - Is Active: True
--------------------------------
[Item ID: 09faa2aa-6098-46a2-be1d-fa93dd9461eb]
 - Title: BOSS DS-1
 - Instrument: boss ds-1 (ID: b7029484-c661-4adc-9524-f66e056ee48e)
 - Included in Matching IDs? False
 - Text match with 'sm57'? False
 - Is Active: True
--------------------------------
[Item ID: 1fa3e76c-e812-43e2-8265-eb758e5f290a]
 - Title: Ibanez RG
 - Instrument: ibanez ibanez rg (ID: 01a372a3-ccee-4cdc-b863-374a7b2a47a6)
 - Included in Matching IDs? False
 - Text match with 'sm57'? False
 - Is Active: True
--------------------------------
</file>

<file path="dagu_malcha.txt">
ë§ì°¨ â†” ë‹¤êµ¬ ê´€ê³„

  - ë§ì°¨: SSO ì¸ì¦ ì„œë²„ (ë¡œê·¸ì¸/íšŒì›ê°€ì…)
  - ë‹¤êµ¬: ì•…ê¸° ì‹œì„¸ ë¹„êµ ì„œë¹„ìŠ¤ (ë§ì°¨ SSOë¡œ ì¸ì¦)
  - ë§¤ë¬¼ ë“±ë¡ ì‹œ ë¹„ë¡œê·¸ì¸ â†’ /login (ë§ì°¨)ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
</file>

<file path="debug_db.py">
import os
import django
import sys

sys.path.append('backend')
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings.local')
django.setup()

from dagu.models import UserItem, Instrument
from django.db.models import Q

query = "ds-1"

with open("debug_result.txt", "w", encoding="utf-8") as f:
    f.write(f"Query: {query}\n")
    
    # 1. Check Instrument
    instruments = Instrument.objects.filter(name__icontains=query)
    f.write(f"Matching Instruments count: {instruments.count()}\n")
    inst_ids = []
    for inst in instruments:
        f.write(f"  Inst: {inst.id} | {inst.brand} | {inst.name}\n")
        inst_ids.append(inst.id)
        
    # 2. Check Latest UserItems
    f.write("\nLatest 5 UserItems:\n")
    latest = UserItem.objects.all().order_by('-created_at')[:5]
    for item in latest:
        f.write(f"  Item: {item.id} | Title: {item.title}\n")
        if item.instrument:
            f.write(f"    Linked Inst: {item.instrument.id} | {item.instrument.brand} | {item.instrument.name}\n")
            if item.instrument.id in inst_ids:
                f.write("    -> MATCHES matching_instrument!\n")
            else:
                f.write("    -> DOES NOT match matching_instrument ID.\n")
        else:
            f.write("    Linked Inst: None\n")
            
    # 3. Check Filter Query result
    q_filter = Q(instrument__name__icontains=query) | \
               Q(instrument__brand__icontains=query) | \
               Q(title__icontains=query)
    
    if instruments:
        q_filter |= Q(instrument__in=instruments)
        
    count = UserItem.objects.filter(q_filter).count()
    f.write(f"\nUserItem filter count: {count}\n")
</file>

<file path="debug_result.txt">
Query: ds-1
Matching Instruments count: 2
  Inst: b7029484-c661-4adc-9524-f66e056ee48e | boss | ds-1
  Inst: ce83c306-b780-4d74-8e35-3646f246454d | boss | ds-1w

Latest 5 UserItems:
  Item: 5e293855-d312-4bba-8640-a3d85518f3de | Title: BOSS DS-1
    Linked Inst: b7029484-c661-4adc-9524-f66e056ee48e | boss | ds-1
    -> MATCHES matching_instrument!
  Item: 9ff69d28-700f-42a5-ac46-6a1b6d9c1aa8 | Title: BOSS DS-1
    Linked Inst: b7029484-c661-4adc-9524-f66e056ee48e | boss | ds-1
    -> MATCHES matching_instrument!
  Item: 0ecf7a72-0dab-432a-a9fa-1af6888b7807 | Title: BOSS DS-1
    Linked Inst: b7029484-c661-4adc-9524-f66e056ee48e | boss | ds-1
    -> MATCHES matching_instrument!
  Item: 09faa2aa-6098-46a2-be1d-fa93dd9461eb | Title: BOSS DS-1
    Linked Inst: b7029484-c661-4adc-9524-f66e056ee48e | boss | ds-1
    -> MATCHES matching_instrument!
  Item: 1fa3e76c-e812-43e2-8265-eb758e5f290a | Title: Ibanez RG
    Linked Inst: 01a372a3-ccee-4cdc-b863-374a7b2a47a6 | ibanez | ibanez rg
    -> DOES NOT match matching_instrument ID.

UserItem filter count: 4
</file>

<file path="frontend/.gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="frontend/Dockerfile">
# Frontend Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

# Install dependencies
COPY package*.json ./
RUN npm ci

# Copy source and build
COPY . .
RUN npm run build

# Production stage with nginx
FROM nginx:alpine

# Copy built assets
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy nginx config
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
</file>

<file path="frontend/eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])
</file>

<file path="frontend/public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="frontend/README.md">
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...

      // Remove tseslint.configs.recommended and replace with this
      tseslint.configs.recommendedTypeChecked,
      // Alternatively, use this for stricter rules
      tseslint.configs.strictTypeChecked,
      // Optionally, add this for stylistic rules
      tseslint.configs.stylisticTypeChecked,

      // Other configs...
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...
      // Enable lint rules for React
      reactX.configs['recommended-typescript'],
      // Enable lint rules for React DOM
      reactDom.configs.recommended,
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```
</file>

<file path="frontend/repomix-output.xml">
This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
Dockerfile
eslint.config.js
index.html
nginx.conf
package.json
public/vite.svg
README.md
src/App.css
src/App.tsx
src/assets/daguLoading.gif
src/assets/react.svg
src/components/ItemCard.tsx
src/components/MatchaBounceLoader.tsx
src/components/SearchBar.tsx
src/components/VSComparisonLayout.tsx
src/hooks/useAuth.ts
src/hooks/useSearch.ts
src/index.css
src/main.tsx
src/pages/HomePage.tsx
src/pages/SearchResultPage.tsx
src/services/api.ts
src/types/index.ts
tsconfig.app.json
tsconfig.json
tsconfig.node.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="Dockerfile">
# Frontend Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

# Install dependencies
COPY package*.json ./
RUN npm ci

# Copy source and build
COPY . .
RUN npm run build

# Production stage with nginx
FROM nginx:alpine

# Copy built assets
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy nginx config
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
</file>

<file path="eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])
</file>

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DAGU</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
</file>

<file path="nginx.conf">
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # SPA fallback
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API proxy
    location /api/ {
        proxy_pass http://backend:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
</file>

<file path="package.json">
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@tailwindcss/vite": "^4.1.18",
    "@tanstack/react-query": "^5.90.17",
    "axios": "^1.13.2",
    "framer-motion": "^12.26.2",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.12.0",
    "tailwindcss": "^4.1.18"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4"
  }
}
</file>

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="README.md">
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...

      // Remove tseslint.configs.recommended and replace with this
      tseslint.configs.recommendedTypeChecked,
      // Alternatively, use this for stricter rules
      tseslint.configs.strictTypeChecked,
      // Optionally, add this for stylistic rules
      tseslint.configs.stylisticTypeChecked,

      // Other configs...
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...
      // Enable lint rules for React
      reactX.configs['recommended-typescript'],
      // Enable lint rules for React DOM
      reactDom.configs.recommended,
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```
</file>

<file path="src/App.css">
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}
</file>

<file path="src/App.tsx">
/**
 * MALCHA-DAGU Main App
 */

import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import HomePage from './pages/HomePage';
import SearchResultPage from './pages/SearchResultPage';

// React Query í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5ë¶„
      gcTime: 10 * 60 * 1000,   // 10ë¶„
      retry: 1,
      refetchOnWindowFocus: false,
    },
  },
});

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <BrowserRouter>
        <Routes>
          <Route path="/" element={<HomePage />} />
          <Route path="/search" element={<SearchResultPage />} />
        </Routes>
      </BrowserRouter>
    </QueryClientProvider>
  );
}

export default App;
</file>

<file path="src/assets/react.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
</file>

<file path="src/components/ItemCard.tsx">
/**
 * Item Card Component
 *
 * Features:
 * - ê°€ê²© ë° í• ì¸ìœ¨ í‘œì‹œ
 * - ì¶œì²˜ ë±ƒì§€
 * - Layout ì• ë‹ˆë©”ì´ì…˜ (ìˆœìœ„ ë³€ê²½ ì‹œ)
 * - í´ë¦­ ì‹œ ë§í¬ ì´ë™
 * - ì‹ ê³ í•˜ê¸° / ê°€ê²© ì—…ë°ì´íŠ¸ ë²„íŠ¼ (ìœ ì € ë§¤ë¬¼ë§Œ)
 */

import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import type { NaverItem, MergedUserItem, ReportReason } from '../types';
import { REPORT_REASON_LABELS } from '../types';

interface ItemCardProps {
    item: NaverItem | MergedUserItem;
    rank?: number;
    referencePrice?: number;
    onClick?: () => void;
    isOwner?: boolean;
    isLoggedIn?: boolean;
    onExtend?: () => void;
    onReport?: (reason: ReportReason, detail?: string) => void;
    onUpdatePrice?: (newPrice: number) => void;
}

// ì¶œì²˜ë³„ ìŠ¤íƒ€ì¼
const SOURCE_STYLES: Record<string, { bg: string; text: string; label: string }> = {
    naver: { bg: 'bg-green-100', text: 'text-green-700', label: 'ë„¤ì´ë²„' },
    mule: { bg: 'bg-blue-100', text: 'text-blue-700', label: 'ë®¬' },
    bunjang: { bg: 'bg-red-100', text: 'text-red-700', label: 'ë²ˆê°œì¥í„°' },
    joonggonara: { bg: 'bg-green-100', text: 'text-green-700', label: 'ì¤‘ê³ ë‚˜ë¼' },
    danggn: { bg: 'bg-orange-100', text: 'text-orange-700', label: 'ë‹¹ê·¼' },
    other: { bg: 'bg-stone-100', text: 'text-stone-700', label: 'ê¸°íƒ€' },
};

function formatPrice(price: number): string {
    return new Intl.NumberFormat('ko-KR').format(price);
}

function calculateDiscount(price: number, referencePrice: number): number {
    if (referencePrice <= 0) return 0;
    return Math.round((1 - price / referencePrice) * 100);
}

// ê¸°íƒ€ í”¼í¬ ìˆœìœ„ ì•„ì´ì½˜
function PickIcon({ rank }: { rank: number }) {
    const colors = {
        1: { fill: '#FFD700', stroke: '#B8860B', text: '#8B4513' }, // ê³¨ë“œ
        2: { fill: '#C0C0C0', stroke: '#808080', text: '#404040' }, // ì‹¤ë²„
        3: { fill: '#CD7F32', stroke: '#8B4513', text: '#FFFFFF' }, // ë¸Œë¡ ì¦ˆ
    };
    const color = colors[rank as 1 | 2 | 3] || colors[3];

    return (
        <svg viewBox="0 0 100 100" className="w-8 h-8 drop-shadow-md">
            {/* í”¼í¬ ëª¸í†µ */}
            <path
                d="M 50 98 C 85 80, 95 30, 85 15 C 75 5, 25 5, 15 15 C 5 30, 15 80, 50 98 Z"
                fill={color.fill}
                stroke={color.stroke}
                strokeWidth="3"
            />
            {/* ìˆœìœ„ ìˆ«ì */}
            <text
                x="50"
                y="55"
                textAnchor="middle"
                fill={color.text}
                fontSize="32"
                fontWeight="bold"
                fontFamily="system-ui, sans-serif"
            >
                {rank}
            </text>
        </svg>
    );
}

export default function ItemCard({
    item,
    rank,
    referencePrice,
    onClick,
    isOwner,
    isLoggedIn,
    onExtend,
    onReport,
    onUpdatePrice,
}: ItemCardProps) {
    const [showReportModal, setShowReportModal] = useState(false);
    const [showPriceModal, setShowPriceModal] = useState(false);
    const [reportReason, setReportReason] = useState<ReportReason>('wrong_price');
    const [newPrice, setNewPrice] = useState(item.lprice.toString());

    const source = item.source || 'other';
    const sourceStyle = SOURCE_STYLES[source] || SOURCE_STYLES.other;
    const mallName = 'mallName' in item ? item.mallName : ('source_display' in item ? item.source_display : '');

    // ìœ ì € ë§¤ë¬¼ì¸ì§€ í™•ì¸ (id í•„ë“œ ì¡´ì¬ ì—¬ë¶€ë¡œ íŒë‹¨)
    const isUserItem = 'id' in item && source !== 'naver';

    // í• ì¸ìœ¨ ê³„ì‚°
    const discount = 'discount_rate' in item
        ? item.discount_rate
        : referencePrice
            ? calculateDiscount(item.lprice, referencePrice)
            : 0;

    // ì´ë¯¸ì§€ URL
    const imageUrl = 'image' in item ? item.image : '';

    const handleClick = () => {
        window.open(item.link, '_blank', 'noopener,noreferrer');
        onClick?.();
    };

    const handleExtend = (e: React.MouseEvent) => {
        e.stopPropagation();
        onExtend?.();
    };

    const handleReportClick = (e: React.MouseEvent) => {
        e.stopPropagation();
        // ë¡œê·¸ì¸ ì—†ì´ë„ ì‹ ê³  ê°€ëŠ¥ (ì„¸ì…˜ ê¸°ë°˜)
        setShowReportModal(true);
    };

    const handleReportSubmit = () => {
        onReport?.(reportReason);
        setShowReportModal(false);
    };

    const handlePriceClick = (e: React.MouseEvent) => {
        e.stopPropagation();
        if (!isLoggedIn) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }
        setNewPrice(item.lprice.toString());
        setShowPriceModal(true);
    };

    const handlePriceSubmit = () => {
        const price = parseInt(newPrice.replace(/,/g, ''), 10);
        if (isNaN(price) || price <= 0) {
            alert('ìœ íš¨í•œ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        onUpdatePrice?.(price);
        setShowPriceModal(false);
    };

    return (
        <>
            <motion.div
                layout
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -20 }}
                whileHover={{ scale: 1.02, y: -4 }}
                whileTap={{ scale: 0.98 }}
                onClick={handleClick}
                className="
                    relative flex flex-col p-0 bg-white rounded-[32px]
                    cursor-pointer transition-all duration-300
                    hover:-translate-y-2
                    shadow-[0_10px_40px_-10px_rgba(0,0,0,0.08)]
                    hover:shadow-[0_20px_50px_-12px_rgba(0,0,0,0.12)]
                    group h-full
                "
            >
                {/* ì´ë¯¸ì§€ (Top Half Cover) */}
                <div className="w-full h-48 sm:h-56 relative overflow-hidden bg-stone-50 rounded-t-[32px]">
                    {imageUrl ? (
                        <img
                            src={imageUrl}
                            alt={item.title}
                            className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                            loading="lazy"
                            onError={(e) => {
                                (e.target as HTMLImageElement).src = 'https://via.placeholder.com/300x200?text=No+Image';
                            }}
                        />
                    ) : (
                        <div className="w-full h-full flex items-center justify-center text-5xl opacity-30">
                            ğŸ¸
                        </div>
                    )}
                    {/* ì¶œì²˜ ë±ƒì§€ (Overlay) */}
                    <span
                        className={`
                            absolute top-4 left-4 px-3 py-1.5 rounded-full text-xs font-bold tracking-wide shadow-sm
                            backdrop-blur-md bg-white/90 ${sourceStyle.text}
                        `}
                    >
                        {sourceStyle.label}
                    </span>

                    {/* ìˆœìœ„ (Overlay) */}
                    {rank && rank <= 3 && (
                        <div className="absolute top-4 right-4 z-10 drop-shadow-md">
                            <PickIcon rank={rank} />
                        </div>
                    )}
                </div>

                {/* ì •ë³´ (Padding) */}
                <div className="flex-1 flex flex-col p-6">
                    {/* ìƒë‹¨: ì œëª© */}
                    <div className="mb-4">
                        <h3 className="text-lg font-bold text-stone-800 line-clamp-2 leading-snug group-hover:text-matcha-700 transition-colors">
                            {item.title}
                        </h3>
                    </div>

                    {/* í•˜ë‹¨: ê°€ê²© + í• ì¸ìœ¨ */}
                    <div className="flex items-end justify-between mt-2">
                        <div>
                            <div className="flex items-baseline gap-1.5">
                                <p className="text-2xl sm:text-3xl font-black text-stone-900 tracking-tight">
                                    {formatPrice(item.lprice)}<span className="text-sm sm:text-base font-bold text-stone-400 ml-1">ì›</span>
                                </p>
                            </div>

                            {discount > 0 && (
                                <p className="text-xs text-stone-500 mt-0.5">
                                    ì‹ í’ˆ ëŒ€ë¹„ <span className="text-matcha-600 font-bold">{discount}%</span> ì €ë ´
                                </p>
                            )}
                            {/* ì¶œì²˜ & íŒë§¤ì²˜ & ë°°ì†¡ì •ë³´ */}
                            <div className="flex items-center gap-2 mb-1 flex-wrap">
                                <span className={`px-2 py-0.5 rounded text-[11px] font-medium ${sourceStyle.bg} ${sourceStyle.text}`}>
                                    {sourceStyle.label}
                                </span>
                                {/* íŒë§¤ì²˜ (ë„¤ì´ë²„ë§Œ í‘œì‹œ) */}
                                {source === 'naver' && mallName && (
                                    <span className="text-xs text-stone-500 font-medium">
                                        {mallName}
                                    </span>
                                )}
                                {/* ë¬´ë£Œë°°ì†¡ ë°°ì§€ (ë„¤ì´ë²„ ì•„ì´í…œì— ì„ì˜ ì ìš© or ì¡°ê±´ë¶€) */}
                                {source === 'naver' && (
                                    <span className="px-1.5 py-0.5 rounded bg-stone-100 text-stone-500 text-[10px]">
                                        ë¬´ë£Œë°°ì†¡
                                    </span>
                                )}
                            </div>

                            {/* ê°€ê²© disclaimer (ë„¤ì´ë²„ ì•„ì´í…œë§Œ) */}
                            {source === 'naver' && (
                                <p className="text-[10px] text-stone-400 mt-0.5">
                                    * ê°€ê²©ì´ ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                                </p>
                            )}
                        </div>

                        {/* ë²„íŠ¼ë“¤ */}
                        <div className="flex items-center gap-2">
                            {/* ì—°ì¥ ë²„íŠ¼ (ë³¸ì¸ ë§¤ë¬¼ë§Œ) */}
                            {isOwner && (
                                <button
                                    onClick={handleExtend}
                                    className="px-3 py-1.5 rounded-full bg-matcha-100 text-matcha-700 text-xs font-semibold hover:bg-matcha-200 transition-colors"
                                >
                                    ì—°ì¥
                                </button>
                            )}

                            {/* ìœ ì € ë§¤ë¬¼: ê°€ê²© ì—…ë°ì´íŠ¸ ë²„íŠ¼ (íŒŒë€ìƒ‰) */}
                            {isUserItem && !isOwner && onUpdatePrice && (
                                <button
                                    onClick={handlePriceClick}
                                    className="w-8 h-8 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center hover:bg-blue-200 transition-colors"
                                    title="ê°€ê²© ì—…ë°ì´íŠ¸"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                            )}

                            {/* ìœ ì € ë§¤ë¬¼: ì‹ ê³  ë²„íŠ¼ (ì£¼í™©ìƒ‰) */}
                            {isUserItem && !isOwner && onReport && (
                                <button
                                    onClick={handleReportClick}
                                    className="w-8 h-8 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center hover:bg-orange-200 transition-colors"
                                    title="ì‹ ê³ í•˜ê¸°"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                </button>
                            )}

                            {/* í™”ì‚´í‘œ ì•„ì´ì½˜ */}
                            <div className="w-8 h-8 rounded-full bg-stone-50 flex items-center justify-center text-stone-400 group-hover:bg-matcha-50 group-hover:text-matcha-600 transition-colors">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 5l7 7-7 7" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </motion.div>

            {/* ì‹ ê³  ëª¨ë‹¬ */}
            <AnimatePresence>
                {showReportModal && (
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
                        onClick={() => setShowReportModal(false)}
                    >
                        <motion.div
                            initial={{ scale: 0.9, opacity: 0 }}
                            animate={{ scale: 1, opacity: 1 }}
                            exit={{ scale: 0.9, opacity: 0 }}
                            className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-xl"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <h3 className="text-lg font-bold text-stone-800 mb-4">ğŸš¨ ì‹ ê³ í•˜ê¸°</h3>
                            <div className="space-y-2 mb-4">
                                {(Object.keys(REPORT_REASON_LABELS) as ReportReason[]).map((reason) => (
                                    <label
                                        key={reason}
                                        className={`flex items-center gap-2 p-3 rounded-lg cursor-pointer transition-colors ${reportReason === reason ? 'bg-red-50 border-red-200 border' : 'bg-stone-50 hover:bg-stone-100'
                                            }`}
                                    >
                                        <input
                                            type="radio"
                                            name="report-reason"
                                            value={reason}
                                            checked={reportReason === reason}
                                            onChange={() => setReportReason(reason)}
                                            className="accent-red-500"
                                        />
                                        <span className="text-sm text-stone-700">{REPORT_REASON_LABELS[reason]}</span>
                                    </label>
                                ))}
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setShowReportModal(false)}
                                    className="flex-1 py-2 rounded-lg bg-stone-100 text-stone-600 font-medium hover:bg-stone-200 transition-colors"
                                >
                                    ì·¨ì†Œ
                                </button>
                                <button
                                    onClick={handleReportSubmit}
                                    className="flex-1 py-2 rounded-lg bg-red-500 text-white font-medium hover:bg-red-600 transition-colors"
                                >
                                    ì‹ ê³ 
                                </button>
                            </div>
                        </motion.div>
                    </motion.div>
                )}
            </AnimatePresence>

            {/* ê°€ê²© ì—…ë°ì´íŠ¸ ëª¨ë‹¬ */}
            <AnimatePresence>
                {showPriceModal && (
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
                        onClick={() => setShowPriceModal(false)}
                    >
                        <motion.div
                            initial={{ scale: 0.9, opacity: 0 }}
                            animate={{ scale: 1, opacity: 1 }}
                            exit={{ scale: 0.9, opacity: 0 }}
                            className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-xl"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <h3 className="text-lg font-bold text-stone-800 mb-4">ğŸ’° ê°€ê²© ì—…ë°ì´íŠ¸</h3>
                            <p className="text-sm text-stone-500 mb-4">
                                ê°€ê²©ì´ ë³€ë™ë˜ì—ˆë‚˜ìš”? ìƒˆ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.
                            </p>
                            <div className="relative mb-4">
                                <input
                                    type="text"
                                    value={newPrice}
                                    onChange={(e) => setNewPrice(e.target.value.replace(/[^0-9]/g, ''))}
                                    className="w-full px-4 py-3 rounded-lg border border-stone-200 focus:border-matcha-400 focus:ring-2 focus:ring-matcha-100 outline-none text-lg"
                                    placeholder="ê°€ê²© ì…ë ¥"
                                />
                                <span className="absolute right-4 top-1/2 -translate-y-1/2 text-stone-400">ì›</span>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setShowPriceModal(false)}
                                    className="flex-1 py-2 rounded-lg bg-stone-100 text-stone-600 font-medium hover:bg-stone-200 transition-colors"
                                >
                                    ì·¨ì†Œ
                                </button>
                                <button
                                    onClick={handlePriceSubmit}
                                    className="flex-1 py-2 rounded-lg bg-matcha-500 text-white font-medium hover:bg-matcha-600 transition-colors"
                                >
                                    ì—…ë°ì´íŠ¸
                                </button>
                            </div>
                        </motion.div>
                    </motion.div>
                )}
            </AnimatePresence>
        </>
    );
}
</file>

<file path="src/components/MatchaBounceLoader.tsx">
/**
 * Matcha-Bounce Loader Component
 * 
 * Features:
 * - GIF ì´ë¯¸ì§€ë§Œ í¬ê²Œ í‘œì‹œ
 * - ì™„ë£Œ ì‹œ ìŠ¬ë¼ì´ë“œ ì•„ì›ƒ
 */

import { motion, AnimatePresence } from 'framer-motion';
import daguLoadingGif from '../assets/daguLoading.gif';

interface MatchaBounceLoaderProps {
    isVisible: boolean;
    onComplete?: () => void;
}

export default function MatchaBounceLoader({
    isVisible,
    onComplete
}: MatchaBounceLoaderProps) {
    return (
        <AnimatePresence onExitComplete={onComplete}>
            {isVisible && (
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{
                        opacity: 0,
                        y: -100,
                        transition: { duration: 0.4, ease: 'easeInOut' }
                    }}
                    className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white"
                >
                    {/* ë©”ì¸ GIF ì´ë¯¸ì§€ */}
                    <img
                        src={daguLoadingGif}
                        alt="ë‹¤êµ¬ ë¡œë”©"
                        className="max-w-md max-h-md"
                    />
                    {/* ë¡œë”© í…ìŠ¤íŠ¸ */}
                    <p className="mt-4 text-lg text-stone-600 font-medium">
                        ë‹¤êµ¬ê°€ ì•…ê¸°ë¥¼ ë‚šëŠ”ì¤‘...
                    </p>
                </motion.div>
            )}
        </AnimatePresence>
    );
}
</file>

<file path="src/components/SearchBar.tsx">
/**
 * Search Bar Component
 * 
 * Features:
 * - ëª¨ë°”ì¼ í¼ìŠ¤íŠ¸ ë””ìì¸
 * - DBì—ì„œ ì•…ê¸° ëª©ë¡ ìë™ì™„ì„±
 * - ê²€ìƒ‰ ë²„íŠ¼ hover íš¨ê³¼
 */

import { useState, useEffect, useRef, type FormEvent } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

interface SearchBarProps {
    onSearch: (query: string) => void;
    isLoading?: boolean;
    placeholder?: string;
    initialValue?: string;
    showSuggestions?: boolean;
}

interface Instrument {
    id: string;
    brand: string;
    name: string;  // APIì—ì„œëŠ” 'name' í•„ë“œ ì‚¬ìš©
    category: string;
}

export default function SearchBar({
    onSearch,
    isLoading = false,
    placeholder = 'ì•…ê¸° ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰ (ì˜ˆ: íœë” ìŠ¤íŠ¸ë«)',
    initialValue = '',
    showSuggestions = true,
}: SearchBarProps) {
    const [query, setQuery] = useState(initialValue);
    const [isFocused, setIsFocused] = useState(false);
    const [instruments, setInstruments] = useState<Instrument[]>([]);
    const [suggestions, setSuggestions] = useState<Instrument[]>([]);
    const [showDropdown, setShowDropdown] = useState(false);
    const wrapperRef = useRef<HTMLDivElement>(null);

    // DBì—ì„œ ì•…ê¸° ëª©ë¡ ë¡œë“œ (ìµœì´ˆ 1íšŒ)
    useEffect(() => {
        async function fetchInstruments() {
            try {
                const res = await fetch('/api/instruments/');
                if (res.ok) {
                    const data = await res.json();
                    // DRF í˜ì´ì§€ë„¤ì´ì…˜ ì‘ë‹µ ì²˜ë¦¬ (results ë°°ì—´)
                    const results = data.results || data;
                    setInstruments(Array.isArray(results) ? results : []);
                }
            } catch (error) {
                console.error('ì•…ê¸° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        fetchInstruments();
    }, []);

    // ì…ë ¥ì— ë”°ë¥¸ ì¶”ì²œ í•„í„°ë§
    useEffect(() => {
        if (query.trim().length > 0 && showSuggestions && instruments.length > 0) {
            const queryLower = query.toLowerCase();
            const filtered = instruments.filter(item => {
                const brand = item.brand || '';
                const modelName = item.name || '';
                const fullName = `${brand} ${modelName}`.toLowerCase();
                return fullName.includes(queryLower) ||
                    brand.toLowerCase().includes(queryLower) ||
                    modelName.toLowerCase().includes(queryLower);
            }).slice(0, 6); // ìµœëŒ€ 6ê°œ
            setSuggestions(filtered);
            setShowDropdown(filtered.length > 0 && isFocused);
        } else {
            setSuggestions([]);
            setShowDropdown(false);
        }
    }, [query, isFocused, showSuggestions, instruments]);

    // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    useEffect(() => {
        function handleClickOutside(event: MouseEvent) {
            if (wrapperRef.current && !wrapperRef.current.contains(event.target as Node)) {
                setShowDropdown(false);
            }
        }
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    const handleSubmit = (e: FormEvent) => {
        e.preventDefault();
        if (query.trim()) {
            onSearch(query.trim());
            setShowDropdown(false);
        }
    };

    const handleSuggestionClick = (instrument: Instrument) => {
        const searchTerm = `${instrument.brand} ${instrument.name}`;
        setQuery(searchTerm);
        onSearch(searchTerm);
        setShowDropdown(false);
    };

    // ì¹´í…Œê³ ë¦¬ë³„ ì´ëª¨ì§€
    const getCategoryEmoji = (category: string) => {
        switch (category.toLowerCase()) {
            case 'ì¼ë ‰ê¸°íƒ€': case 'guitar': return 'ğŸ¸';
            case 'ë² ì´ìŠ¤': case 'bass': return 'ğŸ¸';
            case 'ì´í™í„°': case 'pedal': case 'effects': return 'ğŸ”Š';
            case 'ì•°í”„': case 'amp': return 'ğŸ”ˆ';
            case 'ì–´ì¿ ìŠ¤í‹±': case 'acoustic': return 'ğŸª•';
            default: return 'ğŸµ';
        }
    };

    return (
        <motion.form
            onSubmit={handleSubmit}
            className="w-full max-w-2xl mx-auto"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.5 }}
        >
            <div ref={wrapperRef} className="relative">
                <div
                    className={`
                        relative flex items-center gap-2 p-3 rounded-full transition-all duration-300
                        ${isFocused
                            ? 'bg-white shadow-[0_8px_30px_rgba(0,0,0,0.12)] ring-2 ring-matcha-500 transform -translate-y-1'
                            : 'bg-white shadow-[0_4px_20px_rgba(0,0,0,0.08)] hover:shadow-[0_8px_25px_rgba(0,0,0,0.12)] hover:-translate-y-0.5'
                        }
                    `}
                    style={{ backdropFilter: 'blur(8px)' }}
                >
                    {/* ê²€ìƒ‰ ì•„ì´ì½˜ */}
                    <div className={`pl-4 transition-colors duration-300 ${isFocused ? 'text-matcha-500' : 'text-stone-400'}`}>
                        <svg
                            className="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={2}
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                            />
                        </svg>
                    </div>

                    {/* ì…ë ¥ í•„ë“œ */}
                    <input
                        type="text"
                        value={query}
                        onChange={(e) => setQuery(e.target.value)}
                        onFocus={() => setIsFocused(true)}
                        onBlur={() => setTimeout(() => setIsFocused(false), 150)}
                        placeholder={placeholder}
                        disabled={isLoading}
                        autoComplete="off"
                        className="
                            flex-1 py-3 px-2 bg-transparent outline-none
                            text-stone-800 placeholder-stone-400
                            text-base sm:text-lg caret-matcha-500
                        "
                    />

                    {/* ê²€ìƒ‰ ë²„íŠ¼ */}
                    <motion.button
                        type="submit"
                        disabled={isLoading}
                        whileHover={{ scale: 1.02 }}
                        whileTap={{ scale: 0.98 }}
                        className={`
                            px-8 py-4 rounded-xl font-bold text-lg text-white
                            transition-all duration-200
                            ${isLoading
                                ? 'bg-stone-300 cursor-not-allowed'
                                : 'bg-[#10B981] hover:bg-[#059669] shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/40 hover:scale-105 active:scale-95'
                            }
                        `}
                    >
                        {isLoading ? (
                            <motion.div
                                className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full"
                                animate={{ rotate: 360 }}
                                transition={{ duration: 1, repeat: Infinity, ease: 'linear' }}
                            />
                        ) : (
                            <span className="whitespace-nowrap">ê²€ìƒ‰</span>
                        )}
                    </motion.button>
                </div>

                {/* ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ (DB ì•…ê¸° ëª©ë¡) */}
                <AnimatePresence>
                    {showDropdown && suggestions.length > 0 && (
                        <motion.div
                            initial={{ opacity: 0, y: -10 }}
                            animate={{ opacity: 1, y: 0 }}
                            exit={{ opacity: 0, y: -10 }}
                            transition={{ duration: 0.15 }}
                            className="
                                absolute z-50 w-full mt-2 py-2
                                bg-white rounded-xl shadow-xl border border-stone-100
                                overflow-hidden
                            "
                        >
                            <p className="px-4 py-1 text-[10px] text-stone-400 uppercase tracking-wider">
                                ë“±ë¡ëœ ì•…ê¸°
                            </p>
                            {suggestions.map((instrument) => (
                                <button
                                    key={instrument.id}
                                    type="button"
                                    onClick={() => handleSuggestionClick(instrument)}
                                    className="
                                        w-full px-4 py-3 text-left flex items-center gap-3
                                        hover:bg-matcha-50 transition-colors
                                        text-stone-700 hover:text-matcha-700
                                    "
                                >
                                    <span className="text-lg">{getCategoryEmoji(instrument.category)}</span>
                                    <div className="flex-1">
                                        <p className="font-medium">{instrument.brand} {instrument.name}</p>
                                        <p className="text-xs text-stone-400">{instrument.category}</p>
                                    </div>
                                </button>
                            ))}
                        </motion.div>
                    )}
                </AnimatePresence>
            </div>

            {/* ê²€ìƒ‰ íŒíŠ¸ */}
            <motion.p
                className="mt-3 text-center text-sm text-stone-500"
                initial={{ opacity: 0 }}
                animate={{ opacity: 0.8 }}
                transition={{ delay: 0.3 }}
            >
                ë¸Œëœë“œ, ëª¨ë¸ëª…, ë˜ëŠ” ì¹´í…Œê³ ë¦¬ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”
            </motion.p>
        </motion.form>
    );
}
</file>

<file path="src/components/VSComparisonLayout.tsx">
/**
 * VS Comparison Layout Component
 * 
 * Features:
 * - ì¢Œ: ì‹ í’ˆ ê¸°ì¤€ê°€ (Gray tone)
 * - ìš°: ì¤‘ê³  ìµœì €ê°€ ë¦¬ìŠ¤íŠ¸ (Accent color)
 * - ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ
 */

import { motion } from 'framer-motion';
import ItemCard from './ItemCard';
import type { NaverItem, MergedUserItem } from '../types';

interface VSComparisonLayoutProps {
    reference: {
        name: string;
        price: number;
        image_url: string;
    } | null;
    items: (NaverItem | MergedUserItem)[];
    onItemClick?: (item: NaverItem | MergedUserItem) => void;
}

function formatPrice(price: number): string {
    return new Intl.NumberFormat('ko-KR').format(price);
}

export default function VSComparisonLayout({
    reference,
    items,
    onItemClick,
}: VSComparisonLayoutProps) {
    // ìƒìœ„ 5ê°œë§Œ í‘œì‹œ
    const topItems = items.slice(0, 5);
    const lowestPrice = topItems[0]?.lprice || 0;
    const savings = reference ? reference.price - lowestPrice : 0;
    const savingsPercent = reference && reference.price > 0
        ? Math.round((savings / reference.price) * 100)
        : 0;

    return (
        <div className="w-full max-w-5xl mx-auto">
            {/* VS í—¤ë” */}
            <motion.div
                className="flex items-center justify-center gap-4 mb-8"
                initial={{ opacity: 0, y: -20 }}
                animate={{ opacity: 1, y: 0 }}
            >
                <span className="text-stone-400 font-medium">ì‹ í’ˆ</span>
                <div className="w-12 h-12 rounded-full bg-gradient-to-r from-stone-300 to-matcha-400 flex items-center justify-center text-white font-bold text-lg shadow-lg">
                    VS
                </div>
                <span className="text-matcha-600 font-medium">ì¤‘ê³ </span>
            </motion.div>

            {/* ë©”ì¸ ì»¨í…ì¸  */}
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8">
                {/* ì¢Œì¸¡: ì‹ í’ˆ ê¸°ì¤€ê°€ */}
                <motion.div
                    className="lg:col-span-4"
                    initial={{ opacity: 0, x: -30 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: 0.1 }}
                >
                    <div className="sticky top-4 p-6 bg-white/50 backdrop-blur-sm rounded-2xl border border-stone-200 shadow-sm">
                        <h3 className="text-sm font-medium text-stone-500 mb-4 uppercase tracking-wider">
                            Reference Price
                        </h3>

                        {reference ? (
                            <>
                                {/* ì´ë¯¸ì§€ */}
                                {reference.image_url && (
                                    <div className="w-full aspect-square rounded-xl overflow-hidden bg-white mb-6 border border-stone-100 shadow-inner">
                                        <img
                                            src={reference.image_url}
                                            alt={reference.name}
                                            className="w-full h-full object-contain p-4 mix-blend-multiply"
                                        />
                                    </div>
                                )}

                                {/* ì•…ê¸° ì´ë¦„ */}
                                <p className="text-lg font-bold text-stone-800 mb-2 leading-tight">
                                    {reference.name}
                                </p>

                                {/* ê°€ê²© */}
                                <p className="text-2xl font-bold text-stone-400 line-through decoration-2 decoration-stone-300/50">
                                    â‚©{formatPrice(reference.price)}
                                </p>
                                <p className="text-sm text-stone-400 mt-1">ì‹ í’ˆ í‰ê· ê°€</p>

                                {/* ì ˆì•½ ê¸ˆì•¡ */}
                                {savings > 0 && (
                                    <motion.div
                                        className="mt-6 p-4 bg-matcha-50 rounded-xl border border-matcha-100 relative overflow-hidden"
                                        initial={{ opacity: 0, scale: 0.9 }}
                                        animate={{ opacity: 1, scale: 1 }}
                                        transition={{ delay: 0.3 }}
                                    >
                                        <div className="absolute top-0 right-0 -mr-4 -mt-4 w-12 h-12 bg-matcha-200 rounded-full blur-xl opacity-50"></div>

                                        <p className="text-sm font-medium text-matcha-800 mb-1">
                                            ì¤‘ê³ ë¡œ êµ¬ë§¤ ì‹œ
                                        </p>
                                        <div className="flex items-baseline gap-2">
                                            <p className="text-2xl font-bold text-matcha-600">
                                                {savingsPercent}%
                                            </p>
                                            <span className="text-matcha-600 font-medium">Save</span>
                                        </div>
                                        <p className="text-sm text-matcha-600 mt-0.5 opacity-80">
                                            ì•½ â‚©{formatPrice(savings)} ì ˆì•½
                                        </p>
                                    </motion.div>
                                )}
                            </>
                        ) : (
                            <div className="text-center py-8 text-stone-400">
                                <p className="text-4xl mb-2 opacity-50">ğŸ“Š</p>
                                <p>ê¸°ì¤€ê°€ ì •ë³´ ì—†ìŒ</p>
                            </div>
                        )}
                    </div>
                </motion.div>

                {/* ìš°ì¸¡: ì¤‘ê³  ìµœì €ê°€ ë¦¬ìŠ¤íŠ¸ */}
                <motion.div
                    className="lg:col-span-8"
                    initial={{ opacity: 0, x: 30 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: 0.2 }}
                >
                    <div className="flex items-center justify-between mb-4 px-1">
                        <h3 className="text-lg font-bold text-stone-800 flex items-center gap-2">
                            <span className="text-2xl">ğŸ”¥</span> ìµœì €ê°€ TOP {Math.min(topItems.length, 5)}
                        </h3>
                        <span className="text-xs font-medium px-2 py-1 bg-stone-100 rounded-full text-stone-500">
                            ì´ {items.length}ê°œ ë§¤ë¬¼
                        </span>
                    </div>

                    {topItems.length > 0 ? (
                        <div className="space-y-4">
                            {topItems.map((item, index) => (
                                <ItemCard
                                    key={`item-${index}-${'id' in item ? item.id : item.productId}`}
                                    item={item}
                                    rank={index + 1}
                                    referencePrice={reference?.price}
                                    onClick={() => onItemClick?.(item)}
                                />
                            ))}
                        </div>
                    ) : (
                        <div className="text-center py-16 bg-white/50 border border-dashed border-stone-300 rounded-2xl">
                            <p className="text-4xl mb-4 opacity-50">ğŸ¸</p>
                            <p className="text-stone-500 font-medium">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                            <p className="text-sm text-stone-400 mt-1">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì‹œë„í•´ë³´ì„¸ìš”</p>
                        </div>
                    )}

                    {/* ë”ë³´ê¸° (5ê°œ ì´ìƒì¼ ë•Œ) */}
                    {items.length > 5 && (
                        <motion.button
                            className="w-full mt-6 py-4 text-matcha-700 font-bold bg-white border border-matcha-200 rounded-xl hover:bg-matcha-50 hover:border-matcha-300 transition-all shadow-sm"
                            whileHover={{ scale: 1.01, y: -1 }}
                            whileTap={{ scale: 0.99 }}
                        >
                            + {items.length - 5}ê°œ ë”ë³´ê¸°
                        </motion.button>
                    )}
                </motion.div>
            </div>
        </div>
    );
}
</file>

<file path="src/hooks/useAuth.ts">
/**
 * SSO ì¸ì¦ ìƒíƒœ í™•ì¸ Hook.
 * Dagu ë°±ì—”ë“œ APIë¥¼ í†µí•´ HttpOnly ì¿ í‚¤ ì¸ì¦ ìƒíƒœ í™•ì¸.
 */

import { useState, useEffect } from 'react';

interface AuthState {
    isLoggedIn: boolean;
    isLoading: boolean;
    userId: number | null;
    username: string | null;
}

/**
 * ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ Hook
 * HttpOnly ì¿ í‚¤ëŠ” JSì—ì„œ ì½ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë°±ì—”ë“œ APIë¡œ í™•ì¸
 */
export function useAuth(): AuthState {
    const [state, setState] = useState<AuthState>({
        isLoggedIn: false,
        isLoading: true,
        userId: null,
        username: null,
    });

    useEffect(() => {
        const checkAuth = async () => {
            try {
                const response = await fetch('/api/auth/check/', {
                    credentials: 'include', // ì¿ í‚¤ í¬í•¨ (vite í”„ë¡ì‹œ ê²½ìœ )
                });

                if (response.ok) {
                    const data = await response.json();
                    setState({
                        isLoggedIn: data.is_authenticated,
                        isLoading: false,
                        userId: data.user_id || null,
                        username: data.username || null,
                    });
                } else {
                    setState({
                        isLoggedIn: false,
                        isLoading: false,
                        userId: null,
                        username: null,
                    });
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                setState({
                    isLoggedIn: false,
                    isLoading: false,
                    userId: null,
                    username: null,
                });
            }
        };

        checkAuth();
    }, []);

    return state;
}

export default useAuth;
</file>

<file path="src/hooks/useSearch.ts">
/**
 * React Query hooks for MALCHA-DAGU
 */

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import * as api from '../services/api';
import type { SearchResult } from '../types';

// =============================================================================
// Search Hook
// =============================================================================

export function useSearch(query: string, options?: { enabled?: boolean }) {
    return useQuery<SearchResult>({
        queryKey: ['search', query],
        queryFn: () => api.search(query),
        enabled: options?.enabled ?? query.length > 0,
        staleTime: 5 * 60 * 1000, // 5ë¶„ê°„ ìºì‹œ ìœ ì§€
        gcTime: 10 * 60 * 1000, // 10ë¶„ê°„ ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ë°©ì§€
    });
}

// =============================================================================
// Instruments Hook
// =============================================================================

export function useInstruments(params?: {
    brand?: string;
    category?: string;
    search?: string;
}) {
    return useQuery({
        queryKey: ['instruments', params],
        queryFn: () => api.getInstruments(params),
    });
}

export function useInstrument(id: string) {
    return useQuery({
        queryKey: ['instrument', id],
        queryFn: () => api.getInstrument(id),
        enabled: !!id,
    });
}

// =============================================================================
// User Items Hook
// =============================================================================

export function useUserItems(params?: {
    instrument?: string;
    source?: string;
    min_price?: number;
    max_price?: number;
}) {
    return useQuery({
        queryKey: ['userItems', params],
        queryFn: () => api.getUserItems(params),
    });
}

export function useCreateUserItem() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: api.createUserItem,
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['userItems'] });
            queryClient.invalidateQueries({ queryKey: ['search'] });
        },
    });
}

export function useTrackItemClick() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: api.trackItemClick,
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['userItems'] });
        },
    });
}

export function useExtendUserItem() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: api.extendUserItem,
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['search'] });
            queryClient.invalidateQueries({ queryKey: ['userItems'] });
        },
    });
}

export function useReportItem() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: ({ id, reason, detail }: { id: string; reason: string; detail?: string }) =>
            api.reportUserItem(id, { reason, detail }),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['search'] });
            queryClient.invalidateQueries({ queryKey: ['userItems'] });
        },
    });
}

export function useUpdateItemPrice() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: ({ id, price }: { id: string; price: number }) =>
            api.updateItemPrice(id, price),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['search'] });
            queryClient.invalidateQueries({ queryKey: ['userItems'] });
        },
    });
}

// =============================================================================
// AI Description Hook
// =============================================================================

export function useAIDescription() {
    return useMutation({
        mutationFn: api.getAIDescription,
    });
}
</file>

<file path="src/index.css">
@import "tailwindcss";

@theme {
  /* Matcha Green Palette */
  --color-matcha-50: #f0fdf4;
  --color-matcha-100: #dcfce7;
  --color-matcha-200: #bbf7d0;
  --color-matcha-300: #86efac;
  --color-matcha-400: #4ade80;
  --color-matcha-500: #22c55e;
  --color-matcha-600: #16a34a;
  --color-matcha-700: #15803d;
  --color-matcha-800: #166534;
  --color-matcha-900: #14532d;

  /* Cream/Warm Palette */
  --color-cream-50: #fffbeb;
  --color-cream-100: #fef3c7;
  --color-cream-200: #fde68a;
  --color-cream-300: #fcd34d;

  /* Fonts */
  --font-display: 'Outfit', sans-serif;
  --font-body: 'Inter', sans-serif;
}

/* =============================================================================
   Base Layer
   ============================================================================= */
@layer base {
  html {
    scroll-behavior: smooth;
  }

  body {
    font-family: var(--font-body);
    background: linear-gradient(135deg, #FDFBF7 0%, #F9F8F4 100%);
    min-height: 100vh;
    color: var(--color-stone-800);
    @apply antialiased;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-family: var(--font-display);
    @apply font-semibold leading-tight;
  }
}

/* =============================================================================
   Utilities Layer
   ============================================================================= */
@layer utilities {
  .text-gradient {
    background: linear-gradient(135deg, var(--color-matcha-600) 0%, var(--color-matcha-400) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .glass {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .glass-dark {
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  /* Scrollbar */
  .scrollbar-custom::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  .scrollbar-custom::-webkit-scrollbar-track {
    @apply bg-stone-100;
  }

  .scrollbar-custom::-webkit-scrollbar-thumb {
    @apply bg-matcha-400 rounded-full;
  }

  .scrollbar-custom::-webkit-scrollbar-thumb:hover {
    @apply bg-matcha-500;
  }
}

/* =============================================================================
   Components Layer (Animations)
   ============================================================================= */
@layer components {

  /* Using standard tailwind animation utilities where possible, extending custom ones */
  @keyframes bounce-soft {

    0%,
    100% {
      transform: translateY(0);
    }

    50% {
      transform: translateY(-12px);
    }
  }

  @keyframes pulse-glow {

    0%,
    100% {
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
    }

    50% {
      box-shadow: 0 0 40px rgba(34, 197, 94, 0.5);
    }
  }

  @keyframes slide-up {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-bounce-soft {
    animation: bounce-soft 2s ease-in-out infinite;
  }

  .animate-pulse-glow {
    animation: pulse-glow 2s ease-in-out infinite;
  }

  .animate-slide-up {
    animation: slide-up 0.5s ease-out forwards;
  }
}
</file>

<file path="src/main.tsx">
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.tsx'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
)
</file>

<file path="src/pages/HomePage.tsx">
/**
 * Home Page Component
 *
 * Features:
 * - íˆì–´ë¡œ ì„¹ì…˜
 * - ê²€ìƒ‰ë°”
 * - ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´
 * - ê²€ìƒ‰ ì‹œ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
 */

import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { motion } from 'framer-motion';
import SearchBar from '../components/SearchBar';
import { getPopularSearches } from '../services/api';

const DEFAULT_TERMS = ['íœë” ìŠ¤íŠ¸ë«', 'ê¹ìŠ¨ ë ˆìŠ¤í´', 'í…Œì¼ëŸ¬ ì–´ì¿ ìŠ¤í‹±', 'SM58'];

export default function HomePage() {
    const navigate = useNavigate();
    const [popularTerms, setPopularTerms] = useState<string[]>(DEFAULT_TERMS);

    // ì¸ê¸° ê²€ìƒ‰ì–´ ë¡œë“œ
    useEffect(() => {
        async function fetchPopularSearches() {
            try {
                const terms = await getPopularSearches(4);
                if (terms && terms.length > 0) {
                    setPopularTerms(terms);
                }
            } catch (error) {
                console.warn('Failed to fetch popular searches:', error);
                // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ìœ ì§€
            }
        }
        fetchPopularSearches();
    }, []);

    const handleSearch = (query: string) => {
        navigate(`/search?q=${encodeURIComponent(query)}`);
    };

    return (
        <div className="min-h-screen flex flex-col">
            {/* íˆì–´ë¡œ ì„¹ì…˜ */}
            <main className="flex-1 flex flex-col items-center justify-center px-4 py-16">
                {/* ë¡œê³  / íƒ€ì´í‹€ */}
                <motion.div
                    className="text-center mb-12"
                    initial={{ opacity: 0, y: -30 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.6 }}
                >
                    <motion.div
                        className="text-8xl sm:text-9xl mb-6"
                        animate={{
                            y: [0, -10, 0],
                            rotate: [0, -5, 5, 0],
                        }}
                        transition={{
                            duration: 3,
                            repeat: Infinity,
                            ease: 'easeInOut',
                        }}
                    >
                        ğŸµ
                    </motion.div>

                    <h1 className="text-7xl sm:text-8xl font-black mb-8 tracking-tighter text-stone-800">
                        DAGU
                    </h1>

                    <p className="text-2xl sm:text-3xl text-stone-600 max-w-2xl mx-auto leading-relaxed">
                        ì•…ê¸° ì‹œì„¸ë¥¼ í•œëˆˆì— ë¹„êµí•˜ê³ , <br className="sm:hidden" />
                        <span className="bg-matcha-200 text-matcha-900 px-2 py-0.5 mx-1 font-bold rounded-sm inline-block transform -rotate-1">í•©ë¦¬ì ì¸ ê°€ê²©</span>ì— ë“í…œí•˜ì„¸ìš”
                    </p>
                </motion.div>

                {/* ê²€ìƒ‰ë°” */}
                <div className="w-full max-w-xl px-4 relative z-10">
                    <SearchBar onSearch={handleSearch} />
                </div>

                {/* ì¸ê¸° ê²€ìƒ‰ì–´ / ë¹ ë¥¸ ê²€ìƒ‰ */}
                <motion.div
                    className="mt-12 flex flex-col items-center gap-4"
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ delay: 0.5 }}
                >
                    <span className="text-sm font-medium text-stone-400 uppercase tracking-widest text-[11px] mb-2">ì¸ê¸° ê²€ìƒ‰ì–´</span>
                    <div className="flex flex-wrap justify-center gap-2.5">
                        {popularTerms.map((term) => (
                            <motion.button
                                key={term}
                                onClick={() => handleSearch(term)}
                                className="
                                    px-5 py-2.5 text-base bg-white text-stone-600
                                    rounded-full shadow-sm shadow-stone-200
                                    hover:bg-matcha-50 hover:text-matcha-800 hover:shadow-md hover:-translate-y-0.5
                                    transition-all duration-300
                                    flex items-center gap-2
                                "
                                whileHover={{ scale: 1.05, y: -2 }}
                                whileTap={{ scale: 0.95 }}
                            >
                                <span className="opacity-40 text-xs">#</span>
                                {term}
                            </motion.button>
                        ))}
                    </div>
                </motion.div>
            </main>

            {/* í‘¸í„° */}
            <footer className="py-8 text-center text-sm text-stone-400 mt-auto">
                <p>Â© 2026 MALCHA DAGU. ì•…ê¸° ì‹œì„¸ ë¹„êµ ì„œë¹„ìŠ¤</p>
            </footer>
        </div>
    );
}
</file>

<file path="src/pages/SearchResultPage.tsx">
/**
 * Search Result Page Component
 * 
 * Features:
 * - ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ (Staggered Animation)
 * - ë§¤ë¬¼ ë“±ë¡ ë²„íŠ¼ (API ì—°ë™ + ìë™ ì†ŒìŠ¤ ê°ì§€)
 * - React Query ìºì‹± ë° ìë™ ê°±ì‹ 
 */

import { useState, useEffect } from 'react';
import { useSearchParams, useNavigate } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { useQueryClient } from '@tanstack/react-query';
import { AxiosError } from 'axios';
import SearchBar from '../components/SearchBar';
import MatchaBounceLoader from '../components/MatchaBounceLoader';
import ItemCard from '../components/ItemCard';
import { useSearch, useTrackItemClick, useCreateUserItem, useExtendUserItem, useReportItem, useUpdateItemPrice } from '../hooks/useSearch';
import { useAuth } from '../hooks/useAuth';
import type { NaverItem, MergedUserItem, ReportReason } from '../types';

// API ì—ëŸ¬ ì‘ë‹µ íƒ€ì…
interface ApiErrorResponse {
    [key: string]: string | string[];
}

// ì†ŒìŠ¤ ìë™ ê°ì§€ í—¬í¼
const SOURCE_LABELS: Record<string, string> = {
    mule: 'ë®¬ (Mule)',
    joonggonara: 'ì¤‘ê³ ë‚˜ë¼',
    danggn: 'ë‹¹ê·¼ë§ˆì¼“',
    bunjang: 'ë²ˆê°œì¥í„°',
    other: 'ê¸°íƒ€ ì‚¬ì´íŠ¸'
};

const SOURCE_COLORS: Record<string, string> = {
    mule: 'bg-blue-50 text-blue-700 border-blue-200',
    joonggonara: 'bg-green-50 text-green-700 border-green-200',
    danggn: 'bg-orange-50 text-orange-700 border-orange-200',
    bunjang: 'bg-red-50 text-red-700 border-red-200',
    other: 'bg-stone-50 text-stone-600 border-stone-200'
};

function detectSource(url: string): string {
    const lower = url.toLowerCase();
    if (lower.includes('mule.co.kr')) return 'mule';
    if (lower.includes('joonggonara') || (lower.includes('cafe.naver.com') && lower.includes('joon'))) return 'joonggonara';
    if (lower.includes('daangn.com') || lower.includes('danggn')) return 'danggn';
    if (lower.includes('bunjang.co.kr')) return 'bunjang';
    return 'other';
}

const MIN_LOADING_TIME = 3400;

export default function SearchResultPage() {
    const [searchParams, setSearchParams] = useSearchParams();
    const navigate = useNavigate();
    const query = searchParams.get('q') || '';

    const [showLoader, setShowLoader] = useState(true);
    const [minTimeElapsed, setMinTimeElapsed] = useState(false);
    const [showRegisterModal, setShowRegisterModal] = useState(false);

    // SSO ì¸ì¦ ìƒíƒœ í™•ì¸
    const { isLoggedIn } = useAuth();

    // React Queryë¡œ ê²€ìƒ‰
    const { data, isLoading, isError, error } = useSearch(query, {
        enabled: query.length > 0,
    });

    // í´ë¦­ ì¶”ì 
    const trackClick = useTrackItemClick();

    // ì—°ì¥ ê¸°ëŠ¥
    const extendItem = useExtendUserItem();

    // ì‹ ê³  ê¸°ëŠ¥
    const reportItem = useReportItem();

    // ê°€ê²© ì—…ë°ì´íŠ¸ ê¸°ëŠ¥
    const updatePrice = useUpdateItemPrice();

    // ìµœì†Œ ë¡œë”© ì‹œê°„ ë³´ì¥
    useEffect(() => {
        if (!query) return;
        setShowLoader(true);
        setMinTimeElapsed(false);
        const timer = setTimeout(() => setMinTimeElapsed(true), MIN_LOADING_TIME);
        return () => clearTimeout(timer);
    }, [query]);

    useEffect(() => {
        if (!isLoading && minTimeElapsed) {
            setShowLoader(false);
        }
    }, [isLoading, minTimeElapsed]);

    // URLì„ ì •ê·œí™”ëœ ê²€ìƒ‰ì–´ë¡œ ì—…ë°ì´íŠ¸ (íœë” ìŠ¤íŠ¸ë« â†’ fender Stratocaster)
    // ë¡œë”© ì™„ë£Œ í›„ì—ë§Œ ì—…ë°ì´íŠ¸ (ë¶ˆí•„ìš”í•œ ì¬ê²€ìƒ‰ ë°©ì§€)
    useEffect(() => {
        if (!showLoader && data?.search_query && data.search_query.toLowerCase() !== query.toLowerCase()) {
            setSearchParams({ q: data.search_query }, { replace: true });
        }
    }, [showLoader, data?.search_query, query, setSearchParams]);

    const handleSearch = (newQuery: string) => {
        navigate(`/search?q=${encodeURIComponent(newQuery)}`);
    };

    const handleItemClick = (item: NaverItem | MergedUserItem) => {
        if ('id' in item && item.source !== 'naver') {
            trackClick.mutate(item.id);
        }
    };

    const handleExtendItem = (itemId: string) => {
        extendItem.mutate(itemId, {
            onSuccess: () => {
                alert('ë§¤ë¬¼ì´ 72ì‹œê°„ ì—°ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            },
            onError: (err: unknown) => {
                const axiosErr = err as AxiosError<{ error?: string }>;
                const statusCode = axiosErr.response?.status;
                const serverMsg = axiosErr.response?.data?.error;

                if (statusCode === 401) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\nì—°ì¥ì€ ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
                } else if (statusCode === 403) {
                    alert('ë³¸ì¸ ë§¤ë¬¼ë§Œ ì—°ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                } else if (statusCode === 404) {
                    alert('ë§¤ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì´ë¯¸ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë§¤ë¬¼ì…ë‹ˆë‹¤.');
                } else if (statusCode === 500) {
                    alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } else if (!axiosErr.response) {
                    alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                } else {
                    alert(serverMsg || 'ì—°ì¥ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            },
        });
    };

    const handleReportItem = (itemId: string, reason: ReportReason) => {
        reportItem.mutate({ id: itemId, reason }, {
            onSuccess: (data) => {
                if (data.is_deleted) {
                    alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nê°€ê²© ì˜¤ë¥˜ ì‹ ê³ ê°€ ëˆ„ì ë˜ì–´ í•´ë‹¹ ë§¤ë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else if (data.is_under_review) {
                    alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\ní•´ë‹¹ ë§¤ë¬¼ì€ ê²€í†  ëŒ€ê¸° ì¤‘ìœ¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nê°ì‚¬í•©ë‹ˆë‹¤!');
                }
            },
            onError: (err: unknown) => {
                const axiosErr = err as AxiosError<{ error?: string }>;
                const statusCode = axiosErr.response?.status;
                const serverMsg = axiosErr.response?.data?.error;

                // ìƒíƒœ ì½”ë“œë³„ ìƒì„¸ ë©”ì‹œì§€
                if (statusCode === 400) {
                    if (serverMsg?.includes('ì´ë¯¸ ì‹ ê³ ')) {
                        alert('ì´ë¯¸ ì‹ ê³ í•œ ë§¤ë¬¼ì…ë‹ˆë‹¤.\nê°™ì€ ë§¤ë¬¼ì€ í•œ ë²ˆë§Œ ì‹ ê³ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    } else if (serverMsg?.includes('ë³¸ì¸ ë§¤ë¬¼')) {
                        alert('ë³¸ì¸ ë§¤ë¬¼ì€ ì‹ ê³ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    } else {
                        alert(serverMsg || 'ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.');
                    }
                } else if (statusCode === 404) {
                    alert('ë§¤ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì´ë¯¸ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë§¤ë¬¼ì…ë‹ˆë‹¤.');
                } else if (statusCode === 500) {
                    alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } else if (!axiosErr.response) {
                    alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                } else {
                    alert(serverMsg || 'ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            },
        });
    };

    const handleUpdatePrice = (itemId: string, newPrice: number) => {
        updatePrice.mutate({ id: itemId, price: newPrice }, {
            onSuccess: () => {
                alert('ê°€ê²©ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\nê°ì‚¬í•©ë‹ˆë‹¤!');
            },
            onError: (err: unknown) => {
                const axiosErr = err as AxiosError<{ error?: string }>;
                const statusCode = axiosErr.response?.status;
                const serverMsg = axiosErr.response?.data?.error;

                // ìƒíƒœ ì½”ë“œë³„ ìƒì„¸ ë©”ì‹œì§€
                if (statusCode === 400) {
                    if (serverMsg?.includes('ìœ íš¨í•œ ê°€ê²©')) {
                        alert('ìœ íš¨í•œ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n0ë³´ë‹¤ í° ìˆ«ìë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
                    } else if (serverMsg?.includes('ë„ˆë¬´ ë†’')) {
                        alert('ê°€ê²©ì´ ë„ˆë¬´ ë†’ìŠµë‹ˆë‹¤.\n1ì–µì› ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    } else {
                        alert(serverMsg || 'ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.');
                    }
                } else if (statusCode === 401) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\nê°€ê²© ì—…ë°ì´íŠ¸ëŠ” ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
                } else if (statusCode === 404) {
                    alert('ë§¤ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì´ë¯¸ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë§¤ë¬¼ì…ë‹ˆë‹¤.');
                } else if (statusCode === 500) {
                    alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } else if (!axiosErr.response) {
                    alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                } else {
                    alert(serverMsg || 'ê°€ê²© ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            },
        });
    };

    // ì†Œìœ ì ì—¬ë¶€ í™•ì¸ (is_owner í•„ë“œê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ false)
    const isItemOwner = (item: NaverItem | MergedUserItem): boolean => {
        if (!isLoggedIn) return false;
        // UserItemSerializerì—ì„œ is_owner í•„ë“œ ì œê³µ ì‹œ ì‚¬ìš©
        if ('is_owner' in item) return (item as { is_owner: boolean }).is_owner;
        return false;
    };

    if (!query) {
        navigate('/');
        return null;
    }

    const allItems = data?.items || [];

    return (
        <div className="min-h-screen">
            <MatchaBounceLoader isVisible={showLoader} />

            {!showLoader && (
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ duration: 0.4 }}
                >
                    {/* í—¤ë” */}
                    <header className="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-stone-200 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <div className="flex items-center gap-4">
                                <motion.button
                                    onClick={() => navigate('/')}
                                    className="text-2xl font-black text-matcha-600 tracking-tight"
                                    whileHover={{ scale: 1.05 }}
                                    whileTap={{ scale: 0.95 }}
                                >
                                    DAGU
                                </motion.button>
                                <div className="flex-1 max-w-2xl">
                                    <SearchBar
                                        onSearch={handleSearch}
                                        isLoading={isLoading}
                                        initialValue={query}
                                        placeholder="ë‹¤ë¥¸ ì•…ê¸° ê²€ìƒ‰"
                                    />
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* ë©”ì¸ Container (Grid Layout) */}
                    <main className="max-w-7xl mx-auto px-4 py-8 grid lg:grid-cols-[1fr_280px] gap-8 items-start">

                        {/* Left Column: Results */}
                        <div className="min-w-0">
                            {/* Title & Count */}
                            <div className="mb-6">
                                <h1 className="text-3xl font-bold text-stone-800 tracking-tight">
                                    "<span className="text-matcha-600">{query}</span>" ê²€ìƒ‰ ê²°ê³¼
                                </h1>
                                {data && (
                                    <p className="text-stone-500 mt-2 font-medium">
                                        ì´ {data.total_count}ê°œì˜ ë§¤ë¬¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤
                                    </p>
                                )}
                            </div>

                            {/* Mobile External Search Buttons (Visible only on < lg) */}
                            {/* ì™¸ë¶€ ê²€ìƒ‰ì€ ì •ê·œí™”ëœ ê²€ìƒ‰ì–´ ì‚¬ìš© (search_query: fender Stratocaster ë“±) */}
                            <div className="lg:hidden mb-8">
                                <ExternalSearchButtons query={data?.search_query || query} vertical={false} />
                            </div>

                            {/* ì—ëŸ¬ */}
                            {isError && (
                                <div className="text-center py-12 bg-red-50 rounded-2xl border border-red-100 mb-8">
                                    <p className="text-4xl mb-4">ğŸ˜µ</p>
                                    <p className="text-red-700 font-medium">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>
                                    <p className="text-red-500 text-sm mt-2">
                                        {error instanceof Error ? error.message : 'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'}
                                    </p>
                                </div>
                            )}

                            {/* ê²°ê³¼ ì—†ìŒ */}
                            {data && data.total_count === 0 && (
                                <div className="text-center py-16 bg-stone-50 rounded-2xl border border-dashed border-stone-300 mb-8">
                                    <p className="text-4xl mb-4 opacity-50">ğŸ¸</p>
                                    <p className="text-stone-600 font-medium">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                    <p className="text-stone-400 text-sm mt-2">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì‹œë„í•´ë³´ì„¸ìš”</p>
                                </div>
                            )}

                            {/* ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ */}
                            {allItems.length > 0 && (
                                <motion.div
                                    className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
                                    variants={{
                                        hidden: { opacity: 0 },
                                        show: {
                                            opacity: 1,
                                            transition: {
                                                staggerChildren: 0.1
                                            }
                                        }
                                    }}
                                    initial="hidden"
                                    animate="show"
                                >
                                    {allItems.map((item, index) => (
                                        <motion.div
                                            key={`item-${index}-${'id' in item ? item.id : item.productId}`}
                                            variants={{
                                                hidden: { opacity: 0, y: 20 },
                                                show: { opacity: 1, y: 0 }
                                            }}
                                        >
                                            <ItemCard
                                                item={item}
                                                rank={index + 1}
                                                referencePrice={data?.reference?.price}
                                                onClick={() => handleItemClick(item)}
                                                isOwner={isItemOwner(item)}
                                                isLoggedIn={isLoggedIn}
                                                onExtend={'id' in item ? () => handleExtendItem(item.id) : undefined}
                                                onReport={'id' in item && item.source !== 'naver' ? (reason) => handleReportItem(item.id, reason) : undefined}
                                                onUpdatePrice={'id' in item && item.source !== 'naver' ? (price) => handleUpdatePrice(item.id, price) : undefined}
                                            />
                                        </motion.div>
                                    ))}
                                </motion.div>
                            )}
                        </div>

                        {/* Right Column: Sticky Sidebar (Visible only on >= lg) */}
                        <aside className="hidden lg:block h-full">
                            <div className="sticky top-24 space-y-4">
                                <div className="p-4 bg-stone-50 rounded-2xl border border-stone-100">
                                    <h3 className="text-sm font-bold text-stone-500 mb-3 uppercase tracking-wider">ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì—ì„œ ì°¾ê¸°</h3>
                                    <ExternalSearchButtons query={data?.search_query || query} vertical={true} />
                                </div>
                                {/* ì¶”í›„ ë‹¤ë¥¸ ì‚¬ì´ë“œë°” ì»¨í…ì¸  ì¶”ê°€ ê°€ëŠ¥ (ì˜ˆ: ê´‘ê³ , ì¶”ì²œ ê²€ìƒ‰ì–´ ë“±) */}
                            </div>
                        </aside>

                    </main>

                    {/* FAB (ë§¤ë¬¼ ë“±ë¡) - ë¡œê·¸ì¸ ì‹œì—ë§Œ í‘œì‹œ */}
                    {isLoggedIn && (
                        <motion.button
                            onClick={() => setShowRegisterModal(true)}
                            className="
                                fixed bottom-8 right-8 z-50
                                w-14 h-14 rounded-full
                                bg-matcha-500 text-white
                                shadow-[0_4px_0_0_#16a34a]
                                flex items-center justify-center
                                hover:bg-matcha-600 active:shadow-[0_2px_0_0_#16a34a] active:translate-y-[2px]
                                transition-all duration-150
                            "
                            initial={{ scale: 0, rotate: 90 }}
                            animate={{ scale: 1, rotate: 0 }}
                            whileHover={{ scale: 1.05 }}
                            whileTap={{ scale: 0.95 }}
                        >
                            <svg className="w-7 h-7" fill="none" stroke="currentColor" strokeWidth={2.5} viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                        </motion.button>
                    )}
                </motion.div>
            )}

            {/* ë§¤ë¬¼ ë“±ë¡ ëª¨ë‹¬ */}
            <AnimatePresence>
                {showRegisterModal && (
                    <RegisterModal
                        query={query}
                        onClose={() => setShowRegisterModal(false)}
                    />
                )}
            </AnimatePresence>
        </div>
    );
}

// ì™¸ë¶€ ê²€ìƒ‰ ë²„íŠ¼ ì»´í¬ë„ŒíŠ¸
const ExternalSearchButtons = ({ query, vertical }: { query: string, vertical: boolean }) => (
    <div className={`flex ${vertical ? 'flex-col gap-3' : 'flex-wrap gap-2'}`}>
        {/* Mule */}
        <a
            href={`https://www.mule.co.kr/bbs/market/sell?page=1&map=list&mode=list&region=&start_price=&end_price=&qf=title&qs=${encodeURIComponent(query)}&category=&ct1=&ct2=&ct3=&store=&options=&soldout=&sell_status=&sido=&gugun=&dong=&period=&of=wdate&od=desc&andor=and&v=l`}
            target="_blank"
            rel="noopener noreferrer"
            className={`
                flex items-center ${vertical ? 'justify-between px-5 py-4' : 'justify-center gap-2 px-6 py-3'} 
                rounded-xl bg-blue-100 text-blue-700
                hover:bg-blue-200 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-blue-200/50
                transition-all duration-200 group
            `}
        >
            <span className={`font-bold ${vertical ? 'text-base' : ''}`}>Mule</span>
            <svg className="w-4 h-4 opacity-70 group-hover:translate-x-0.5 group-hover:opacity-100 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        </a>

        {/* Reverb */}
        <a
            href={`https://reverb.com/marketplace?query=${encodeURIComponent(query)}`}
            target="_blank"
            rel="noopener noreferrer"
            className={`
                flex items-center ${vertical ? 'justify-between px-5 py-4' : 'justify-center gap-2 px-6 py-3'} 
                rounded-xl bg-yellow-100 text-yellow-700
                hover:bg-yellow-200 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-yellow-200/50
                transition-all duration-200 group
            `}
        >
            <span className={`font-bold ${vertical ? 'text-base' : ''}`}>Reverb</span>
            <svg className="w-4 h-4 opacity-70 group-hover:translate-x-0.5 group-hover:opacity-100 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        </a>

        {/* Digimart */}
        <a
            href={`https://www.digimart.net/search?productKeyword=${encodeURIComponent(query)}`}
            target="_blank"
            rel="noopener noreferrer"
            className={`
                flex items-center ${vertical ? 'justify-between px-5 py-4' : 'justify-center gap-2 px-6 py-3'} 
                rounded-xl bg-red-100 text-red-700
                hover:bg-red-200 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-red-200/50
                transition-all duration-200 group
            `}
        >
            <span className={`font-bold ${vertical ? 'text-base' : ''}`}>Digimart</span>
            <svg className="w-4 h-4 opacity-70 group-hover:translate-x-0.5 group-hover:opacity-100 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        </a>
    </div>
);

// ë§¤ë¬¼ ë“±ë¡ ëª¨ë‹¬
function RegisterModal({ query, onClose }: { query: string; onClose: () => void }) {
    const [price, setPrice] = useState('');
    const [link, setLink] = useState('');
    const [detectedSource, setDetectedSource] = useState('other');

    // ë§í¬ ì…ë ¥ ì‹œ ì†ŒìŠ¤ ê°ì§€
    useEffect(() => {
        setDetectedSource(detectSource(link));
    }, [link]);

    // API Hook
    const createUserItem = useCreateUserItem();
    const queryClient = useQueryClient();

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();

        // 1. ë§í¬ URL ë³´ì • (http/https ì—†ìœ¼ë©´ ì¶”ê°€)
        let finalLink = link.trim();
        if (finalLink && !finalLink.match(/^https?:\/\//)) {
            finalLink = `https://${finalLink}`;
        }

        // 2. ìµœì¢… ì†ŒìŠ¤ ê²°ì •
        const finalSource = detectSource(finalLink);

        createUserItem.mutate({
            title: query,
            price: Number(price),
            link: finalLink,
            source: finalSource
        }, {
            onSuccess: () => {
                // ê²€ìƒ‰ ê²°ê³¼ ì¦‰ì‹œ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
                queryClient.refetchQueries({ queryKey: ['search'] });

                const sourceName = SOURCE_LABELS[finalSource] || 'ë“±ë¡ëœ ë§¤ë¬¼';
                alert(`${sourceName} ë§¤ë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¸`);
                onClose();
            },
            onError: (err: Error) => {
                const error = err as AxiosError<ApiErrorResponse>;
                console.error('Failed to register item:', error);

                let errorMsg = 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                try {
                    const data = error.response?.data;
                    if (data) {
                        // JSON ë¬¸ìì—´ë¡œ ë³€í™˜ í›„ íŒŒì‹±
                        const jsonStr = JSON.stringify(data);
                        if (jsonStr.includes('ì´ë¯¸ ë“±ë¡ëœ')) {
                            errorMsg = 'ì´ë¯¸ ë“±ë¡ëœ ë§¤ë¬¼ì…ë‹ˆë‹¤.';
                        } else if (jsonStr.includes('í—ˆìš©ë˜ì§€ ì•Šì€')) {
                            errorMsg = 'í—ˆìš©ë˜ì§€ ì•Šì€ ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤.\n(ë®¬, ë²ˆê°œì¥í„°, ë‹¹ê·¼ë§ˆì¼“, ì¤‘ê³ ë‚˜ë¼ë§Œ ë“±ë¡ ê°€ëŠ¥)';
                        } else {
                            // ëª¨ë“  ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ì¶œ
                            const messages: string[] = [];
                            Object.values(data).forEach(value => {
                                if (Array.isArray(value)) {
                                    messages.push(...value.map(v => String(v)));
                                } else if (typeof value === 'string') {
                                    messages.push(value);
                                }
                            });
                            errorMsg = messages.join('\n') || 'ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                        }
                    }
                } catch {
                    errorMsg = error.message || 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                }
                alert(errorMsg);
            }
        });
    };

    return (
        <motion.div
            className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
        >
            <motion.div
                className="w-full max-w-md bg-white rounded-2xl shadow-2xl p-6"
                initial={{ scale: 0.9, y: 20 }}
                animate={{ scale: 1, y: 0 }}
                exit={{ scale: 0.9, y: 20 }}
                onClick={(e) => e.stopPropagation()}
            >
                <div className="flex items-center justify-between mb-4">
                    <h2 className="text-xl font-bold text-stone-800">ë§¤ë¬¼ ë“±ë¡</h2>
                    <button
                        onClick={onClose}
                        className="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-500 hover:bg-stone-200"
                    >
                        âœ•
                    </button>
                </div>

                {/* ì•…ê¸°ëª… í‘œì‹œ (ìë™) */}
                <div className="mb-4 p-3 bg-matcha-50 rounded-xl border border-matcha-100">
                    <p className="text-xs text-matcha-600 font-medium mb-1">ì•…ê¸°ëª…</p>
                    <p className="text-lg font-bold text-matcha-800">{query}</p>
                </div>

                <form onSubmit={handleSubmit} className="space-y-4">
                    {/* ê°€ê²© */}
                    <div>
                        <label className="block text-sm font-medium text-stone-700 mb-1.5">
                            ê°€ê²© (ì›)
                        </label>
                        <input
                            type="number"
                            value={price}
                            onChange={(e) => setPrice(e.target.value)}
                            className="w-full px-4 py-3 rounded-xl border border-stone-200 focus:border-matcha-400 focus:ring-2 focus:ring-matcha-100 outline-none transition-all"
                            placeholder="ì˜ˆ: 850000"
                            required
                        />
                    </div>

                    {/* ë§í¬ */}
                    <div>
                        <label className="block text-sm font-medium text-stone-700 mb-1.5">
                            ë§¤ë¬¼ ë§í¬
                        </label>
                        <input
                            type="text"
                            value={link}
                            onChange={(e) => setLink(e.target.value)}
                            className="w-full px-4 py-3 rounded-xl border border-stone-200 focus:border-matcha-400 focus:ring-2 focus:ring-matcha-100 outline-none transition-all"
                            placeholder="ì˜ˆ: mule.co.kr/..."
                            required
                        />

                        {/* URL ê°ì§€ ê²°ê³¼ í‘œì‹œ */}
                        {link.length > 5 && (
                            <motion.div
                                initial={{ opacity: 0, y: -5 }}
                                animate={{ opacity: 1, y: 0 }}
                                className={`mt-2 flex items-center gap-2 text-sm p-3 rounded-xl border ${SOURCE_COLORS[detectedSource]}`}
                            >
                                <span className="text-lg">
                                    {detectedSource === 'other' ? 'ğŸ”—' : 'âœ…'}
                                </span>
                                <span className="font-bold">
                                    {detectedSource === 'other'
                                        ? 'ì¶œì²˜ë¥¼ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (ê¸°íƒ€ë¡œ ë“±ë¡ë©ë‹ˆë‹¤)'
                                        : `${SOURCE_LABELS[detectedSource]} ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!`}
                                </span>
                            </motion.div>
                        )}
                    </div>

                    {/* ë²„íŠ¼ */}
                    <div className="flex gap-3 pt-2">
                        <button
                            type="button"
                            onClick={onClose}
                            className="flex-1 py-3 rounded-xl border border-stone-200 text-stone-600 font-medium hover:bg-stone-50 transition-colors"
                        >
                            ì·¨ì†Œ
                        </button>
                        <button
                            type="submit"
                            disabled={createUserItem.isPending}
                            className={`flex-1 py-3 rounded-xl text-white font-bold transition-all shadow-md active:scale-95 disabled:opacity-50 ${detectedSource !== 'other'
                                ? 'bg-matcha-600 hover:bg-matcha-700 hover:shadow-lg'
                                : 'bg-stone-500 hover:bg-stone-600'
                                }`}
                        >
                            {createUserItem.isPending ? 'ë“±ë¡ ì¤‘...' : 'ë“±ë¡í•˜ê¸°'}
                        </button>
                    </div>
                </form>
            </motion.div>
        </motion.div>
    );
}
</file>

<file path="src/services/api.ts">
/**
 * API client for MALCHA-DAGU backend
 */

import axios from 'axios';
import type { SearchResult, Instrument, UserItem, AIDescription } from '../types';

const api = axios.create({
    baseURL: '/api',
    headers: {
        'Content-Type': 'application/json',
    },
    withCredentials: true,  // SSO ì¿ í‚¤ ì „ì†¡ í•„ìˆ˜
});

// =============================================================================
// Search API
// =============================================================================

export async function search(query: string, display = 20): Promise<SearchResult> {
    const response = await api.get<SearchResult>('/search/', {
        params: { q: query, display },
    });
    return response.data;
}

export async function getPopularSearches(limit = 4): Promise<string[]> {
    const response = await api.get<{ terms: string[] }>('/popular-searches/', {
        params: { limit },
    });
    return response.data.terms;
}

// =============================================================================
// Instrument API
// =============================================================================

export async function getInstruments(params?: {
    brand?: string;
    category?: string;
    search?: string;
}): Promise<Instrument[]> {
    const response = await api.get<{ results: Instrument[] }>('/instruments/', { params });
    return response.data.results || response.data as unknown as Instrument[];
}

export async function getInstrument(id: string): Promise<Instrument> {
    const response = await api.get<Instrument>(`/instruments/${id}/`);
    return response.data;
}

// =============================================================================
// UserItem API
// =============================================================================

export async function getUserItems(params?: {
    instrument?: string;
    source?: string;
    min_price?: number;
    max_price?: number;
}): Promise<UserItem[]> {
    const response = await api.get<{ results: UserItem[] }>('/items/', { params });
    return response.data.results || response.data as unknown as UserItem[];
}

export async function createUserItem(data: {
    instrument?: string;
    price: number;
    link: string;
    source: string;
    title?: string;
}): Promise<UserItem> {
    // instrumentê°€ ì—†ê±°ë‚˜ ë¹ˆ ë¬¸ìì—´ì´ë©´ ì œê±°
    const payload = { ...data };
    if (!payload.instrument) {
        delete payload.instrument;
    }
    const response = await api.post<UserItem>('/items/', payload);
    return response.data;
}

export async function trackItemClick(id: string): Promise<UserItem> {
    const response = await api.post<UserItem>(`/items/${id}/click/`);
    return response.data;
}

export async function extendUserItem(id: string): Promise<UserItem> {
    const response = await api.post<UserItem>(`/items/${id}/extend/`);
    return response.data;
}

export async function reportUserItem(id: string, data: {
    reason: string;
    detail?: string;
}): Promise<{ message: string; report_count: number; is_under_review: boolean; is_deleted: boolean }> {
    const response = await api.post(`/items/${id}/report/`, data);
    return response.data;
}

export async function updateItemPrice(id: string, price: number): Promise<UserItem> {
    const response = await api.post<UserItem>(`/items/${id}/update_price/`, { price });
    return response.data;
}

// =============================================================================
// AI Description API
// =============================================================================

export async function getAIDescription(data: {
    model_name: string;
    brand: string;
    category: string;
}): Promise<AIDescription> {
    const response = await api.post<AIDescription>('/ai/describe/', data);
    return response.data;
}

export default api;
</file>

<file path="src/types/index.ts">
/**
 * Type definitions for MALCHA-DAGU
 */

// =============================================================================
// API Response Types
// =============================================================================

export interface Instrument {
    id: string;
    name: string;
    brand: string;
    category: string;
    category_display: string;
    image_url: string;
    reference_price: number;
    description: string;
    created_at: string;
    updated_at: string;
}

export interface UserItem {
    id: string;
    instrument: string;
    instrument_detail: {
        id: string;
        name: string;
        brand: string;
        image_url: string;
        reference_price: number;
    };
    price: number;
    link: string;
    source: string;
    source_display: string;
    title: string;
    is_active: boolean;
    expired_at: string;
    extended_at: string | null;
    click_count: number;
    discount_rate: number;
    is_expired: boolean;
    is_owner: boolean;
    owner_id: number | null;
    created_at: string;
    updated_at: string;
}

export interface NaverItem {
    title: string;
    link: string;
    image: string;
    lprice: number;
    hprice: number;
    mallName: string;
    productId: string;
    productType: number;
    source: 'naver';
}

export interface SearchResult {
    query: string;
    search_query: string;  // ì •ê·œí™”ëœ ê²€ìƒ‰ì–´ (ì™¸ë¶€ ë§í¬ìš©)
    total_count: number;
    reference: {
        name: string;
        price: number;
        image_url: string;
    } | null;
    items: (NaverItem | MergedUserItem)[];
    naver_items: NaverItem[];
    user_items: MergedUserItem[];
}

export interface MergedUserItem {
    id: string;
    title: string;
    link: string;
    image: string;
    lprice: number;
    source: string;
    source_display: string;
    discount_rate: number;
    instrument_id: string;
    instrument_name: string;
    instrument_brand: string;
    extended_at: string | null;
    report_count: number;
}

// ì‹ ê³  ì‚¬ìœ  íƒ€ì…
export type ReportReason = 'wrong_price' | 'sold_out' | 'fake' | 'inappropriate' | 'other';

export const REPORT_REASON_LABELS: Record<ReportReason, string> = {
    wrong_price: 'ê°€ê²©ì´ ë‹¤ë¦…ë‹ˆë‹¤',
    sold_out: 'ì´ë¯¸ íŒë§¤ì™„ë£Œëœ ë§¤ë¬¼ì…ë‹ˆë‹¤',
    fake: 'í—ˆìœ„/ì‚¬ê¸° ë§¤ë¬¼ì…ë‹ˆë‹¤',
    inappropriate: 'ë¶€ì ì ˆí•œ ë‚´ìš©ì…ë‹ˆë‹¤',
    other: 'ê¸°íƒ€',
};

export interface AIDescription {
    summary: string;
    check_point: string;
}

// =============================================================================
// Component Props Types
// =============================================================================

export interface SearchBarProps {
    onSearch: (query: string) => void;
    isLoading?: boolean;
    placeholder?: string;
}

export interface ItemCardProps {
    item: NaverItem | MergedUserItem;
    rank?: number;
    referencePrice?: number;
    onClick?: () => void;
    isOwner?: boolean;
    isLoggedIn?: boolean;
    onExtend?: () => void;
    onReport?: (reason: ReportReason, detail?: string) => void;
    onUpdatePrice?: (newPrice: number) => void;
}

export interface LoaderProps {
    isVisible: boolean;
    onComplete?: () => void;
}
</file>

<file path="tsconfig.app.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}
</file>

<file path="tsconfig.json">
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
</file>

<file path="tsconfig.node.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import tailwindcss from '@tailwindcss/vite'

// https://vite.dev/config/
export default defineConfig({
  plugins: [
    react(),
    tailwindcss(),
  ],
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8001',
        changeOrigin: true,
      },
    },
  },
})
</file>

</files>
</file>

<file path="frontend/src/assets/react.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
</file>

<file path="frontend/src/components/CategoryHeader.tsx">
import { motion } from 'framer-motion';

interface Props {
    taxonomy: {
        title: string;
        type: string;
        brand: string;
        breadcrumbs: string[];
        description: string;
        logo_url?: string;
    };
}

export default function CategoryHeader({ taxonomy }: Props) {
    return (
        <div className="mb-6">
            {/* Breadcrumbs */}
            <div className="flex items-center gap-2 text-xs font-medium text-stone-400 mb-2 overflow-x-auto whitespace-nowrap scrollbar-hide">
                {taxonomy.breadcrumbs.map((crumb, index) => (
                    <div key={index} className="flex items-center gap-2">
                        {index > 0 && <span className="text-stone-300">â€º</span>}
                        <span className={index === taxonomy.breadcrumbs.length - 1 ? "text-matcha-600 font-bold" : "hover:text-stone-600 cursor-pointer transition-colors"}>
                            {crumb}
                        </span>
                    </div>
                ))}
            </div>

            {/* Title & Description */}
            <motion.div
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.4 }}
            >
                <div className="flex items-center gap-4 mb-2">
                    {/* Logo (if available) */}
                    {taxonomy.logo_url && (
                        <img
                            src={taxonomy.logo_url}
                            alt={taxonomy.brand}
                            className="w-12 h-12 object-contain p-1 bg-white rounded-lg border border-stone-100"
                        />
                    )}

                    <div className="flex items-baseline gap-3">
                        <h1 className="text-3xl sm:text-4xl font-black text-stone-800 tracking-tight">
                            {taxonomy.title}
                        </h1>
                        <span className="px-2.5 py-0.5 rounded-full bg-stone-100 text-stone-500 text-[10px] font-bold uppercase tracking-wide border border-stone-200">
                            {taxonomy.type}
                        </span>
                    </div>
                </div>

                <p className="text-stone-500 font-medium leading-relaxed max-w-2xl">
                    {taxonomy.description}
                </p>
            </motion.div>

            {/* Divider */}
            <div className="h-px w-full bg-gradient-to-r from-stone-200 via-stone-100 to-transparent my-6" />
        </div>
    );
}
</file>

<file path="frontend/src/components/VSComparisonLayout.tsx">
/**
 * VS Comparison Layout Component
 * 
 * Features:
 * - ì¢Œ: ì‹ í’ˆ ê¸°ì¤€ê°€ (Gray tone)
 * - ìš°: ì¤‘ê³  ìµœì €ê°€ ë¦¬ìŠ¤íŠ¸ (Accent color)
 * - ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ
 */

import { motion } from 'framer-motion';
import ItemCard from './ItemCard';
import type { NaverItem, MergedUserItem } from '../types';

interface VSComparisonLayoutProps {
    reference: {
        name: string;
        price: number;
        image_url: string;
    } | null;
    items: (NaverItem | MergedUserItem)[];
    onItemClick?: (item: NaverItem | MergedUserItem) => void;
}

function formatPrice(price: number): string {
    return new Intl.NumberFormat('ko-KR').format(price);
}

export default function VSComparisonLayout({
    reference,
    items,
    onItemClick,
}: VSComparisonLayoutProps) {
    // ìƒìœ„ 5ê°œë§Œ í‘œì‹œ
    const topItems = items.slice(0, 5);
    const lowestPrice = topItems[0]?.lprice || 0;
    const savings = reference ? reference.price - lowestPrice : 0;
    const savingsPercent = reference && reference.price > 0
        ? Math.round((savings / reference.price) * 100)
        : 0;

    return (
        <div className="w-full max-w-5xl mx-auto">
            {/* VS í—¤ë” */}
            <motion.div
                className="flex items-center justify-center gap-4 mb-8"
                initial={{ opacity: 0, y: -20 }}
                animate={{ opacity: 1, y: 0 }}
            >
                <span className="text-stone-400 font-medium">ì‹ í’ˆ</span>
                <div className="w-12 h-12 rounded-full bg-gradient-to-r from-stone-300 to-matcha-400 flex items-center justify-center text-white font-bold text-lg shadow-lg">
                    VS
                </div>
                <span className="text-matcha-600 font-medium">ì¤‘ê³ </span>
            </motion.div>

            {/* ë©”ì¸ ì»¨í…ì¸  */}
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8">
                {/* ì¢Œì¸¡: ì‹ í’ˆ ê¸°ì¤€ê°€ */}
                <motion.div
                    className="lg:col-span-4"
                    initial={{ opacity: 0, x: -30 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: 0.1 }}
                >
                    <div className="sticky top-4 p-6 bg-white/50 backdrop-blur-sm rounded-2xl border border-stone-200 shadow-sm">
                        <h3 className="text-sm font-medium text-stone-500 mb-4 uppercase tracking-wider">
                            Reference Price
                        </h3>

                        {reference ? (
                            <>
                                {/* ì´ë¯¸ì§€ */}
                                {reference.image_url && (
                                    <div className="w-full aspect-square rounded-xl overflow-hidden bg-white mb-6 border border-stone-100 shadow-inner">
                                        <img
                                            src={reference.image_url}
                                            alt={reference.name}
                                            className="w-full h-full object-contain p-4 mix-blend-multiply"
                                        />
                                    </div>
                                )}

                                {/* ì•…ê¸° ì´ë¦„ */}
                                <p className="text-lg font-bold text-stone-800 mb-2 leading-tight">
                                    {reference.name}
                                </p>

                                {/* ê°€ê²© */}
                                <p className="text-2xl font-bold text-stone-400 line-through decoration-2 decoration-stone-300/50">
                                    â‚©{formatPrice(reference.price)}
                                </p>
                                <p className="text-sm text-stone-400 mt-1">ì‹ í’ˆ í‰ê· ê°€</p>

                                {/* ì ˆì•½ ê¸ˆì•¡ */}
                                {savings > 0 && (
                                    <motion.div
                                        className="mt-6 p-4 bg-matcha-50 rounded-xl border border-matcha-100 relative overflow-hidden"
                                        initial={{ opacity: 0, scale: 0.9 }}
                                        animate={{ opacity: 1, scale: 1 }}
                                        transition={{ delay: 0.3 }}
                                    >
                                        <div className="absolute top-0 right-0 -mr-4 -mt-4 w-12 h-12 bg-matcha-200 rounded-full blur-xl opacity-50"></div>

                                        <p className="text-sm font-medium text-matcha-800 mb-1">
                                            ì¤‘ê³ ë¡œ êµ¬ë§¤ ì‹œ
                                        </p>
                                        <div className="flex items-baseline gap-2">
                                            <p className="text-2xl font-bold text-matcha-600">
                                                {savingsPercent}%
                                            </p>
                                            <span className="text-matcha-600 font-medium">Save</span>
                                        </div>
                                        <p className="text-sm text-matcha-600 mt-0.5 opacity-80">
                                            ì•½ â‚©{formatPrice(savings)} ì ˆì•½
                                        </p>
                                    </motion.div>
                                )}
                            </>
                        ) : (
                            <div className="text-center py-8 text-stone-400">
                                <p className="text-4xl mb-2 opacity-50">ğŸ“Š</p>
                                <p>ê¸°ì¤€ê°€ ì •ë³´ ì—†ìŒ</p>
                            </div>
                        )}
                    </div>
                </motion.div>

                {/* ìš°ì¸¡: ì¤‘ê³  ìµœì €ê°€ ë¦¬ìŠ¤íŠ¸ */}
                <motion.div
                    className="lg:col-span-8"
                    initial={{ opacity: 0, x: 30 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: 0.2 }}
                >
                    <div className="flex items-center justify-between mb-4 px-1">
                        <h3 className="text-lg font-bold text-stone-800 flex items-center gap-2">
                            <span className="text-2xl">ğŸ”¥</span> ìµœì €ê°€ TOP {Math.min(topItems.length, 5)}
                        </h3>
                        <span className="text-xs font-medium px-2 py-1 bg-stone-100 rounded-full text-stone-500">
                            ì´ {items.length}ê°œ ë§¤ë¬¼
                        </span>
                    </div>

                    {topItems.length > 0 ? (
                        <div className="space-y-4">
                            {topItems.map((item, index) => (
                                <ItemCard
                                    key={`item-${index}-${'id' in item ? item.id : item.productId}`}
                                    item={item}
                                    rank={index + 1}
                                    referencePrice={reference?.price}
                                    onClick={() => onItemClick?.(item)}
                                />
                            ))}
                        </div>
                    ) : (
                        <div className="text-center py-16 bg-white/50 border border-dashed border-stone-300 rounded-2xl">
                            <p className="text-4xl mb-4 opacity-50">ğŸ¸</p>
                            <p className="text-stone-500 font-medium">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                            <p className="text-sm text-stone-400 mt-1">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì‹œë„í•´ë³´ì„¸ìš”</p>
                        </div>
                    )}

                    {/* ë”ë³´ê¸° (5ê°œ ì´ìƒì¼ ë•Œ) */}
                    {items.length > 5 && (
                        <motion.button
                            className="w-full mt-6 py-4 text-matcha-700 font-bold bg-white border border-matcha-200 rounded-xl hover:bg-matcha-50 hover:border-matcha-300 transition-all shadow-sm"
                            whileHover={{ scale: 1.01, y: -1 }}
                            whileTap={{ scale: 0.99 }}
                        >
                            + {items.length - 5}ê°œ ë”ë³´ê¸°
                        </motion.button>
                    )}
                </motion.div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/src/main.tsx">
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.tsx'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
)
</file>

<file path="frontend/src/pages/CategoryPage.tsx">
/**
 * Category/Brand Page Component
 * 
 * Handles hierarchical URLs:
 * - /brand/fender
 * - /category/guitar/fender ...
 */

import { useParams, useNavigate, Link } from 'react-router-dom';
import { motion } from 'framer-motion';
import { useSearch } from '../hooks/useSearch';
import SearchBar from '../components/SearchBar';
import ItemCard from '../components/ItemCard';
import MatchaBounceLoader from '../components/MatchaBounceLoader';
import CategoryHeader from '../components/CategoryHeader';
import { useState, useEffect } from 'react';
import { useAuth } from '../hooks/useAuth';

const MIN_LOADING_TIME = 2500;

export default function CategoryPage() {
    const { brand, model, submodel } = useParams<{ brand: string; model?: string; submodel?: string }>();
    const navigate = useNavigate();
    const { isLoggedIn } = useAuth();

    // Construct search query
    const rawQuery = [brand, model, submodel].filter(Boolean).join(' ');

    // Loader state
    const [showLoader, setShowLoader] = useState(true);
    const [minTimeElapsed, setMinTimeElapsed] = useState(false);

    // Search API call
    const { data, isLoading, isError, error } = useSearch(rawQuery, {
        enabled: rawQuery.length > 0,
    });

    // Minimum load time
    useEffect(() => {
        if (!rawQuery) return;
        setShowLoader(true);
        setMinTimeElapsed(false);
        const timer = setTimeout(() => setMinTimeElapsed(true), MIN_LOADING_TIME);
        return () => clearTimeout(timer);
    }, [rawQuery]);

    useEffect(() => {
        if (!isLoading && minTimeElapsed) {
            setShowLoader(false);
        }
    }, [isLoading, minTimeElapsed]);

    const handleSearch = (newQuery: string) => {
        navigate(`/search?q=${encodeURIComponent(newQuery)}`);
    };

    const allItems = data?.items || [];

    // If backend returns taxonomy, use it. Otherwise fallback to simple header.
    const taxonomy = data?.taxonomy;

    return (
        <div className="min-h-screen">
            <MatchaBounceLoader isVisible={showLoader} />

            {!showLoader && (
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ duration: 0.4 }}
                >
                    {/* Header */}
                    <header className="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-stone-200 shadow-sm">
                        <div className="max-w-7xl mx-auto px-3 sm:px-4 py-2 sm:py-4">
                            <div className="flex items-center gap-2 sm:gap-4">
                                <motion.button
                                    onClick={() => navigate('/')}
                                    className="text-lg sm:text-2xl font-black text-matcha-600 tracking-tight shrink-0"
                                    whileHover={{ scale: 1.05 }}
                                    whileTap={{ scale: 0.95 }}
                                >
                                    DAGU
                                </motion.button>
                                <div className="flex-1 min-w-0">
                                    <SearchBar
                                        onSearch={handleSearch}
                                        isLoading={isLoading}
                                        initialValue={rawQuery}
                                        placeholder="ë‹¤ë¥¸ ì•…ê¸° ê²€ìƒ‰"
                                    />
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-3 sm:px-4 py-4 sm:py-8">

                        {/* Breadcrumbs fallback (if no taxonomy) */}
                        {!taxonomy && (
                            <nav className="flex items-center gap-2 text-xs font-medium text-stone-400 mb-4 overflow-x-auto whitespace-nowrap scrollbar-hide">
                                <Link to="/" className="hover:text-stone-600 transition-colors">Home</Link>
                                <span className="text-stone-300">â€º</span>
                                <span className="text-matcha-600 font-bold capitalize">{rawQuery}</span>
                            </nav>
                        )}

                        {/* Category Header (Taxonomy or Fallback) */}
                        <div className="mb-8">
                            {taxonomy ? (
                                <CategoryHeader taxonomy={taxonomy} />
                            ) : (
                                <>
                                    <h1 className="text-3xl sm:text-4xl font-black text-stone-800 tracking-tight capitalize mb-2">
                                        {rawQuery}
                                    </h1>
                                    <p className="text-stone-500 font-medium leading-relaxed max-w-2xl">
                                        {rawQuery} ê´€ë ¨ ë§¤ë¬¼ ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤.
                                    </p>
                                </>
                            )}

                            {data && (
                                <p className="text-sm text-stone-400 mt-2 text-right border-t border-dashed pt-2">
                                    ì´ {data.total_count}ê°œì˜ ë§¤ë¬¼ ë°œê²¬
                                </p>
                            )}
                        </div>

                        {/* Divider */}
                        {!taxonomy && <div className="h-px w-full bg-gradient-to-r from-stone-200 via-stone-100 to-transparent mb-8" />}

                        {/* Error */}
                        {isError && (
                            <div className="text-center py-12 bg-red-50 rounded-2xl border border-red-100 mb-8">
                                <p className="text-4xl mb-4">ğŸ˜µ</p>
                                <p className="text-red-700 font-medium">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>
                                <p className="text-red-500 text-sm mt-2">
                                    {error instanceof Error ? error.message : 'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'}
                                </p>
                            </div>
                        )}

                        {/* Results Grid */}
                        {allItems.length > 0 ? (
                            <motion.div
                                className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-6"
                                variants={{
                                    hidden: { opacity: 0 },
                                    show: {
                                        opacity: 1,
                                        transition: { staggerChildren: 0.08 }
                                    }
                                }}
                                initial="hidden"
                                animate="show"
                            >
                                {allItems.map((item, index) => (
                                    <motion.div
                                        key={`item-${index}-${'id' in item ? item.id : item.productId}`}
                                        variants={{
                                            hidden: { opacity: 0, y: 20 },
                                            show: { opacity: 1, y: 0 }
                                        }}
                                    >
                                        <ItemCard
                                            item={item}
                                            rank={index + 1}
                                            referencePrice={data?.reference?.price}
                                            isLoggedIn={isLoggedIn}
                                        />
                                    </motion.div>
                                ))}
                            </motion.div>
                        ) : (
                            !isLoading && (
                                <div className="text-center py-16 bg-stone-50 rounded-2xl border border-dashed border-stone-300 mb-8">
                                    <p className="text-4xl mb-4 opacity-50">ğŸ¸</p>
                                    <p className="text-stone-600 font-medium">'{rawQuery}' ê´€ë ¨ ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                                </div>
                            )
                        )}
                    </main>

                    {/* Footer */}
                    <footer className="mt-12 py-6 text-center text-xs text-stone-400 border-t border-stone-100">
                        <p>* ë„¤ì´ë²„ì‡¼í•‘ ê°€ê²© ì •ë³´ëŠ” ì‹¤ì‹œê°„ ì¡°íšŒ ê²°ê³¼ì´ë©°, ì‹¤ì œ íŒë§¤ê°€ì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </footer>
                </motion.div>
            )}
        </div>
    );
}
</file>

<file path="frontend/tsconfig.app.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}
</file>

<file path="frontend/tsconfig.json">
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
</file>

<file path="frontend/tsconfig.node.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="package.json">
{
  "name": "root-app",
  "scripts": {
    "heroku-postbuild": "cd frontend && npm install && npm run build"
  },
  "engines": {
    "node": "18.x"
  }
}
</file>

<file path="Procfile">
web: gunicorn backend.config.wsgi --log-file -
</file>

<file path="run_server.bat">
@echo off
REM MALCHA-DAGU ê°œë°œ ì„œë²„ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
REM í¬íŠ¸: 127.0.0.1:8001

cd /d "%~dp0backend"
python manage.py runserver 127.0.0.1:8001
</file>

<file path="runtime.txt">
python-3.12.8
</file>

<file path="test_api.py">

</file>

<file path="test_prod.py">
import requests
import json

# Test production API
url = "https://malchalab.com/dagu/api/search/"
params = {"q": "ds-1"}

try:
    response = requests.get(url, params=params, timeout=10)
    data = response.json()
    
    print(f"Status: {response.status_code}")
    print(f"Total Count: {data.get('total_count', 'N/A')}")
    print(f"User Items Count: {len(data.get('user_items', []))}")
    print(f"Naver Items Count: {len(data.get('naver_items', []))}")
    
    print("\n=== User Items ===")
    for item in data.get('user_items', [])[:3]:
        print(f"  ID: {item.get('id')}")
        print(f"  Title: {item.get('title')}")
        print(f"  lprice: {item.get('lprice')}")
        print(f"  source: {item.get('source')}")
        print("  ---")
        
except Exception as e:
    print(f"ERROR: {e}")
</file>

<file path="verify_malcha_cookie.py">
import sys
import getpass
import requests
import json
from urllib.parse import urljoin

BASE_URL = "https://malchalab.com"

# Common dj-rest-auth login endpoints
ENDPOINTS = [
    "/dj-rest-auth/login/",
    "/api/auth/login/",
    "/api/login/",
    "/accounts/login/",
    "/auth/login/",
]

def check_cookie(username, password):
    session = requests.Session()
    session.headers.update({
        "Content-Type": "application/json",
        "Origin": BASE_URL,
        "Referer": BASE_URL + "/"
    })

    payload = {
        "username": username,
        "password": password,
        # dj-rest-auth uses 'email' sometimes, handle both if needed or let user retry
        "email": username if "@" in username else None 
    }
    # Clean up None values
    payload = {k: v for k, v in payload.items() if v is not None}

    print(f"\nScanning endpoints on {BASE_URL}...")

    for path in ENDPOINTS:
        url = urljoin(BASE_URL, path)
        print(f"Trying {url} ... ", end="", flush=True)
        
        try:
            response = session.post(url, json=payload, timeout=5)
            
            if response.status_code == 200:
                print("SUCCESS! (200 OK)")
                print("-" * 60)
                
                # Check Cookies
                cookies = response.cookies
                access_token = None
                
                # 'requests' CookieJar automatically handles domains, 
                # but we want to see the RAW Set-Cookie header to verify 'Domain' attribute.
                # However, requests hides raw headers for merged cookies. 
                # We check 'response.headers' for 'Set-Cookie'.
                
                # Note: 'requests' merges multiple Set-Cookie headers into one? 
                # No, response.headers['Set-Cookie'] returns one string (merged) or list?
                # It behaves differently versions. 
                # Using 'response.raw.headers' is safer? No.
                
                # Let's inspect session cookies
                found_token = False
                for cookie in session.cookies:
                    if cookie.name == "malcha-access-token":
                        found_token = True
                        print(f"[Cookie Found] {cookie.name}")
                        print(f"   Value: {cookie.value[:20]}...")
                        print(f"   Domain: {cookie.domain}")
                        print(f"   Path: {cookie.path}")
                        print(f"   Secure: {cookie.secure}")
                        
                        if cookie.domain == ".malchalab.com":
                            print("\nâœ… PASS: Domain is correctly set to '.malchalab.com'")
                        else:
                            print(f"\nâŒ FAIL: Domain is '{cookie.domain}'. It MUST be '.malchalab.com'")
                
                if not found_token:
                    print("\nâŒ FAIL: 'malcha-access-token' cookie NOT received.")
                    print("Raw Set-Cookie Headers:")
                    print(json.dumps(dict(response.headers), indent=2))
                
                print("-" * 60)
                return True
                
            elif response.status_code == 400:
                # Login failed (wrong credentials)
                print("Failed (400 Bad Request). Check ID/PW.")
                print(response.text)
                return False
                
            else:
                print(f"Status {response.status_code}")
                
        except Exception as e:
            print(f"Error: {e}")

    print("\nCould not find a valid login endpoint or login failed.")
    return False

if __name__ == "__main__":
    print("=== Malcha Login Cookie Verifier ===")
    print("Checks if the login cookie has the correct Domain attribute for SSO.\n")
    
    username = input("Username (or Email): ").strip()
    password = getpass.getpass("Password: ").strip()
    
    if not username or not password:
        print("Username/Password required.")
        sys.exit(1)
        
    check_cookie(username, password)
</file>

<file path=".claude/settings.local.json">
{
  "permissions": {
    "allow": [
      "Bash(xargs -I {} bash -c 'wc -l \"\"{}\"\" | awk \"\"{print \\\\$1 \\\\\"\" {} \\\\\"\"}\"\"')",
      "Bash(sort:*)",
      "Bash(python:*)",
      "Bash(npx tsc:*)",
      "Bash(npm run type-check:*)"
    ]
  }
}
</file>

<file path="backend/dagu/admin.py">
"""
Admin configuration for MALCHA-DAGU.
"""

from django.contrib import admin
from django.utils import timezone

from .models import Instrument, UserItem, SearchMissLog


@admin.register(Instrument)
class InstrumentAdmin(admin.ModelAdmin):
    list_display = ['brand', 'name', 'parent', 'category', 'reference_price', 'created_at']
    list_filter = ['category', 'brand']
    search_fields = ['name', 'brand']
    ordering = ['brand', 'name']
    autocomplete_fields = ['parent']  # ë¶€ëª¨ ì„ íƒ ì‹œ ê²€ìƒ‰ ê°€ëŠ¥


@admin.register(UserItem)
class UserItemAdmin(admin.ModelAdmin):
    list_display = [
        'instrument', 'price', 'source', 'is_active', 
        'expired_at', 'click_count', 'created_at'
    ]
    list_filter = ['is_active', 'source', 'instrument__category']
    search_fields = ['instrument__name', 'instrument__brand', 'title']
    ordering = ['-created_at']
    readonly_fields = ['click_count', 'created_at', 'updated_at']
    
    def get_queryset(self, request):
        return super().get_queryset(request).select_related('instrument')


@admin.register(SearchMissLog)
class SearchMissLogAdmin(admin.ModelAdmin):
    """ë¯¸ë“±ë¡ ê²€ìƒ‰ì–´ ê´€ë¦¬ (ìì£¼ ê²€ìƒ‰ë˜ì§€ë§Œ DBì— ì—†ëŠ” ì•…ê¸°)"""
    list_display = ['query', 'search_count', 'is_resolved', 'last_searched_at']
    list_filter = ['is_resolved']
    search_fields = ['query', 'normalized_query']
    ordering = ['-search_count']
    readonly_fields = ['query', 'normalized_query', 'search_count', 'created_at', 'last_searched_at']
    actions = ['mark_as_resolved']
    
    @admin.action(description="ì„ íƒí•œ í•­ëª© ì²˜ë¦¬ ì™„ë£Œë¡œ í‘œì‹œ")
    def mark_as_resolved(self, request, queryset):
        queryset.update(is_resolved=True, resolved_at=timezone.now())
</file>

<file path="backend/dagu/tasks.py">
"""
Celery tasks for MALCHA-DAGU.
Scheduled tasks for automatic cleanup.
"""

import logging

from celery import shared_task
from django.utils import timezone

from .models import ItemClick, UserItem

logger = logging.getLogger(__name__)


@shared_task(name='dagu.cleanup_expired_items')
def cleanup_expired_items():
    """
    ë§Œë£Œëœ ë§¤ë¬¼ ìë™ ë¹„í™œì„±í™”.
    Celery Beatë¡œ 10ë¶„ë§ˆë‹¤ ì‹¤í–‰.
    
    Soft Delete: is_active = False
    (ì‹¤ì œ ì‚­ì œëŠ” í•˜ì§€ ì•ŠìŒ - ë°ì´í„° ë³´ì¡´)
    """
    now = timezone.now()
    
    # ë§Œë£Œë˜ì—ˆì§€ë§Œ ì•„ì§ í™œì„± ìƒíƒœì¸ í•­ëª© ì¡°íšŒ
    expired_items = UserItem.objects.filter(
        is_active=True,
        expired_at__lte=now,
    )
    
    count = expired_items.count()
    
    if count > 0:
        # ì¼ê´„ ì—…ë°ì´íŠ¸ (íš¨ìœ¨ì )
        expired_items.update(is_active=False)
        logger.info(f"Deactivated {count} expired items")
    else:
        logger.debug("No expired items to cleanup")
    
    return f"Processed {count} items"


@shared_task(name='dagu.purge_old_inactive_items')
def purge_old_inactive_items(days=30):
    """
    ì˜¤ë˜ëœ ë¹„í™œì„± ë§¤ë¬¼ ì™„ì „ ì‚­ì œ.
    ì›” 1íšŒ ì •ë„ ì‹¤í–‰ ê¶Œì¥.
    
    Args:
        days: ë¹„í™œì„±í™” í›„ ë©°ì¹ ì´ ì§€ë‚œ í•­ëª©ì„ ì‚­ì œí• ì§€
    """
    from datetime import timedelta
    
    cutoff_date = timezone.now() - timedelta(days=days)
    
    old_items = UserItem.objects.filter(
        is_active=False,
        updated_at__lte=cutoff_date,
    )
    
    count = old_items.count()
    
    if count > 0:
        old_items.delete()
        logger.info(f"Purged {count} old inactive items")
    
    return f"Purged {count} items"


@shared_task(name='dagu.cleanup_old_click_logs')
def cleanup_old_click_logs(days=7):
    """
    ì˜¤ë˜ëœ í´ë¦­ ë¡œê·¸ ì‚­ì œ.
    DB ìš©ëŸ‰ ê´€ë¦¬ë¥¼ ìœ„í•´ 7ì¼ ì§€ë‚œ ë¡œê·¸ ì‚­ì œ.
    ë§¤ì¼ 1íšŒ ì‹¤í–‰ ê¶Œì¥.

    Args:
        days: ë©°ì¹  ì§€ë‚œ í´ë¦­ ë¡œê·¸ë¥¼ ì‚­ì œí• ì§€ (ê¸°ë³¸: 7ì¼)
    """
    from datetime import timedelta

    cutoff_date = timezone.now() - timedelta(days=days)

    old_clicks = ItemClick.objects.filter(clicked_at__lt=cutoff_date)
    count = old_clicks.count()

    if count > 0:
        old_clicks.delete()
        logger.info(f"Deleted {count} old click logs (older than {days} days)")
    else:
        logger.debug("No old click logs to cleanup")

    return f"Deleted {count} click logs"
</file>

<file path="backend/Dockerfile">
# Backend Dockerfile
FROM python:3.11-slim

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements.txt .
RUN pip install --upgrade pip && \
    pip install -r requirements.txt

# Copy project
COPY . .

# Collect static files
RUN python manage.py collectstatic --noinput || true

# Run with gunicorn
CMD ["gunicorn", "--bind", "0.0.0.0:8001", "--workers", "2", "config.wsgi:application"]
</file>

<file path="backend/manage.py">
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    
    # [ìˆ˜ì • ì „] os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    
    # [ìˆ˜ì • í›„] ë’¤ì— .localì„ ë¶™ì—¬ì„œ ê°œë°œìš© ì„¤ì •ì„ ê¸°ë³¸ìœ¼ë¡œ ì§€ì •í•©ë‹ˆë‹¤.
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings.local')
    
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()
</file>

<file path="backend/populate_brands.py">
import os
import django
from django.utils.text import slugify

import sys

# Add the current directory (backend) to sys.path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# Use local settings for script execution
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings.local")
django.setup()

from dagu.models import Instrument, Brand

def populate_brands():
    print("Starting Brand population...")
    instruments = Instrument.objects.all()
    count = 0
    updated_count = 0
    
    # Unique brands found
    brands_found = set()
    
    for inst in instruments:
        count += 1
        brand_text = inst.brand
        if not brand_text:
            continue
            
        # Create/Get Brand
        brand_slug = slugify(brand_text)
        if not brand_slug:
             continue
             
        brand_obj, created = Brand.objects.get_or_create(
            slug=brand_slug,
            defaults={
                'name': brand_text.title(),
                'description': f"{brand_text.title()} ë¸Œëœë“œì…ë‹ˆë‹¤."
            }
        )
        
        if created:
            print(f"Created Brand: {brand_obj.name}")
            brands_found.add(brand_obj.name)
        
        # Link Instrument
        if not inst.brand_obj:
            inst.brand_obj = brand_obj
            inst.save() # This triggers the save logic we added too
            updated_count += 1
            if updated_count % 10 == 0:
                print(f"Updated {updated_count} instruments...")

    print(f"Done! Processed {count} instruments, updated {updated_count} links.")
    print(f"Total Brands in DB: {Brand.objects.count()}")

if __name__ == "__main__":
    populate_brands()
</file>

<file path="backend/run_migrations.py">
import os
import django
from django.core.management import call_command
import sys

# Add the current directory (backend) to sys.path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings.local")
django.setup()

print("1. Making migrations for 'dagu'...")
call_command('makemigrations', 'dagu')

print("2. Applying migrations...")
call_command('migrate', 'dagu')

print("3. Done!")
</file>

<file path="check_user_items.py">
import os
import django
from django.utils import timezone
from django.db.models import Q
import sys

sys.path.append('backend')
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings.local')
django.setup()

from dagu.models import UserItem, Instrument

query = "sm57"
print(f"Checking UserItems significantly related to '{query}'...")

# 1. Check Instrument Match
matching_instruments = Instrument.objects.filter(name__icontains=query)
print(f"Matching Instruments: {matching_instruments.count()}")
matching_ids = []
for inst in matching_instruments:
    print(f" - Found Instrument: {inst.brand} {inst.name} (ID: {inst.id})")
    matching_ids.append(inst.id)

# 2. Check UserItems with simplified query logic (mimicking search.py update)
q_filter = Q(instrument__name__icontains=query) | \
           Q(instrument__brand__icontains=query) | \
           Q(title__icontains=query)

if matching_instruments:
    q_filter |= Q(instrument__in=matching_instruments)

print(f"\nQuery Filter: {q_filter}")

items = UserItem.objects.filter(q_filter)
print(f"\nTotal UserItems matching query: {items.count()}")

# 3. Inspect Latest Items specifically for ID mismatch
print("\n=== LATEST 5 USER ITEMS INSPECTION ===")
last_items = UserItem.objects.order_by('-created_at')[:5]
for item in last_items:
    print(f"[Item ID: {item.id}]")
    print(f" - Title: {item.title}")
    print(f" - Instrument: {item.instrument} (ID: {item.instrument.id})")
    
    is_id_match = item.instrument.id in matching_ids
    print(f" - Included in Matching IDs? {is_id_match}")
            
    is_text_match = (
        query.lower() in item.title.lower() or 
        query.lower() in item.instrument.name.lower() or 
        query.lower() in item.instrument.brand.lower()
    )
    print(f" - Text match with '{query}'? {is_text_match}")
    print(f" - Is Active: {item.is_active}")
    print("--------------------------------")
</file>

<file path="frontend/index.html">
<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DAGU</title>
</head>

<body>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>

</html>
</file>

<file path="frontend/nginx.conf">
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # SPA fallback
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API proxy
    location /api/ {
        proxy_pass http://backend:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
</file>

<file path="frontend/package.json">
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@tailwindcss/vite": "^4.1.18",
    "@tanstack/react-query": "^5.90.17",
    "axios": "^1.13.2",
    "framer-motion": "^12.26.2",
    "js-cookie": "^3.0.5",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.12.0",
    "tailwindcss": "^4.1.18"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/js-cookie": "^3.0.6",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4"
  }
}
</file>

<file path="frontend/src/App.css">
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 1rem;
  text-align: center;
}

@media (min-width: 640px) {
  #root {
    padding: 2rem;
  }
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}
</file>

<file path="frontend/src/App.tsx">
/**
 * MALCHA-DAGU Main App
 */

import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import HomePage from './pages/HomePage';
import SearchResultPage from './pages/SearchResultPage';
import CategoryPage from './pages/CategoryPage';

// React Query í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5ë¶„
      gcTime: 10 * 60 * 1000,   // 10ë¶„
      retry: 1,
      refetchOnWindowFocus: false,
    },
  },
});

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <BrowserRouter>
        <Routes>
          <Route path="/" element={<HomePage />} />
          <Route path="/search" element={<SearchResultPage />} />
          {/* Brand & Category Routes */}
          <Route path="/brand/:brand" element={<CategoryPage />} />
          <Route path="/category/:brand" element={<CategoryPage />} />
          <Route path="/category/:brand/:model" element={<CategoryPage />} />
          <Route path="/category/:brand/:model/:submodel" element={<CategoryPage />} />
        </Routes>
      </BrowserRouter>
    </QueryClientProvider>
  );
}

export default App;
</file>

<file path="frontend/src/hooks/useAuth.ts">
/**
 * SSO ì¸ì¦ ìƒíƒœ í™•ì¸ Hook.
 * Dagu ë°±ì—”ë“œ APIë¥¼ í†µí•´ HttpOnly ì¿ í‚¤ ì¸ì¦ ìƒíƒœ í™•ì¸.
 */

import { useState, useEffect } from 'react';

interface AuthState {
    isLoggedIn: boolean;
    isLoading: boolean;
    userId: number | null;
    username: string | null;
}

/**
 * ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ Hook
 * HttpOnly ì¿ í‚¤ëŠ” JSì—ì„œ ì½ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë°±ì—”ë“œ APIë¡œ í™•ì¸
 */
export function useAuth(): AuthState {
    const [state, setState] = useState<AuthState>({
        isLoggedIn: false,
        isLoading: true,
        userId: null,
        username: null,
    });

    useEffect(() => {
        const checkAuth = async () => {
            // ë¡œì»¬ ê°œë°œ í™˜ê²½ìš© ì˜ˆì™¸ ì²˜ë¦¬
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('Localhost detected: Bypassing auth check for development.');
                setState({
                    isLoggedIn: true,
                    isLoading: false,
                    userId: 1, // ë”ë¯¸ ìœ ì € ID
                    username: 'Developer',
                });
                return;
            }

            try {
                const response = await fetch('/api/auth/check/', {
                    credentials: 'include', // ì¿ í‚¤ í¬í•¨ (vite í”„ë¡ì‹œ ê²½ìœ )
                });
                // ... (ê¸°ì¡´ ë¡œì§ ìœ ì§€)

                if (response.ok) {
                    const data = await response.json();
                    setState({
                        isLoggedIn: data.is_authenticated,
                        isLoading: false,
                        userId: data.user_id || null,
                        username: data.username || null,
                    });
                } else {
                    setState({
                        isLoggedIn: false,
                        isLoading: false,
                        userId: null,
                        username: null,
                    });
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                setState({
                    isLoggedIn: false,
                    isLoading: false,
                    userId: null,
                    username: null,
                });
            }
        };

        checkAuth();
    }, []);

    return state;
}

export default useAuth;
</file>

<file path="frontend/src/hooks/useSearch.ts">
/**
 * React Query hooks for MALCHA-DAGU
 */

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import * as api from '../services/api';
import type { SearchResult } from '../types';

// =============================================================================
// Search Hook
// =============================================================================

export function useSearch(query: string, options?: { enabled?: boolean }) {
    return useQuery<SearchResult>({
        queryKey: ['search', query],
        queryFn: () => api.search(query),
        enabled: options?.enabled ?? query.length > 0,
        staleTime: 5 * 60 * 1000, // 5ë¶„ê°„ ìºì‹œ ìœ ì§€
        gcTime: 10 * 60 * 1000, // 10ë¶„ê°„ ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ë°©ì§€
    });
}

// =============================================================================
// Instruments Hook
// =============================================================================

export function useInstruments(params?: {
    brand?: string;
    category?: string;
    search?: string;
}) {
    return useQuery({
        queryKey: ['instruments', params],
        queryFn: () => api.getInstruments(params),
    });
}

export function useInstrument(id: string) {
    return useQuery({
        queryKey: ['instrument', id],
        queryFn: () => api.getInstrument(id),
        enabled: !!id,
    });
}

// =============================================================================
// User Items Hook
// =============================================================================

export function useUserItems(params?: {
    instrument?: string;
    source?: string;
    min_price?: number;
    max_price?: number;
}) {
    return useQuery({
        queryKey: ['userItems', params],
        queryFn: () => api.getUserItems(params),
    });
}

export function useCreateUserItem() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: api.createUserItem,
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['userItems'] });
            queryClient.invalidateQueries({ queryKey: ['search'] });
        },
    });
}

export function useTrackItemClick() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: api.trackItemClick,
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['userItems'] });
        },
    });
}

export function useExtendUserItem() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: api.extendUserItem,
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['search'] });
            queryClient.invalidateQueries({ queryKey: ['userItems'] });
        },
    });
}

export function useReportItem() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: ({ id, reason, detail }: { id: string; reason: string; detail?: string }) =>
            api.reportUserItem(id, { reason, detail }),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['search'] });
            queryClient.invalidateQueries({ queryKey: ['userItems'] });
        },
    });
}

export function useUpdateItemPrice() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: ({ id, price }: { id: string; price: number }) =>
            api.updateItemPrice(id, price),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['search'] });
            queryClient.invalidateQueries({ queryKey: ['userItems'] });
        },
    });
}

export function useDeleteUserItem() {
    const queryClient = useQueryClient();

    return useMutation({
        mutationFn: api.deleteUserItem,
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['search'] });
            queryClient.invalidateQueries({ queryKey: ['userItems'] });
        },
    });
}

// =============================================================================
// AI Description Hook
// =============================================================================

export function useAIDescription() {
    return useMutation({
        mutationFn: api.getAIDescription,
    });
}
</file>

<file path="frontend/src/index.css">
@import "tailwindcss";

@theme {
  /* Matcha Green Palette */
  --color-matcha-50: #f0fdf4;
  --color-matcha-100: #dcfce7;
  --color-matcha-200: #bbf7d0;
  --color-matcha-300: #86efac;
  --color-matcha-400: #4ade80;
  --color-matcha-500: #22c55e;
  --color-matcha-600: #16a34a;
  --color-matcha-700: #15803d;
  --color-matcha-800: #166534;
  --color-matcha-900: #14532d;

  /* Cream/Warm Palette */
  --color-cream-50: #fffbeb;
  --color-cream-100: #fef3c7;
  --color-cream-200: #fde68a;
  --color-cream-300: #fcd34d;

  /* Fonts */
  --font-display: 'Outfit', sans-serif;
  --font-body: 'Inter', sans-serif;
}

/* =============================================================================
   Base Layer
   ============================================================================= */
@layer base {
  html {
    scroll-behavior: smooth;
  }

  body {
    font-family: var(--font-body);
    background: linear-gradient(135deg, #FDFBF7 0%, #F9F8F4 100%);
    min-height: 100vh;
    color: var(--color-stone-800);
    @apply antialiased;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-family: var(--font-display);
    @apply font-semibold leading-tight;
  }
}

/* =============================================================================
   Utilities Layer
   ============================================================================= */
@layer utilities {
  .text-gradient {
    background: linear-gradient(135deg, var(--color-matcha-600) 0%, var(--color-matcha-400) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .glass {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .glass-dark {
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  /* Scrollbar */
  .scrollbar-custom::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  .scrollbar-custom::-webkit-scrollbar-track {
    @apply bg-stone-100;
  }

  .scrollbar-custom::-webkit-scrollbar-thumb {
    @apply bg-matcha-400 rounded-full;
  }

  .scrollbar-custom::-webkit-scrollbar-thumb:hover {
    @apply bg-matcha-500;
  }
}

/* =============================================================================
   Components Layer (Animations)
   ============================================================================= */
@layer components {

  /* Using standard tailwind animation utilities where possible, extending custom ones */
  @keyframes bounce-soft {

    0%,
    100% {
      transform: translateY(0);
    }

    50% {
      transform: translateY(-12px);
    }
  }

  @keyframes pulse-glow {

    0%,
    100% {
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
    }

    50% {
      box-shadow: 0 0 40px rgba(34, 197, 94, 0.5);
    }
  }

  @keyframes slide-up {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-bounce-soft {
    animation: bounce-soft 2s ease-in-out infinite;
  }

  .animate-pulse-glow {
    animation: pulse-glow 2s ease-in-out infinite;
  }

  .animate-slide-up {
    animation: slide-up 0.5s ease-out forwards;
  }
}
</file>

<file path="backend/config/urls.py">
"""
URL configuration for MALCHA-DAGU project.
"""
from django.conf import settings
from django.contrib import admin
from django.urls import include, path, re_path
from django.views.generic import TemplateView

urlpatterns = [
    # 1. ê´€ë¦¬ì ë° API ì£¼ì†Œ (ë¨¼ì € ê²€ì‚¬)
    path('malcha_admin_site/', admin.site.urls),
    path('api/', include('dagu.urls')),
]

# 2. ë¦¬ì•¡íŠ¸ ì—°ë™ (í”„ë¡œë•ì…˜ì—ì„œë§Œ)
# ë¡œì»¬ ê°œë°œ ì‹œì—ëŠ” React dev serverê°€ ë³„ë„ë¡œ ëŒì•„ê°€ë¯€ë¡œ í•„ìš” ì—†ìŒ
if not settings.DEBUG:
    urlpatterns += [
        re_path(r'^.*$', TemplateView.as_view(template_name='index.html')),
    ]
</file>

<file path="backend/config/wsgi.py">
"""
WSGI config for config project.
"""

import os
import sys
from pathlib import Path

from django.core.wsgi import get_wsgi_application

# [ì¶”ê°€ë¨] í˜„ì¬ íŒŒì¼(wsgi.py)ì˜ 2ë‹¨ê³„ ìƒìœ„ í´ë”(backend)ë¥¼ ê²½ë¡œì— ì¶”ê°€
# ì´ë ‡ê²Œ í•´ì•¼ 'config.settings'ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
path = Path(__file__).resolve().parent.parent
if str(path) not in sys.path:
    sys.path.append(str(path))

# [ê¸°ì¡´ ì„¤ì • ìœ ì§€]
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings.prod')

application = get_wsgi_application()
</file>

<file path="backend/dagu/services/naver.py">
"""
Naver Shopping API Service for MALCHA-DAGU.

Provides search functionality with caching and quality filtering.
"""

from __future__ import annotations

import concurrent.futures
import hashlib
import logging
from typing import Any

import requests
from django.conf import settings
from django.core.cache import cache

from ..config import CrawlerConfig
from ..filters import filter_naver_item, filter_naver_item_with_reason, calculate_dynamic_min_price
from .utils import normalize_brand

logger = logging.getLogger(__name__)

# =============================================================================
# Constants
# =============================================================================

NAVER_API_URL = 'https://openapi.naver.com/v1/search/shop.json'
CACHE_TTL = 60 * 60  # 1ì‹œê°„


# =============================================================================
# Naver Shopping API Service
# =============================================================================

class NaverShoppingService:
    """
    ë„¤ì´ë²„ ì‡¼í•‘ API ì—°ë™ ì„œë¹„ìŠ¤.

    Features:
        - Redis ìºì‹± (1ì‹œê°„ TTL)
        - ë³‘ë ¬ í˜ì´ì§€ ìš”ì²­ (ThreadPoolExecutor)
        - 6ë‹¨ê³„ í’ˆì§ˆ í•„í„°ë§
        - í•œê¸€ ë¸Œëœë“œëª… ì •ê·œí™”

    Usage:
        >>> service = NaverShoppingService()
        >>> results = service.search("BOSS DS-1", display=20)
    """

    def __init__(self) -> None:
        self.client_id = settings.NAVER_CLIENT_ID
        self.client_secret = settings.NAVER_CLIENT_SECRET
        self.headers = {
            'X-Naver-Client-Id': self.client_id,
            'X-Naver-Client-Secret': self.client_secret,
        }
        self._timeout = CrawlerConfig.TIMEOUT_NAVER

    def _get_cache_key(
        self,
        query: str,
        display: int,
        brand: str | None = None,
        category: str | None = None,
        min_price: int | None = None,
    ) -> str:
        """ìºì‹œ í‚¤ ìƒì„± (ê²€ìƒ‰ì–´ + í•„í„° ì¡°ê±´ í•´ì‹œ)"""
        key_base = f"naver_search:{query}:{display}:{brand or ''}:{category or ''}:{min_price or ''}"
        return hashlib.md5(key_base.encode()).hexdigest()

    def _normalize_query(self, query: str) -> str:
        """ê²€ìƒ‰ì–´ ì •ê·œí™” (í•œê¸€ ë¸Œëœë“œ -> ì˜ë¬¸)"""
        return normalize_brand(query)

    def _fetch_page(self, query: str, start: int, sort: str) -> list[dict]:
        """ë‹¨ì¼ í˜ì´ì§€ API ìš”ì²­"""
        try:
            params = {
                'query': query,
                'display': 100,
                'start': start,
                'sort': sort,
                'exclude': 'rental',
            }
            response = requests.get(
                NAVER_API_URL,
                headers=self.headers,
                params=params,
                timeout=self._timeout,
            )
            response.raise_for_status()
            return response.json().get('items', [])

        except requests.exceptions.RequestException as e:
            logger.error(f"Naver API Error (start={start}): {e}")
            return []

    def _fetch_all_pages(self, query: str, sort: str, target_count: int = 200) -> list[dict]:
        """ë³‘ë ¬ í˜ì´ì§€ ìš”ì²­ìœ¼ë¡œ ëŒ€ëŸ‰ ì•„ì´í…œ ìˆ˜ì§‘"""
        page_size = 100
        starts = list(range(1, target_count, page_size))

        all_items = []

        with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
            logger.info(f"ë³‘ë ¬ ìˆ˜ì§‘ ì‹œì‘: {target_count}ê°œ ëª©í‘œ")

            futures = {
                executor.submit(self._fetch_page, query, start, sort): start
                for start in starts
            }

            for future in concurrent.futures.as_completed(futures):
                items = future.result()
                all_items.extend(items)

        logger.info(f"ë³‘ë ¬ ìˆ˜ì§‘ ì™„ë£Œ: ì´ {len(all_items)}ê°œ ì•„ì´í…œ")
        return all_items

    def search(
        self,
        query: str,
        display: int = 20,
        sort: str = 'sim',
        brand: str | None = None,
        category: str | None = None,
        min_price: int | None = None,
        reference_price: int | None = None,
    ) -> list[dict[str, Any]]:
        """
        ë„¤ì´ë²„ ì‡¼í•‘ API ê²€ìƒ‰ + í•„í„°ë§.

        Args:
            query: ê²€ìƒ‰ì–´
            display: ê²°ê³¼ ê°œìˆ˜ (ìµœëŒ€ 100)
            sort: ì •ë ¬ (sim: ì •í™•ë„, date: ë‚ ì§œ, asc: ê°€ê²©ë‚®ì€ìˆœ, dsc: ê°€ê²©ë†’ì€ìˆœ)
            brand: ë¸Œëœë“œ í•„í„° (ì„ íƒ)
            category: ì¹´í…Œê³ ë¦¬ í•„í„° (ì„ íƒ)
            min_price: ìµœì†Œ ê°€ê²© í•„í„° (ì„ íƒ)
            reference_price: ì‹ í’ˆ ê¸°ì¤€ê°€ (ìˆìœ¼ë©´ ì´ ê°’ì˜ 10%ë¥¼ ìµœì†Œê°€ë¡œ ì‚¬ìš©)

        Returns:
            í•„í„°ë§ëœ ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸
        """
        # API í‚¤ í™•ì¸ - ëˆ„ë½ ì‹œ ëª…í™•í•œ ì˜ˆì™¸ ë°œìƒ
        if not self.client_id or not self.client_secret:
            logger.critical("Naver API credentials not configured - Search unavailable")
            from django.core.exceptions import ImproperlyConfigured
            raise ImproperlyConfigured(
                "NAVER_CLIENT_ID and NAVER_CLIENT_SECRET must be set for search functionality"
            )

        # ê²€ìƒ‰ì–´ ì •ê·œí™”
        normalized_query = self._normalize_query(query)

        # ìºì‹œ í™•ì¸ (í•„í„° ì¡°ê±´ í¬í•¨)
        cache_key = self._get_cache_key(
            normalized_query, display * 3, brand, category, min_price
        )
        cached_result = cache.get(cache_key)

        if cached_result is not None:
            logger.debug(f"Cache HIT: {query}")
            raw_items = cached_result
        else:
            logger.info(f"Cache MISS - API í˜¸ì¶œ: {query}")

            try:
                raw_items = self._fetch_all_pages(normalized_query, sort)
                cache.set(cache_key, raw_items, CACHE_TTL)
                logger.debug(f"[Cache] ì €ì¥ ì™„ë£Œ: {len(raw_items)}ê°œ")

            except Exception as e:
                logger.exception(f"Naver API error: {e}")
                return []

        # í•„í„°ë§ ì ìš©
        filtered_items = self._apply_filters(
            raw_items, query, brand, category, min_price, reference_price, display
        )

        # ìŠ¤ì½”ì–´ìˆœ -> ê°€ê²©ìˆœ ì •ë ¬
        filtered_items.sort(key=lambda x: (-x.get('score', 0), x.get('lprice', 0)))

        self._log_results(raw_items, filtered_items, display)

        return filtered_items[:display]

    def _apply_filters(
        self,
        items: list[dict],
        query: str,
        brand: str | None,
        category: str | None,
        min_price: int | None,
        reference_price: int | None,
        display: int,
    ) -> list[dict]:
        """ì•„ì´í…œ í•„í„°ë§ ì ìš© (ìƒì„¸ ë¡œê·¸ í¬í•¨)"""
        filtered = []
        filter_stats = {
            'price': 0,
            'blacklist': 0,
            'brand': 0,
            'category': 0,
            'category_fields': 0,
            'product_type': 0,
            'dynamic_price': 0,
            'passed': 0,
        }

        # [ë™ì  ê°€ê²© í•„í„°ë§] reference_priceê°€ ì—†ìœ¼ë©´ ê°€ê²© ë¶„í¬ ê¸°ë°˜ìœ¼ë¡œ ìµœì†Œê°€ ê³„ì‚°
        dynamic_min_price = None
        if not reference_price and not min_price:
            # ë¨¼ì € ê°€ê²© ëª©ë¡ ì¶”ì¶œ (ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì œì™¸ ì „)
            prices = []
            for item in items:
                try:
                    lprice = int(item.get('lprice', 0))
                    if lprice > 0:
                        prices.append(lprice)
                except (ValueError, TypeError):
                    pass

            if prices:
                dynamic_min_price = calculate_dynamic_min_price(prices)

        for item in items:
            result, reason = filter_naver_item_with_reason(
                item=item,
                query=query,
                brand=brand,
                category=category,
                min_price=min_price,
                reference_price=reference_price,
            )
            if result:
                # ë™ì  ê°€ê²© í•„í„° ì¶”ê°€ ì ìš© (reference_price ì—†ì„ ë•Œë§Œ)
                if dynamic_min_price and result['lprice'] < dynamic_min_price:
                    filter_stats['dynamic_price'] += 1
                    logger.debug(f"[ë™ì í•„í„°] ì œì™¸: {result['lprice']:,}ì› < {dynamic_min_price:,}ì› - {result['title'][:40]}")
                    continue

                filter_stats['passed'] += 1
                filtered.append(result)
            else:
                filter_stats[reason] = filter_stats.get(reason, 0) + 1

        # í•„í„°ë§ í†µê³„ ë¡œê·¸
        logger.error(
            f"[í•„í„° í†µê³„] í†µê³¼: {filter_stats['passed']} | "
            f"ê°€ê²©: {filter_stats['price']} | "
            f"ë™ì ê°€ê²©: {filter_stats['dynamic_price']} | "
            f"ë¸”ë™ë¦¬ìŠ¤íŠ¸: {filter_stats['blacklist']} | "
            f"ë¸Œëœë“œ: {filter_stats['brand']} | "
            f"ì¹´í…Œê³ ë¦¬: {filter_stats['category']} | "
            f"ì•¡ì„¸ì„œë¦¬: {filter_stats['category_fields']} | "
            f"ìƒí’ˆíƒ€ì…: {filter_stats['product_type']}"
        )

        # NOTE: truncationì€ ì •ë ¬ í›„ search()ì—ì„œ ìˆ˜í–‰
        return filtered

    def _log_results(
        self,
        raw_items: list[dict],
        filtered_items: list[dict],
        display: int,
    ) -> None:
        """ê²°ê³¼ ë¡œê¹…"""
        logger.info(
            f"[Naver] í•„í„°ë§: ì›ë³¸({len(raw_items)}) -> "
            f"í†µê³¼({len(filtered_items)}) -> ë°˜í™˜({min(len(filtered_items), display)})"
        )

        if filtered_items:
            logger.info("ìƒìœ„ ê²°ê³¼:")
            for i, item in enumerate(filtered_items[:3], 1):
                logger.info(
                    f"  {i}. [{item['lprice']:,}ì›] "
                    f"{item['title'][:40]}... ({item.get('mallName', 'N/A')})"
                )
</file>

<file path="backend/dagu/urls.py">
"""
URL configuration for DAGU app.
"""

from django.urls import include, path
from rest_framework.routers import DefaultRouter

from . import views

# ViewSet router
router = DefaultRouter()
router.register(r'instruments', views.InstrumentViewSet, basename='instrument')
router.register(r'items', views.UserItemViewSet, basename='useritem')

urlpatterns = [
    # Auth Check API (SSO)
    path('auth/check/', views.AuthCheckView.as_view(), name='auth-check'),

    # Search API
    path('search/', views.SearchView.as_view(), name='search'),

    # Popular Searches API
    path('popular-searches/', views.PopularSearchView.as_view(), name='popular-searches'),

    # AI Description API (ì„ì‹œ ë¹„í™œì„±í™”)
    # path('ai/describe/', views.AIDescriptionView.as_view(), name='ai-describe'),

    # ViewSet routes
    path('', include(router.urls)),
]
</file>

<file path="frontend/src/components/MatchaBounceLoader.tsx">
/**
 * Matcha-Bounce Loader Component
 * 
 * Features:
 * - GIF ì´ë¯¸ì§€ë§Œ í¬ê²Œ í‘œì‹œ
 * - ì™„ë£Œ ì‹œ ìŠ¬ë¼ì´ë“œ ì•„ì›ƒ
 */

import { motion, AnimatePresence } from 'framer-motion';
import daguLoadingGif from '../assets/daguLoading.gif';

interface MatchaBounceLoaderProps {
    isVisible: boolean;
    onComplete?: () => void;
}

export default function MatchaBounceLoader({
    isVisible,
    onComplete
}: MatchaBounceLoaderProps) {
    return (
        <AnimatePresence onExitComplete={onComplete}>
            {isVisible && (
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{
                        opacity: 0,
                        y: -100,
                        transition: { duration: 0.4, ease: 'easeInOut' }
                    }}
                    className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white"
                >
                    {/* ë©”ì¸ GIF ì´ë¯¸ì§€ */}
                    <img
                        src={daguLoadingGif}
                        alt="ë‹¤êµ¬ ë¡œë”©"
                        className="w-64 sm:w-full sm:max-w-md h-auto object-contain"
                    />
                    {/* ë¡œë”© í…ìŠ¤íŠ¸ */}
                    <p className="mt-4 text-lg text-stone-600 font-medium">
                        ë‹¤êµ¬ê°€ ì•…ê¸°ë¥¼ ë‚šëŠ”ì¤‘...
                    </p>
                </motion.div>
            )}
        </AnimatePresence>
    );
}
</file>

<file path=".gitignore">
# General
.DS_Store
Thumbs.db
*.log

# Environment Variables
.env
.env.*
!.env.example
backend/.env
frontend/.env
env/
venv/
.venv/

# Python / Django
__pycache__/
*.py[cod]
*$py.class
db.sqlite3
media/
staticfiles/

# Node.js / React
node_modules/
dist/
build/
.npm/

# IDE
.vscode/
.idea/

# Local Settings
backend/config/settings/local.py
</file>

<file path="backend/config/settings/base.py">
import os
from pathlib import Path
from datetime import timedelta
import environ

# =============================================================================
# 1. Path Setup
# =============================================================================
# backend/config/settings/base.py ìœ„ì¹˜ ê¸°ì¤€ -> 3ë‹¨ê³„ ìœ„ê°€ backend í´ë”
BASE_DIR = Path(__file__).resolve().parent.parent.parent

# environ ì´ˆê¸°í™”
env = environ.Env()
# .env íŒŒì¼ì´ ìˆìœ¼ë©´ ë¡œë“œ (ë¡œì»¬ ê°œë°œìš©)
env_file = BASE_DIR / '.env'
if env_file.exists():
    environ.Env.read_env(str(env_file))

# =============================================================================
# 2. Core Config
# =============================================================================
SECRET_KEY = env('SHARED_SECRET_KEY', default=env('SECRET_KEY', default='django-insecure-dev-key'))

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    # Third-party
    'rest_framework',
    'rest_framework_simplejwt',
    'corsheaders',
    # 'django_celery_beat', # í•„ìš”ì‹œ ì£¼ì„ í•´ì œ
    # Local apps
    'dagu',
]

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware', # [í•„ìˆ˜] ì •ì  íŒŒì¼ ì„œë¹™
    'config.middleware.SecurityHeadersMiddleware', # ì»¤ìŠ¤í…€ ë¯¸ë“¤ì›¨ì–´ (íŒŒì¼ ì¡´ì¬ í™•ì¸ í•„ìš”)
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    # 'config.middleware.RequestLoggingMiddleware', # í•„ìš”ì‹œ ì£¼ì„ í•´ì œ
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR, 'templates')], # ê¸°ë³¸ í…œí”Œë¦¿ í´ë”
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'

# =============================================================================
# 3. Static & I18N
# =============================================================================
LANGUAGE_CODE = 'ko-kr'
TIME_ZONE = 'Asia/Seoul'
USE_I18N = True
USE_TZ = True

STATIC_URL = '/static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'
# prod.pyì—ì„œ extend í•˜ê¸° ìœ„í•´ ë¯¸ë¦¬ ì •ì˜
STATICFILES_DIRS = []

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# =============================================================================
# 4. REST Framework & JWT
# =============================================================================
REST_FRAMEWORK = {
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
    ],
    'DEFAULT_PARSER_CLASSES': [
        'rest_framework.parsers.JSONParser',
    ],
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 20,
    'DEFAULT_THROTTLE_CLASSES': [
        'rest_framework.throttling.AnonRateThrottle',
        'rest_framework.throttling.UserRateThrottle',
    ],
    'DEFAULT_THROTTLE_RATES': {
        'anon': '100/hour',
        'user': '1000/hour',
        'search': '60/minute',
    },
    # íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³ , ì—†ë‹¤ë©´ ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”.
    'EXCEPTION_HANDLER': 'dagu.exceptions.custom_exception_handler',
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'dagu.authentication.JWTCookieAuthentication',
    ],
}

# SSO JWT ì„¤ì •
SIMPLE_JWT = {
    "ACCESS_TOKEN_LIFETIME": timedelta(minutes=30),
    "REFRESH_TOKEN_LIFETIME": timedelta(days=7),
    "ALGORITHM": "HS256",
    "SIGNING_KEY": SECRET_KEY,
    "AUTH_HEADER_TYPES": ("Bearer",),
    "AUTH_COOKIE": "malcha-access-token",
    "AUTH_COOKIE_HTTP_ONLY": True,
    "AUTH_COOKIE_SAMESITE": "Lax",
    "ISSUER": "malchalab.com",
    # AUDIENCE ìë™ ê²€ì¦ ë¹„í™œì„±í™” (authentication.pyì—ì„œ ìˆ˜ë™ ê²€ì¦)
    # SimpleJWTê°€ ë°°ì—´ audience ì²˜ë¦¬ë¥¼ ì œëŒ€ë¡œ ëª»í•¨
    # "AUDIENCE": ["malchalab.com", "dagu.malchalab.com"],
    "JTI_CLAIM": "jti",
    "TOKEN_TYPE_CLAIM": "token_type",
    "USER_ID_CLAIM": "user_id",
}

# =============================================================================
# 5. External API Keys
# =============================================================================
NAVER_CLIENT_ID = env('NAVER_CLIENT_ID', default='')
NAVER_CLIENT_SECRET = env('NAVER_CLIENT_SECRET', default='')
OPENAI_API_KEY = env('OPENAI_API_KEY', default='')
</file>

<file path="backend/dagu/authentication.py">
"""
SSO JWT Cookie Authentication for MALCHA-DAGU.
Validates JWT tokens issued by Malcha (malchalab.com) from cookies.

Security Features:
- Issuer (iss) ê²€ì¦: malchalab.comì—ì„œ ë°œê¸‰ëœ í† í°ë§Œ í—ˆìš©
- Audience (aud) ê²€ì¦: dagu.malchalab.comì´ ìˆ˜ì‹ ìì¸ í† í°ë§Œ í—ˆìš©
- Lazy User Sync: ìœ íš¨í•œ í† í°ì´ë©´ Dagu DBì— ìë™ ì‚¬ìš©ì ìƒì„±
- ìƒì„¸ ë³´ì•ˆ ë¡œê¹…
"""

import logging
import time
from functools import lru_cache

from django.conf import settings
from django.contrib.auth import get_user_model
from django.core.cache import cache
from rest_framework_simplejwt.authentication import JWTAuthentication
from rest_framework_simplejwt.exceptions import InvalidToken, TokenError, AuthenticationFailed

logger = logging.getLogger(__name__)
User = get_user_model()

# ì¸ì¦ ì‹¤íŒ¨ ì¶”ì ìš© ìºì‹œ í‚¤ prefix
AUTH_FAIL_CACHE_PREFIX = 'sso_auth_fail:'
AUTH_FAIL_THRESHOLD = 10  # 10íšŒ ì‹¤íŒ¨
AUTH_FAIL_WINDOW = 300  # 5ë¶„


class JWTCookieAuthentication(JWTAuthentication):
    """
    Malchaì—ì„œ ë°œê¸‰í•œ JWT ì¿ í‚¤ë¥¼ ì½ì–´ ì¸ì¦í•˜ëŠ” í´ë˜ìŠ¤.

    SSO êµ¬ì¡°:
    - Malcha (malchalab.com): JWT ë°œê¸‰ (Auth Server)
    - Dagu (dagu.malchalab.com): JWT ê²€ì¦ (Resource Server)

    ë³´ì•ˆ ê¸°ëŠ¥:
    - Issuer/Audience claim ê²€ì¦ (settingsì—ì„œ ìë™ ì²˜ë¦¬)
    - ì¸ì¦ ì‹¤íŒ¨ Rate Limiting (IP ê¸°ë°˜)
    - Lazy User Sync (ìœ íš¨í•œ í† í°ë§Œ)
    - ìƒì„¸ ë³´ì•ˆ ë¡œê¹…
    """

    def authenticate(self, request):
        """
        ì¿ í‚¤ì—ì„œ JWT access tokenì„ ì¶”ì¶œí•˜ì—¬ ê²€ì¦.

        Returns:
            tuple: (user, validated_token) ì¸ì¦ ì„±ê³µ ì‹œ
            None: ì¿ í‚¤ì— í† í°ì´ ì—†ì„ ë•Œ

        Raises:
            AuthenticationFailed: Rate limit ì´ˆê³¼ ì‹œ
        """
        # ì„¤ì •ì—ì„œ ì¿ í‚¤ëª… ê°€ì ¸ì˜¤ê¸°
        cookie_name = getattr(settings, 'SIMPLE_JWT', {}).get('AUTH_COOKIE', 'malcha-access-token')

        # ì¿ í‚¤ì—ì„œ access token ì¶”ì¶œ
        raw_token = request.COOKIES.get(cookie_name)

        if raw_token is None:
            # ê°œë°œ í™˜ê²½ì—ì„œëŠ” ë”ë¯¸ ì¸ì¦ í—ˆìš© (DEBUG=Trueì¼ ë•Œë§Œ)
            if getattr(settings, 'DEBUG', False):
                return self._get_dev_user()
            return None

        # Rate Limiting ì²´í¬ (IP ê¸°ë°˜) - ê°œë°œ í™˜ê²½ì—ì„œëŠ” ë¹„í™œì„±í™”
        client_ip = self._get_client_ip(request)
        if not getattr(settings, 'DEBUG', False) and self._is_rate_limited(client_ip):
            logger.warning(f"SSO rate limit exceeded for IP: {client_ip}")
            raise AuthenticationFailed('Too many authentication attempts. Please try again later.')

        try:
            # í† í° ê²€ì¦ (ì„œëª…, ë§Œë£Œ, iss, aud ë“± - SimpleJWTê°€ ìë™ ì²˜ë¦¬)
            validated_token = self.get_validated_token(raw_token)

            # ì¶”ê°€ ë³´ì•ˆ ê²€ì¦
            self._validate_token_claims(validated_token)

            # í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ ë˜ëŠ” ìƒì„±
            user = self._get_or_create_user(validated_token)

            if user:
                # ì¸ì¦ ì„±ê³µ ì‹œ ì‹¤íŒ¨ ì¹´ìš´í„° ë¦¬ì…‹
                self._reset_fail_count(client_ip)
                logger.info(f"SSO authentication successful: user_id={user.id}, ip={client_ip}")
                return user, validated_token
            else:
                self._record_auth_failure(client_ip, "user_creation_failed")
                return None

        except (TokenError, InvalidToken) as e:
            # í† í°ì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ìµëª… ì‚¬ìš©ìë¡œ ì²˜ë¦¬ (AllowAny ì—”ë“œí¬ì¸íŠ¸ í—ˆìš©)
            self._record_auth_failure(client_ip, f"token_error: {e}")
            logger.warning(f"SSO token validation failed: {e} (ip={client_ip})")
            # ê°œë°œ í™˜ê²½ì—ì„œëŠ” ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì´ë¼ë„ ë”ë¯¸ ìœ ì €ë¡œ ì¸ì¦
            if getattr(settings, 'DEBUG', False):
                logger.info("DEBUG mode: Falling back to dev user despite invalid token")
                return self._get_dev_user()
            return None
        except AuthenticationFailed as e:
            # Rate limit ì—ëŸ¬ë§Œ re-raise, ê·¸ ì™¸ëŠ” None ë°˜í™˜
            if 'Too many' in str(e):
                raise
            logger.warning(f"SSO auth failed: {e} (ip={client_ip})")
            # ê°œë°œ í™˜ê²½ì—ì„œëŠ” ë”ë¯¸ ìœ ì €ë¡œ ì¸ì¦
            if getattr(settings, 'DEBUG', False):
                return self._get_dev_user()
            return None
        except Exception as e:
            self._record_auth_failure(client_ip, f"unexpected_error: {e}")
            logger.error(f"SSO authentication error: {e} (ip={client_ip})")
            # ê°œë°œ í™˜ê²½ì—ì„œëŠ” ë”ë¯¸ ìœ ì €ë¡œ ì¸ì¦
            if getattr(settings, 'DEBUG', False):
                return self._get_dev_user()
            return None

    def _get_client_ip(self, request) -> str:
        """í´ë¼ì´ì–¸íŠ¸ IP ì¶”ì¶œ (í”„ë¡ì‹œ ê³ ë ¤)"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            return x_forwarded_for.split(',')[0].strip()
        return request.META.get('REMOTE_ADDR', 'unknown')

    def _is_rate_limited(self, client_ip: str) -> bool:
        """ì¸ì¦ ì‹¤íŒ¨ Rate Limiting ì²´í¬"""
        cache_key = f"{AUTH_FAIL_CACHE_PREFIX}{client_ip}"
        fail_count = cache.get(cache_key, 0)
        return fail_count >= AUTH_FAIL_THRESHOLD

    def _record_auth_failure(self, client_ip: str, reason: str):
        """ì¸ì¦ ì‹¤íŒ¨ ê¸°ë¡"""
        cache_key = f"{AUTH_FAIL_CACHE_PREFIX}{client_ip}"
        fail_count = cache.get(cache_key, 0) + 1
        cache.set(cache_key, fail_count, AUTH_FAIL_WINDOW)
        logger.warning(f"SSO auth failure recorded: ip={client_ip}, count={fail_count}, reason={reason}")

    def _reset_fail_count(self, client_ip: str):
        """ì¸ì¦ ì„±ê³µ ì‹œ ì‹¤íŒ¨ ì¹´ìš´í„° ë¦¬ì…‹"""
        cache_key = f"{AUTH_FAIL_CACHE_PREFIX}{client_ip}"
        cache.delete(cache_key)

    def _validate_token_claims(self, validated_token):
        """
        ì¶”ê°€ í† í° í´ë ˆì„ ê²€ì¦.
        - token_type, user_id ê²€ì¦
        - audience ìˆ˜ë™ ê²€ì¦ (SimpleJWT ë°°ì—´ ì²˜ë¦¬ ì´ìŠˆ ìš°íšŒ)
        """
        # token_type ê²€ì¦ (access í† í°ë§Œ í—ˆìš©)
        token_type = validated_token.get('token_type')
        if token_type != 'access':
            raise TokenError(f"Invalid token type: {token_type}")

        # audience ìˆ˜ë™ ê²€ì¦ (SimpleJWTê°€ ë°°ì—´ ì²˜ë¦¬ ëª»í•¨)
        aud = validated_token.get('aud')
        allowed_audiences = ['malchalab.com', 'dagu.malchalab.com']
        if aud:
            # audê°€ ë°°ì—´ì´ë©´ êµì§‘í•© í™•ì¸, ë¬¸ìì—´ì´ë©´ í¬í•¨ ì—¬ë¶€ í™•ì¸
            if isinstance(aud, list):
                if not any(a in allowed_audiences for a in aud):
                    raise TokenError(f"Invalid audience: {aud}")
            elif aud not in allowed_audiences:
                raise TokenError(f"Invalid audience: {aud}")
            logger.debug(f"Audience validated: {aud}")

        # user_id ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        user_id = validated_token.get('user_id')
        if not user_id:
            raise TokenError("Missing user_id claim")

        # jti (JWT ID) ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì²´í¬ìš©)
        jti = validated_token.get('jti')
        if not jti:
            logger.warning("Token missing jti claim - blacklist check unavailable")

    def _get_or_create_user(self, validated_token):
        """
        í† í°ì—ì„œ ì‚¬ìš©ì ì¡°íšŒ ë˜ëŠ” ìƒì„± (Lazy Sync).

        Malchaì˜ user_idë¥¼ ì‚¬ìš©í•˜ì—¬ Dagu DBì—ì„œ ì¡°íšŒ.
        ì—†ìœ¼ë©´ ìë™ ìƒì„±.

        ë³´ì•ˆ ê³ ë ¤ì‚¬í•­:
        - user_id íƒ€ì… ê²€ì¦ (ì •ìˆ˜ë§Œ í—ˆìš©)
        - ìƒì„± ì‹œ ìµœì†Œ ê¶Œí•œë§Œ ë¶€ì—¬
        - ìƒì„¸ ë¡œê¹…
        """
        try:
            # ê¸°ë³¸ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©ì ì¡°íšŒ ì‹œë„
            return self.get_user(validated_token)
        except Exception:
            pass

        # ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ í† í°ì—ì„œ ì •ë³´ ì¶”ì¶œí•˜ì—¬ ìƒì„±
        try:
            user_id = validated_token.get('user_id')
            if not user_id:
                logger.warning("SSO token missing user_id claim")
                return None

            # user_id íƒ€ì… ê²€ì¦ (ì •ìˆ˜ë§Œ í—ˆìš© - injection ë°©ì§€)
            if not isinstance(user_id, int):
                try:
                    user_id = int(user_id)
                except (ValueError, TypeError):
                    logger.error(f"SSO invalid user_id type: {type(user_id)}")
                    return None

            # user_id ë²”ìœ„ ê²€ì¦ (ìŒìˆ˜ ë°©ì§€)
            if user_id <= 0:
                logger.error(f"SSO invalid user_id value: {user_id}")
                return None

            # Malcha user_idë¡œ Dagu DBì— ì‚¬ìš©ì ìƒì„±/ì¡°íšŒ
            user, created = User.objects.get_or_create(
                id=user_id,
                defaults={
                    'username': f'malcha_user_{user_id}',
                    'is_active': True,
                    # ë³´ì•ˆ: staff/superuser ê¶Œí•œ ë¶€ì—¬ ì•ˆí•¨
                    'is_staff': False,
                    'is_superuser': False,
                }
            )

            if created:
                logger.info(f"SSO: Created new user in Dagu DB (id={user_id})")
            else:
                logger.debug(f"SSO: Found existing user in Dagu DB (id={user_id})")

            return user

        except Exception as e:
            logger.error(f"SSO user sync failed: {e}")
            return None

    def _get_dev_user(self):
        """
        ê°œë°œ í™˜ê²½ìš© ë”ë¯¸ ì‚¬ìš©ì ë°˜í™˜.
        DEBUG=Trueì¼ ë•Œë§Œ ì‚¬ìš©ë¨.
        """
        try:
            user, created = User.objects.get_or_create(
                id=1,
                defaults={
                    'username': 'dev_user',
                    'is_active': True,
                    'is_staff': True,  # ê°œë°œ í™˜ê²½ì—ì„œëŠ” staff ê¶Œí•œ ë¶€ì—¬
                    'is_superuser': False,
                }
            )
            if created:
                logger.info("Created development user (id=1)")
            return user, None  # (user, token) í˜•íƒœë¡œ ë°˜í™˜
        except Exception as e:
            logger.error(f"Dev user creation failed: {e}")
            return None
</file>

<file path="backend/dagu/serializers.py">
"""
Serializers for MALCHA-DAGU API.
"""

from rest_framework import serializers

from .models import Instrument, UserItem, Brand


class BrandSerializer(serializers.ModelSerializer):
    """ë¸Œëœë“œ ì‹œë¦¬ì–¼ë¼ì´ì €"""
    class Meta:
        model = Brand
        fields = ['name', 'slug', 'logo_url', 'description']


class InstrumentSerializer(serializers.ModelSerializer):
    """ì•…ê¸° ë§ˆìŠ¤í„° ì‹œë¦¬ì–¼ë¼ì´ì €"""
    
    category_display = serializers.CharField(
        source='get_category_display', 
        read_only=True
    )
    # ë¸Œëœë“œ ìƒì„¸ ì •ë³´ (ì½ê¸° ì „ìš©)
    brand_detail = BrandSerializer(source='brand_obj', read_only=True)
    
    class Meta:
        model = Instrument
        fields = [
            'id', 'name', 'brand', 'brand_detail', 'category', 'category_display',
            'image_url', 'reference_price', 'description',
            'created_at', 'updated_at'
        ]
        read_only_fields = ['id', 'created_at', 'updated_at']


class InstrumentMinimalSerializer(serializers.ModelSerializer):
    """ì•…ê¸° ê°„ë‹¨ ì •ë³´ (ëª©ë¡ìš©)"""
    
    class Meta:
        model = Instrument
        fields = ['id', 'name', 'brand', 'image_url', 'reference_price']


class UserItemSerializer(serializers.ModelSerializer):
    """ìœ ì € ë§¤ë¬¼ ì‹œë¦¬ì–¼ë¼ì´ì €"""

    instrument_detail = InstrumentMinimalSerializer(
        source='instrument',
        read_only=True
    )
    source_display = serializers.CharField(
        source='get_source_display',
        read_only=True
    )
    discount_rate = serializers.FloatField(read_only=True)
    is_expired = serializers.BooleanField(read_only=True)
    is_owner = serializers.SerializerMethodField()

    class Meta:
        model = UserItem
        fields = [
            'id', 'instrument', 'instrument_detail', 'price', 'link',
            'source', 'source_display', 'title', 'is_active',
            'expired_at', 'extended_at', 'click_count', 'discount_rate',
            'is_expired', 'is_owner', 'report_count',
            'created_at', 'updated_at'
        ]
        read_only_fields = [
            'id', 'click_count', 'extended_at', 'report_count', 'created_at', 'updated_at'
        ]

    def get_is_owner(self, obj):
        """í˜„ì¬ ìš”ì²­ ìœ ì €ê°€ ì†Œìœ ìì¸ì§€ í™•ì¸"""
        request = self.context.get('request')
        if request and request.user.is_authenticated:
            return obj.owner_id == request.user.id
        return False


class UserItemCreateSerializer(serializers.ModelSerializer):
    """ìœ ì € ë§¤ë¬¼ ìƒì„±ìš© ì‹œë¦¬ì–¼ë¼ì´ì €"""
    
    class Meta:
        model = UserItem
        fields = ['instrument', 'price', 'link', 'source', 'title']
        extra_kwargs = {
            'instrument': {'required': False, 'allow_null': True}  # ë°±ì—”ë“œì—ì„œ ìë™ ë§¤ì¹­
        }

    def validate_link(self, value):
        from .services.item_service import is_allowed_link
        
        link = value.strip()
        
        # 1. í—ˆìš©ëœ ì‚¬ì´íŠ¸ ê²€ì¦
        if not is_allowed_link(link):
            raise serializers.ValidationError('í—ˆìš©ë˜ì§€ ì•Šì€ ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤. (ë®¬, ë²ˆê°œì¥í„°, ë‹¹ê·¼ë§ˆì¼“, ì¤‘ê³ ë‚˜ë¼ë§Œ ê°€ëŠ¥)')
            
        # 2. ì¤‘ë³µ ì²´í¬ (í™œì„± ë§¤ë¬¼ ì¤‘) - create ì‹œì—ë§Œ ì²´í¬
        if not self.instance:
            if UserItem.objects.filter(link=link, is_active=True).exists():
                raise serializers.ValidationError('ì´ë¯¸ ë“±ë¡ëœ ë§¤ë¬¼ì…ë‹ˆë‹¤.')
                
        return link


class NaverItemSerializer(serializers.Serializer):
    """ë„¤ì´ë²„ ì‡¼í•‘ API ì‘ë‹µ ì‹œë¦¬ì–¼ë¼ì´ì €"""
    
    title = serializers.CharField()
    link = serializers.URLField()
    image = serializers.URLField()
    lprice = serializers.IntegerField()  # ìµœì €ê°€
    hprice = serializers.IntegerField(required=False, default=0)  # ìµœê³ ê°€
    mallName = serializers.CharField()
    productId = serializers.CharField()
    productType = serializers.IntegerField()
    
    # ê°€ê³µëœ í•„ë“œ
    source = serializers.SerializerMethodField()
    
    def get_source(self, obj):
        return 'naver'


class SearchResultSerializer(serializers.Serializer):
    """í†µí•© ê²€ìƒ‰ ê²°ê³¼ ì‹œë¦¬ì–¼ë¼ì´ì €"""

    # ê²€ìƒ‰ ë©”íƒ€ ì •ë³´
    query = serializers.CharField()
    search_query = serializers.CharField()  # ì •ê·œí™”ëœ ê²€ìƒ‰ì–´ (ì™¸ë¶€ ë§í¬ìš©)
    total_count = serializers.IntegerField()

    # ì‹ í’ˆ ì •ë³´
    reference = serializers.DictField(required=False)
    
    # Taxonomy ì •ë³´ (DB ê¸°ë°˜)
    taxonomy = serializers.DictField(required=False, allow_null=True)
    
    # ë§¤ì¹­ëœ ì•…ê¸° ì •ë³´ (ë§¤ë¬¼ ë“±ë¡ìš©)
    matched_instrument = serializers.DictField(required=False, allow_null=True)
    
    # ê°€ê²©ìˆœ ì •ë ¬ëœ í†µí•© ê²°ê³¼
    items = serializers.ListField()
    
    # ë„¤ì´ë²„ ê²°ê³¼ë§Œ
    naver_items = serializers.ListField()
    
    # ìœ ì € ë§¤ë¬¼ë§Œ
    user_items = serializers.ListField()


class AIDescriptionRequestSerializer(serializers.Serializer):
    """AI ì„¤ëª… ìš”ì²­ ì‹œë¦¬ì–¼ë¼ì´ì €"""
    
    model_name = serializers.CharField(max_length=200)
    brand = serializers.CharField(max_length=100)
    category = serializers.CharField(max_length=50)


class AIDescriptionResponseSerializer(serializers.Serializer):
    """AI ì„¤ëª… ì‘ë‹µ ì‹œë¦¬ì–¼ë¼ì´ì €"""
    
    summary = serializers.CharField()
    check_point = serializers.CharField(allow_blank=True)
</file>

<file path="backend/dagu/services.py">
"""
Business logic for MALCHA-DAGU.

- NaverShoppingService: ë„¤ì´ë²„ ì‡¼í•‘ API ì—°ë™ + ìºì‹± + í•„í„°ë§
- SearchAggregatorService: ë„¤ì´ë²„ + DB ë°ì´í„° ë³‘í•©
- AIDescriptionService: AI ì•…ê¸° ì„¤ëª… ìƒì„±
"""

import hashlib
import logging
import re
import concurrent.futures
from difflib import SequenceMatcher
from typing import Any

import requests
from django.conf import settings
from django.core.cache import cache
from django.db import models
from django.utils import timezone

from .models import Instrument, UserItem
from .config import CrawlerConfig
from .filters import (
    filter_naver_item,
    clean_html_tags,
    calculate_match_score,
    check_blacklist,
    check_min_price,
    check_category_fields,
    check_product_type,
    build_exclusion_query,
)

logger = logging.getLogger(__name__)

# =============================================================================
# Constants
# =============================================================================

NAVER_API_URL = 'https://openapi.naver.com/v1/search/shop.json'
CACHE_TTL = 60 * 60  # 1ì‹œê°„ (ì´ˆ ë‹¨ìœ„)


# =============================================================================
# Naver Shopping API Service
# =============================================================================

class NaverShoppingService:
    """
    ë„¤ì´ë²„ ì‡¼í•‘ API ì—°ë™ ì„œë¹„ìŠ¤.
    Redis ìºì‹±ìœ¼ë¡œ API í˜¸ì¶œ ìµœì†Œí™”.
    í•„í„°ë§ ë¡œì§ìœ¼ë¡œ í’ˆì§ˆ í–¥ìƒ.
    """
    
    def __init__(self):
        self.client_id = settings.NAVER_CLIENT_ID
        self.client_secret = settings.NAVER_CLIENT_SECRET
        self.headers = {
            'X-Naver-Client-Id': self.client_id,
            'X-Naver-Client-Secret': self.client_secret,
        }
    
    def _get_cache_key(self, query: str, display: int = 20) -> str:
        """ìºì‹œ í‚¤ ìƒì„± (ê²€ìƒ‰ì–´ í•´ì‹œ)"""
        key_base = f"naver_search:{query}:{display}"
        return hashlib.md5(key_base.encode()).hexdigest()
    
    def search(
        self, 
        query: str, 
        display: int = 20, 
        sort: str = 'sim',  # ê°€ê²©ë‚®ì€ìˆœ (ìœ ì € ìš”ì²­ ë°˜ì˜)
        brand: str = None,
        category: str = None,
        min_price: int = None,
    ) -> list[dict]:
        """
        ë„¤ì´ë²„ ì‡¼í•‘ API ê²€ìƒ‰ + í•„í„°ë§.
        
        Args:
            query: ê²€ìƒ‰ì–´
            display: ê²°ê³¼ ê°œìˆ˜ (ìµœëŒ€ 100)
            sort: ì •ë ¬ (sim: ì •í™•ë„, date: ë‚ ì§œ, asc: ê°€ê²©ë‚®ì€ìˆœ, dsc: ê°€ê²©ë†’ì€ìˆœ)
            brand: ë¸Œëœë“œ í•„í„° (ì„ íƒ)
            category: ì¹´í…Œê³ ë¦¬ í•„í„° (ì„ íƒ)
            min_price: ìµœì†Œ ê°€ê²© í•„í„° (ì„ íƒ)
        
        Returns:
            í•„í„°ë§ëœ ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸
        """
        # 0. ê²€ìƒ‰ì–´ ì •ê·œí™” (í•œê¸€ ë¸Œëœë“œ -> ì˜ì–´ë¡œ í†µì¼í•˜ì—¬ ìºì‹œ íš¨ìœ¨ì„± ì¦ëŒ€)
        from .config import CategoryConfig
        normalized_query = query
        for kr_name, en_brand in CategoryConfig.BRAND_NAME_MAPPING.items():
            logger.debug(f"Brand: {kr_name}")
            if kr_name in query:
                normalized_query = query.replace(kr_name, en_brand)
                logger.debug(f"[Cache] ê²€ìƒ‰ì–´ ì •ê·œí™”: '{query}' -> '{normalized_query}'")
                break
        
        # 1. ìºì‹œ í™•ì¸ (ì •ê·œí™”ëœ ê²€ìƒ‰ì–´ë¡œ ìºì‹œ í‚¤ ìƒì„±)
        cache_key = self._get_cache_key(normalized_query, display * 3)  # í•„í„°ë§ ê³ ë ¤í•˜ì—¬ 3ë°° ìš”ì²­
        cached_result = cache.get(cache_key)
        
        raw_items = []
        
        if cached_result is not None:
            logger.debug(f"Cache HIT for query: {query}")
            raw_items = cached_result
        else:
            logger.info(f"ğŸ“¡ Cache MISS - API í˜¸ì¶œ ì‹œì‘: {query}")
            
            # 2. API í˜¸ì¶œ (API í‚¤ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜)
            if not self.client_id or not self.client_secret:
                logger.warning("âš ï¸ Naver API credentials not configured")
                return []
            
            try:
                # ì œì™¸ í‚¤ì›Œë“œ ì¶”ê°€ (API ë ˆë²¨ í•„í„°ë§) - ì¼ë‹¨ ë¹„í™œì„±í™”
                # enhanced_query = build_exclusion_query(normalized_query)
                enhanced_query = normalized_query  # ì •ê·œí™”ëœ ì¿¼ë¦¬ ì‚¬ìš©
                logger.info(f"ë„¤ì´ë²„ API ê²€ìƒ‰: '{enhanced_query}'")
                
                # í•„í„°ë§ ëŒ€ë¹„ ë„‰ë„‰í•˜ê²Œ 500ê°œ ìˆ˜ì§‘ (ë³‘ë ¬ ì²˜ë¦¬)
                target_count = 200
                page_size = 100
                starts = range(1, target_count, page_size)  # 1, 101, 201, 301, 401
                
                raw_items = []
                
                # ë‚´ë¶€ í•¨ìˆ˜: ë‹¨ì¼ í˜ì´ì§€ ìš”ì²­
                def fetch_page(start_idx):
                    try:
                        p = {
                            'query': enhanced_query,
                            'display': page_size,
                            'start': start_idx,
                            'sort': sort,
                            'exclude': 'rental',
                        }
                        # logger.debug(f"ğŸ“¤ API ìš”ì²­ ì‹œì‘: start={start_idx}")
                        res = requests.get(
                            NAVER_API_URL,
                            headers=self.headers,
                            params=p,
                            timeout=CrawlerConfig.TIMEOUT_NAVER,
                        )
                        res.raise_for_status()
                        data = res.json()
                        items = data.get('items', [])
                        # logger.debug(f"ğŸ“¥ API ì‘ë‹µ ì™„ë£Œ: start={start_idx}, ê°€ì ¸ì˜¨ ê°œìˆ˜={len(items)}")
                        return items
                    except Exception as e:
                        logger.error(f"Naver API Error (start={start_idx}): {e}")
                        return []

                # ThreadPoolExecutorë¡œ ë³‘ë ¬ ì‹¤í–‰ (ì†ë„ ìµœì í™”)
                with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
                    logger.info(f"ï¿½ ë³‘ë ¬ ìˆ˜ì§‘ ì‹œì‘: {target_count}ê°œ ëª©í‘œ (Workers=5)")
                    results = executor.map(fetch_page, starts)
                    
                    for items in results:
                        raw_items.extend(items)
                
                logger.info(f"âœ… ë³‘ë ¬ ìˆ˜ì§‘ ì™„ë£Œ: ì´ {len(raw_items)}ê°œ ì•„ì´í…œ í™•ë³´")
                
                # ìºì‹± (ì›ë³¸ ë°ì´í„°)
                cache.set(cache_key, raw_items, CACHE_TTL)
                logger.debug(f"[Cache] ìºì‹± ì™„ë£Œ: {len(raw_items)}ê°œ ì•„ì´í…œ")
                
            except requests.exceptions.Timeout:
                logger.error(f"Naver API timeout for query: {query}")
                return []
            except requests.exceptions.RequestException as e:
                logger.error(f"Naver API error for query {query}: {e}")
                return []
            except Exception as e:
                logger.exception(f"Unexpected error in Naver API: {e}")
                return []
        
        # 3. í•„í„°ë§ ì ìš©
        filtered_items = []
        stats = {
            'total': 0, 
            'price_fail': 0, 
            'blacklist_fail': 0, 
            'brand_fail': 0, 
            'category_fail': 0,
            'category_field_fail': 0,
            'product_type_fail': 0,
            'passed': 0
        }
        
        logger.debug(f"í•„í„°ë§ ì‹œì‘: {len(raw_items)}ê°œ ì•„ì´í…œ")

        for item in raw_items:
            stats['total'] += 1
            title = item.get('title', '')[:50]
            logger.debug(f"ì²˜ë¦¬ ì¤‘: {title}")
            price = int(item.get('lprice', 0) or 0)
            
            # í•„í„°ë§ í•¨ìˆ˜ í˜¸ì¶œ
            filtered = filter_naver_item(
                item=item,
                query=query,
                brand=brand,
                category=category,
                min_price=min_price,
            )
            
            if filtered:
                stats['passed'] += 1
                filtered_items.append(filtered)
                logger.debug(f"âœ… í†µê³¼: [{price:,}ì›] {title}...")
                
                # ëª©í‘œ ê°œìˆ˜ ë‹¬ì„± ì‹œ ì¤‘ë‹¨
                if len(filtered_items) >= display:
                    break
            else:
                # ì‹¤íŒ¨ ì›ì¸ ë¡œê¹… (DEBUG ë ˆë²¨)
                logger.debug(f"âŒ íƒˆë½: [{price:,}ì›] {title}...")
        
        # 4. ìŠ¤ì½”ì–´ìˆœ ì •ë ¬ í›„ ê°€ê²©ìˆœ ì •ë ¬
        filtered_items.sort(key=lambda x: (-x.get('score', 0), x.get('lprice', 0)))
        
        # í†µê³„ ë¡œê¹…
        logger.info(
            f"ğŸ“Š [Naver] í•„í„°ë§ ì™„ë£Œ: "
            f"ì›ë³¸({stats['total']}) â†’ í†µê³¼({stats['passed']}) â†’ ë°˜í™˜({len(filtered_items[:display])})"
        )
        
        # ìƒìœ„ 3ê°œ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°
        if filtered_items:
            logger.info("ğŸ† ìƒìœ„ ê²°ê³¼:")
            for i, item in enumerate(filtered_items[:3], 1):
                logger.info(f"   {i}. [{item['lprice']:,}ì›] {item['title'][:40]}... ({item.get('mallName', 'N/A')})")
        
        return filtered_items[:display]


# =============================================================================
# Search Utilities (ê²€ìƒ‰ ìœ í‹¸ë¦¬í‹°)
# =============================================================================

def normalize_search_term(term: str) -> str:
    """
    ê²€ìƒ‰ì–´ ì •ê·œí™”: ëŒ€ì†Œë¬¸ì, í•˜ì´í”ˆ, ê³µë°± í†µì¼
    ì˜ˆ: "DS-1", "ds1", "ds 1", "DS 1" â†’ "ds1"
    """
    if not term:
        return ""
    # ì†Œë¬¸ì ë³€í™˜
    result = term.lower().strip()
    # í•˜ì´í”ˆ, ì–¸ë”ìŠ¤ì½”ì–´, ê³µë°± ì œê±°
    result = re.sub(r'[-_\s]+', '', result)
    return result


def expand_query_with_aliases(query: str) -> list[str]:
    """
    ê²€ìƒ‰ì–´ë¥¼ ë³„ì¹­ ë§¤í•‘ìœ¼ë¡œ í™•ì¥
    ì˜ˆ: "ds1" â†’ ["ds1", "DS-1"]
    """
    from .config import CategoryConfig

    expanded = [query]
    query_lower = query.lower().strip()
    query_normalized = normalize_search_term(query)

    # ë³„ì¹­ â†’ ì •ì‹ ëª¨ë¸ëª… ë³€í™˜
    aliases = getattr(CategoryConfig, 'MODEL_ALIASES', {})

    # ì •ê·œí™”ëœ ê²€ìƒ‰ì–´ë¡œ ë³„ì¹­ ì°¾ê¸°
    if query_normalized in aliases:
        expanded.append(aliases[query_normalized])

    # ì›ë³¸ ê²€ìƒ‰ì–´(ì†Œë¬¸ì)ë¡œë„ ë³„ì¹­ ì°¾ê¸°
    if query_lower in aliases:
        expanded.append(aliases[query_lower])

    # ê²€ìƒ‰ì–´ì˜ ê° í† í°ë³„ë¡œ ë³„ì¹­ í™•ì¥
    for token in query_lower.split():
        token_norm = normalize_search_term(token)
        if token_norm in aliases:
            expanded.append(aliases[token_norm])
        if token in aliases:
            expanded.append(aliases[token])

    return list(set(expanded))


def tokenize_query(query: str) -> list[str]:
    """
    ê²€ìƒ‰ì–´ë¥¼ í† í°ìœ¼ë¡œ ë¶„ë¦¬
    ì˜ˆ: "boss ds-1" â†’ ["boss", "ds-1", "ds1"]
    """
    tokens = []
    # ê³µë°±ìœ¼ë¡œ ë¶„ë¦¬
    words = query.lower().strip().split()
    for word in words:
        tokens.append(word)
        # í•˜ì´í”ˆ ì œê±° ë²„ì „ë„ ì¶”ê°€
        normalized = re.sub(r'[-_]+', '', word)
        if normalized != word:
            tokens.append(normalized)
    return list(set(tokens))


def calculate_instrument_match_score(query: str, instrument) -> float:
    """
    ê²€ìƒ‰ì–´ì™€ ì•…ê¸°ì˜ ë§¤ì¹­ ìŠ¤ì½”ì–´ ê³„ì‚° (0.0 ~ 1.0)

    ë†’ì€ ì ìˆ˜ ì¡°ê±´:
    - ëª¨ë¸ëª… ì •í™• ì¼ì¹˜ (ì˜ˆ: "ds-1" == "DS-1")
    - ë¸Œëœë“œ+ëª¨ë¸ëª… ì¡°í•© ì¼ì¹˜
    - ë³„ì¹­ ë§¤ì¹­ (ì˜ˆ: "ds1" â†’ "DS-1")
    - í† í° ê¸°ë°˜ ë¶€ë¶„ ë§¤ì¹­
    """
    query_normalized = normalize_search_term(query)
    query_tokens = tokenize_query(query)

    # ê²€ìƒ‰ì–´ ë³„ì¹­ í™•ì¥ (ds1 â†’ DS-1 ë“±)
    expanded_queries = expand_query_with_aliases(query)

    name = instrument.name or ""
    brand = instrument.brand or ""
    name_normalized = normalize_search_term(name)
    brand_normalized = normalize_search_term(brand)
    full_name = f"{brand} {name}".strip()
    full_normalized = normalize_search_term(full_name)

    score = 0.0

    # 0. ë³„ì¹­ í™•ì¥ëœ ì¿¼ë¦¬ë¡œ ì •í™• ë§¤ì¹­ ì²´í¬
    for expanded in expanded_queries:
        expanded_norm = normalize_search_term(expanded)
        if expanded_norm == name_normalized:
            score = 1.0
            logger.debug(f"[Score 1.0] ë³„ì¹­ ì •í™• ì¼ì¹˜: '{expanded}' == '{name}'")
            return score
        # ë³„ì¹­ì´ ëª¨ë¸ëª…ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (ì˜ˆ: "DS-1" in "BOSS DS-1 Distortion")
        if expanded.lower() in name.lower():
            score = 0.95
            logger.debug(f"[Score 0.95] ë³„ì¹­ í¬í•¨: '{expanded}' in '{name}'")
            return score

    # 1. ì •ê·œí™”ëœ ëª¨ë¸ëª… ì •í™• ì¼ì¹˜ (ìµœê³  ì ìˆ˜)
    if query_normalized == name_normalized:
        score = 1.0
        logger.debug(f"[Score 1.0] ì •í™• ì¼ì¹˜: '{query}' == '{name}'")
        return score

    # 2. ì •ê·œí™”ëœ ì „ì²´ ì´ë¦„(ë¸Œëœë“œ+ëª¨ë¸) ì •í™• ì¼ì¹˜
    if query_normalized == full_normalized:
        score = 0.95
        logger.debug(f"[Score 0.95] ì „ì²´ ì¼ì¹˜: '{query}' == '{full_name}'")
        return score

    # 3. ëª¨ë¸ëª…ì´ ê²€ìƒ‰ì–´ì— í¬í•¨ (ì˜ˆ: "ds-1" in "boss ds-1")
    if name_normalized and name_normalized in query_normalized:
        score = 0.9
        logger.debug(f"[Score 0.9] ëª¨ë¸ëª… í¬í•¨: '{name}' in '{query}'")
        return score

    # 4. ê²€ìƒ‰ì–´ê°€ ëª¨ë¸ëª…ì— í¬í•¨ (ì˜ˆ: "ds" in "ds-1")
    if query_normalized and query_normalized in name_normalized:
        base_score = 0.7
        # ê¸¸ì´ ë¹„ìœ¨ë¡œ ë³´ì • (ì§§ì€ ê²€ìƒ‰ì–´ í˜ë„í‹°)
        length_ratio = len(query_normalized) / len(name_normalized) if name_normalized else 0
        score = base_score * length_ratio
        logger.debug(f"[Score {score:.2f}] ë¶€ë¶„ í¬í•¨: '{query}' in '{name}'")
        return max(score, 0.3)

    # 5. í† í° ê¸°ë°˜ ë§¤ì¹­ (ë³„ì¹­ í¬í•¨)
    matched_tokens = 0
    all_tokens = query_tokens.copy()
    # ë³„ì¹­ í™•ì¥ëœ í† í°ë„ ì¶”ê°€
    for expanded in expanded_queries:
        all_tokens.extend(tokenize_query(expanded))
    all_tokens = list(set(all_tokens))

    for token in all_tokens:
        token_norm = normalize_search_term(token)
        if token_norm in name_normalized or token_norm in brand_normalized:
            matched_tokens += 1

    if matched_tokens > 0 and all_tokens:
        token_score = matched_tokens / len(all_tokens)
        score = 0.6 * token_score
        logger.debug(f"[Score {score:.2f}] í† í° ë§¤ì¹­: {matched_tokens}/{len(all_tokens)}")
        return score

    # 6. ìœ ì‚¬ë„ ê¸°ë°˜ ë§¤ì¹­ (SequenceMatcher)
    similarity = SequenceMatcher(None, query_normalized, name_normalized).ratio()
    if similarity > 0.6:
        score = 0.5 * similarity
        logger.debug(f"[Score {score:.2f}] ìœ ì‚¬ë„: {similarity:.2f}")
        return score

    return score


def find_best_matching_instruments(query: str, instruments_qs, min_score: float = 0.3):
    """
    ê²€ìƒ‰ì–´ì— ê°€ì¥ ì˜ ë§ëŠ” ì•…ê¸°ë“¤ì„ ìŠ¤ì½”ì–´ ìˆœìœ¼ë¡œ ë°˜í™˜

    Args:
        query: ê²€ìƒ‰ì–´
        instruments_qs: Instrument QuerySet
        min_score: ìµœì†Œ ìŠ¤ì½”ì–´ (ì´í•˜ëŠ” ì œì™¸)

    Returns:
        list of (instrument, score) tuples, sorted by score desc
    """
    scored_instruments = []

    for instrument in instruments_qs:
        score = calculate_instrument_match_score(query, instrument)
        if score >= min_score:
            scored_instruments.append((instrument, score))

    # ìŠ¤ì½”ì–´ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    scored_instruments.sort(key=lambda x: x[1], reverse=True)

    if scored_instruments:
        logger.info(
            f"[ë§¤ì¹­ ê²°ê³¼] query='{query}' â†’ "
            f"Best: {scored_instruments[0][0].brand} {scored_instruments[0][0].name} "
            f"(score={scored_instruments[0][1]:.2f})"
        )

    return scored_instruments


# =============================================================================
# Search Aggregator Service
# =============================================================================

class SearchAggregatorService:
    """
    ë„¤ì´ë²„ ì‡¼í•‘ + DB ìœ ì € ë§¤ë¬¼ í†µí•© ê²€ìƒ‰ ì„œë¹„ìŠ¤.
    ê°€ê²©ìˆœ ì •ë ¬ë¡œ ë³‘í•©.
    """
    
    def __init__(self):
        self.naver_service = NaverShoppingService()
    
    def _extract_brand_from_query(self, query: str) -> str | None:
        """ê²€ìƒ‰ì–´ì—ì„œ ë¸Œëœë“œ ì¶”ì¶œ (ê°„ë‹¨í•œ íœ´ë¦¬ìŠ¤í‹±)"""
        from .config import CategoryConfig
        
        query_lower = query.lower()
        print(query_lower)
        
        # ì•Œë ¤ì§„ ë¸Œëœë“œ ëª©ë¡ì—ì„œ ì°¾ê¸°
        known_brands = CategoryConfig.KNOWN_BRANDS + [
            'boss', 'ibanez', 'jackson', 'charvel', 'schecter', 'suhr',
            'mesa', 'vox', 'marshall', 'orange', 'ampeg', 'tc electronic'
        ]
        
        # 0. í•œê¸€ ë¸Œëœë“œ ë§¤í•‘ ì²´í¬
        for kr_name, en_brand in CategoryConfig.BRAND_NAME_MAPPING.items():
            if kr_name in query_lower:
                return en_brand

        for brand in known_brands:
            if brand in query_lower:
                return brand
        
        # ì²« ë‹¨ì–´ë¥¼ ë¸Œëœë“œë¡œ ê°€ì • (2ê¸€ì ì´ìƒ)
        first_word = query.split()[0] if query.split() else ""
        if len(first_word) > 2:
            return first_word.lower()
        
        return None
    
    def _detect_category(self, query: str) -> str | None:
        """ê²€ìƒ‰ì–´ì—ì„œ ì¹´í…Œê³ ë¦¬ ì¶”ë¡ """
        from .config import CategoryConfig
        
        query_lower = query.lower()
        
        if any(kw in query_lower for kw in CategoryConfig.BASS_KEYWORDS):
            return 'BASS'
        if any(kw in query_lower for kw in CategoryConfig.PEDAL_KEYWORDS):
            return 'PEDAL'
        if any(kw in query_lower for kw in CategoryConfig.AMP_KEYWORDS):
            return 'AMP'
        if any(kw in query_lower for kw in CategoryConfig.ACOUSTIC_KEYWORDS):
            return 'ACOUSTIC'
        
        # ê¸°ë³¸ê°’ì€ GUITAR
        return 'GUITAR'
    
    def search(self, query: str, display: int = 20) -> dict[str, Any]:
        """
        í†µí•© ê²€ìƒ‰ ìˆ˜í–‰.
        
        Returns:
            {
                'query': str,
                'total_count': int,
                'reference': { ... },  # ì‹ í’ˆ ê¸°ì¤€ê°€ ì •ë³´
                'items': [ ... ],      # ê°€ê²©ìˆœ í†µí•© ê²°ê³¼
                'naver_items': [ ... ],
                'user_items': [ ... ],
            }
        """
        # ë¸Œëœë“œ/ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ
        brand = self._extract_brand_from_query(query)
        category = self._detect_category(query)
        
        logger.debug(f"query='{query}', brand={brand}, category={category}")
        
        from .config import CategoryConfig
        query_lower = query.lower().strip()
        query_normalized = normalize_search_term(query)

        # =================================================================
        # 1. DBì—ì„œ ê²€ìƒ‰ì–´ì™€ ë§¤ì¹­ë˜ëŠ” ì•…ê¸°(Instrument) ì°¾ê¸°
        # - ìŠ¤ë§ˆíŠ¸ ë§¤ì¹­: ì •ê·œí™” + ìŠ¤ì½”ì–´ë§ + ë³„ì¹­ í™•ì¥
        # - Unknown ë¸Œëœë“œ ì œì™¸
        # =================================================================

        # 1-1. í›„ë³´ ì•…ê¸° ì¡°íšŒ (ë„“ê²Œ ê²€ìƒ‰)
        query_tokens = tokenize_query(query)
        expanded_queries = expand_query_with_aliases(query)  # ë³„ì¹­ í™•ì¥
        candidate_filter = models.Q()

        # [NEW] ë¸Œëœë“œ ê°ì²´ê°€ ê°ì§€ë˜ë©´ í•´ë‹¹ ë¸Œëœë“œë¡œ í•„í„°ë§ (ìš°ì„ ìˆœìœ„ ë†’ìŒ)
        from .models import Brand
        target_brand = None
        
        # 1. ì¿¼ë¦¬ ì „ì²´ê°€ ë¸Œëœë“œëª…ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
        try:
             target_brand = Brand.objects.get(name__iexact=brand) if brand else None
        except Brand.DoesNotExist:
             target_brand = None

        # 2. ë¸Œëœë“œ ë§¤í•‘ì—ì„œ ê°ì§€ëœ ë¸Œëœë“œê°€ ìˆìœ¼ë©´ DBì—ì„œ ì¡°íšŒ
        if not target_brand and brand:
             target_brand = Brand.objects.filter(slug__iexact=brand).first() or \
                            Brand.objects.filter(name__icontains=brand).first()

        if target_brand:
            logger.info(f"Target Brand Detected: {target_brand.name}")
            # í•´ë‹¹ ë¸Œëœë“œì˜ ì•…ê¸°ë“¤ë§Œ ê²€ìƒ‰ ëŒ€ìƒì— í¬í•¨
            candidate_filter &= models.Q(brand_obj=target_brand)
            
            # ë¸Œëœë“œëª…ì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ì¿¼ë¦¬ë¡œ ëª¨ë¸ëª… ê²€ìƒ‰ (ì˜µì…˜)
            # ì˜ˆ: "Fender Strat" -> brand="Fender", query="Strat"
            # í•˜ì§€ë§Œ í˜„ì¬ effective_queryëŠ” ì „ì²´ ì¿¼ë¦¬ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë‘ 
        
        # ì •ê·œí™”ëœ ê²€ìƒ‰ì–´ë¡œ ì´ë¦„/ë¸Œëœë“œ ê²€ìƒ‰ (ê¸°ì¡´ ë¡œì§ + brand_obj ì¶”ê°€)
        candidate_filter |= models.Q(name__icontains=query_normalized)
        candidate_filter |= models.Q(brand_obj__name__icontains=query_normalized) # Relation ê¸°ë°˜ ê²€ìƒ‰
        for token in query_tokens:
            candidate_filter |= models.Q(name__icontains=token)
            candidate_filter |= models.Q(brand__icontains=token)

        # ë³„ì¹­ í™•ì¥ëœ ì¿¼ë¦¬ë¡œë„ ê²€ìƒ‰ (ì˜ˆ: ds1 â†’ DS-1)
        for expanded in expanded_queries:
            candidate_filter |= models.Q(name__icontains=expanded)
            # í† í° ë¶„ë¦¬ëœ ë³„ì¹­ë„ ê²€ìƒ‰
            for token in expanded.split():
                if len(token) > 1:
                    candidate_filter |= models.Q(name__icontains=token)

        # ì›ë³¸ ê²€ìƒ‰ì–´ë¡œë„ ê²€ìƒ‰ (í•˜ì´í”ˆ í¬í•¨ ì¼€ì´ìŠ¤)
        candidate_filter |= models.Q(name__icontains=query_lower)
        candidate_filter |= models.Q(brand__icontains=query_lower)

        logger.debug(f"ë³„ì¹­ í™•ì¥: {query} â†’ {expanded_queries}")

        candidate_instruments = Instrument.objects.filter(
            candidate_filter
        ).exclude(
            brand__iexact='unknown'
        )[:50]  # ìŠ¤ì½”ì–´ë§ì„ ìœ„í•´ ë„‰ë„‰í•˜ê²Œ

        logger.debug(f"í›„ë³´ ì•…ê¸° {candidate_instruments.count()}ê°œ ì¡°íšŒë¨")

        # 1-2. ìŠ¤ì½”ì–´ë§ ê¸°ë°˜ ìµœì  ë§¤ì¹­
        scored_matches = find_best_matching_instruments(
            query=query,
            instruments_qs=candidate_instruments,
            min_score=0.3  # 30% ì´ìƒ ë§¤ì¹­ë§Œ í¬í•¨
        )

        # ìƒìœ„ 10ê°œë§Œ ì‚¬ìš©
        matching_instruments = [inst for inst, score in scored_matches[:10]]
        best_match = scored_matches[0] if scored_matches else None

        if best_match:
            logger.info(
                f"[DB ë§¤ì¹­] '{query}' â†’ '{best_match[0].brand} {best_match[0].name}' "
                f"(score={best_match[1]:.2f})"
            )

        # =================================================================
        # 2. ë„¤ì´ë²„ ê²€ìƒ‰ - ìµœì  ë§¤ì¹­ ì•…ê¸° ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±
        # =================================================================
        naver_items = []
        search_query = query

        if best_match and best_match[1] >= 0.5:  # 50% ì´ìƒ ë§¤ì¹­ì¼ ë•Œë§Œ ì¹˜í™˜
            best_instrument = best_match[0]
            search_query = f"{best_instrument.brand} {best_instrument.name}"
            brand = best_instrument.brand.lower() if best_instrument.brand else brand
            category = best_instrument.category if best_instrument.category else category
            logger.info(f"[ì¿¼ë¦¬ ë³€í™˜] '{query}' â†’ '{search_query}'")
        else:
            # í•œê¸€ ë¸Œëœë“œ -> ì˜ì–´ ë¸Œëœë“œ ì¹˜í™˜
            for kr_name, en_brand in CategoryConfig.BRAND_NAME_MAPPING.items():
                if kr_name in query:
                    search_query = query.replace(kr_name, en_brand)
                    break
        
        logger.info(f"ê²€ìƒ‰ ì‹œì‘: '{search_query}' (ë¸Œëœë“œ: {brand}, ì¹´í…Œê³ ë¦¬: {category})")
        
        naver_items = self.naver_service.search(
            query=search_query, 
            display=display,
            brand=brand,
            category=category,
        )
        
        # =================================================================
        # 3. DB ìœ ì € ë§¤ë¬¼ ê²€ìƒ‰ - ë§¤ì¹­ëœ ì•…ê¸°ì— ì—°ê²°ëœ UserItem ìš°ì„ 
        # =================================================================
        now = timezone.now()

        # Taxonomy ì •ë³´ ìƒì„± (Brand ê°ì²´ ê¸°ë°˜)
        taxonomy = None
        if target_brand:
            taxonomy = {
                'title': target_brand.name,
                'type': 'brand',
                'brand': target_brand.name,
                'breadcrumbs': ['Home', target_brand.name],
                'description': target_brand.description or f"{target_brand.name} ë¸Œëœë“œì˜ ì•…ê¸° ëª¨ìŒì…ë‹ˆë‹¤.",
                'logo_url': target_brand.logo_url
            }
        elif best_match and best_match[1] >= 0.8:
             # ëª¨ë¸ ë§¤ì¹­ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
             best_inst = best_match[0]
             taxonomy = {
                'title': f"{best_inst.brand_obj.name if best_inst.brand_obj else best_inst.brand.title()} {best_inst.name}",
                'type': 'model',
                'brand': best_inst.brand_obj.name if best_inst.brand_obj else best_inst.brand.title(),
                'breadcrumbs': ['Home', best_inst.brand_obj.name if best_inst.brand_obj else 'Instrument', best_inst.name],
                'description': f"{best_inst.brand_obj.name if best_inst.brand_obj else best_inst.brand}ì˜ {best_inst.name} ëª¨ë¸ì…ë‹ˆë‹¤."
            }

        if matching_instruments:  # ë¦¬ìŠ¤íŠ¸ì´ë¯€ë¡œ len > 0 ì²´í¬
            # ë§¤ì¹­ëœ ì•…ê¸°ë“¤ì˜ UserItem ê°€ì ¸ì˜¤ê¸°
            user_items_qs = UserItem.objects.filter(
                is_active=True,
                expired_at__gt=now,
                instrument__in=matching_instruments
            ).select_related('instrument')[:display]
        else:
            # ë§¤ì¹­ ì•…ê¸° ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ (ì œëª©/ë¸Œëœë“œ ê²€ìƒ‰)
            user_items_qs = UserItem.objects.filter(
                is_active=True,
                expired_at__gt=now,
            ).filter(
                models.Q(instrument__name__icontains=query) |
                models.Q(instrument__brand__icontains=query) |
                models.Q(title__icontains=query)
            ).select_related('instrument')[:display]
        
        # ìœ ì € ë§¤ë¬¼ì„ ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜ + í•„í„°ë§
        user_items = []
        reference_info = None
        
        for item in user_items_qs:
            title = item.title or str(item.instrument)
            
            # ë¸”ë™ë¦¬ìŠ¤íŠ¸ í•„í„°
            if not check_blacklist(title):
                continue
            
            # ìµœì†Œ ê°€ê²© í•„í„° (ìœ ì € ë§¤ë¬¼ì€ ê°€ê²© ì œí•œ ì—†ì´ ë…¸ì¶œ)
            # if not check_min_price(item.price):
            #     continue
            
            user_items.append({
                'id': str(item.id),
                'title': title,
                'link': item.link,
                'image': item.instrument.image_url,
                'lprice': item.price,
                'source': item.source,
                'source_display': item.get_source_display(),
                'discount_rate': item.discount_rate,
                'instrument_id': str(item.instrument.id),
                'instrument_name': item.instrument.name,
                'instrument_brand': item.instrument.brand,
                'score': calculate_match_score(query, title, item.instrument.image_url),
            })
            
            # ì‹ í’ˆ ê¸°ì¤€ê°€ ì •ë³´ (ì²« ë²ˆì§¸ ë§¤ë¬¼ ê¸°ì¤€)
            if reference_info is None and item.instrument.reference_price > 0:
                reference_info = {
                    'name': str(item.instrument),
                    'price': item.instrument.reference_price,
                    'image_url': item.instrument.image_url,
                }
        
        # ì•…ê¸° ë§ˆìŠ¤í„°ì—ì„œë„ ê¸°ì¤€ê°€ ê²€ìƒ‰ (ìœ ì € ë§¤ë¬¼ì´ ì—†ì„ ê²½ìš°)
        # best_matchê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
        if reference_info is None and best_match:
            instrument = best_match[0]
            if instrument.reference_price > 0:
                reference_info = {
                    'name': str(instrument),
                    'price': instrument.reference_price,
                    'image_url': instrument.image_url,
                }

        # ê·¸ë˜ë„ ì—†ìœ¼ë©´ DB ê²€ìƒ‰
        if reference_info is None:
            instrument = Instrument.objects.filter(
                models.Q(name__icontains=query) |
                models.Q(brand__icontains=query)
            ).first()

            if instrument and instrument.reference_price > 0:
                reference_info = {
                    'name': str(instrument),
                    'price': instrument.reference_price,
                    'image_url': instrument.image_url,
                }
        
        # 3. ê°€ê²©ìˆœ ë³‘í•© ì •ë ¬
        all_items = naver_items + user_items
        all_items.sort(key=lambda x: x.get('lprice', 0))
        
        logger.info(f"âœ… ê²€ìƒ‰ ì™„ë£Œ: ë„¤ì´ë²„({len(naver_items)}) + ìœ ì €({len(user_items)}) = ì´({len(all_items)})")
        
        return {
            'query': query,
            'total_count': len(all_items),
            'reference': reference_info,
            'items': all_items,
            'naver_items': naver_items,
            'user_items': user_items,
            'taxonomy': taxonomy,
        }


# =============================================================================
# AI Description Service
# =============================================================================

class AIDescriptionService:
    """
    AI ì•…ê¸° ì„¤ëª… ìƒì„± ì„œë¹„ìŠ¤.
    í• ë£¨ì‹œë„¤ì´ì…˜ ë°©ì§€ë¥¼ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ ì ìš©.
    """
    
    def __init__(self):
        self.api_key = settings.OPENAI_API_KEY
        self.api_url = 'https://api.openai.com/v1/chat/completions'
    
    def generate_description(
        self, 
        model_name: str, 
        brand: str, 
        category: str
    ) -> dict[str, str]:
        """
        ì•…ê¸° ì„¤ëª… ìƒì„± (í• ë£¨ì‹œë„¤ì´ì…˜ ë°©ì§€ ì ìš©).
        
        Returns:
            {'summary': str, 'check_point': str}
        """
        if not self.api_key:
            logger.warning("OpenAI API key not configured")
            return {
                'summary': f'{brand} {model_name} - ë¯¿ì„ ìˆ˜ ìˆëŠ” ì„ íƒ',
                'check_point': '',
            }
        
        # í• ë£¨ì‹œë„¤ì´ì…˜ ë°©ì§€ í”„ë¡¬í”„íŠ¸
        system_prompt = """ë„ˆëŠ” ì•…ê¸° ì „ë¬¸ê°€ì´ì íŒ©íŠ¸ ì²´í¬ì— ì—„ê²©í•œ ì—ë””í„°ë‹¤.
ì‚¬ìš©ìê°€ ìš”ì²­í•œ ì•…ê¸°ì— ëŒ€í•œ 'í•œ ì¤„ í‰'ê³¼ 'êµ¬ë§¤ ê°€ì´ë“œ'ë¥¼ ì‘ì„±í•˜ë¼.

# Rules (Strict)
1. **No Hallucination:** Input Dataì™€ ë„ˆì˜ ì§€ì‹ ë² ì´ìŠ¤ê°€ 100% ì¼ì¹˜í•˜ëŠ” íŒ©íŠ¸ë§Œ ì„œìˆ í•˜ë¼.
   ì¶œì‹œ ì—°ë„ë‚˜ ì„¸ë¶€ ìŠ¤í™ì´ í™•ì‹¤í•˜ì§€ ì•Šìœ¼ë©´ ì ˆëŒ€ ì–¸ê¸‰í•˜ì§€ ë§ê³  í†¤/ìŒìƒ‰ íŠ¹ì§• ìœ„ì£¼ë¡œ ì„œìˆ í•˜ë¼.
2. **Tone:** "ì´ ì•…ê¸°ëŠ”~" ì²˜ëŸ¼ ì§€ë£¨í•˜ê²Œ ì‹œì‘í•˜ì§€ ë§ˆë¼.
   "ë”°ëœ»í•œ ë°°ìŒì´ ë§¤ë ¥ì ì…ë‹ˆë‹¤", "ì…ë¬¸ìš©ìœ¼ë¡œ ìµœê³ ì˜ ì„ íƒì…ë‹ˆë‹¤" ê°™ì´ í•µì‹¬ë¶€í„° ì°Œë¥´ëŠ” ê°„ê²°í•œ ë¬¸ì²´ë¥¼ ì¨ë¼.
3. **Structure:**
   - [summary]: 20ì ì´ë‚´ ì„íŒ©íŠ¸ ìˆëŠ” ë¬¸êµ¬.
   - [check_point]: ì¤‘ê³  ê±°ë˜ ì‹œ ë°˜ë“œì‹œ í™•ì¸í•´ì•¼ í•  ê³ ì§ˆë³‘(ë…¸ë¸Œ ì¡ìŒ, ë„¥ íœ¨ ë“±) 1ê°€ì§€. ëª¨ë¥´ë©´ ë¹ˆ ë¬¸ìì—´.

JSON í˜•ì‹ìœ¼ë¡œ { "summary": "...", "check_point": "..." } ë§Œ ì¶œë ¥í•˜ë¼."""
        
        user_prompt = f"""# Input Data
- ëª¨ë¸ëª…: {model_name}
- ë¸Œëœë“œ: {brand}
- ì¹´í…Œê³ ë¦¬: {category}"""
        
        try:
            import json
            response = requests.post(
                self.api_url,
                headers={
                    'Authorization': f'Bearer {self.api_key}',
                    'Content-Type': 'application/json',
                },
                json={
                    'model': 'gpt-4o-mini',
                    'messages': [
                        {'role': 'system', 'content': system_prompt},
                        {'role': 'user', 'content': user_prompt},
                    ],
                    'temperature': 0.2,  # ì°½ì˜ì„± ë‚®ì¶¤ (íŒ©íŠ¸ ìœ„ì£¼)
                    'max_tokens': 200,
                },
                timeout=10,
            )
            response.raise_for_status()
            
            data = response.json()
            content = data['choices'][0]['message']['content']
            
            # JSON íŒŒì‹±
            result = json.loads(content)
            return {
                'summary': result.get('summary', ''),
                'check_point': result.get('check_point', ''),
            }
            
        except Exception as e:
            logger.exception(f"AI description generation error: {e}")
            return {
                'summary': f'{brand} {model_name}',
                'check_point': '',
            }
</file>

<file path="backend/dagu/services/utils.py">
"""
Search utility functions for MALCHA-DAGU.

Provides search term normalization, alias expansion, and instrument matching.
"""

from __future__ import annotations

import logging
import re
from difflib import SequenceMatcher
from functools import lru_cache
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from django.db.models import QuerySet
    from ..models import Instrument

logger = logging.getLogger(__name__)


# =============================================================================
# Cached Config Accessors (ì„±ëŠ¥ ìµœì í™”)
# =============================================================================

@lru_cache(maxsize=1)
def _get_model_aliases() -> dict[str, str]:
    """MODEL_ALIASES ìºì‹œ ë¡œë“œ"""
    from ..config import CategoryConfig
    return getattr(CategoryConfig, 'MODEL_ALIASES', {})


@lru_cache(maxsize=1)
def _get_brand_mapping() -> dict[str, str]:
    """BRAND_NAME_MAPPING ìºì‹œ ë¡œë“œ"""
    from ..config import CategoryConfig
    return getattr(CategoryConfig, 'BRAND_NAME_MAPPING', {})


@lru_cache(maxsize=1)
def _get_guitar_brands() -> list[str]:
    """GUITAR_BRANDS ìºì‹œ ë¡œë“œ"""
    from ..config import CategoryConfig
    return getattr(CategoryConfig, 'GUITAR_BRANDS', [])


def clear_config_cache() -> None:
    """ì„¤ì • ìºì‹œ ì´ˆê¸°í™” (ì„¤ì • ë³€ê²½ ì‹œ í˜¸ì¶œ)"""
    _get_model_aliases.cache_clear()
    _get_brand_mapping.cache_clear()
    _get_guitar_brands.cache_clear()
    _get_known_brands.cache_clear()
    _get_category_keywords.cache_clear()


# =============================================================================
# Brand Normalization (í†µí•© ë¸Œëœë“œ ì²˜ë¦¬)
# =============================================================================

@lru_cache(maxsize=1)
def _get_known_brands() -> list[str]:
    """KNOWN_BRANDS ìºì‹œ ë¡œë“œ"""
    from ..config import CategoryConfig
    return getattr(CategoryConfig, 'KNOWN_BRANDS', [])


def normalize_brand(query: str) -> str:
    """
    ê²€ìƒ‰ì–´ì—ì„œ í•œê¸€ ë¸Œëœë“œë¥¼ ì˜ë¬¸ìœ¼ë¡œ ë³€í™˜.

    Examples:
        >>> normalize_brand("íœë” ìŠ¤íŠ¸ë«")
        'fender ìŠ¤íŠ¸ë«'
        >>> normalize_brand("boss ds-1")
        'boss ds-1'

    Args:
        query: ê²€ìƒ‰ì–´

    Returns:
        ì˜ë¬¸ ë¸Œëœë“œë¡œ ì¹˜í™˜ëœ ê²€ìƒ‰ì–´
    """
    brand_mapping = _get_brand_mapping()
    result = query

    for kr_name, en_brand in brand_mapping.items():
        if kr_name in query:
            result = query.replace(kr_name, en_brand)
            logger.debug(f"[Brand] ì •ê·œí™”: '{query}' -> '{result}'")
            break

    return result


def extract_brand(query: str) -> str | None:
    """
    ê²€ìƒ‰ì–´ì—ì„œ ë¸Œëœë“œ ì¶”ì¶œ.

    Examples:
        >>> extract_brand("íœë” ìŠ¤íŠ¸ë«")
        'fender'
        >>> extract_brand("BOSS DS-1")
        'boss'

    Args:
        query: ê²€ìƒ‰ì–´

    Returns:
        ì¶”ì¶œëœ ë¸Œëœë“œ (ì†Œë¬¸ì) ë˜ëŠ” None
    """
    query_lower = query.lower()

    # í•œê¸€ ë¸Œëœë“œ ë§¤í•‘ ì²´í¬
    brand_mapping = _get_brand_mapping()
    for kr_name, en_brand in brand_mapping.items():
        if kr_name in query_lower:
            return en_brand

    # ì•Œë ¤ì§„ ë¸Œëœë“œ ëª©ë¡ì—ì„œ ì°¾ê¸°
    guitar_brands = _get_guitar_brands()
    known_brands = _get_known_brands()
    all_brands = guitar_brands + known_brands

    for brand in all_brands:
        if brand in query_lower:
            return brand

    # ì²« ë‹¨ì–´ë¥¼ ë¸Œëœë“œë¡œ ê°€ì • (2ê¸€ì ì´ìƒ)
    # ë‹¨, ëª¨ë¸ëª…ì´ë‚˜ ì¹´í…Œê³ ë¦¬ í‚¤ì›Œë“œì¸ ê²½ìš° ì œì™¸ (ì˜ˆ: "sm57", "strat")
    words = query.split()
    if words and len(words[0]) > 2:
        candidate = words[0].lower()
        
        # 1. ëª¨ë¸ ë³„ì¹­ ì²´í¬
        aliases = _get_model_aliases()
        if candidate in aliases:
            return None
            
        # 2. ì¹´í…Œê³ ë¦¬ í‚¤ì›Œë“œ ì²´í¬ (ì˜ˆ: guitar, bass, sm57 ë“±)
        category_keywords = _get_category_keywords()
        for kw_list in category_keywords.values():
            if candidate in kw_list:
                return None
        
        # 3. ëª¨ë¸ëª… ë°¸ë¥˜ ì²´í¬ (Aliasì˜ target ê°’)
        if candidate in [v.lower() for v in aliases.values()]:
            return None

        return candidate


def is_known_brand(brand_name: str) -> bool:
    """
    í•´ë‹¹ ë¸Œëœë“œëª…ì´ ì•Œë ¤ì§„ ë¸Œëœë“œ ëª©ë¡(ì„¤ì •ê°’)ì— í¬í•¨ë˜ëŠ”ì§€ í™•ì¸.
    ê²€ìƒ‰ í•„í„°ë§ ì‹œ ì˜ëª»ëœ ë¸Œëœë“œ ì¶”ì •ìœ¼ë¡œ ì¸í•œ ê²°ê³¼ ëˆ„ë½ ë°©ì§€ìš©.
    """
    if not brand_name:
        return False
        
    brand_lower = brand_name.lower()
    
    # 1. ê¸°íƒ€ ë¸Œëœë“œ ëª©ë¡
    if brand_lower in [b.lower() for b in _get_guitar_brands()]:
        return True
        
    # 2. ì¶”ê°€ ì•Œë ¤ì§„ ë¸Œëœë“œ ëª©ë¡
    if brand_lower in [b.lower() for b in _get_known_brands()]:
        return True
        
    # 3. ë§¤í•‘ëœ ì˜ë¬¸ ë¸Œëœë“œ ëª©ë¡
    if brand_lower in [v.lower() for v in _get_brand_mapping().values()]:
        return True
        
    return False

    return None


# =============================================================================
# Category Detection
# =============================================================================

@lru_cache(maxsize=1)
def _get_category_keywords() -> dict[str, list[str]]:
    """ì¹´í…Œê³ ë¦¬ë³„ í‚¤ì›Œë“œ ìºì‹œ ë¡œë“œ"""
    from ..config import CategoryConfig
    return {
        'bass': getattr(CategoryConfig, 'BASS_KEYWORDS', []),
        'effect': getattr(CategoryConfig, 'PEDAL_KEYWORDS', []),
        'amp': getattr(CategoryConfig, 'AMP_KEYWORDS', []),
        'acoustic': getattr(CategoryConfig, 'ACOUSTIC_KEYWORDS', []),
        'mic': getattr(CategoryConfig, 'MIC_KEYWORDS', []),
    }


def detect_category(text: str) -> str:
    """
    í…ìŠ¤íŠ¸ì—ì„œ ì•…ê¸° ì¹´í…Œê³ ë¦¬ ì¶”ë¡ .

    Examples:
        >>> detect_category("BOSS DS-1 ë””ìŠ¤í† ì…˜ í˜ë‹¬")
        'effect'
        >>> detect_category("Fender Jazz Bass")
        'bass'
        >>> detect_category("Gibson Les Paul")
        'guitar'

    Args:
        text: ì œëª© ë˜ëŠ” ê²€ìƒ‰ì–´

    Returns:
        ì¹´í…Œê³ ë¦¬ ('guitar', 'bass', 'effect', 'amp', 'acoustic')
    """
    text_lower = text.lower()
    keywords = _get_category_keywords()

    for category, kw_list in keywords.items():
        if any(kw in text_lower for kw in kw_list):
            return category

    return 'guitar'  # ê¸°ë³¸ê°’


# =============================================================================
# Search Term Normalization
# =============================================================================

def normalize_search_term(term: str) -> str:
    """
    ê²€ìƒ‰ì–´ ì •ê·œí™”: ëŒ€ì†Œë¬¸ì, í•˜ì´í”ˆ, ê³µë°± í†µì¼.

    Examples:
        >>> normalize_search_term("DS-1")
        'ds1'
        >>> normalize_search_term("ds 1")
        'ds1'
        >>> normalize_search_term("Les Paul")
        'lespaul'

    Args:
        term: ì›ë³¸ ê²€ìƒ‰ì–´

    Returns:
        ì •ê·œí™”ëœ ê²€ìƒ‰ì–´ (ì†Œë¬¸ì, íŠ¹ìˆ˜ë¬¸ì ì œê±°)
    """
    if not term:
        return ""

    result = term.lower().strip()
    # í•˜ì´í”ˆ, ì–¸ë”ìŠ¤ì½”ì–´, ê³µë°± ì œê±°
    result = re.sub(r'[-_\s]+', '', result)
    return result





def tokenize_query(query: str) -> list[str]:
    """
    ê²€ìƒ‰ì–´ë¥¼ í† í°ìœ¼ë¡œ ë¶„ë¦¬.

    Examples:
        >>> tokenize_query("boss ds-1")
        ['boss', 'ds-1', 'ds1']
        >>> tokenize_query("Fender Strat")
        ['fender', 'strat']

    Args:
        query: ê²€ìƒ‰ì–´

    Returns:
        í† í° ë¦¬ìŠ¤íŠ¸ (ì›ë³¸ + ì •ê·œí™”ëœ ë²„ì „)
    """
    tokens = []
    words = query.lower().strip().split()

    for word in words:
        tokens.append(word)
        # í•˜ì´í”ˆ ì œê±° ë²„ì „ë„ ì¶”ê°€ (ds-1 -> ds1)
        normalized = re.sub(r'[-_]+', '', word)
        if normalized != word:
            tokens.append(normalized)

    return list(set(tokens))


def expand_query_with_aliases(query: str) -> list[str]:
    """
    ê²€ìƒ‰ì–´ë¥¼ ë³„ì¹­ ë§¤í•‘ìœ¼ë¡œ í™•ì¥.

    Examples:
        >>> expand_query_with_aliases("ds1")
        ['ds1', 'DS-1']
        >>> expand_query_with_aliases("strat")
        ['strat', 'Stratocaster']

    Args:
        query: ê²€ìƒ‰ì–´

    Returns:
        í™•ì¥ëœ ê²€ìƒ‰ì–´ ë¦¬ìŠ¤íŠ¸ (ì›ë³¸ + ë³„ì¹­ ë§¤í•‘ëœ ì •ì‹ëª…)
    """
    aliases = _get_model_aliases()
    expanded = [query]

    query_lower = query.lower().strip()
    query_normalized = normalize_search_term(query)

    # ì •ê·œí™”ëœ ê²€ìƒ‰ì–´ë¡œ ë³„ì¹­ ì°¾ê¸°
    if query_normalized in aliases:
        expanded.append(aliases[query_normalized])

    # ì›ë³¸ ê²€ìƒ‰ì–´(ì†Œë¬¸ì)ë¡œë„ ë³„ì¹­ ì°¾ê¸°
    if query_lower in aliases:
        expanded.append(aliases[query_lower])

    # ê° í† í°ë³„ë¡œ ë³„ì¹­ í™•ì¥
    for token in query_lower.split():
        token_norm = normalize_search_term(token)
        if token_norm in aliases:
            expanded.append(aliases[token_norm])
        if token in aliases:
            expanded.append(aliases[token])

    return list(set(expanded))


# =============================================================================
# Instrument Matching
# =============================================================================

def calculate_instrument_match_score(query: str, instrument: Instrument) -> float:
    """
    ê²€ìƒ‰ì–´ì™€ ì•…ê¸°ì˜ ë§¤ì¹­ ìŠ¤ì½”ì–´ ê³„ì‚°.

    Scoring Tiers (ê°œì„ ëœ ìš°ì„ ìˆœìœ„):
        1.0  - ì •ê·œí™”ëœ ì´ë¦„ ì •í™• ì¼ì¹˜ (DS-1 == DS-1)
        0.95 - ë³„ì¹­ í™•ì¥ í›„ ì •í™• ì¼ì¹˜
        0.9  - ë‹¨ì–´ ê²½ê³„ ì¼ì¹˜ (ê²€ìƒ‰ì–´ê°€ ì™„ì „í•œ í† í°)
        0.7  - ë¶€ë¶„ í¬í•¨ + Length Penalty (ì ‘ë¯¸ì‚¬ ì—†ìŒ)
        0.5  - ë¶€ë¶„ í¬í•¨ + ë²„ì „ ì ‘ë¯¸ì‚¬ ìˆìŒ (DS-1W ë“±)
        0.4  - í† í° ê¸°ë°˜ ë§¤ì¹­
        0.3  - ìœ ì‚¬ë„ ê¸°ë°˜ ë§¤ì¹­

    Args:
        query: ê²€ìƒ‰ì–´
        instrument: Instrument ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤

    Returns:
        0.0 ~ 1.0 ì‚¬ì´ì˜ ë§¤ì¹­ ìŠ¤ì½”ì–´
    """
    query_normalized = normalize_search_term(query)
    query_tokens = tokenize_query(query)
    expanded_queries = expand_query_with_aliases(query)

    name = instrument.name or ""
    brand = instrument.brand or ""
    name_normalized = normalize_search_term(name)
    brand_normalized = normalize_search_term(brand)
    full_name = f"{brand} {name}".strip()
    full_normalized = normalize_search_term(full_name)

    # =========================================================================
    # Tier -1: ë¸Œëœë“œ ë¶ˆì¼ì¹˜ í•„í„°ë§ (Brand Mismatch Hard Filter)
    # =========================================================================
    # ì¿¼ë¦¬ì—ì„œ ëª…í™•í•œ ë¸Œëœë“œê°€ ê°ì§€ë˜ì—ˆëŠ”ë°, ì•…ê¸° ë¸Œëœë“œì™€ ë‹¤ë¥´ë©´ ì œì™¸
    # ì˜ˆ: "Gibson Les Paul" ê²€ìƒ‰ ì‹œ "Epiphone Les Paul"ì€ ì œì™¸ë˜ì–´ì•¼ í•¨
    detected_brand = extract_brand(query)
    if detected_brand and is_known_brand(detected_brand):
        # ê°ì§€ëœ ë¸Œëœë“œê°€ ì•…ê¸° ë¸Œëœë“œ(ì •ê·œí™”ë¨)ì— í¬í•¨ë˜ì§€ ì•Šìœ¼ë©´ ë¶ˆì¼ì¹˜ë¡œ ê°„ì£¼
        # (ì˜ˆ: detected="gibson", brand="epiphone" -> ë¶ˆì¼ì¹˜)
        # (ì˜ˆ: detected="fender", brand="squier by fender" -> ì¼ì¹˜ í—ˆìš©)
        if brand_normalized and normalize_search_term(detected_brand) not in brand_normalized:
            logger.debug(f"[Score 0.0] ë¸Œëœë“œ ë¶ˆì¼ì¹˜: ì¿¼ë¦¬('{detected_brand}') != ì•…ê¸°('{brand}')")
            return 0.0

    # =========================================================================
    # Tier 0: ì •ê·œí™”ëœ ì´ë¦„ ì •í™• ì¼ì¹˜ (ìµœìš°ì„ )
    # =========================================================================
    if query_normalized == name_normalized:
        logger.debug(f"[Score 1.0] ì •í™• ì¼ì¹˜: '{query}' == '{name}'")
        return 1.0

    # Tier 0.5: ì „ì²´ ì´ë¦„(ë¸Œëœë“œ+ëª¨ë¸) ì •í™• ì¼ì¹˜
    if query_normalized == full_normalized:
        logger.debug(f"[Score 1.0] ì „ì²´ ì¼ì¹˜: '{query}' == '{full_name}'")
        return 1.0

    # =========================================================================
    # Tier 1: ë³„ì¹­ í™•ì¥ í›„ ì •í™• ì¼ì¹˜
    # =========================================================================
    for expanded in expanded_queries:
        expanded_norm = normalize_search_term(expanded)
        if expanded_norm == name_normalized:
            logger.debug(f"[Score 0.95] ë³„ì¹­ ì •í™• ì¼ì¹˜: '{expanded}' == '{name}'")
            return 0.95

    # =========================================================================
    # Tier 2: ëª¨ë¸ëª…ì´ ê²€ìƒ‰ì–´ì— í¬í•¨ (ì‚¬ìš©ìê°€ ë” ê¸´ ì¿¼ë¦¬ ì…ë ¥)
    # =========================================================================
    if name_normalized and name_normalized in query_normalized:
        logger.debug(f"[Score 0.9] ëª¨ë¸ëª… í¬í•¨: '{name}' in '{query}'")
        return 0.9

    # =========================================================================
    # Tier 3: ê²€ìƒ‰ì–´ê°€ ëª¨ë¸ëª…ì— í¬í•¨ (ë¶€ë¶„ ì¼ì¹˜)
    # - ë²„ì „ ì ‘ë¯¸ì‚¬ ê²€ì‚¬ (DS-1 vs DS-1W)
    # - Length Penalty ì ìš©
    # =========================================================================
    if query_normalized and query_normalized in name_normalized:
        idx = name_normalized.find(query_normalized)
        suffix_start = idx + len(query_normalized)
        
        # ê²€ìƒ‰ì–´ ë’¤ì— ë¬¸ìê°€ ë¶™ì–´ìˆëŠ”ì§€ í™•ì¸ (ë²„ì „ ì ‘ë¯¸ì‚¬)
        if suffix_start < len(name_normalized):
            next_char = name_normalized[suffix_start]
            # ì•ŒíŒŒë²³/ìˆ«ìê°€ ë°”ë¡œ ë¶™ì–´ìˆìœ¼ë©´ ë‹¤ë¥¸ ëª¨ë¸ (DS-1W, SM57-LC ë“±)
            if next_char.isalnum():
                logger.debug(f"[Score 0.5] ë²„ì „ ì ‘ë¯¸ì‚¬ ê°ì§€: '{query}' in '{name}' (suffix: '{name_normalized[suffix_start:]}')")
                return 0.5
        
        # ì ‘ë¯¸ì‚¬ ì—†ìŒ â†’ Length Penalty ì ìš©
        length_diff = len(name_normalized) - len(query_normalized)
        # ê¸€ì ì°¨ì´ê°€ í´ìˆ˜ë¡ ì ìˆ˜ ê°ì†Œ (ìµœì†Œ 0.5)
        penalty = max(0.5, 1.0 - (length_diff * 0.05))
        score = 0.7 * penalty
        logger.debug(f"[Score {score:.2f}] ë¶€ë¶„ í¬í•¨: '{query}' in '{name}' (length_diff={length_diff})")
        return score

    # =========================================================================
    # Tier 4: ë³„ì¹­ í™•ì¥ ì¿¼ë¦¬ê°€ ëª¨ë¸ëª…ì— í¬í•¨
    # =========================================================================
    for expanded in expanded_queries:
        if expanded.lower() in name.lower():
            logger.debug(f"[Score 0.6] ë³„ì¹­ ë¶€ë¶„ í¬í•¨: '{expanded}' in '{name}'")
            return 0.6

    # =========================================================================
    # Tier 5: í† í° ê¸°ë°˜ ë§¤ì¹­
    # =========================================================================
    all_tokens = query_tokens.copy()
    for expanded in expanded_queries:
        all_tokens.extend(tokenize_query(expanded))
    all_tokens = list(set(all_tokens))

    matched_tokens = sum(
        1 for token in all_tokens
        if normalize_search_term(token) in name_normalized
        or normalize_search_term(token) in brand_normalized
    )

    if matched_tokens > 0 and all_tokens:
        score = 0.4 * (matched_tokens / len(all_tokens))
        logger.debug(f"[Score {score:.2f}] í† í° ë§¤ì¹­: {matched_tokens}/{len(all_tokens)}")
        return score

    # =========================================================================
    # Tier 6: ìœ ì‚¬ë„ ê¸°ë°˜ ë§¤ì¹­ (fallback)
    # =========================================================================
    similarity = SequenceMatcher(None, query_normalized, name_normalized).ratio()
    if similarity > 0.6:
        score = 0.3 * similarity
        logger.debug(f"[Score {score:.2f}] ìœ ì‚¬ë„: {similarity:.2f}")
        return score

    return 0.0


def find_best_matching_instruments(
    query: str,
    instruments_qs: QuerySet[Instrument],
    min_score: float = 0.3,
) -> list[tuple[Instrument, float]]:
    """
    ê²€ìƒ‰ì–´ì— ê°€ì¥ ì˜ ë§ëŠ” ì•…ê¸°ë“¤ì„ ìŠ¤ì½”ì–´ ìˆœìœ¼ë¡œ ë°˜í™˜.

    Args:
        query: ê²€ìƒ‰ì–´
        instruments_qs: Instrument QuerySet
        min_score: ìµœì†Œ ìŠ¤ì½”ì–´ (ì´í•˜ëŠ” ì œì™¸)

    Returns:
        (instrument, score) íŠœí”Œ ë¦¬ìŠ¤íŠ¸, ìŠ¤ì½”ì–´ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    """
    scored_instruments = [
        (instrument, calculate_instrument_match_score(query, instrument))
        for instrument in instruments_qs
    ]

    # ìµœì†Œ ìŠ¤ì½”ì–´ ì´ìƒë§Œ í•„í„°ë§
    scored_instruments = [
        (inst, score) for inst, score in scored_instruments
        if score >= min_score
    ]

    # ìŠ¤ì½”ì–´ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    scored_instruments.sort(key=lambda x: x[1], reverse=True)

    if scored_instruments:
        best = scored_instruments[0]
        logger.info(
            f"[ë§¤ì¹­ ê²°ê³¼] query='{query}' -> "
            f"Best: {best[0].brand} {best[0].name} (score={best[1]:.2f})"
        )

    return scored_instruments
</file>

<file path="frontend/src/types/index.ts">
/**
 * Type definitions for MALCHA-DAGU
 */

// =============================================================================
// API Response Types
// =============================================================================

export interface Instrument {
    id: string;
    name: string;
    brand: string;
    category: string;
    category_display: string;
    image_url: string;
    reference_price: number;
    description: string;
    created_at: string;
    updated_at: string;
}

export interface UserItem {
    id: string;
    instrument: string;
    instrument_detail: {
        id: string;
        name: string;
        brand: string;
        image_url: string;
        reference_price: number;
    };
    price: number;
    link: string;
    source: string;
    source_display: string;
    title: string;
    is_active: boolean;
    expired_at: string;
    extended_at: string | null;
    click_count: number;
    discount_rate: number;
    is_expired: boolean;
    is_owner: boolean;
    owner_id: number | null;
    created_at: string;
    updated_at: string;
}

export interface NaverItem {
    title: string;
    link: string;
    image: string;
    lprice: number;
    hprice: number;
    mallName: string;
    productId: string;
    productType: number;
    source: 'naver';
}

export interface SearchResult {
    query: string;
    search_query: string;  // ì •ê·œí™”ëœ ê²€ìƒ‰ì–´ (ì™¸ë¶€ ë§í¬ìš©)
    total_count: number;
    reference: {
        name: string;
        price: number;
        image_url: string;
    } | null;
    taxonomy: {
        title: string;
        type: string; // 'brand' | 'model'
        brand: string;
        breadcrumbs: string[];
        description: string;
        logo_url?: string;
    } | null;
    matched_instrument: {
        id: string;
        name: string;
        brand: string;
        category: string;
    } | null;
    items: (NaverItem | MergedUserItem)[];
    naver_items: NaverItem[];
    user_items: MergedUserItem[];
}

export interface MergedUserItem {
    id: string;
    title: string;
    link: string;
    image: string;
    lprice: number;
    source: string;
    source_display: string;
    discount_rate: number;
    instrument_id: string;
    instrument_name: string;
    instrument_brand: string;
    extended_at: string | null;
    report_count: number;
}

// ì‹ ê³  ì‚¬ìœ  íƒ€ì…
export type ReportReason = 'wrong_price' | 'sold_out' | 'fake' | 'inappropriate' | 'other';

export const REPORT_REASON_LABELS: Record<ReportReason, string> = {
    wrong_price: 'ê°€ê²©ì´ ë‹¤ë¦…ë‹ˆë‹¤',
    sold_out: 'ì´ë¯¸ íŒë§¤ì™„ë£Œëœ ë§¤ë¬¼ì…ë‹ˆë‹¤',
    fake: 'í—ˆìœ„/ì‚¬ê¸° ë§¤ë¬¼ì…ë‹ˆë‹¤',
    inappropriate: 'ë¶€ì ì ˆí•œ ë‚´ìš©ì…ë‹ˆë‹¤',
    other: 'ê¸°íƒ€',
};

export interface AIDescription {
    summary: string;
    check_point: string;
}

// =============================================================================
// Component Props Types
// =============================================================================

export interface SearchBarProps {
    onSearch: (query: string) => void;
    isLoading?: boolean;
    placeholder?: string;
}

export interface ItemCardProps {
    item: NaverItem | MergedUserItem;
    rank?: number;
    referencePrice?: number;
    onClick?: () => void;
    isOwner?: boolean;
    isLoggedIn?: boolean;
    onExtend?: () => void;
    onReport?: (reason: ReportReason, detail?: string) => void;
    onUpdatePrice?: (newPrice: number) => void;
}

export interface LoaderProps {
    isVisible: boolean;
    onComplete?: () => void;
}
</file>

<file path="frontend/vite.config.ts">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import tailwindcss from '@tailwindcss/vite'

// https://vite.dev/config/
// í•¨ìˆ˜ í˜•íƒœë¡œ ë°”ê¿”ì„œ command(ì‹¤í–‰ ëª…ë ¹ì–´)ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
export default defineConfig(({ command }) => {
  const isBuild = command === 'build';

  return {
    plugins: [
      react(),
      tailwindcss(),
    ],
    // [í•µì‹¬] ë¹Œë“œí•  ë•Œ(ë°°í¬ìš©)ëŠ” '/static/', ë¡œì»¬ ê°œë°œì¼ ë•ŒëŠ” '/' ì‚¬ìš©
    base: isBuild ? '/static/' : '/',

    server: {
      port: 3000,
      proxy: {
        '/api': {
          target: 'http://localhost:8001',
          changeOrigin: true,
        },
      },
    },
  };
});
</file>

<file path="requirements.txt">
# --- 1. Django & Web Framework ---
Django
djangorestframework
djangorestframework-simplejwt
django-cors-headers
django-environ
django-allauth
dj-rest-auth
django-redis

# --- 2. Server & Database ---
gunicorn
whitenoise
psycopg2-binary
dj-database-url

# --- 3. Async Task & Redis ---
celery
django-celery-results
redis
kombu
billiard
vine

# --- 4. Utilities ---
Pillow
requests
python-dotenv
urllib3
certifi
idna
charset-normalizer

# --- 5. Data & Audio Processing ---
numpy
pandas
scipy
librosa
soundfile
audioread
numba
llvmlite
scikit-learn
joblib
pooch
platformdirs
mido
# rtmidiëŠ” ì„œë²„(Linux)ì—ì„œ ì†Œë¦¬ë¥¼ ëª» ë‚´ë¯€ë¡œ ì œê±°í•¨

# --- 6. Korean Text Processing ---
python-mecab-ko
python-mecab-ko-dic
konlpy
JPype1

# --- 7. Others (System Compatibility) ---
# opencvëŠ” ì„œë²„ìš©ì¸ headless ë²„ì „ì„ ì¨ì•¼ ì—ëŸ¬ê°€ ì•ˆ ë‚©ë‹ˆë‹¤.
opencv-python-headless
# ìœˆë„ìš°ìš© python-magic-bin ëŒ€ì‹  ë¦¬ëˆ…ìŠ¤ìš©ì„ ì”ë‹ˆë‹¤.
python-magic
python-dateutil
pytz
tqdm
typing_extensions
</file>

<file path="frontend/src/components/SearchBar.tsx">
/**
 * Search Bar Component
 * 
 * Features:
 * - ëª¨ë°”ì¼ í¼ìŠ¤íŠ¸ ë””ìì¸
 * - DBì—ì„œ ì•…ê¸° ëª©ë¡ ìë™ì™„ì„±
 * - ê²€ìƒ‰ ë²„íŠ¼ hover íš¨ê³¼
 */

import { useState, useEffect, useRef, type FormEvent } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

interface SearchBarProps {
    onSearch: (query: string) => void;
    isLoading?: boolean;
    placeholder?: string;
    initialValue?: string;
    showSuggestions?: boolean;
    hideHint?: boolean;
}

interface Instrument {
    id: string;
    brand: string;
    name: string;  // APIì—ì„œëŠ” 'name' í•„ë“œ ì‚¬ìš©
    category: string;
}

export default function SearchBar({
    onSearch,
    isLoading = false,
    placeholder = 'ì•…ê¸° ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰ (ì˜ˆ: íœë” ìŠ¤íŠ¸ë«)',
    initialValue = '',
    showSuggestions = true,
    hideHint = false,
}: SearchBarProps) {
    const [query, setQuery] = useState(initialValue);
    const [isFocused, setIsFocused] = useState(false);
    const [suggestions, setSuggestions] = useState<Instrument[]>([]);
    const [showDropdown, setShowDropdown] = useState(false);
    const wrapperRef = useRef<HTMLDivElement>(null);

    // ê²€ìƒ‰ì–´ ë³€ê²½ ì‹œ ì„œë²„ ê²€ìƒ‰ (Debounce ì ìš©)
    useEffect(() => {
        const trimmedQuery = query.trim();
        if (!trimmedQuery || !showSuggestions) {
            setSuggestions([]);
            setShowDropdown(false);
            return;
        }

        const timer = setTimeout(async () => {
            try {
                // ì„œë²„ì—ì„œ ê²€ìƒ‰ (ë¸Œëœë“œ/ëª¨ë¸ëª… í¬í•¨)
                // api.tsì˜ getInstrumentsëŠ” { search: string } íŒŒë¼ë¯¸í„°ë¥¼ ì§€ì›í•¨
                const { getInstruments } = await import('../services/api');
                const results = await getInstruments({ search: trimmedQuery });

                // ìµœëŒ€ 6ê°œë§Œ í‘œì‹œ
                setSuggestions(results.slice(0, 6));

                // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆê³  í¬ì»¤ìŠ¤ ìƒíƒœë©´ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
                if (results.length > 0 && isFocused) {
                    setShowDropdown(true);
                }
            } catch (error) {
                console.error('ì¶”ì²œ ê²€ìƒ‰ì–´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }, 300); // 300ms ë”œë ˆì´

        return () => clearTimeout(timer);
    }, [query, showSuggestions]);

    // í¬ì»¤ìŠ¤ ìƒíƒœì— ë”°ë¥¸ ë“œë¡­ë‹¤ìš´ í‘œì‹œ ì œì–´
    useEffect(() => {
        if (isFocused && suggestions.length > 0) {
            setShowDropdown(true);
        } else if (!isFocused) {
            // blur ì‹œì—ëŠ” handleSuggestionClick ë“±ì„ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ ë‹«í˜ (onBlurì—ì„œ ì²˜ë¦¬ë¨) ë˜ëŠ” ì¦‰ì‹œ ë‹«í˜
            // ì—¬ê¸°ì„œëŠ” onBlurê°€ ì²˜ë¦¬í•˜ë¯€ë¡œ ì¶”ê°€ ë™ì‘ ë¶ˆí•„ìš”, 
            // ë‹¤ë§Œ isFocusedê°€ falseë¡œ ë°”ë€Œë©´ ë“œë¡­ë‹¤ìš´ì„ ë‹«ëŠ”ê²Œ ì•ˆì „í•¨ (onBlurì˜ timeoutê³¼ ë³„ê°œë¡œ)
            const timer = setTimeout(() => setShowDropdown(false), 200);
            return () => clearTimeout(timer);
        }
    }, [isFocused, suggestions]);

    // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    useEffect(() => {
        function handleClickOutside(event: MouseEvent) {
            if (wrapperRef.current && !wrapperRef.current.contains(event.target as Node)) {
                setShowDropdown(false);
            }
        }
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    const handleSubmit = (e: FormEvent) => {
        e.preventDefault();
        if (query.trim()) {
            onSearch(query.trim());
            setShowDropdown(false);
        }
    };

    const handleSuggestionClick = (instrument: Instrument) => {
        const searchTerm = `${instrument.brand} ${instrument.name}`;
        setQuery(searchTerm);
        onSearch(searchTerm);
        setShowDropdown(false);
    };

    // ì¹´í…Œê³ ë¦¬ë³„ ì´ëª¨ì§€
    const getCategoryEmoji = (category: string) => {
        switch (category.toLowerCase()) {
            case 'ì¼ë ‰ê¸°íƒ€': case 'guitar': return 'ğŸ¸';
            case 'ë² ì´ìŠ¤': case 'bass': return 'ğŸ¸';
            case 'ì´í™í„°': case 'pedal': case 'effects': return 'ğŸ”Š';
            case 'ì•°í”„': case 'amp': return 'ğŸ”ˆ';
            case 'ì–´ì¿ ìŠ¤í‹±': case 'acoustic': return 'ğŸª•';
            default: return 'ğŸµ';
        }
    };

    return (
        <motion.form
            onSubmit={handleSubmit}
            className="w-full max-w-2xl mx-auto"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.5 }}
        >
            <div ref={wrapperRef} className="relative">
                <div
                    className={`
                        relative flex items-center gap-1 sm:gap-2 p-2 sm:p-3 rounded-full transition-all duration-300
                        ${isFocused
                            ? 'bg-white shadow-[0_8px_30px_rgba(0,0,0,0.12)] ring-2 ring-matcha-500 transform -translate-y-1'
                            : 'bg-white shadow-[0_4px_20px_rgba(0,0,0,0.08)] hover:shadow-[0_8px_25px_rgba(0,0,0,0.12)] hover:-translate-y-0.5'
                        }
                    `}
                    style={{ backdropFilter: 'blur(8px)' }}
                >
                    {/* ê²€ìƒ‰ ì•„ì´ì½˜ */}
                    <div className={`pl-2 sm:pl-4 transition-colors duration-300 ${isFocused ? 'text-matcha-500' : 'text-stone-400'}`}>
                        <svg
                            className="w-4 h-4 sm:w-5 sm:h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                strokeLinecap="round"
                                strokeLinejoin="round"
                                strokeWidth={2}
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                            />
                        </svg>
                    </div>

                    {/* ì…ë ¥ í•„ë“œ */}
                    <input
                        type="text"
                        value={query}
                        onChange={(e) => setQuery(e.target.value)}
                        onFocus={() => setIsFocused(true)}
                        onBlur={() => setTimeout(() => setIsFocused(false), 150)}
                        placeholder={placeholder}
                        disabled={isLoading}
                        autoComplete="off"
                        className="
                            flex-1 py-2 sm:py-3 px-1 sm:px-2 bg-transparent outline-none
                            text-stone-800 placeholder-stone-400
                            text-sm sm:text-lg caret-matcha-500 min-w-0
                        "
                    />

                    {/* ê²€ìƒ‰ ë²„íŠ¼ */}
                    <motion.button
                        type="submit"
                        disabled={isLoading}
                        whileHover={{ scale: 1.02 }}
                        whileTap={{ scale: 0.98 }}
                        className={`
                            px-4 sm:px-8 py-2.5 sm:py-4 rounded-lg sm:rounded-xl font-bold text-sm sm:text-lg text-white
                            transition-all duration-200 shrink-0
                            ${isLoading
                                ? 'bg-stone-300 cursor-not-allowed'
                                : 'bg-[#10B981] hover:bg-[#059669] shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/40 hover:scale-105 active:scale-95'
                            }
                        `}
                    >
                        {isLoading ? (
                            <motion.div
                                className="w-4 h-4 sm:w-5 sm:h-5 border-2 border-white/30 border-t-white rounded-full"
                                animate={{ rotate: 360 }}
                                transition={{ duration: 1, repeat: Infinity, ease: 'linear' }}
                            />
                        ) : (
                            <span className="whitespace-nowrap">ê²€ìƒ‰</span>
                        )}
                    </motion.button>
                </div>

                {/* ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ (DB ì•…ê¸° ëª©ë¡) */}
                <AnimatePresence>
                    {showDropdown && suggestions.length > 0 && (
                        <motion.div
                            initial={{ opacity: 0, y: -10 }}
                            animate={{ opacity: 1, y: 0 }}
                            exit={{ opacity: 0, y: -10 }}
                            transition={{ duration: 0.15 }}
                            className="
                                absolute z-50 w-full mt-2 py-2
                                bg-white rounded-xl shadow-xl border border-stone-100
                                overflow-hidden
                            "
                        >
                            <p className="px-4 py-1 text-[10px] text-stone-400 uppercase tracking-wider">
                                ë“±ë¡ëœ ì•…ê¸°
                            </p>
                            {suggestions.map((instrument) => (
                                <button
                                    key={instrument.id}
                                    type="button"
                                    onClick={() => handleSuggestionClick(instrument)}
                                    className="
                                        w-full px-4 py-3 text-left flex items-center gap-3
                                        hover:bg-matcha-50 transition-colors
                                        text-stone-700 hover:text-matcha-700
                                    "
                                >
                                    <span className="text-lg">{getCategoryEmoji(instrument.category)}</span>
                                    <div className="flex-1">
                                        <p className="font-medium">{instrument.brand} {instrument.name}</p>
                                        <p className="text-xs text-stone-400">{instrument.category}</p>
                                    </div>
                                </button>
                            ))}
                        </motion.div>
                    )}
                </AnimatePresence>
            </div>

            {/* ê²€ìƒ‰ íŒíŠ¸ */}
            {!hideHint && (
                <motion.p
                    className="mt-3 text-center text-sm text-stone-500"
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 0.8 }}
                    transition={{ delay: 0.3 }}
                >
                    ë¸Œëœë“œ, ëª¨ë¸ëª…, ë˜ëŠ” ì¹´í…Œê³ ë¦¬ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”
                </motion.p>
            )}
        </motion.form>
    );
}
</file>

<file path="backend/dagu/config.py">
"""
Filter configuration for MALCHA-DAGU.
Based on proven filtering patterns for instrument search quality.
"""


class CrawlerConfig:
    """í¬ë¡¤ëŸ¬/API ì„¤ì •"""

    # ê°€ê²© ì„¤ì • (ì‹ í’ˆ ê¸°ì¤€ê°€ ì—†ì„ ë•Œ í´ë°±ìš©)
    MIN_PRICE_KRW = 150000  # 20ë§Œì› (ì•…ê¸° ê¸°ë³¸)
    MIN_PRICE_PEDAL = 50000 # 5ë§Œì› (ì´í™í„°/ì•¡ì„¸ì„œë¦¬)
    MIN_PRICE_MIC = 30000   # 3ë§Œì› (ë§ˆì´í¬)
    MIN_PRICE_USD = 100

    # ì‹ í’ˆ ê¸°ì¤€ê°€ ëŒ€ë¹„ ìµœì†Œê°€ ë¹„ìœ¨ (45% = 0.45)
    MIN_PRICE_RATIO = 0.45
    
    # ê²°ê³¼ ê°œìˆ˜ ì„¤ì •
    MAX_RESULTS_NAVER = 20
    MAX_RESULTS_USER = 20
    
    # íƒ€ì„ì•„ì›ƒ
    TIMEOUT_NAVER = 5


class CategoryConfig:
    """ì¹´í…Œê³ ë¦¬ íŒë³„ìš© í‚¤ì›Œë“œ"""

    # =========================================================================
    # 1. ë¸Œëœë“œ/ì¹´í…Œê³ ë¦¬ ë¦¬ìŠ¤íŠ¸ í™•ì¥
    # =========================================================================

    GUITAR_BRANDS = [
        "fender", "gibson", "prs", "ibanez", "esp", "jackson", "gopherwood", "swing",
        "schecter", "suhr", "tom anderson", "james tyler", "mayones", "strandberg",
        "cort", "yamaha", "epiphone", "squier", "ltd", "musicman", "gretsch"
    ]

    BASS_KEYWORDS = [
        'bass', 'precision', 'jazz bass', 'pbass', 'jbass',
        'ë² ì´ìŠ¤', 'ë² ì´ì“°', 'í”„ë ˆì‹œì „', 'í”„ë ˆì‹œì ¼', 'ì¬ì¦ˆë² ì´ìŠ¤', 'ì¬ë² ', 'í”„ë² ',
        'stingray', 'ìŠ¤íŒ…ë ˆì´', 'sire', 'ì‚¬ì´ì–´', 'fami', 'ì•¡í‹°ë¸Œ', 'íŒ¨ì‹œë¸Œ'
    ]

    # =========================================================================
    # 2. ëª¨ë¸ëª… ë³„ì¹­ ë§¤í•‘ (ê²€ìƒ‰ì–´ â†’ ì •ì‹ ëª¨ë¸ëª…)
    # =========================================================================
    MODEL_ALIASES = {
        # --- Fender & Squier (êµ­ë‚´ ì€ì–´ í¬í•¨) ---
        'strat': 'Stratocaster',
        'stratocaster': 'Stratocaster',
        'ìŠ¤íŠ¸ë«': 'Stratocaster',
        'ìŠ¤íŠ¸ë ›': 'Stratocaster',
        'ìŠ¤íŠ¸ë¼í† ìºìŠ¤í„°': 'Stratocaster',
        'ìŠ¤í…ë‹¤ë“œ': 'Standard',
        'ìŠ¤íƒ ë‹¤ë“œ': 'Standard',
        'tele': 'Telecaster',
        'telecaster': 'Telecaster',
        'í…”ë ˆ': 'Telecaster',
        'í…”ë ˆìºìŠ¤í„°': 'Telecaster',
        'jazzmaster': 'Jazzmaster',
        'ì¬ì¦ˆë§ˆìŠ¤í„°': 'Jazzmaster',
        'ì¬ë§ˆ': 'Jazzmaster',
        'jaguar': 'Jaguar',
        'ì¬ê·œì–´': 'Jaguar',
        'mustang': 'Mustang',
        'ë¨¸ìŠ¤íƒ±': 'Mustang',
        'ë¯¸íœ': 'Fender American',  # ì¤‘ìš”: ì›ì‚°ì§€ ì€ì–´
        'ì¼íœ': 'Fender Japan',
        'ë©•íœ': 'Fender Mexico',
        'ì»¤ìƒµ': 'Custom Shop',
        'ì»¤ìŠ¤í…€ìƒµ': 'Custom Shop',
        'íŠ¸ë ˆë””ì…”ë„': 'Traditional',
        'íŠ¸ë ˆ': 'Traditional',
        'í”„ë¡œí˜ì…”ë„': 'Professional',
        'ì•„í”„ë¡œ': 'American Professional',
        'ìš¸íŠ¸ë¼': 'Ultra',
        'ë¹ˆí‹°ì§€': 'Vintage',
        'ë¦¬ì´ìŠˆ': 'Reissue',

        # --- Gibson & Epiphone ---
        'lp': 'Les Paul',
        'lespaul': 'Les Paul',
        'les paul': 'Les Paul',
        'ë ˆìŠ¤í´': 'Les Paul',
        'ë ˆí´': 'Les Paul',  # ì€ì–´
        'sg': 'SG',
        'ì—ìŠ¤ì§€': 'SG',
        'es335': 'ES-335',
        'es-335': 'ES-335',
        'í• ë¡œìš°': 'Hollow Body',
        'ì„¸ë¯¸í• ë¡œìš°': 'Semi-Hollow',
        'flying v': 'Flying V',
        'í”Œë¼ì‰ë¸Œì´': 'Flying V',
        'explorer': 'Explorer',
        'ìµìŠ¤í”Œë¡œëŸ¬': 'Explorer',
        'j45': 'J-45',
        'hummingbird': 'Hummingbird',
        'í—ˆë°ë²„ë“œ': 'Hummingbird',
        'íˆìŠ¤í† ë¦­': 'Historic',
        'íŠ¸ë˜ë””ì…”ë„': 'Traditional',

        # --- Ibanez & Super Strat ---
        'rg': 'RG',
        'az': 'AZ',
        'jem': 'JEM',
        'prestige': 'Prestige',
        'í”„ë ˆìŠ¤í‹°ì§€': 'Prestige',
        'j.custom': 'j.custom',
        'ì œì´ì»¤ìŠ¤í…€': 'j.custom',
        'pia': 'PIA',

        # --- PRS ---
        'custom24': 'Custom 24',
        'custom 24': 'Custom 24',
        'ì»¤ìŠ¤í…€24': 'Custom 24',
        'mccarty': 'McCarty',
        'ë§¤ì¹´í‹°': 'McCarty',
        'silver sky': 'Silver Sky',
        'ì‹¤ë²„ìŠ¤ì¹´ì´': 'Silver Sky',
        'ì‹¤ìŠ¤': 'Silver Sky',  # ì€ì–´
        'se': 'SE',
        'ce': 'CE',

        # --- BOSS Pedals (ìƒì„¸ ë§¤í•‘) ---
        'ds1': 'DS-1', 'ds-1': 'DS-1',
        'ds2': 'DS-2', 'ds-2': 'DS-2',
        'sd1': 'SD-1', 'sd-1': 'SD-1',
        'bd2': 'BD-2', 'bd-2': 'BD-2',
        'mt2': 'MT-2', 'mt-2': 'MT-2',
        'od3': 'OD-3', 'od-3': 'OD-3',
        'ce5': 'CE-5', 'ce-5': 'CE-5',
        'ch1': 'CH-1', 'ch-1': 'CH-1',
        'dd8': 'DD-8', 'dd-8': 'DD-8',
        'dd200': 'DD-200', 'dd-200': 'DD-200',
        'rv6': 'RV-6', 'rv-6': 'RV-6',
        'tu3': 'TU-3', 'tu-3': 'TU-3',
        'rc5': 'RC-5', 'rc-5': 'RC-5',
        'gt1000': 'GT-1000', 'gt-1000': 'GT-1000',
        'katana': 'KATANA',

        # --- Popular Pedals & Multi-FX (ì€ì–´ í¬í•¨) ---
        'ts9': 'TS9',
        'ts808': 'TS808',
        'tubescreamer': 'Tube Screamer',
        'tube screamer': 'Tube Screamer',
        'íŠœë¸ŒìŠ¤í¬ë¦¬ë¨¸': 'Tube Screamer',
        'bigsky': 'BigSky',
        'ë¹…ìŠ¤ì¹´ì´': 'BigSky',
        'timeline': 'Timeline',
        'íƒ€ì„ë¼ì¸': 'Timeline',
        'mobius': 'Mobius',
        'ëª¨ë¹„ìš°ìŠ¤': 'Mobius',
        'blue sky': 'BlueSky',
        'ë¸”ë£¨ìŠ¤ì¹´ì´': 'BlueSky',
        'h9': 'H9',
        'helix': 'Helix',
        'íë¦­ìŠ¤': 'Helix',
        'hx stomp': 'HX Stomp',
        'hxstomp': 'HX Stomp',
        'hxìŠ¤í†°í”„': 'HX Stomp',
        'quad cortex': 'Quad Cortex',
        'ì¿¼ë“œì½”í…ìŠ¤': 'Quad Cortex',
        'ì¿¼ë“œì½”ì–´í…ìŠ¤': 'Quad Cortex',  # ì˜¤íƒ€ ëŒ€ì‘
        'ì¿¼ì½”': 'Quad Cortex',  # ì€ì–´
        'kemper': 'Kemper',
        'ì¼í¼': 'Kemper',
        'ìº í¼': 'Kemper',
        'iridium': 'Iridium',
        'ì´ë¦¬ë“': 'Iridium',
        'ocd': 'OCD',
        'klon': 'Centaur',
        'centaur': 'Centaur',
        'í´ë¡ ': 'Centaur',
        'jan ray': 'Jan Ray',
        'ì”ë ˆì´': 'Jan Ray',
        'timmy': 'Timmy',
        'íŒ€ë¯¸': 'Timmy',

        # --- Bass Specific ---
        'ë² ì´ìŠ¤': 'bass',
        'pbass': 'Precision Bass',
        'p-bass': 'Precision Bass',
        'precision': 'Precision Bass',
        'í”„ë ˆì‹œì „': 'Precision Bass',
        'í”„ë ˆì‹œì ¼': 'Precision Bass',
        'í”„ë² ': 'Precision Bass',
        'jbass': 'Jazz Bass',
        'j-bass': 'Jazz Bass',
        'ì¬ì¦ˆë² ì´ìŠ¤': 'Jazz Bass',
        'ì¬ë² ': 'Jazz Bass',
        'stingray': 'StingRay',
        'ìŠ¤íŒ…ë ˆì´': 'StingRay',

        # --- Amps ---
        'jcm800': 'JCM800',
        'jcm900': 'JCM900',
        'jcm2000': 'JCM2000',
        'dsl': 'DSL',
        'plexi': 'Plexi',
        'í”Œë ‰ì‹œ': 'Plexi',
        'ac30': 'AC30',
        'ac15': 'AC15',
        'twin reverb': 'Twin Reverb',
        'íŠ¸ìœˆë¦¬ë²„ë¸Œ': 'Twin Reverb',
        'blues junior': 'Blues Junior',
        'ë¸”ë£¨ìŠ¤ì£¼ë‹ˆì–´': 'Blues Junior',
        'ë¸”ì£¼': 'Blues Junior',  # ì€ì–´
        'rectifier': 'Rectifier',
        'ë ‰í‹°íŒŒì´ì–´': 'Rectifier',
        'mark v': 'Mark V',
        'ë§ˆí¬5': 'Mark V',

        # --- General Terms ---
        'ê¸°íƒ€': 'guitar',
        'ì¼ë ‰': 'electric',
        'ì–´ì¿ ìŠ¤í‹±': 'acoustic',
        'í†µê¸°íƒ€': 'acoustic guitar',
        'ë©€í™': 'Multi Effect',  # ì€ì–´
        'ë©€í‹°ì´í™í„°': 'Multi Effect',
        'ê¾¹ê¾¹ì´': 'Stompbox',  # ì€ì–´
    }

    # =========================================================================
    # 3. í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ í™•ì¥ (ê²€ìƒ‰ í•„í„°ë§ìš©)
    # =========================================================================

    PEDAL_KEYWORDS = [
        'pedal', 'stomp', 'effect', 'effects', 'effector', 'processor',
        'ì´í™í„°', 'í˜ë‹¬', 'ìŠ¤í†°í”„', 'ê¾¹ê¾¹ì´', 'ë©€í‹°ì´í™í„°', 'ë©€í™', 'ë³´ë“œ',
        # ë¸Œëœë“œ
        'boss', 'ë³´ìŠ¤', 'strymon', 'ìŠ¤íŠ¸ë¼ì´ëª¬', 'tc electronic', 'í‹°ì”¨',
        'mxr', 'electro-harmonix', 'ehx', 'ì´í•˜ëª¨',
        'ibanez', 'ts808', 'ts9', 'keeley', 'í‚¬ë¦¬', 'walrus', 'ì›”ëŸ¬ìŠ¤', 'jhs',
        'chase bliss', 'ì²´ì´ìŠ¤ë¸”ë¦¬ìŠ¤', 'vemuram', 'ë² ë¬´ëŒ', 'xotic', 'ì—‘ì¡°í‹±',
        'universal audio', 'ua', 'line6', 'ë¼ì¸6', 'neural dsp', 'ë‰´ëŸ´',
        # ì´í™íŠ¸ ì¢…ë¥˜ (í•œê¸€ í¬í•¨)
        'overdrive', 'ì˜¤ë²„ë“œë¼ì´ë¸Œ', 'distortion', 'ë””ìŠ¤í† ì…˜', 'fuzz', 'í¼ì¦ˆ',
        'delay', 'ë”œë ˆì´', 'reverb', 'ë¦¬ë²„ë¸Œ', 'chorus', 'ì½”ëŸ¬ìŠ¤', 'phaser', 'í˜ì´ì €',
        'flanger', 'í”Œëœì €', 'compressor', 'ì»´í”„', 'ì»´í”„ë ˆì„œ', 'wah', 'ì™€ìš°',
        'looper', 'ë£¨í¼', 'tuner', 'íŠœë„ˆ', 'eq', 'ì´í€„ë¼ì´ì €',
        'booster', 'ë¶€ìŠ¤í„°', 'octave', 'ì˜¥íƒ€ë¸Œ', 'tremolo', 'íŠ¸ë ˆëª°ë¡œ',
        'vibrato', 'ë¹„ë¸Œë¼í† ', 'noise gate', 'ë…¸ì´ì¦ˆê²Œì´íŠ¸', 'preamp', 'í”„ë¦¬ì•°í”„',
        'ir loader', 'irë¡œë”', 'cab sim', 'ìº¡ì‹¬',
        # ì£¼ìš” ëª¨ë¸ ì‹ë³„ì
        'ds-1', 'sd-1', 'bd-2', 'mt-2', 'ts9', 'ts808', 'klon', 'ocr', 'bigsky',
        'h9', 'hx stomp', 'quad cortex', 'gt-1000', 'kemper'
    ]

    AMP_KEYWORDS = [
        'amp', 'cabinet', 'head', 'combo', 'amplifier', 'stack',
        'ì•°í”„', 'ìºë¹„ë„·', 'ìºë¹„ë‹›', 'í—¤ë“œ', 'ì½¤ë³´', 'ìŠ¤íƒ', 'ì§„ê³µê´€', 'íŠœë¸Œ',
        'tube amp', 'solid state', 'ì†”ë¦¬ë“œìŠ¤í…Œì´íŠ¸', 'modeling', 'ëª¨ë¸ë§',
        'marshall', 'ë§ˆìƒ¬', 'fender', 'íœë”', 'vox', 'ë³µìŠ¤', 'orange', 'ì˜¤ë Œì§€',
        'mesa boogie', 'ë©”ì‚¬', 'ë©”ì‚¬ë¶€ê¸°', 'kemper', 'ìº í¼', 'fractal', 'í”„ë™íƒˆ',
        'yamaha thr', 'thr10', 'thr30', 'katana', 'ì¹´íƒ€ë‚˜', 'spark', 'ìŠ¤íŒŒí¬'
    ]

    ACOUSTIC_KEYWORDS = [
        'acoustic', 'martin', 'taylor', 'gibson', 'yamaha', 'cort', 'crafter',
        'ì–´ì¿ ìŠ¤í‹±', 'í†µê¸°íƒ€', 'ë§ˆí‹´', 'í…Œì¼ëŸ¬', 'ì•¼ë§ˆí•˜', 'ì½œíŠ¸', 'í¬ë˜í”„í„°', 'ê³ í¼ìš°ë“œ',
        'top solid', 'íƒ‘ì†”ë¦¬ë“œ', 'all solid', 'ì˜¬ì†”ë¦¬ë“œ', 'íƒ‘ë°±ì†”ë¦¬ë“œ',
        'dreadnought', 'ë“œë ˆë“œë„›', 'om body', 'omë°”ë””', 'ga body', 'gaë°”ë””',
        'jumbo', 'ì ë³´', 'parlor', 'íŒ”ëŸ¬', 'cutaway', 'ì»·ì–´ì›¨ì´', 'pickup', 'í”½ì—…'
    ]

    MIC_KEYWORDS = [
        'microphone', 'mic', 'condenser', 'dynamic', 'ribbon', 'wireless',
        'ë§ˆì´í¬', 'ë§ˆì´í¬ë¡œí°', 'ì½˜ë´ì„œ', 'ë‹¤ì´ë‚˜ë¯¹', 'ë¦¬ë³¸', 'ë¬´ì„ ',
        # ë¸Œëœë“œ
        'shure', 'ìŠˆì–´', 'sennheiser', 'ì  í•˜ì´ì €', 'neumann', 'ë…¸ì´ë§Œ',
        'akg', 'audio-technica', 'ì˜¤ë””ì˜¤í…Œí¬ë‹ˆì¹´', 'rode', 'ë¡œë°',
        'blue', 'beyerdynamic', 'ë² ì´ì–´ë‹¤ì´ë‚˜ë¯¹', 'electro-voice', 'ev',
        'warm audio', 'ì›œì˜¤ë””ì˜¤', 'lewitt', 'ë£¨ìœ—',
        # ëª¨ë¸
        'sm58', 'sm57', 'sm7b', 'beta58', 'u87', 'tlm103', 'nt1', 'at2020',
    ]
    # ì•Œë ¤ì§„ ë¸Œëœë“œ ëª©ë¡ (ë¸Œëœë“œ ê°ì§€ìš©)
    KNOWN_BRANDS = [
        # ---------------------------------------------------------
        # 1. Electric Guitars (Major & High-end)
        # ---------------------------------------------------------
        'fender', 'gibson', 'prs', 'ibanez', 'esp', 'jackson', 'charvel',
        'schecter', 'suhr', 'musicman', 'g&l', 'yamaha', 'kramer',
        'gretsch', 'rickenbacker', 'danelectro', 'tom anderson', 'james tyler',
        'mayones', 'strandberg', 'aristides', 'kiesel', 'godin', 'reverend',
        'duesenberg', 'heritage', 'bacchus', 'momose', 'fgn',  # Fujigen

        # ---------------------------------------------------------
        # 2. Sub & Budget Brands (Cost-effective)
        # ---------------------------------------------------------
        'squier', 'epiphone', 'ltd', 'sterling', 'tribute', 'edwards',
        'grassroots', 'tokai', 'burny', 'greco', 'aria pro ii',
        'harley benton', 'sire', 'cort', 'swing', 'dame', 'hex', 'spear',
        'uno', 'corona', 'volcan',

        # ---------------------------------------------------------
        # 3. Acoustic Guitars
        # ---------------------------------------------------------
        'taylor', 'martin', 'gopherwood', 'crafter', 'lakewood', 'maton',
        'cole clark', 'sigma', 'guild', 'takamine', 'ovation', 'lowden',
        'mcpherson', 'breedlove', 'seagull', 'yamaha', 'cort',

        # ---------------------------------------------------------
        # 4. Bass Specific (High-end & Popular)
        # ---------------------------------------------------------
        'warwick', 'spector', 'sandberg', 'dingwall', 'fodera', 'sadowsky',
        'lakland', 'mtd', 'kensmith', 'atelier z', 'moon',

        # ---------------------------------------------------------
        # 5. Amps & Modelers (Digital/Analog)
        # ---------------------------------------------------------
        'marshall', 'vox', 'orange', 'mesa', 'ampeg', 'fender', 'peavey',
        'engl', 'bogner', 'friedman', 'soldano', 'blackstar', 'hughes & kettner',
        'kemper', 'fractal', 'line 6', 'neural dsp', 'headrush', 'boss', 'roland',
        'positive grid', 'dv mark', 'markbass', 'aguilar', 'darkglass',

        # ---------------------------------------------------------
        # 6. Effects Pedals (Stompboxes)
        # ---------------------------------------------------------
        'boss', 'tc electronic', 'strymon', 'electro-harmonix', 'mxr', 'dunlop',
        'digitech', 'zoom', 'mooer', 'nux', 'jhs', 'keeley', 'walrus audio',
        'chase bliss', 'eventide', 'meris', 'earthquaker devices', 'analogman',
        'fulltone', 'xotic', 'vemuram', 'klon', 'catalinbread', 'mad professor',
        'source audio', 'free the tone', 'vertex', 'hotone', 'valeton',
    ]

    # í•œê¸€ ë¸Œëœë“œëª… ë§¤í•‘ (ìœ ì €ê°€ ê²€ìƒ‰í•  ë§Œí•œ ë³€ì¹™ í‘œê¸° í¬í•¨)
    BRAND_NAME_MAPPING = {
        # --- Major Guitars ---
        'íœë”': 'fender', 'íŒ¬ë”': 'fender',
        'ê¹ìŠ¨': 'gibson',
        'í”¼ì•Œì—ìŠ¤': 'prs', 'í´ë¦¬ë“œìŠ¤ë¯¸ìŠ¤': 'prs', 'í´ë¦¬ë“œ': 'prs',
        'ì•„ì´ë°”ë„¤ì¦ˆ': 'ibanez', 'ì´ë°”ë„¤ì¦ˆ': 'ibanez',
        'ì´ì—ìŠ¤í”¼': 'esp',
        'ì­ìŠ¨': 'jackson',
        'ìƒ¤ë²¨': 'charvel',
        'ì‰‘í„°': 'schecter', 'ì„¹í„°': 'schecter',
        'ì¨': 'suhr', 'ì„œ': 'suhr', 'ì¡´ì¨': 'suhr',
        'ë®¤ì§ë§¨': 'musicman',
        'ì§€ì•¤ì—˜': 'g&l', 'ì§€ì—”ì—˜': 'g&l',
        'ì•¼ë§ˆí•˜': 'yamaha',
        'í¬ë˜ë¨¸': 'kramer', 'í¬ë ˆì´ë¨¸': 'kramer',
        'ê·¸ë ˆì¹˜': 'gretsch',
        'ë¦¬ì¼„ë² ì»¤': 'rickenbacker', 'ë¦¬ì¼„ë°°ì»¤': 'rickenbacker',
        'ëŒ„ì¼ë ‰íŠ¸ë¡œ': 'danelectro', 'ëŒ„ì¼ë ‰': 'danelectro',
        'íƒì•¤ë”ìŠ¨': 'tom anderson', 'í†°ì•¤ë”ìŠ¨': 'tom anderson',
        'ì œì„ìŠ¤íƒ€ì¼ëŸ¬': 'james tyler', 'ì œíƒ€': 'james tyler',
        'ë§ˆìš”ë„¤ì¦ˆ': 'mayones',
        'ìŠ¤íŠ¸ëœë“œë²„ê·¸': 'strandberg',
        'ì•„ë¦¬ìŠ¤í‹°ë°ìŠ¤': 'aristides',
        'í‚¤ì ¤': 'kiesel', 'ì¹´ì´ì ¤': 'kiesel',
        'ê³ ë”˜': 'godin',
        'ë ˆë²„ëŸ°ë“œ': 'reverend', 'ë ˆë²„ëœë“œ': 'reverend',
        'ë“€ì„¼ë²„ê·¸': 'duesenberg',
        'í—¤ë¦¬í‹°ì§€': 'heritage',
        'ë°”ì»¤ìŠ¤': 'bacchus', 'ë°”ì¿ ìŠ¤': 'bacchus',
        'ëª¨ëª¨ì„¸': 'momose',
        'í›„ì§€ê²': 'fgn',

        # --- Sub/Budget/Domestic ---
        'ìŠ¤ì½°ì´ì–´': 'squier', 'ìŠ¤í€´ì–´': 'squier',
        'ì—í”¼í°': 'epiphone',
        'ì—˜í‹°ë””': 'ltd',
        'ìŠ¤í„¸ë§': 'sterling',
        'íŠ¸ë¦¬ë·°íŠ¸': 'tribute',
        'ì—ë“œì›Œì¦ˆ': 'edwards',
        'ê·¸ë¼ìŠ¤ë£¨ì¸ ': 'grassroots',
        'í† ì¹´ì´': 'tokai',
        'ë²„ë‹ˆ': 'burny',
        'ê·¸ë ˆì½”': 'greco',
        'í• ë¦¬ë²¤íŠ¼': 'harley benton',
        'ì‚¬ì´ì–´': 'sire',
        'ì½œíŠ¸': 'cort',
        'ìŠ¤ìœ™': 'swing',
        'ë°ì„': 'dame',
        'í—¥ìŠ¤': 'hex',
        'ìŠ¤í”¼ì–´': 'spear',
        'ìš°ë…¸': 'uno',
        'ì½”ë¡œë‚˜': 'corona',
        'ë³¼ìº”': 'volcan', 'ë³¼ì¹¸': 'volcan',

        # --- Acoustic ---
        'í…Œì¼ëŸ¬': 'taylor',
        'ë§ˆí‹´': 'martin',
        'ê³ í¼ìš°ë“œ': 'gopherwood',
        'í¬ë˜í”„í„°': 'crafter', 'ì„±ìŒ': 'crafter',
        'ë ˆì´í¬ìš°ë“œ': 'lakewood',
        'ë©”ì´íŠ¼': 'maton',
        'ì½œí´ë½': 'cole clark',
        'ì‹œê·¸ë§ˆ': 'sigma',
        'ê¸¸ë“œ': 'guild',
        'íƒ€ì¹´ë¯¸ë„¤': 'takamine',
        'ì˜¤ë² ì´ì…˜': 'ovation',
        'ë¡œìš°ë“ ': 'lowden',
        'ë§¥í¼ìŠ¨': 'mcpherson',
        'ë¸Œë¦¬ëŸ¬ë¸Œ': 'breedlove',
        'ì‹œê±¸': 'seagull',

        # --- Bass Specific ---
        'ì›Œìœ…': 'warwick',
        'ìŠ¤í™í„°': 'spector',
        'ìƒŒë“œë²„ê·¸': 'sandberg',
        'ë”©ì›”': 'dingwall',
        'í¬ë°ë¼': 'fodera',
        'ìƒˆë„ìš°ìŠ¤í‚¤': 'sadowsky', 'ìƒˆë„ìŠ¤í‚¤': 'sadowsky',
        'ë½ëœë“œ': 'lakland', 'ë ˆí¬ëœë“œ': 'lakland',
        'ì— í‹°ë””': 'mtd',
        'ì¼„ìŠ¤ë¯¸ìŠ¤': 'kensmith',
        'ì•„í‹€ë¦¬ì—': 'atelier z', 'ì•„í‹€ë¦¬ì—ì§€': 'atelier z',
        'ë¬¸': 'moon',

        # --- Amps & Modelers ---
        'ë§ˆìƒ¬': 'marshall',
        'ë³µìŠ¤': 'vox',
        'ì˜¤ë Œì§€': 'orange',
        'ë©”ì‚¬': 'mesa', 'ë©”ì‚¬ë¶€ê¸°': 'mesa',
        'ì•”í™': 'ampeg', 'ì•”í˜ê·¸': 'ampeg',
        'í”¼ë¹„': 'peavey',
        'ì•µê¸€': 'engl', 'ì´ì—”ì§€ì—ì´': 'engl',
        'ë³´ê·¸ë„ˆ': 'bogner',
        'í”„ë¦¬ë“œë§Œ': 'friedman',
        'ì†”ë‹¤ë…¸': 'soldano',
        'ë¸”ë™ìŠ¤íƒ€': 'blackstar',
        'íœ´ê±°ìŠ¤ì•¤ì¼€íŠ¸ë„ˆ': 'hughes & kettner', 'íœ´ê±°ìŠ¤': 'hughes & kettner',
        'ì¼í¼': 'kemper',
        'í”„ë™íƒˆ': 'fractal', 'í”„ë ‰íƒˆ': 'fractal',
        'ë¼ì¸ì‹ìŠ¤': 'line 6', 'ë¼ì¸6': 'line 6', 'íë¦­ìŠ¤': 'line 6',
        'ë‰´ëŸ´': 'neural dsp', 'ë‰´ëŸ´ë””ì—ìŠ¤í”¼': 'neural dsp', 'ì¿¼ë“œì½”ì–´í…ìŠ¤': 'neural dsp',
        'í—¤ë“œëŸ¬ì‰¬': 'headrush', 'í—¤ë“œëŸ¬ì‹œ': 'headrush',
        'í¬ì§€í‹°ë¸Œê·¸ë¦¬ë“œ': 'positive grid', 'ìŠ¤íŒŒí¬': 'positive grid',
        'ë””ë¸Œì´ë§ˆí¬': 'dv mark',
        'ë§ˆí¬ë² ì´ìŠ¤': 'markbass',
        'ì•„ê·ˆë¼': 'aguilar',
        'ë‹¤í¬ê¸€ë˜ìŠ¤': 'darkglass',

        # --- Pedals ---
        'ë³´ìŠ¤': 'boss',
        'í‹°ì”¨': 'tc electronic', 'í‹°ì”¨ì¼ë ‰íŠ¸ë¡œë‹‰': 'tc electronic',
        'ìŠ¤íŠ¸ë¼ì´ëª¬': 'strymon', 'ìŠ¤íŠ¸ë¼ì´ë¨¼': 'strymon',
        'ì¼ë ‰íŠ¸ë¡œí•˜ëª¨ë‹‰ìŠ¤': 'electro-harmonix', 'ì´í•˜ëª¨': 'electro-harmonix',
        'ì— ì—‘ìŠ¤ì•Œ': 'mxr',
        'ë˜ë¡­': 'dunlop',
        'ë””ì§€í…': 'digitech',
        'ì¤Œ': 'zoom',
        'ë¬´ì–´': 'mooer',
        'ëˆ…ìŠ¤': 'nux',
        'ì œì´ì—ì´ì¹˜ì—ìŠ¤': 'jhs',
        'í‚¬ë¦¬': 'keeley',
        'ì›”ëŸ¬ìŠ¤': 'walrus audio', 'ì›”ëŸ¬ìŠ¤ì˜¤ë””ì˜¤': 'walrus audio',
        'ì²´ì´ìŠ¤ë¸”ë¦¬ìŠ¤': 'chase bliss',
        'ì´ë¸íƒ€ì´ë“œ': 'eventide',
        'ë©”ë¦¬ìŠ¤': 'meris',
        'ì–¼ìŠ¤í€˜ì´ì»¤': 'earthquaker devices', 'ì´íë””': 'earthquaker devices',
        'ì•„ë‚ ë¡œê·¸ë§¨': 'analogman',
        'í’€í†¤': 'fulltone',
        'ì—‘ì¡°í‹±': 'xotic', 'ì—ê·¸ì¡°í‹±': 'xotic',
        'ë² ë¬´ëŒ': 'vemuram',
        'í´ë¡ ': 'klon',
        'ì¹´íƒˆë¦°ë¸Œë ˆë“œ': 'catalinbread',
        'ë§¤ë“œí”„ë¡œí˜ì„œ': 'mad professor',
        'ì†ŒìŠ¤ì˜¤ë””ì˜¤': 'source audio',
        'í”„ë¦¬ë”í†¤': 'free the tone',
        'ë²„í…ìŠ¤': 'vertex',
        'í•«í†¤': 'hotone',
        'ë°œë ˆí†¤': 'valeton',
    }
    
  

class FilterConfig:
    """í•„í„°ë§ ì„¤ì •"""

    # =========================================================================
    # [1] í†µí•© ë¸”ë™ë¦¬ìŠ¤íŠ¸ (ì´ ë‹¨ì–´ê°€ ì œëª©ì— ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ì œì™¸)
    # =========================================================================
    BLACKLIST_KEYWORDS = [
        # 1. ìƒíƒœ/ì¡°ê±´ (ì˜ë¬¸)
        'case only', 'empty', 'neck only', 'body only', 'parts only', 
        'box only', 'damaged', 'broken', 'for parts',
        
        # 2. ë¶€í’ˆë¥˜ (ì˜ë¬¸)
        'neck', 'body', 'pickup', 'pickups', 'knob', 'knobs',
        'bridge', 'potentiometer', 'pot', 'pots',
        'part', 'parts', 'screw', 'screws', 'saddle',
        'wiring', 'truss rod', 'pickguard', 'switch', 'tuner', 'tuners',
        'cover', 'covers', 'plate', 'assembly', 'electronics', 'í”½ì—…',
        
        # 2-1. ë¶€í’ˆë¥˜ (í•œê¸€)
        'ë„¥ë§Œ', 'ë°”ë””', 'ë°”ë””ë§Œ', 'í”½ì—…', 'ë…¸ë¸Œ', 'ë¸Œë¦¿ì§€', 'ë¸Œë¦¬ì§€',
        'ë¶€í’ˆ', 'ë‚˜ì‚¬', 'ë„ˆíŠ¸', 'í‚¤íŠ¸', 'ì¡°ë¦½', 'ë°°ì„ ', 'í”½ê°€ë“œ', 'ìŠ¤ìœ„ì¹˜',
        'íŠœë„ˆ', 'ì»¤ë²„', 'ë®ê°œ', 'íšŒë¡œ', 'ìŠ¤í”¼ì»¤', 'ì•Œë£¨ë¯¸ëŠ„', 'íˆ´', 'ì•„ë…¸ë‹¤ì´ì§•', 'íŠœë‹', 'ë³¸ì²´',
        
        # 3. ì•¡ì„¸ì„œë¦¬ë¥˜ (ì˜ë¬¸)
        'case', 'bag', 'gig bag', 'hardcase', 'strap', 'cable',
        'capo', 'hanger', 'sticker', 'picks', 'slide',
        'string', 'polish', 'cloth', 'mini', 'ë¯¸ë‹ˆ', 'adapter', 'ëª¨ì', 'ìì „ê±°',  # 'ì†ì¡ì´' ì œê±° (ì™¼ì†ì¡ì´ ê¸°íƒ€ ì˜¤íƒ ë°©ì§€)
        
        # 3-1. ì•¡ì„¸ì„œë¦¬ë¥˜ (í•œê¸€)
        'ì¼€ì´ìŠ¤', 'ê°€ë°©', 'ê¸±ë°±', 'ìŠ¤íŠ¸ë©', 'ì¼€ì´ë¸”',
        'ì¹´í¬', 'ìŠ¤íƒ ë“œ', 'ê±°ì¹˜ëŒ€', 'ìŠ¬ë¼ì´ë“œ', 'ì¤„', 'ì–´ëŒ‘í„°',
        
        # 4. ë¬¸ì„œ/ì¡ë™ì‚¬ë‹ˆ
        'manual', 'instruction', 'warranty', 'certificate', 'book',
        'logo', 'decal', 'poster', 'catalog',
        'ì„¤ëª…ì„œ', 'ë©”ë‰´ì–¼', 'ë³´ì¦ì„œ', 'êµë³¸', 'ë¡œê³ ', 'í¬ìŠ¤í„°', 'ì¹´íŠ¸ë¦¬ì§€', 'ê·¸ë¦´', 'ë§ˆì´í¬ ì†œ', 'í‹°',
        
        # 5. ì§í‰/ë³µì œí’ˆ
        'copy', 'replica', 'clone', 'fake', 'style', 'type',
        'ë³µì‚¬', 'ë³µì œ', 'ëª¨ì¡°', 'ì§í‰', 'ì¹´í”¼', 'ë ˆí”Œë¦¬ì¹´', 'ë¯¸ë‹ˆì–´ì²˜',
        
        # 6. ë¶ˆëŸ‰/íŒŒì†
        'íŒŒì†', 'ê³ ì¥', 'ë¶ˆëŸ‰', 'í ì§‘', 'ë¶€ëŸ¬ì§', 'ê¹¨ì§', 'junk', 'ë² ì´ìŠ¤ í‚¤',
    ]
    
    # =========================================================================
    # [2] ë¸Œëœë“œ í•˜ì´ì–´ë¼í‚¤ (ìƒìœ„ ë¸Œëœë“œ ê²€ìƒ‰ ì‹œ í•˜ìœ„ ë¸Œëœë“œ ì œì™¸)
    # =========================================================================
    BRAND_HIERARCHY = {
        # ---------------------------------------------------------
        # 1. Fender Family
        # ---------------------------------------------------------
        'fender': [
            # ì„œë¸Œ ë¸Œëœë“œ
            'squier', 'squire', 'ìŠ¤ì½°ì´ì–´', 'ìŠ¤í€´ì–´',
            # ë³´ê¸‰í˜• ì‹œë¦¬ì¦ˆ (Squier ë¼ì¸ì—…)
            'affinity', 'ì–´í”¼ë‹ˆí‹°', 'bullet', 'ë¶ˆë ›', 'sonic', 'ì†Œë‹‰',
            'classic vibe', 'cv', 'í´ë˜ì‹ë°”ì´ë¸Œ', 'í´ë°”',
            'paranormal', 'íŒŒë¼ë…¸ë§', 'contemporary', 'ì»¨í…œí¬ëŸ¬ë¦¬',
            'fender clone', 'copy', 'replica', 'ì´ë¯¸í…Œì´ì…˜', 'ì§í‰',
            'starcaster', 'ìŠ¤íƒ€ìºìŠ¤í„°',  # Fender ì„œë¸Œ ë¸Œëœë“œë¡œ ì·¨ê¸‰ë˜ê¸°ë„ í•¨
            'mini', 'ë¯¸ë‹ˆ',  # ë¯¸ë‹ˆ ê¸°íƒ€
        ],

        # ---------------------------------------------------------
        # 2. Gibson Family
        # ---------------------------------------------------------
        'gibson': [
            # ì„œë¸Œ ë¸Œëœë“œ
            'epiphone', 'ì—í”¼í°',
            'maestro', 'ë§ˆì—ìŠ¤íŠ¸ë¡œ',  # ì´ˆì €ê°€ ë¼ì¸
            'baldwin', 'ë³¼ë“œìœˆ',
            'kramer', 'í¬ë˜ë¨¸',  # í˜„ì¬ëŠ” Gibson ì‚°í•˜ì´ë‚˜ ë…ì ë¼ì¸ ì„±ê²© ê°•í•¨ (êµ¬ë¶„ í•„ìš” ì‹œ ë¶„ë¦¬)
            'orville', 'ì˜¤ë¹Œ',  # ê³¼ê±° ì¼ë³¸ ìƒì‚° ë¼ì´ì„ ìŠ¤ ë¸Œëœë“œ
            'kalamazoo', 'ì¹¼ë¼ë§ˆì£¼',
            # ê°€í’ˆ/ì¹´í”¼
            'gibson style', 'gibson copy', 'replica', 'chibson', 'ì§­ìŠ¨', 'ë ˆí”Œë¦¬ì¹´',
        ],

        # ---------------------------------------------------------
        # 3. PRS (Paul Reed Smith)
        # ---------------------------------------------------------
        'prs': [
            # ë³´ê¸‰í˜•/ì„í¬íŠ¸ ë¼ì¸
            'se', 'student edition', 'ì—ìŠ¤ì´',
            's2', 'ì—ìŠ¤íˆ¬',  # *ì£¼ì˜: S2ëŠ” USA ë¼ì¸ì´ì§€ë§Œ Core(ë©”ì¸)ë³´ë‹¤ ì €ë ´í•˜ì—¬ êµ¬ë¶„í•˜ê¸°ë„ í•¨
            'ce', 'ì”¨ì´',  # *ì£¼ì˜: CE(Bolt-on)ë„ USAì§€ë§Œ ê°€ê²©ëŒ€ê°€ ë‹¤ë¦„
            'se standard', 'se custom',
        ],

        # ---------------------------------------------------------
        # 4. ESP Family
        # ---------------------------------------------------------
        'esp': [
            # ì„œë¸Œ ë¸Œëœë“œ (ê°€ê²©ëŒ€ë³„)
            'ltd', 'ì—˜í‹°ë””',
            'edwards', 'ì—ë“œì›Œì¦ˆ',  # ì¼ë³¸ ë‚´ìˆ˜ ì¤‘ê¸‰
            'grassroots', 'ê·¸ë¼ìŠ¤ë£¨ì¸ ',  # ì¼ë³¸ ë‚´ìˆ˜ ë³´ê¸‰í˜•
            'navigator', 'ë„¤ë¹„ê²Œì´í„°',  # ESPë³´ë‹¤ ë¹„ì‹¼ ë¹ˆí‹°ì§€ ë³µê° ë¼ì¸
        ],

        # ---------------------------------------------------------
        # 5. Music Man (Ernie Ball)
        # ---------------------------------------------------------
        'musicman': [
            # ì„œë¸Œ ë¸Œëœë“œ
            'sterling', 'sterling by musicman', 'sbmm', 'ìŠ¤í„¸ë§',
            'sub', 's.u.b', 'ì„œë¸Œ',  # Sterlingì˜ í•˜ìœ„ ë¼ì¸
            'olp', 'ì˜¬í”¼',  # ê³¼ê±° ë¼ì´ì„ ìŠ¤ ì €ê°€í˜• (ì¤‘ê³  ì‹œì¥ì— ë§ìŒ)
        ],

        # ---------------------------------------------------------
        # 6. G&L
        # ---------------------------------------------------------
        'g&l': [
            'tribute', 'tribute series', 'íŠ¸ë¦¬ë·°íŠ¸',  # ì¸ë„ë„¤ì‹œì•„/ì¤‘êµ­ ìƒì‚° ë¼ì¸
        ],

        # ---------------------------------------------------------
        # 7. Lakland
        # ---------------------------------------------------------
        'lakland': [
            'skyline', 'ìŠ¤ì¹´ì´ë¼ì¸',  # ì¸ë„ë„¤ì‹œì•„ ìƒì‚° ë¼ì¸
        ],

        # ---------------------------------------------------------
        # 8. Schecter
        # ---------------------------------------------------------
        'schecter': [
            'sgr', 'ì—ìŠ¤ì§€ì—ì´ì•Œ',  # ì´ˆì €ê°€ ì…ë¬¸ìš© ë¼ì¸
            'diamond series', 'ë‹¤ì´ì•„ëª¬ë“œ', 'ë‹¤ì´ì•„ëª¬ë“œ ì‹œë¦¬ì¦ˆ',  # ëŒ€ë¶€ë¶„ì˜ ì–‘ì‚°í˜• ëª¨ë¸ (USA ì»¤ìŠ¤í…€ê³¼ êµ¬ë¶„)
            'omen', 'ì˜¤ë©˜',
            'damien', 'ë°ë¯¸ì•ˆ',
        ],

        # ---------------------------------------------------------
        # 9. Warwick (Bass)
        # ---------------------------------------------------------
        'warwick': [
            'rockbass', 'rock bass', 'ë½ë² ì´ìŠ¤',  # ì €ê°€í˜• ë¼ì¸
        ],

        # ---------------------------------------------------------
        # 10. Suhr
        # ---------------------------------------------------------
        'suhr': [
            'rasmus', 'ë¼ìŠ¤ë¬´ìŠ¤',  # ë‹¨ì¢…ëœ ì¤‘êµ­ ìƒì‚° ë¼ì¸ (ì¤‘ê³  ì‹œì¥ì— ê°€ë” ë“±ì¥)
        ],

        # ---------------------------------------------------------
        # 11. Marshall (Amps)
        # ---------------------------------------------------------
        'marshall': [
            'mg', 'mg series', 'ì— ì§€',  # ì €ê°€í˜• TR ì•°í”„ ë¼ì¸ (JCM/JVM ë“± ì§„ê³µê´€ê³¼ êµ¬ë¶„)
            'park', 'íŒŒí¬',  # ê³¼ê±° ë§ˆìƒ¬ì˜ ì„œë¸Œ ë¸Œëœë“œ
            'valvestate', 'ë°¸ë¸ŒìŠ¤í…Œì´íŠ¸',  # êµ¬í˜• í•˜ì´ë¸Œë¦¬ë“œ
        ]
    }
    # =========================================================================
    # [3] í† í° ë™ì˜ì–´ (ëª¨ë¸ëª… ë§¤ì¹­ í™•ì¥)
    # =========================================================================
    TOKEN_SYNONYMS = {
        'stratocaster': ['strat', 'st'],
        'telecaster': ['tele', 'tl'],
        'les paul': ['lp', 'lespaul'],
        'precision': ['pbass', 'p-bass', 'p bass'],
        'jazz bass': ['jbass', 'j-bass', 'j bass'],
        'mexico': ['mexico', 'mexican', 'mim', 'player'],
        'japan': ['japan', 'japanese', 'mij', 'cij'],
        'usa': ['usa', 'american', 'mia'],
        'custom': ['custom', 'cs', 'masterbuilt'],
    }
    
    # =========================================================================
    # [4] ì¹´í…Œê³ ë¦¬ ë¶ˆì¼ì¹˜ í•„í„° í‚¤ì›Œë“œ
    # =========================================================================
    
    # ê¸°íƒ€/ë² ì´ìŠ¤ ê²€ìƒ‰ ì‹œ í˜ë‹¬ ì œì™¸ìš©
    CATEGORY_PEDAL_KEYWORDS = [
        'pedal', 'stomp', 'stompbox', 'effect', 'effects', 'fx',
        'overdrive', 'distortion', 'fuzz', 'boost', 'booster',
        'delay', 'reverb', 'echo', 'chorus', 'flanger', 'phaser',
        'tremolo', 'vibrato', 'compressor', 'limiter',
        'wah', 'wah-wah', 'octave', 'harmonizer',
        'eq', 'equalizer', 'looper', 'multi-effect', 'pedalboard',
        'í˜ë‹¬', 'ì´í™í„°', 'ì´í™íŠ¸', 'ìŠ¤í†°í”„',
        'ì˜¤ë²„ë“œë¼ì´ë¸Œ', 'ë””ìŠ¤í† ì…˜', 'í¼ì¦ˆ', 'ë¶€ìŠ¤í„°',
        'ë”œë ˆì´', 'ë¦¬ë²„ë¸Œ', 'ì½”ëŸ¬ìŠ¤', 'ì»´í”„ë ˆì„œ', 'ì™€ìš°', 'ë£¨í¼',
    ]
    
    # ê¸°íƒ€/ë² ì´ìŠ¤ ê²€ìƒ‰ ì‹œ ì•°í”„ ì œì™¸ìš©
    CATEGORY_AMP_KEYWORDS = [
        'amplifier', 'amp', 'amp head', 'combo', 'combo amp',
        'cabinet', 'cab', 'head', 'stack', 'half stack', 'full stack',
        'rumble', 'bassman', 'twin reverb', 'deluxe reverb',  # 'deluxe' ë‹¨ë… ì œê±° (Les Paul Deluxe ì˜¤íƒ ë°©ì§€)
        'princeton', 'champ', 'super', 'vibrolux',
        'marshall', 'vox', 'orange', 'mesa', 'boogie', 'peavey', 'ampeg',
        'roland', 'boss katana', 'blackstar',
        'ì•°í”„', 'ì½¤ë³´', 'ì½¤ë³´ì•°í”„', 'ìºë¹„ë„·', 'í—¤ë“œì•°í”„', 'ìŠ¤íƒ',
    ]
    
    # í˜ë‹¬ ê²€ìƒ‰ ì‹œ ê¸°íƒ€/ë² ì´ìŠ¤ ë³¸ì²´ ì œì™¸ìš©
    CATEGORY_INSTRUMENT_KEYWORDS = [
        'electric guitar', 'acoustic guitar', 'bass guitar',
        'ì¼ë ‰ê¸°íƒ€', 'ì¼ë ‰íŠ¸ë¦­ ê¸°íƒ€', 'ì–´ì¿ ìŠ¤í‹±', 'ë² ì´ìŠ¤ê¸°íƒ€',
    ]

    # ì´í™í„° ê²€ìƒ‰ ì‹œ í™•ì‹¤í•œ ì´í™í„° í™•ì¸ìš©
    EFFECT_CONFIRM_KEYWORDS = [
        'pedal', 'effect', 'stomp', 'í˜ë‹¬', 'ì´í™í„°', 'ì´í™íŠ¸',
    ]

    # ë§ˆì´í¬ ê²€ìƒ‰ ì‹œ í™•ì‹¤í•œ ë§ˆì´í¬ í™•ì¸ìš©
    MIC_CONFIRM_KEYWORDS = [
        'microphone', 'mic', 'condenser', 'dynamic', 'vocal',
        'ë§ˆì´í¬', 'ë§ˆì´í¬ë¡œí°', 'ì½˜ë´ì„œ', 'ë‹¤ì´ë‚˜ë¯¹', 'ë³´ì»¬',
    ]

    # ë§ˆì´í¬ ê²€ìƒ‰ ì‹œ ì œì™¸í•  í‚¤ì›Œë“œ (ê¸°íƒ€/ë² ì´ìŠ¤/ì•°í”„/ì´í™í„°)
    CATEGORY_MIC_EXCLUDE_KEYWORDS = [
        'guitar', 'bass', 'amp', 'amplifier', 'pedal', 'effect',
        'ê¸°íƒ€', 'ë² ì´ìŠ¤', 'ì•°í”„', 'í˜ë‹¬', 'ì´í™í„°',
    ]
    
    # BASS/GUITAR ê²€ìƒ‰ ì‹œ ì–´ì¿ ìŠ¤í‹± ì œì™¸ìš©
    CATEGORY_ACOUSTIC_KEYWORDS = [
        'acoustic bass', 'acoustic-electric bass', 'semi-acoustic bass',
        'hollow body bass', 'semi-hollow bass',
        'acoustic guitar', 'acoustic-electric', 'semi-acoustic',
        'hollow body', 'semi-hollow',
        'ì–´ì¿ ìŠ¤í‹±ë² ì´ìŠ¤', 'ì–´ì¿ ìŠ¤í‹± ë² ì´ìŠ¤', 'í†µë² ì´ìŠ¤',
        'ì–´ì¿ ìŠ¤í‹±ê¸°íƒ€', 'ì–´ì¿ ìŠ¤í‹± ê¸°íƒ€', 'í†µê¸°íƒ€',
    ]
    
    # =========================================================================
    # [5] ì¿¼ë¦¬ ì œì™¸ í‚¤ì›Œë“œ (API ìš”ì²­ ì‹œ ì¿¼ë¦¬ì— -í‚¤ì›Œë“œ ì¶”ê°€)
    # =========================================================================
    QUERY_EXCLUSION_KEYWORDS = [
        # ì „ì›/ì¼€ì´ë¸”ë¥˜
        'ì–´ëŒ‘í„°', 'ì•„ë‹µí„°', 'ì¼€ì´ë¸”', 'íŒŒì›Œ', 'ì „ì›',
        # ë¶€í’ˆë¥˜
        'ë…¸ë¸Œ', 'ì­', 'ë¸Œë¦¿ì§€', 'í”½ì—…', 'ìƒˆë“¤',
        # ì•…ì„¸ì„œë¦¬ë¥˜
        'ìŠ¤íŠ¸ë©', 'ì¼€ì´ìŠ¤', 'ê°€ë°©', 'ê±°ì¹˜ëŒ€',
        # ê¸°íƒ€
        'ìŠ¤í‹°ì»¤', 'ë°°í„°ë¦¬', 'ì¶©ì „ê¸°',
    ]
    
    # =========================================================================
    # [6] ì•¡ì„¸ì„œë¦¬ ì¹´í…Œê³ ë¦¬ (category3, category4ì—ì„œ ì œì™¸í•  ì¹´í…Œê³ ë¦¬)
    # =========================================================================
    ACCESSORY_CATEGORY_BLACKLIST = [
        # category4 ê°’ìœ¼ë¡œ ìì£¼ ì˜¤ëŠ” ì•¡ì„¸ì„œë¦¬ ë¶„ë¥˜
        'ì•…ê¸°ë¶€í’ˆ', 'ê¸°íƒ€ë¶€í’ˆ', 'ë² ì´ìŠ¤ë¶€í’ˆ', 'ë¶€í’ˆ',
        'ì•…ê¸°ì¼€ì´ë¸”', 'ì¼€ì´ë¸”', 'ìŒí–¥ì¼€ì´ë¸”',
        'ê¸°íƒ€ì•¡ì„¸ì„œë¦¬', 'ë² ì´ìŠ¤ì•¡ì„¸ì„œë¦¬', 'ì•…ì„¸ì‚¬ë¦¬', 'ì•¡ì„¸ì„œë¦¬',
        'ê¸°íƒ€ì¼€ì´ìŠ¤', 'ë² ì´ìŠ¤ì¼€ì´ìŠ¤', 'ê¸±ë°±',
        'ê¸°íƒ€ìŠ¤íƒ ë“œ', 'ì•…ê¸°ìŠ¤íƒ ë“œ', 'ê±°ì¹˜ëŒ€',
        'ê¸°íƒ€ìŠ¤íŠ¸ë©', 'ìŠ¤íŠ¸ë©',
        'ê¸°íƒ€ì¤„', 'ë² ì´ìŠ¤ì¤„', 'í˜„', 'ìŠ¤íŠ¸ë§',
        'ê¸°íƒ€í”½', 'í”¼í¬', 'í”½',
        'ê¸°íƒ€ì¹´í¬', 'ì¹´í¬',
        'ì–´ëŒ‘í„°', 'ì „ì›ì¥ì¹˜', 'íŒŒì›Œì„œí”Œë¼ì´',
    ]
    
    # =========================================================================
    # [7] ìœ íš¨í•œ ì•…ê¸° ì¹´í…Œê³ ë¦¬ (ì´ ì¹´í…Œê³ ë¦¬ë©´ 'ë³¸í’ˆ'ìœ¼ë¡œ ê°„ì£¼)
    # =========================================================================
    VALID_INSTRUMENT_CATEGORIES = {
        # ê¸°íƒ€ë¥˜
        'guitar': ['ì¼ë ‰ê¸°íƒ€', 'ì¼ë ‰íŠ¸ë¦­ê¸°íƒ€', 'ì–´ì¿ ìŠ¤í‹±ê¸°íƒ€', 'í´ë˜ì‹ê¸°íƒ€', 'ê¸°íƒ€'],
        'bass': ['ë² ì´ìŠ¤ê¸°íƒ€', 'ì¼ë ‰íŠ¸ë¦­ë² ì´ìŠ¤', 'ì–´ì¿ ìŠ¤í‹±ë² ì´ìŠ¤', 'ë² ì´ìŠ¤'],
        'pedal': ['ì´í™í„°', 'ê¸°íƒ€ì´í™í„°', 'ë² ì´ìŠ¤ì´í™í„°', 'ë©€í‹°ì´í™í„°', 'í˜ë‹¬'],
        'amp': ['ê¸°íƒ€ì•°í”„', 'ë² ì´ìŠ¤ì•°í”„', 'ì•°í”„', 'ì½¤ë³´ì•°í”„', 'ì•°í”„í—¤ë“œ'],
        'mic': ['ë§ˆì´í¬', 'ë§ˆì´í¬ë¡œí°', 'ì½˜ë´ì„œë§ˆì´í¬', 'ë‹¤ì´ë‚˜ë¯¹ë§ˆì´í¬', 'ë¬´ì„ ë§ˆì´í¬'],
    }
    
    # =========================================================================
    # [8] productType í•„í„° (ìƒí’ˆ íƒ€ì…ë³„ ì‹ ë¢°ë„)
    # =========================================================================
    # 1: ì¼ë°˜ìƒí’ˆ(ê°€ê²©ë¹„êµO), 2: ì¼ë°˜ìƒí’ˆ(ê°€ê²©ë¹„êµX), 3: ì¼ë°˜ìƒí’ˆ(ê°€ê²©ë¹„êµ ë§¤ì¹­)
    # 4: ì¤‘ê³ ìƒí’ˆ, 5: ë‹¨ì¢…ìƒí’ˆ, 6: íŒë§¤ì˜ˆì •ìƒí’ˆ
    VALID_PRODUCT_TYPES = [1, 2, 3]  # ì¤‘ê³ (4), ë‹¨ì¢…(5), íŒë§¤ì˜ˆì •(6) ì œì™¸
</file>

<file path="backend/dagu/models.py">
"""
Database models for MALCHA-DAGU.

- Instrument: ì•…ê¸° ë§ˆìŠ¤í„° ë°ì´í„° (ê´€ë¦¬ìë§Œ ìˆ˜ì • ê°€ëŠ¥)
- UserItem: ìœ ì €ê°€ ë“±ë¡í•œ ì¤‘ê³  ë§¤ë¬¼ (ë§Œë£Œ ì‹œê°„ ìë™ ê´€ë¦¬)
"""

import uuid
from datetime import timedelta

from django.db import models
from django.utils import timezone


def default_expiry():
    """ê¸°ë³¸ ë§Œë£Œ ì‹œê°„: 72ì‹œê°„ í›„"""
    return timezone.now() + timedelta(hours=72)



class Brand(models.Model):
    """
    ë¸Œëœë“œ ì •ë³´ë¥¼ ê´€ë¦¬í•˜ëŠ” ëª¨ë¸.
    URL ìŠ¬ëŸ¬ê·¸, ë¡œê³ , ì„¤ëª…ì„ í¬í•¨í•˜ì—¬ ë¸Œëœë“œ í˜ì´ì§€ êµ¬ì„±ì— ì‚¬ìš©ë¨.
    """
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    name = models.CharField(max_length=100, unique=True, verbose_name='ë¸Œëœë“œëª… (ì •ì‹)')
    slug = models.SlugField(max_length=100, unique=True, verbose_name='URL ìŠ¬ëŸ¬ê·¸')
    logo_url = models.URLField(max_length=2000, blank=True, verbose_name='ë¡œê³  URL')
    description = models.TextField(blank=True, verbose_name='ë¸Œëœë“œ ì„¤ëª…')
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = 'ë¸Œëœë“œ'
        verbose_name_plural = 'ë¸Œëœë“œ ëª©ë¡'
        ordering = ['name']

    def __str__(self):
        return self.name

    def save(self, *args, **kwargs):
        if not self.slug:
            # ê¸°ë³¸ ìŠ¬ëŸ¬ê·¸ ìƒì„± (ê°„ë‹¨í•œ ì²˜ë¦¬)
            from django.utils.text import slugify
            self.slug = slugify(self.name)
        super().save(*args, **kwargs)


class Instrument(models.Model):
    """
    ì•…ê¸° ë§ˆìŠ¤í„° í…Œì´ë¸”.
    ì´ ë°ì´í„°ëŠ” ê´€ë¦¬ìë§Œ ìƒì„±/ìˆ˜ì • ê°€ëŠ¥.
    """
    
    CATEGORY_CHOICES = [
        ('guitar', 'ê¸°íƒ€'),
        ('bass', 'ë² ì´ìŠ¤'),
        ('keyboard', 'í‚¤ë³´ë“œ/ì‹ ë””'),
        ('drum', 'ë“œëŸ¼/í¼ì»¤ì…˜'),
        ('effect', 'ì´í™í„°'),
        ('amp', 'ì•°í”„'),
        ('acoustic', 'ì–´ì¿ ìŠ¤í‹±'),
        ('mic', 'ë§ˆì´í¬'),
        ('other', 'ê¸°íƒ€ ì•…ê¸°'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # [Refactor] ë¸Œëœë“œ ê´€ê³„í˜• ë°ì´í„°ë¡œ ì „í™˜ ì¤‘
    # ê¸°ì¡´ ë¬¸ìì—´ í•„ë“œëŠ” í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€í•˜ë˜, save()ì—ì„œ ìë™ ë™ê¸°í™”
    brand = models.CharField(max_length=100, verbose_name='ë¸Œëœë“œ (Legacy)')
    brand_obj = models.ForeignKey(
        Brand, 
        on_delete=models.SET_NULL, 
        null=True, 
        blank=True, 
        related_name='instruments',
        verbose_name='ë¸Œëœë“œ (Relation)'
    )

    parent = models.ForeignKey(
        'self', 
        on_delete=models.SET_NULL, 
        null=True, 
        blank=True, 
        related_name='children',
        verbose_name='ìƒìœ„ ì•…ê¸° (ë¶€ëª¨)'
    )
    
    name = models.CharField(max_length=500, verbose_name='ëª¨ë¸ëª…')
    category = models.CharField(
        max_length=50, 
        choices=CATEGORY_CHOICES, 
        default='guitar',
        verbose_name='ì¹´í…Œê³ ë¦¬'
    )
    image_url = models.URLField(max_length=2000, blank=True, verbose_name='ëŒ€í‘œ ì´ë¯¸ì§€ URL')
    reference_price = models.PositiveIntegerField(
        default=0, 
        verbose_name='ì‹ í’ˆ ê¸°ì¤€ê°€',
        help_text='ì‹ í’ˆ ì •ê°€ (ì›)'
    )
    description = models.TextField(blank=True, verbose_name='ì„¤ëª…')
    
    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def get_all_descendants(self):
        """
        ëª¨ë“  í•˜ìœ„ ìì‹ ì•…ê¸°(ì†ì, ì¦ì†ì í¬í•¨)ë¥¼ ì¬ê·€ì ìœ¼ë¡œ ì¡°íšŒ.
        """
        descendants = set()
        children = self.children.all()
        for child in children:
            descendants.add(child)
            descendants.update(child.get_all_descendants())
        return list(descendants)

    class Meta:
        verbose_name = 'ì•…ê¸°'
        verbose_name_plural = 'ì•…ê¸° ëª©ë¡'
        ordering = ['brand', 'name']
        indexes = [
            models.Index(fields=['brand']),
            models.Index(fields=['category']),
            models.Index(fields=['name']),
        ]

    def save(self, *args, **kwargs):
        # 1. ë¬¸ìì—´ ì •ê·œí™”
        if self.brand:
            self.brand = self.brand.lower().strip()
        if self.name:
            self.name = self.name.lower().strip()
            
        # 2. Brand ê°ì²´ ìë™ ì—°ê²° (ì—†ìœ¼ë©´ ìƒì„±)
        if self.brand and not self.brand_obj:
            from django.utils.text import slugify
            brand_slug = slugify(self.brand)
            
            # Brand ì°¾ê±°ë‚˜ ìƒì„±
            brand_instance, created = Brand.objects.get_or_create(
                slug=brand_slug,
                defaults={
                    'name': self.brand.title(), # Title Caseë¡œ ì €ì¥ (ì˜ˆ: fender -> Fender)
                }
            )
            self.brand_obj = brand_instance
            
        # 3. ë°˜ëŒ€ë¡œ brand_objë§Œ ìˆê³  brand í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì±„ì›Œì¤Œ
        if self.brand_obj and not self.brand:
            self.brand = self.brand_obj.slug

        super().save(*args, **kwargs)

    def __str__(self):
        return f"{self.brand} {self.name}"


class UserItem(models.Model):
    """
    ìœ ì €ê°€ ë“±ë¡í•œ ì¤‘ê³  ë§¤ë¬¼.
    ë§Œë£Œ ì‹œê°„ì´ ì§€ë‚˜ë©´ ìë™ìœ¼ë¡œ ë¹„í™œì„±í™”ë¨ (Celery Beat).
    """
    
    SOURCE_CHOICES = [
        ('bunjang', 'ë²ˆê°œì¥í„°'),
        ('joonggonara', 'ì¤‘ê³ ë‚˜ë¼'),
        ('danggn', 'ë‹¹ê·¼ë§ˆì¼“'),
        ('mule', 'ë®¬'),
        ('other', 'ê¸°íƒ€'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    instrument = models.ForeignKey(
        Instrument, 
        on_delete=models.CASCADE, 
        related_name='user_items',
        verbose_name='ì•…ê¸°'
    )
    price = models.PositiveIntegerField(verbose_name='íŒë§¤ê°€')
    link = models.URLField(max_length=2000, verbose_name='íŒë§¤ ë§í¬')
    source = models.CharField(
        max_length=50, 
        choices=SOURCE_CHOICES, 
        default='other',
        verbose_name='ì¶œì²˜'
    )
    title = models.CharField(max_length=300, blank=True, verbose_name='ë§¤ë¬¼ ì œëª©')
    
    # Status & Lifecycle
    is_active = models.BooleanField(default=True, verbose_name='í™œì„± ìƒíƒœ')
    expired_at = models.DateTimeField(
        default=default_expiry, 
        db_index=True,  # ì„±ëŠ¥ í•µì‹¬: ì¸ë±ì‹± í•„ìˆ˜
        verbose_name='ë§Œë£Œ ì‹œê°„'
    )
    click_count = models.PositiveIntegerField(default=0, verbose_name='í´ë¦­ ìˆ˜')

    # ì†Œìœ ì ì •ë³´ (JWT user_id ì €ì¥, FK ì—†ì´ ì •ìˆ˜ë§Œ)
    owner_id = models.IntegerField(
        null=True, blank=True,
        db_index=True,
        verbose_name='ë“±ë¡ì ID'
    )
    extended_at = models.DateTimeField(
        null=True, blank=True,
        verbose_name='ì—°ì¥ ì‹œì '
    )

    # ì‹ ê³  ê´€ë ¨
    report_count = models.PositiveIntegerField(default=0, verbose_name='ì‹ ê³  íšŸìˆ˜')
    is_under_review = models.BooleanField(default=False, verbose_name='ê²€í†  ì¤‘')

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = 'ì¤‘ê³  ë§¤ë¬¼'
        verbose_name_plural = 'ì¤‘ê³  ë§¤ë¬¼ ëª©ë¡'
        ordering = ['price', '-created_at']
        indexes = [
            models.Index(fields=['is_active', 'expired_at']),
            models.Index(fields=['price']),
        ]
    
    def __str__(self):
        return f"{self.instrument} - â‚©{self.price:,}"
    
    @property
    def is_expired(self):
        """ë§Œë£Œ ì—¬ë¶€ í™•ì¸"""
        return timezone.now() > self.expired_at
    
    @property
    def discount_rate(self):
        """ì‹ í’ˆ ëŒ€ë¹„ í• ì¸ìœ¨ ê³„ì‚°"""
        if self.instrument.reference_price > 0:
            discount = (1 - self.price / self.instrument.reference_price) * 100
            return round(discount, 1)
        return 0
    
    def extend_expiry(self, hours=12):
        """
        í´ë¦­ ì‹œ ë§Œë£Œ ì‹œê°„ ì—°ì¥.
        ë™ì‹œì„± ë¬¸ì œë¥¼ í”¼í•˜ê¸° ìœ„í•´ save() ëŒ€ì‹  update() ê¶Œì¥.
        """
        self.expired_at = timezone.now() + timedelta(hours=hours)
        self.save(update_fields=['expired_at', 'updated_at'])


class SearchQuery(models.Model):
    """
    ê²€ìƒ‰ì–´ ì¶”ì  ëª¨ë¸.
    ì¸ê¸° ê²€ìƒ‰ì–´ ì§‘ê³„ìš©.
    """
    query = models.CharField(max_length=200, db_index=True, verbose_name='ê²€ìƒ‰ì–´')
    search_count = models.PositiveIntegerField(default=1, verbose_name='ê²€ìƒ‰ íšŸìˆ˜')
    last_searched_at = models.DateTimeField(auto_now=True, verbose_name='ë§ˆì§€ë§‰ ê²€ìƒ‰')
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = 'ê²€ìƒ‰ì–´'
        verbose_name_plural = 'ê²€ìƒ‰ì–´ ëª©ë¡'
        ordering = ['-search_count', '-last_searched_at']

    def __str__(self):
        return f"{self.query} ({self.search_count}íšŒ)"


class ItemReport(models.Model):
    """
    ìœ ì € ì‹ ê³  ë‚´ì—­.
    ì¤‘ë³µ ì‹ ê³  ë°©ì§€ ë° ì‹ ê³  ì‚¬ìœ  ì¶”ì ìš©.
    - ë¡œê·¸ì¸ ìœ ì €: reporter_id ì‚¬ìš©
    - ë¹„ë¡œê·¸ì¸ ìœ ì €: session_key ì‚¬ìš©
    """

    REASON_CHOICES = [
        ('wrong_price', 'ê°€ê²©ì´ ë‹¤ë¦…ë‹ˆë‹¤'),
        ('sold_out', 'ì´ë¯¸ íŒë§¤ì™„ë£Œëœ ë§¤ë¬¼ì…ë‹ˆë‹¤'),
        ('fake', 'í—ˆìœ„/ì‚¬ê¸° ë§¤ë¬¼ì…ë‹ˆë‹¤'),
        ('inappropriate', 'ë¶€ì ì ˆí•œ ë‚´ìš©ì…ë‹ˆë‹¤'),
        ('other', 'ê¸°íƒ€'),
    ]

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    item = models.ForeignKey(
        UserItem,
        on_delete=models.CASCADE,
        related_name='reports',
        verbose_name='ë§¤ë¬¼'
    )
    # ë¡œê·¸ì¸ ìœ ì €ìš©
    reporter_id = models.IntegerField(
        null=True, blank=True,
        db_index=True,
        verbose_name='ì‹ ê³ ì ID'
    )
    # ë¹„ë¡œê·¸ì¸ ìœ ì €ìš© (ì„¸ì…˜ í‚¤)
    session_key = models.CharField(
        max_length=40,
        null=True, blank=True,
        db_index=True,
        verbose_name='ì„¸ì…˜ í‚¤'
    )
    reason = models.CharField(
        max_length=50,
        choices=REASON_CHOICES,
        default='other',
        verbose_name='ì‹ ê³  ì‚¬ìœ '
    )
    detail = models.TextField(blank=True, verbose_name='ìƒì„¸ ë‚´ìš©')
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = 'ë§¤ë¬¼ ì‹ ê³ '
        verbose_name_plural = 'ë§¤ë¬¼ ì‹ ê³  ëª©ë¡'
        ordering = ['-created_at']
        # ë³µí•© ìœ ë‹ˆí¬ ì œì•½ ì œê±° (ì½”ë“œì—ì„œ ì²˜ë¦¬)

    def __str__(self):
        return f"{self.item} - {self.get_reason_display()}"


class ItemClick(models.Model):
    """
    í´ë¦­ ë¡œê·¸ (íŠ¸ë Œë”© ê³„ì‚°ìš©).
    ì‹œê°„ëŒ€ë³„ í´ë¦­ ìˆ˜ë¥¼ ì§‘ê³„í•˜ì—¬ "ì§€ê¸ˆ ëœ¨ëŠ”" ì•…ê¸°ë¥¼ í‘œì‹œ.
    """
    item = models.ForeignKey(
        UserItem,
        on_delete=models.CASCADE,
        related_name='clicks',
        verbose_name='ë§¤ë¬¼'
    )
    clicked_at = models.DateTimeField(auto_now_add=True, db_index=True)

    class Meta:
        verbose_name = 'í´ë¦­ ë¡œê·¸'
        verbose_name_plural = 'í´ë¦­ ë¡œê·¸ ëª©ë¡'
        indexes = [
            models.Index(fields=['clicked_at']),
        ]

    def __str__(self):
        return f"{self.item} - {self.clicked_at}"


class SearchMissLog(models.Model):
    """
    DB ë§¤ì¹­ ì‹¤íŒ¨ ê²€ìƒ‰ì–´ ë¡œê·¸.
    ìì£¼ ê²€ìƒ‰ë˜ì§€ë§Œ DBì— ì—†ëŠ” ì•…ê¸°ë¥¼ ì¶”ì í•˜ì—¬ ìš°ì„  ë“±ë¡ ëŒ€ìƒ íŒŒì•….
    """
    query = models.CharField(max_length=200, db_index=True, verbose_name='ê²€ìƒ‰ì–´')
    normalized_query = models.CharField(
        max_length=200,
        db_index=True,
        verbose_name='ì •ê·œí™”ëœ ê²€ìƒ‰ì–´',
        help_text='ì†Œë¬¸ì, ê³µë°± ì •ë¦¬ëœ ê²€ìƒ‰ì–´'
    )
    search_count = models.PositiveIntegerField(default=1, verbose_name='ê²€ìƒ‰ íšŸìˆ˜')
    last_searched_at = models.DateTimeField(auto_now=True, verbose_name='ë§ˆì§€ë§‰ ê²€ìƒ‰')
    created_at = models.DateTimeField(auto_now_add=True)

    # ì²˜ë¦¬ ìƒíƒœ
    is_resolved = models.BooleanField(default=False, verbose_name='ì²˜ë¦¬ ì™„ë£Œ')
    resolved_at = models.DateTimeField(null=True, blank=True, verbose_name='ì²˜ë¦¬ ì‹œì ')
    resolved_instrument = models.ForeignKey(
        Instrument,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        related_name='resolved_misses',
        verbose_name='ë“±ë¡ëœ ì•…ê¸°'
    )

    class Meta:
        verbose_name = 'ë¯¸ë“±ë¡ ê²€ìƒ‰ì–´'
        verbose_name_plural = 'ë¯¸ë“±ë¡ ê²€ìƒ‰ì–´ ëª©ë¡'
        ordering = ['-search_count', '-last_searched_at']

    def __str__(self):
        status = "âœ“" if self.is_resolved else "â—‹"
        return f"{status} {self.query} ({self.search_count}íšŒ)"

    @classmethod
    def log_miss(cls, query: str):
        """
        ê²€ìƒ‰ ë¯¸ìŠ¤ ê¸°ë¡.
        ì´ë¯¸ ìˆìœ¼ë©´ ì¹´ìš´íŠ¸ ì¦ê°€, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±.
        """
        normalized = query.lower().strip()

        # ë„ˆë¬´ ì§§ê±°ë‚˜ ê¸´ ê²€ìƒ‰ì–´ëŠ” ë¬´ì‹œ
        if len(normalized) < 2 or len(normalized) > 100:
            return None

        obj, created = cls.objects.get_or_create(
            normalized_query=normalized,
            defaults={'query': query}
        )

        if not created:
            # ì¹´ìš´íŠ¸ ì¦ê°€ (F í‘œí˜„ì‹ìœ¼ë¡œ race condition ë°©ì§€)
            from django.db.models import F
            cls.objects.filter(pk=obj.pk).update(
                search_count=F('search_count') + 1
            )

        return obj
</file>

<file path="frontend/src/pages/HomePage.tsx">
/**
 * Home Page Component
 *
 * Features:
 * - íˆì–´ë¡œ ì„¹ì…˜
 * - ê²€ìƒ‰ë°”
 * - ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´
 * - ê²€ìƒ‰ ì‹œ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
 */

import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { motion } from 'framer-motion';
import SearchBar from '../components/SearchBar';
import { getPopularSearches } from '../services/api';

const DEFAULT_TERMS = ['íœë” ìŠ¤íŠ¸ë«', 'ê¹ìŠ¨ ë ˆìŠ¤í´', 'í…Œì¼ëŸ¬ ì–´ì¿ ìŠ¤í‹±', 'SM58'];

export default function HomePage() {
    const navigate = useNavigate();
    const [popularTerms, setPopularTerms] = useState<string[]>(DEFAULT_TERMS);

    // ì¸ê¸° ê²€ìƒ‰ì–´ ë¡œë“œ
    useEffect(() => {
        async function fetchPopularSearches() {
            try {
                const terms = await getPopularSearches(4);
                if (terms && terms.length > 0) {
                    setPopularTerms(terms);
                }
            } catch (error) {
                console.warn('Failed to fetch popular searches:', error);
                // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ìœ ì§€
            }
        }
        fetchPopularSearches();
    }, []);

    const handleSearch = (query: string) => {
        navigate(`/search?q=${encodeURIComponent(query)}`);
    };

    return (
        <div className="min-h-screen flex flex-col">
            {/* íˆì–´ë¡œ ì„¹ì…˜ */}
            <main className="flex-1 flex flex-col items-center justify-center px-4 py-16">
                {/* ë¡œê³  / íƒ€ì´í‹€ */}
                <motion.div
                    className="text-center mb-8 sm:mb-12"
                    initial={{ opacity: 0, y: -30 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.6 }}
                >
                    <motion.div
                        className="text-7xl sm:text-[10rem] mb-4 sm:mb-8"
                        animate={{
                            y: [0, -10, 0],
                            rotate: [0, -5, 5, 0],
                        }}
                        transition={{
                            duration: 3,
                            repeat: Infinity,
                            ease: 'easeInOut',
                        }}
                    >
                        ğŸµ
                    </motion.div>

                    <div className="relative inline-block">
                        <h1 className="text-6xl sm:text-9xl font-black mb-6 sm:mb-10 tracking-tighter text-stone-800">
                            DAGU
                        </h1>
                        <span className="absolute top-0 -right-8 sm:-right-16 text-xl sm:text-4xl font-bold text-matcha-500 rotate-12">
                            beta
                        </span>
                    </div>

                    <p className="text-lg sm:text-3xl text-stone-600 max-w-2xl mx-auto leading-relaxed px-4">
                        ì•…ê¸° ì‹œì„¸ë¥¼ í•œëˆˆì— ë¹„êµí•˜ê³  <br className="sm:hidden" />
                        <span className="block sm:inline mt-2 sm:mt-0"><span className="text-matcha-600 font-black">ë‹¤êµ¬</span>ì—ì„œ <span className="font-bold text-stone-800">ë‹¤êµ¬</span>í•´ë³´ì„¸ìš”</span>
                    </p>
                </motion.div>

                {/* ê²€ìƒ‰ë°” */}
                <div className="w-full max-w-2xl px-4 relative z-10">
                    <SearchBar onSearch={handleSearch} />
                </div>

                {/* ì¸ê¸° ê²€ìƒ‰ì–´ / ë¹ ë¥¸ ê²€ìƒ‰ */}
                <motion.div
                    className="mt-8 sm:mt-12 flex flex-col items-center gap-3 sm:gap-4 px-4"
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ delay: 0.5 }}
                >
                    <span className="text-xs sm:text-sm font-medium text-stone-400 uppercase tracking-widest mb-1 sm:mb-2">ì¸ê¸° ë§¤ë¬¼</span>
                    <div className="flex flex-wrap justify-center gap-2 sm:gap-2.5">
                        {popularTerms.map((term, i) => (
                            <motion.button
                                key={`${term}-${i}`}
                                onClick={() => handleSearch(term)}
                                className="
                                    pl-2.5 sm:pl-3 pr-4 sm:pr-5 py-2 sm:py-2.5 text-sm sm:text-base bg-white text-stone-600
                                    rounded-full shadow-sm shadow-stone-200
                                    hover:bg-matcha-50 hover:text-matcha-800 hover:shadow-md hover:-translate-y-0.5
                                    transition-all duration-300
                                    flex items-center gap-2 sm:gap-2.5 group
                                "
                                whileHover={{ scale: 1.05, y: -2 }}
                                whileTap={{ scale: 0.95 }}
                            >
                                <span className={`
                                    w-4 h-4 sm:w-5 sm:h-5 flex items-center justify-center rounded-full text-[9px] sm:text-[10px] font-black
                                    ${i < 3 ? 'bg-matcha-100 text-matcha-600' : 'bg-stone-100 text-stone-400'}
                                    group-hover:bg-white group-hover:text-matcha-600 transition-colors
                                `}>
                                    {i + 1}
                                </span>
                                <span className="font-medium">{term}</span>
                            </motion.button>
                        ))}
                    </div>
                </motion.div>
            </main>

            {/* í‘¸í„° */}
            <footer className="py-8 text-center text-sm text-stone-400 mt-auto space-y-1">
                <p>Â© 2026 DAGU. ë¹„ì˜ë¦¬ë¡œ ìš´ì˜ë˜ëŠ” ì•…ê¸° ì‹œì„¸ ë¹„êµ ì„œë¹„ìŠ¤</p>
                <p className="text-xs text-stone-300">* ë„¤ì´ë²„ì‡¼í•‘ ê°€ê²© ì •ë³´ëŠ” ì‹¤ì‹œê°„ ì¡°íšŒ ê²°ê³¼ì´ë©°, ì‹¤ì œ íŒë§¤ê°€ì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </footer>
        </div>
    );
}
</file>

<file path="frontend/src/services/api.ts">
/**
 * API client for MALCHA-DAGU backend
 */

import axios from 'axios';
import Cookies from 'js-cookie';
import type { SearchResult, Instrument, UserItem, AIDescription } from '../types';

const api = axios.create({
    baseURL: '/api',
    headers: {
        'Content-Type': 'application/json',
    },
    withCredentials: true,  // SSO ì¿ í‚¤ ì „ì†¡ í•„ìˆ˜
    xsrfCookieName: 'csrftoken',  // Django default CSRF ì¿ í‚¤ëª…
    xsrfHeaderName: 'X-CSRFToken',  // Django default CSRF í—¤ë”ëª…
});

// CSRF í† í° ìë™ ì „ì†¡ (Axios ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œë„ ë™ì‘í•˜ì§€ë§Œ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€)
api.interceptors.request.use((config) => {
    const csrfToken = Cookies.get('csrftoken');
    if (csrfToken && config.headers) {
        config.headers['X-CSRFToken'] = csrfToken;
    }
    return config;
}, (error) => {
    return Promise.reject(error);
});

// =============================================================================
// Search API
// =============================================================================

export async function search(query: string, display = 20): Promise<SearchResult> {
    const response = await api.get<SearchResult>('/search/', {
        params: { q: query, display },
    });
    return response.data;
}

export async function getPopularSearches(limit = 4): Promise<string[]> {
    const response = await api.get<{ terms: string[] }>('/popular-searches/', {
        params: { limit },
    });
    return response.data.terms;
}

// =============================================================================
// Instrument API
// =============================================================================

export async function getInstruments(params?: {
    brand?: string;
    category?: string;
    search?: string;
}): Promise<Instrument[]> {
    const response = await api.get<{ results: Instrument[] }>('/instruments/', { params });
    return response.data.results || response.data as unknown as Instrument[];
}

export async function getInstrument(id: string): Promise<Instrument> {
    const response = await api.get<Instrument>(`/instruments/${id}/`);
    return response.data;
}

// =============================================================================
// UserItem API
// =============================================================================

export async function getUserItems(params?: {
    instrument?: string;
    source?: string;
    min_price?: number;
    max_price?: number;
}): Promise<UserItem[]> {
    const response = await api.get<{ results: UserItem[] }>('/items/', { params });
    return response.data.results || response.data as unknown as UserItem[];
}

export async function createUserItem(data: {
    instrument?: number;
    price: number;
    link: string;
    source: string;
    title?: string;
}): Promise<UserItem> {
    // instrumentê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì „ì†¡, ì—†ìœ¼ë©´ ì œê±° (ë°±ì—”ë“œ ë§¤ì¹­ ìœ ë„)
    const payload = { ...data };
    if (!payload.instrument) {
        delete payload.instrument;
    }
    const response = await api.post<UserItem>('/items/', payload);
    return response.data;
}

export async function trackItemClick(id: string): Promise<UserItem> {
    const response = await api.post<UserItem>(`/items/${id}/click/`);
    return response.data;
}

export async function extendUserItem(id: string): Promise<UserItem> {
    const response = await api.post<UserItem>(`/items/${id}/extend/`);
    return response.data;
}

export async function reportUserItem(id: string, data: {
    reason: string;
    detail?: string;
}): Promise<{ message: string; report_count: number; is_under_review: boolean; is_deleted: boolean }> {
    const response = await api.post(`/items/${id}/report/`, data);
    return response.data;
}

// ... existing code ...
export async function updateItemPrice(id: string, price: number): Promise<UserItem> {
    const response = await api.post<UserItem>(`/items/${id}/update_price/`, { price });
    return response.data;
}

export async function deleteUserItem(id: string): Promise<void> {
    await api.delete(`/items/${id}/`);
}

// =============================================================================
// AI Description API
// =============================================================================

export async function getAIDescription(data: {
    model_name: string;
    brand: string;
    category: string;
}): Promise<AIDescription> {
    const response = await api.post<AIDescription>('/ai/describe/', data);
    return response.data;
}

export default api;
</file>

<file path="backend/dagu/filters.py">
"""
Filter utilities for MALCHA-DAGU.
Quality filtering functions for search results.
"""

import logging
import re
from functools import lru_cache
from typing import Optional

from .config import FilterConfig, CategoryConfig, CrawlerConfig

logger = logging.getLogger(__name__)

# =============================================================================
# ì‚¬ìš©ì ë§¤ë¬¼ í•„í„°ë§
# =============================================================================

def filter_user_item(
    title: str,
    price: int,
    category: str = None,
    min_price: int = None,
) -> bool:
    """
    ì‚¬ìš©ì ë§¤ë¬¼ í•„í„°ë§.
    ìœ ì €ê°€ ì§ì ‘ ë“±ë¡í•œ ë§¤ë¬¼ì´ë¯€ë¡œ ê°€ê²© í•„í„°ëŠ” ì ìš©í•˜ì§€ ì•ŠìŒ.

    Returns:
        True = í†µê³¼, False = íƒˆë½
    """
    # [í•„í„° 1] ë¸”ë™ë¦¬ìŠ¤íŠ¸

    return True


def filter_user_item_by_brand(
    query: str,
    item_brand: str,
) -> bool:
    """
    ì‚¬ìš©ì ë§¤ë¬¼ ë¸Œëœë“œ í•„í„°ë§.
    
    ê²€ìƒ‰ì–´ì— ëª…ì‹œëœ ë¸Œëœë“œì™€ ë§¤ë¬¼ì˜ ì•…ê¸° ë¸Œëœë“œê°€ ë‹¤ë¥´ë©´ í•„í„°ë§.
    ì˜ˆ: 'Squier Strat' ê²€ìƒ‰ ì‹œ, instrument.brandê°€ 'Fender'ì¸ ë§¤ë¬¼ì€ ì œì™¸.
    
    Args:
        query: ì‚¬ìš©ì ê²€ìƒ‰ì–´
        item_brand: ë§¤ë¬¼ì— ì—°ê²°ëœ ì•…ê¸°ì˜ ë¸Œëœë“œ (instrument.brand)
        
    Returns:
        True = í†µê³¼, False = íƒˆë½
    """
    from .services.utils import extract_brand, is_known_brand
    
    # 1. ê²€ìƒ‰ì–´ì—ì„œ ë¸Œëœë“œ ì¶”ì¶œ
    query_brand = extract_brand(query)
    
    # 2. ê²€ìƒ‰ì–´ì— ëª…ì‹œì  ë¸Œëœë“œê°€ ì—†ìœ¼ë©´ í•„í„° ì•ˆ í•¨ (í†µê³¼)
    if not query_brand or not is_known_brand(query_brand):
        return True
    
    # 3. ë§¤ë¬¼ì— ë¸Œëœë“œê°€ ì—†ìœ¼ë©´ í•„í„° ì•ˆ í•¨ (í†µê³¼)
    if not item_brand:
        return True
    
    # 4. ë¸Œëœë“œ ì¼ì¹˜ ì—¬ë¶€ í™•ì¸ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
    query_brand_lower = query_brand.lower()
    item_brand_lower = item_brand.lower()
    
    # ë¸Œëœë“œê°€ ì¼ì¹˜í•˜ë©´ í†µê³¼
    if query_brand_lower in item_brand_lower or item_brand_lower in query_brand_lower:
        return True
    
    # ë¸Œëœë“œê°€ ë‹¤ë¥´ë©´ íƒˆë½
    logger.debug(f"[Brand Filter] íƒˆë½: query_brand='{query_brand}', item_brand='{item_brand}'")
    return False


# =============================================================================
# í•„í„° í†µê³„ (ë””ë²„ê¹…ìš©)
# =============================================================================

class FilterStats:
    """í•„í„° í†µê³„ ì¶”ì  (ë””ë²„ê¹…ìš©)"""

    def __init__(self):
        self.reset()

    def reset(self):
        self.total = 0
        self.passed = 0
        self.failed_by = {
            'price': 0,
            'blacklist': 0,
            'brand': 0,
            'category': 0,
            'category_fields': 0,
            'product_type': 0,
        }

    def record_pass(self):
        self.total += 1
        self.passed += 1

    def record_fail(self, reason: str):
        self.total += 1
        if reason in self.failed_by:
            self.failed_by[reason] += 1

    def log_summary(self, prefix: str = ""):
        if self.total == 0:
            return
        logger.info(
            f"{prefix}[FilterStats] ì´ {self.total}ê°œ ì¤‘ {self.passed}ê°œ í†µê³¼ "
            f"({self.passed/self.total*100:.1f}%)"
        )
        for reason, count in self.failed_by.items():
            if count > 0:
                logger.debug(f"  - {reason}: {count}ê°œ íƒˆë½")


# ì „ì—­ í†µê³„ ì¸ìŠ¤í„´ìŠ¤ (ì„ íƒì  ì‚¬ìš©)
_filter_stats = FilterStats()


# =============================================================================
# ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë¡œë”© (ìºì‹±ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”)
# =============================================================================

@lru_cache(maxsize=1)
def get_blacklist() -> tuple[str, ...]:
    """
    ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ë° ì •ê·œí™” (ìµœì í™” ë²„ì „).
    - ì¤‘ë³µ ì œê±° ë° ì†Œë¬¸ì ì •ê·œí™”
    - ê¸´ ë‹¨ì–´ ìˆœì„œë¡œ ì •ë ¬ (í•„í„°ë§ ì •í™•ë„ í–¥ìƒ)
    - ë¡œê¹… ë ˆë²¨ ìµœì í™” ë° ë¹„ì •ìƒ ë°ì´í„° í•„í„°ë§
    """
    # 1. ì„¤ì •ê°’ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸)
    raw_list = getattr(FilterConfig, 'BLACKLIST_KEYWORDS', [])

    if not raw_list:
        logger.warning("âš ï¸ BLACKLIST_KEYWORDSê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•Šê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")
        return tuple()

    # 2. ë°ì´í„° ì •ì œ (Set Comprehensionìœ¼ë¡œ ì†ë„ í–¥ìƒ)
    # ë¬¸ìì—´ì¸ ê²ƒë§Œ ê³¨ë¼ë‚´ì„œ strip, lower ì²˜ë¦¬
    processed_set = {
        str(item).strip().lower()
        for item in raw_list
        if item and len(str(item).strip()) > 0
    }

    result_list = []
    for word in processed_set:
        # ë¹„ì •ìƒì ìœ¼ë¡œ ê¸´ ë‹¨ì–´ ê²½ê³  (ì„¤ì • íŒŒì¼ ì˜¤íƒ€ ê°ì§€)
        if len(word) > 25:
            logger.warning(f"ğŸš© ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ë¹„ì •ìƒì ìœ¼ë¡œ ê¸´ ë‹¨ì–´ ë°œê²¬ (ì˜¤íƒ€ í™•ì¸ ê¶Œì¥): '{word}'")

        # [ê¸°ì¡´ ê°œì„ ] ë£¨í”„ ì•ˆì˜ logger.error(word)ëŠ” ì„œë²„ ë¶€í•˜ë¥¼ ì£¼ë¯€ë¡œ ì œê±°í•˜ê±°ë‚˜ debugë¡œ ë³€ê²½
        # logger.debug(f"Blacklist word loaded: {word}")
        result_list.append(word)

    # 3. í•µì‹¬ ê°œì„ : ë‹¨ì–´ ê¸¸ì´ì— ë”°ë¼ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    # 'í•˜ë“œì¼€ì´ìŠ¤'ê°€ 'ì¼€ì´ìŠ¤'ë³´ë‹¤ ì•ì— ì™€ì•¼ ì •í™•í•œ ë§¤ì¹­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    result_list.sort(key=len, reverse=True)

    logger.info(f"âœ… ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì™„ë£Œ: {len(result_list)}ê°œ í‚¤ì›Œë“œ")
    return tuple(result_list)

def clear_blacklist_cache():
    """ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìºì‹œ ì´ˆê¸°í™” (ì„¤ì • ë³€ê²½ ì‹œ í˜¸ì¶œ)"""
    get_blacklist.cache_clear()


# =============================================================================
# í•„í„° í•¨ìˆ˜ë“¤
# =============================================================================

def _is_korean(text: str) -> bool:
    """í•œê¸€ í¬í•¨ ì—¬ë¶€ í™•ì¸"""
    return any('\uac00' <= char <= '\ud7a3' for char in text)


def check_blacklist(title: str) -> bool:
    """
    ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê²€ì‚¬.
    - ë¸”ë™ë¦¬ìŠ¤íŠ¸ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ í•„í„°ë§
    - "ì„¸íŠ¸", "í¬í•¨" ë“± ì˜ˆì™¸ í‚¤ì›Œë“œëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ

    Returns:
        True = í†µê³¼ (ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ì—†ìŒ)
        False = íƒˆë½ (ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ìˆìŒ)
    """
    title_lower = title.lower()
    current_blacklist = get_blacklist()

    for blackword in current_blacklist:
        if _is_korean(blackword):
            # í•œê¸€: ë¶€ë¶„ë¬¸ìì—´ ë§¤ì¹­
            if blackword in title_lower:
                logger.debug(f"[Blacklist] íƒˆë½: '{blackword}' - {title[:50]}")
                return False
        else:
            # ì˜ì–´: ë‹¨ì–´ ê²½ê³„ ê²€ì‚¬
            pattern = rf'(?<![a-zA-Z0-9]){re.escape(blackword)}(?![a-zA-Z0-9])'
            if re.search(pattern, title_lower):
                logger.debug(f"[Blacklist] íƒˆë½: '{blackword}' - {title[:50]}")
                return False

    return True


def check_min_price(price: int, category: str, reference_price: int, min_price: int = None) -> bool:
    """
    ìµœì†Œ ê°€ê²© ê²€ì‚¬.
    ë¶€í’ˆ/ì¼€ì´ìŠ¤ ë“± ë„ˆë¬´ ì‹¼ ë¬¼ê±´ ì œì™¸.
    
    Returns:
        True = í†µê³¼
        False = íƒˆë½
    """

    if min_price is None:
        min_price = calculate_min_price(category, reference_price)
    if price < min_price:
        return False
    
    return True


def check_brand_integrity(target_brand: str, title: str, category: str = None) -> bool:
    """
    ì¹´í…Œê³ ë¦¬ë³„ ë¸Œëœë“œ ë¬´ê²°ì„± ê²€ì‚¬.
    - guitar, bass: ìƒìœ„ ë¸Œëœë“œ ê²€ìƒ‰ ì‹œ í•˜ìœ„ ë¸Œëœë“œ(Hierarchy) ì—„ê²© ì œì™¸
    - ì¹´í…Œê³ ë¦¬ ë¶ˆí™•ì‹¤(None): í•˜ì´ì–´ë¼í‚¤ ê²€ì‚¬ ê±´ë„ˆëœ€ (ì˜¤íƒ ë°©ì§€)
    - ê¸°íƒ€ ì¹´í…Œê³ ë¦¬: ë¸Œëœë“œ ì¡´ì¬ ì—¬ë¶€ ë° ë‹¨ì–´ ê²½ê³„ë§Œ ê²€ì‚¬ (ìœ ì—°í•¨ ìœ ì§€)
    """
    if not target_brand or 'pending' in target_brand.lower():
        return True

    target_lower = target_brand.lower().strip()
    title_lower = title.lower()
    
    # 1. [ê¸°íƒ€/ë² ì´ìŠ¤ ì „ìš©] ë¸Œëœë“œ í•˜ì´ì–´ë¼í‚¤ ê²€ì‚¬
    # ì¹´í…Œê³ ë¦¬ê°€ í™•ì‹¤í•  ë•Œë§Œ ì ìš© (None = í™•ì‹  ì—†ìŒ â†’ í•˜ì´ì–´ë¼í‚¤ ê²€ì‚¬ ìŠ¤í‚µ)
    if category is not None and category in ['guitar', 'bass']:
        hierarchy = getattr(FilterConfig, 'BRAND_HIERARCHY', {})
        lower_brands = hierarchy.get(target_lower, [])

        for lb in lower_brands:
            if lb.lower() in title_lower:
                logger.debug(f"â›” [BrandFilter] í•˜ìœ„ ë¸Œëœë“œ ì œì™¸ ({category}): '{lb}' in '{title[:50]}'")
                return False

    # 2. [ê³µí†µ] í—ˆìš© í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ì—… (ë³¸ë˜ ì´ë¦„ + í•œ/ì˜ ë³„ì¹­)
    # BRAND_NAME_MAPPINGì—ì„œ ì´ ë¸Œëœë“œì— í•´ë‹¹í•˜ëŠ” ë³„ì¹­ì„ ëª¨ë‘ ê°€ì ¸ì˜´
    aliases = [k for k, v in getattr(CategoryConfig, 'BRAND_NAME_MAPPING', {}).items() if v == target_lower]
    allowed_keywords = [target_lower] + aliases

    # 3. [ê³µí†µ] ì •ê·œí‘œí˜„ì‹ì„ ì´ìš©í•œ ë¸Œëœë“œ ì¡´ì¬ í™•ì¸ (ì˜¤íƒ ë°©ì§€)
    # ì œëª©ì— ê²€ìƒ‰í•œ ë¸Œëœë“œë‚˜ ê·¸ ë³„ì¹­ì´ 'ë‹¨ì–´'ë¡œì„œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    for kw in allowed_keywords:
        # ì˜ë¬¸/ìˆ«ì ê²½ê³„ë¥¼ í¬í•¨í•œ íŒ¨í„´ (ì˜ˆ: 'ESP'ê°€ 'Response'ì— ê±¸ë¦¬ì§€ ì•Šë„ë¡)
        pattern = rf'(?<![a-zA-Z0-9]){re.escape(kw)}(?![a-zA-Z0-9])'
        if re.search(pattern, title_lower):
            return True

    logger.debug(f"âŒ [BrandFilter] ë¸Œëœë“œ ë¶ˆì¼ì¹˜: '{target_lower}' ì—†ìŒ - {title[:50]}")
    return False

def validate_tokens(model_name: str, title: str) -> bool:
    """
    ëª¨ë¸ëª… í† í° ê²€ì¦.
    - ëª¨ë¸ëª…ì˜ ì£¼ìš” í† í°ì´ ì œëª©ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    - ë™ì˜ì–´ë„ í™•ì¸ (TOKEN_SYNONYMS)
    
    Returns:
        True = í†µê³¼ (ìµœì†Œ 1ê°œ í† í° ë§¤ì¹­)
        False = íƒˆë½
    """
    # Pending ì²˜ë¦¬
    clean_model = model_name.replace("[Pending] Pending...", "").strip()
    tokens = [t.lower() for t in clean_model.split() if len(t) > 1]
    
    # í† í°ì´ ì—†ìœ¼ë©´ í†µê³¼
    if not tokens:
        return True
    
    title_lower = title.lower()
    synonyms_map = getattr(FilterConfig, 'TOKEN_SYNONYMS', {})
    
    # ëª¨ë“  í† í° ì¤‘ í•˜ë‚˜ë¼ë„ ë§¤ì¹­ë˜ë©´ í†µê³¼
    for token in tokens:
        # ì§ì ‘ ë§¤ì¹­
        if token in title_lower:
            return True
        # ë™ì˜ì–´ ë§¤ì¹­
        synonyms = synonyms_map.get(token, [])
        if any(syn in title_lower for syn in synonyms):
            return True
    
    logger.debug(f"í† í° íƒˆë½: {tokens} not in '{title[:50]}...'")
    return False


def _contains_keywords(title_lower: str, config_key: str) -> bool:
    """
    configì—ì„œ í‚¤ì›Œë“œ ëª©ë¡ì„ ê°€ì ¸ì™€ ì œëª©ì— 'ë…ë¦½ëœ ë‹¨ì–´'ë¡œ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸.
    ì •ê·œí‘œí˜„ì‹ì„ ì‚¬ìš©í•˜ì—¬ ë¶€ë¶„ ì¼ì¹˜ë¡œ ì¸í•œ ì˜¤íƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
    """
    keywords = getattr(FilterConfig, config_key, [])

    for kw in keywords:
        kw_clean = kw.lower().strip()
        if not kw_clean:
            continue

        # 1. í•œê¸€ì´ í¬í•¨ëœ ê²½ìš°: ê¸°ì¡´ì²˜ëŸ¼ ë¶€ë¶„ ì¼ì¹˜ í—ˆìš© (ë„ì–´ì“°ê¸° ë¬´ê´€)
        if any('\uac00' <= char <= '\ud7a3' for char in kw_clean):
            if kw_clean in title_lower:
                return True
        else:
            # 2. ì˜ë¬¸/ìˆ«ìë§Œ ìˆëŠ” ê²½ìš°: ë‹¨ì–´ ê²½ê³„ ê²€ì‚¬ ì ìš©
            # (?<![a-zA-Z0-9]) : ì•ë’¤ì— ì˜ë¬¸ì´ë‚˜ ìˆ«ìê°€ ë¶™ì–´ìˆì§€ ì•Šì•„ì•¼ í•¨
            pattern = rf'(?<![a-zA-Z0-9]){re.escape(kw_clean)}(?![a-zA-Z0-9])'
            if re.search(pattern, title_lower):
                return True

    return False

def check_category_mismatch(search_category: str, title: str) -> bool:
    """
    ì¹´í…Œê³ ë¦¬ ë¶ˆì¼ì¹˜ ê²€ì‚¬.
    - ê¸°íƒ€/ë² ì´ìŠ¤ ê²€ìƒ‰ ì‹œ í˜ë‹¬/ì•°í”„ ì œì™¸
    - í˜ë‹¬ ê²€ìƒ‰ ì‹œ ê¸°íƒ€ ë³¸ì²´ ì œì™¸

    Returns:
        True = í†µê³¼
        False = íƒˆë½ (ë¶ˆì¼ì¹˜)
    """
    title_lower = title.lower()
    search_cat = search_category.lower() if search_category else ""

    # guitar/bass ê²€ìƒ‰ ì‹œ
    if search_cat in ['guitar', 'bass']:
        if _contains_keywords(title_lower, 'CATEGORY_PEDAL_KEYWORDS'):
            logger.debug(f"â›” ì¹´í…Œê³ ë¦¬ íƒˆë½: í˜ë‹¬ í‚¤ì›Œë“œ in '{title[:50]}...'")
            return False
        if _contains_keywords(title_lower, 'CATEGORY_AMP_KEYWORDS'):
            logger.debug(f"â›” ì¹´í…Œê³ ë¦¬ íƒˆë½: ì•°í”„ í‚¤ì›Œë“œ in '{title[:50]}...'")
            return False
        if _contains_keywords(title_lower, 'CATEGORY_ACOUSTIC_KEYWORDS'):
            logger.debug(f"â›” ì¹´í…Œê³ ë¦¬ íƒˆë½: ì–´ì¿ ìŠ¤í‹± í‚¤ì›Œë“œ in '{title[:50]}...'")
            return False

    # acoustic ê²€ìƒ‰ ì‹œ
    if search_cat == 'acoustic':
        if _contains_keywords(title_lower, 'CATEGORY_PEDAL_KEYWORDS'):
            return False
        if _contains_keywords(title_lower, 'CATEGORY_AMP_KEYWORDS'):
            return False

    # effect(ì´í™í„°) ê²€ìƒ‰ ì‹œ
    if search_cat == 'effect':
        # "í˜ë‹¬", "ì´í™í„°" ë“±ì´ ì œëª©ì— ìˆìœ¼ë©´ í™•ì‹¤íˆ ì´í™í„°ì´ë¯€ë¡œ í†µê³¼
        if _contains_keywords(title_lower, 'EFFECT_CONFIRM_KEYWORDS'):
            return True
        # ê·¸ ì™¸ì—ëŠ” ê¸°íƒ€ ë³¸ì²´ í‚¤ì›Œë“œ í™•ì¸
        if _contains_keywords(title_lower, 'CATEGORY_INSTRUMENT_KEYWORDS'):
            return False

    # amp ê²€ìƒ‰ ì‹œ
    if search_cat == 'amp':
        if _contains_keywords(title_lower, 'CATEGORY_PEDAL_KEYWORDS'):
            return False

    # mic(ë§ˆì´í¬) ê²€ìƒ‰ ì‹œ
    if search_cat == 'mic':
        # "ë§ˆì´í¬", "ë§ˆì´í¬ë¡œí°" ë“±ì´ ì œëª©ì— ìˆìœ¼ë©´ í™•ì‹¤íˆ ë§ˆì´í¬ì´ë¯€ë¡œ í†µê³¼
        if _contains_keywords(title_lower, 'MIC_CONFIRM_KEYWORDS'):
            return True
        # ê·¸ ì™¸ì—ëŠ” ê¸°íƒ€/ì•°í”„/ì´í™í„° í‚¤ì›Œë“œ í™•ì¸
        if _contains_keywords(title_lower, 'CATEGORY_MIC_EXCLUDE_KEYWORDS'):
            return False

    return True


def check_category_fields(item: dict) -> bool:
    # 1. í•„ë“œ ê°’ í™•ë³´ (ì†Œë¬¸ìí™” ë° None ë°©ì§€)
    # ë„¤ì´ë²„ APIëŠ” category1~4ê¹Œì§€ ì œê³µí•˜ë¯€ë¡œ 3, 4ë¥¼ ì¤‘ì ì ìœ¼ë¡œ ë´…ë‹ˆë‹¤.
    cat3 = str(item.get('category3', '')).lower()
    cat4 = str(item.get('category4', '')).lower()

    # ì¹´í…Œê³ ë¦¬ ì •ë³´ê°€ ì•„ì˜ˆ ì—†ìœ¼ë©´ ì¼ë‹¨ í†µê³¼ (ì œëª© í•„í„°ì—ì„œ ê±¸ëŸ¬ì§ˆ ê²ƒì„ ê¸°ëŒ€)
    if not cat3 and not cat4:
        return True

    # 2. ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë¡œë“œ (ë¯¸ë¦¬ ì†Œë¬¸ìí™”ëœ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¨ë‹¤ê³  ê°€ì •)
    # ì˜ˆ: ['ìš©í’ˆ', 'ì¼€ì´ìŠ¤', 'ì†Œëª¨í’ˆ', 'ë¶€í’ˆ', 'í”¼í¬', 'ìŠ¤íŠ¸ë©', 'ìŠ¤íƒ ë“œ']
    blacklist = getattr(FilterConfig, 'ACCESSORY_CATEGORY_BLACKLIST', [])

    for kw in blacklist:
        kw_lower = kw.lower()
        # 3. ë¶€ë¶„ ì¼ì¹˜ ê²€ì‚¬
        if kw_lower in cat3 or kw_lower in cat4:
            logger.debug(f"â›” [CategoryFieldFilter] íƒˆë½: '{kw_lower}' ë°œê²¬ "
                         f"(cat3: '{cat3}', cat4: '{cat4}')")
            return False

    return True
def check_product_type(item: dict) -> bool:
    """
    productType í•„ë“œ ê²€ì‚¬.
    ì¤‘ê³ (4), ë‹¨ì¢…(5), íŒë§¤ì˜ˆì •(6) ì œì™¸.
    
    Returns:
        True = í†µê³¼
        False = íƒˆë½
    """
    try:
        product_type = int(item.get('productType', 1))
    except (ValueError, TypeError):
        return True  # íŒŒì‹± ì‹¤íŒ¨ì‹œ í†µê³¼
    
    valid_types = getattr(FilterConfig, 'VALID_PRODUCT_TYPES', [1, 2, 3])
    
    if product_type not in valid_types:
        logger.debug(f"[ProductType] íƒˆë½: {product_type} (í—ˆìš©: {valid_types}) - {item.get('title', '')[:30]}")
        return False
    
    return True


def build_exclusion_query(query: str) -> str:
    """
    ì¿¼ë¦¬ì— ì œì™¸ í‚¤ì›Œë“œë¥¼ ì¶”ê°€í•˜ì—¬ API ë ˆë²¨ì—ì„œ ì•¡ì„¸ì„œë¦¬ í•„í„°ë§.
    ì˜ˆ: 'BOSS DS-1' -> 'BOSS DS-1 -ì–´ëŒ‘í„° -ì¼€ì´ë¸” -ë…¸ë¸Œ'
    
    Returns:
        ì œì™¸ í‚¤ì›Œë“œê°€ ì¶”ê°€ëœ ì¿¼ë¦¬ ë¬¸ìì—´
    """
    exclusion_keywords = getattr(FilterConfig, 'QUERY_EXCLUSION_KEYWORDS', [])
    
    if not exclusion_keywords:
        return query
    
    # ì œì™¸ ì—°ì‚°ì ì¶”ê°€
    exclusions = ' '.join([f'-{kw}' for kw in exclusion_keywords])
    return f'{query} {exclusions}'


def calculate_match_score(query: str, title: str, image_url: str = None) -> int:
    """
    ë§¤ì¹­ ìŠ¤ì½”ì–´ ê³„ì‚°.
    - ê²€ìƒ‰ì–´ í† í° ë§¤ì¹­ë¥  (í•µì‹¬)
    - ì´ë¯¸ì§€ ìœ ë¬´, ì¤‘ê³  ì—¬ë¶€, ì •í’ˆ ì—¬ë¶€
    
    Returns:
        0-100 ì ìˆ˜
    """
    score = 0
    
    # ì¤‘ë³µ ì œê±° (ì ìˆ˜ ë»¥íŠ€ê¸° ë°©ì§€)
    query_tokens = list(set([t.lower() for t in query.split() if len(t) > 1]))
    title_lower = title.lower()
    
    if not query_tokens:
        return 50  # ì¿¼ë¦¬ ì—†ìœ¼ë©´ ê¸°ë³¸ ì ìˆ˜
    
    # í† í° ë§¤ì¹­ë¥  (ìµœëŒ€ 70ì )
    matched = sum(1 for t in query_tokens if t in title_lower)
    match_ratio = matched / len(query_tokens)
    
    score += int(match_ratio * 70)
    
    # ëª¨ë“  í† í°ì´ ë‹¤ í¬í•¨ë˜ë©´ ë³´ë„ˆìŠ¤ (+15ì )
    if match_ratio == 1.0:
        score += 15
    
    # ì´ë¯¸ì§€ ìˆìœ¼ë©´ +10ì 
    if image_url and 'http' in str(image_url):
        score += 10
    
    # ì¤‘ê³ í’ˆì´ë©´ +5ì  (ì¤‘ê³  ê±°ë˜ ì‚¬ì´íŠ¸ì´ë¯€ë¡œ)
    if 'ì¤‘ê³ ' in title_lower or 'used' in title_lower:
        score += 5
    
    # ì •í’ˆ í‚¤ì›Œë“œ ìˆìœ¼ë©´ +5ì 
    if 'ì •í’ˆ' in title_lower or 'genuine' in title_lower or 'authentic' in title_lower:
        score += 5
    
    return min(score, 100)


def clean_html_tags(text: str) -> str:
    """HTML íƒœê·¸ ë° íŠ¹ìˆ˜ë¬¸ì ì œê±°"""
    # HTML íƒœê·¸ ì œê±°
    clean = re.sub(r'<[^>]+>', '', text)
    # &nbsp; ë“± HTML ì—”í‹°í‹° ì œê±°
    clean = clean.replace('\xa0', ' ')
    # ì—°ì† ê³µë°± ì •ë¦¬
    clean = re.sub(r'\s+', ' ', clean)
    return clean.strip()


def calculate_min_price(category: str = None, reference_price: int = None) -> int:
    """
    ìµœì†Œ ê°€ê²© ê³„ì‚°.
    - reference_priceê°€ ìˆìœ¼ë©´: ì‹ í’ˆê°€ì˜ MIN_PRICE_RATIO (10%)
    - ì—†ìœ¼ë©´: ì¹´í…Œê³ ë¦¬ë³„ ê¸°ë³¸ê°’ ì‚¬ìš©
    """
    # ì‹ í’ˆ ê¸°ì¤€ê°€ê°€ ìˆìœ¼ë©´ ë¹„ìœ¨ë¡œ ê³„ì‚°
    if reference_price and reference_price > 0:
        calculated = int(reference_price * CrawlerConfig.MIN_PRICE_RATIO)
        # ìµœì†Œ 1ë§Œì›ì€ ë³´ì¥
        return max(calculated, 10000)

    # í´ë°±: ì¹´í…Œê³ ë¦¬ë³„ ê¸°ë³¸ê°’
    if category == 'effect':
        return CrawlerConfig.MIN_PRICE_PEDAL
    elif category == 'mic':
        return CrawlerConfig.MIN_PRICE_MIC
    else:
        return CrawlerConfig.MIN_PRICE_KRW


def calculate_dynamic_min_price(prices: list[int], threshold_ratio: float = 0.15) -> int:
    """
    ë™ì  ê°€ê²© í•„í„°ë§ (DBì— ì—†ëŠ” ì•…ê¸°ìš©).
    ê°€ê²© ë¶„í¬ì˜ ì¤‘ê°„ê°’(Median)ì„ êµ¬í•˜ê³ , ê·¸ ì¤‘ê°„ê°’ì˜ threshold_ratio ì´í•˜ì¸ ìƒí’ˆì€ ì œì™¸.

    Args:
        prices: ê²€ìƒ‰ ê²°ê³¼ ê°€ê²© ë¦¬ìŠ¤íŠ¸
        threshold_ratio: ì¤‘ê°„ê°’ ëŒ€ë¹„ ìµœì†Œê°€ ë¹„ìœ¨ (ê¸°ë³¸ 15%)

    Returns:
        ë™ì ìœ¼ë¡œ ê³„ì‚°ëœ ìµœì†Œ ê°€ê²©
    """
    if not prices or len(prices) < 5:
        return 0  # ë°ì´í„° ë¶€ì¡± ì‹œ í•„í„°ë§ ì•ˆ í•¨

    sorted_prices = sorted(prices)
    n = len(sorted_prices)

    # ì¤‘ê°„ê°’ ê³„ì‚°
    if n % 2 == 0:
        median = (sorted_prices[n // 2 - 1] + sorted_prices[n // 2]) // 2
    else:
        median = sorted_prices[n // 2]

    # ì¤‘ê°„ê°’ì˜ threshold_ratioë¥¼ ìµœì†Œê°€ë¡œ ì„¤ì •
    dynamic_min = int(median * threshold_ratio)

    # ìµœì†Œ 1ë§Œì› ë³´ì¥
    dynamic_min = max(dynamic_min, 10000)

    logger.info(f"[ë™ì í•„í„°] ê°€ê²©ë¶„í¬: {len(prices)}ê°œ, ì¤‘ê°„ê°’: {median:,}ì› â†’ ìµœì†Œê°€: {dynamic_min:,}ì›")

    return dynamic_min


def filter_naver_item_with_reason(
    item: dict,
    query: str,
    brand: str = None,
    category: str = None,
    min_price: int = None,
    reference_price: int = None,
) -> tuple[Optional[dict], str]:
    """
    ë„¤ì´ë²„ ì‡¼í•‘ ì•„ì´í…œ í•„í„°ë§ (íƒˆë½ ì´ìœ  ë°˜í™˜).

    Args:
        reference_price: ì‹ í’ˆ ê¸°ì¤€ê°€ (ìˆìœ¼ë©´ ì´ ê°’ì˜ 10%ë¥¼ ìµœì†Œê°€ë¡œ ì‚¬ìš©)

    Returns:
        (ì •ì œëœ ì•„ì´í…œ ë˜ëŠ” None, íƒˆë½ ì´ìœ )
    """
    title = clean_html_tags(item.get('title', ''))
    try:
        lprice = int(item.get('lprice', 0))
    except (ValueError, TypeError):
        logger.info(f"[Filter] âŒ ê°€ê²©íŒŒì‹±ì‹¤íŒ¨ - {title[:60]}")
        return None, 'price'

    # [í•„í„° 1] ìµœì†Œ ê°€ê²©

    if not check_min_price(lprice,category,reference_price, min_price):
        return None, 'price'

    # [í•„í„° 5] ì¹´í…Œê³ ë¦¬ í•„ë“œ ê²€ì‚¬
    if not check_category_fields(item):
        cat_info = f"[{item.get('category1', '')}/{item.get('category2', '')}/{item.get('category3', '')}/{item.get('category4', '')}]"
        logger.info(f"[Filter] âŒ ì•¡ì„¸ì„œë¦¬ì¹´í…Œê³ ë¦¬ {cat_info} - {title[:60]}")
        return None, 'category_fields'


    # [í•„í„° 2] ë¸”ë™ë¦¬ìŠ¤íŠ¸
    if not check_blacklist(title):
        logger.info(f"[Filter] âŒ ë¸”ë™ë¦¬ìŠ¤íŠ¸ - {title[:60]}")
        return None, 'blacklist'


    # [í•„í„° 4] ì¹´í…Œê³ ë¦¬ ë¶ˆì¼ì¹˜
    if category and not check_category_mismatch(category, title):
        cat_info = f"[{item.get('category1', '')}/{item.get('category2', '')}/{item.get('category3', '')}/{item.get('category4', '')}]"
        logger.info(f"[Filter] âŒ ì¹´í…Œê³ ë¦¬ë¶ˆì¼ì¹˜ '{category}' {cat_info} - {title[:60]}")
        return None, 'category'

    # [í•„í„° 3] ë¸Œëœë“œ ë¬´ê²°ì„±
    if brand and not check_brand_integrity(brand, title, category):
        logger.info(f"[Filter] âŒ ë¸Œëœë“œë¶ˆì¼ì¹˜ '{brand}' - {title[:60]}")
        return None, 'brand'




    # ëª¨ë“  í•„í„° í†µê³¼
    image_url = item.get('image', '')
    result = {
        'title': title,
        'link': item.get('link', ''),
        'image': image_url,
        'lprice': lprice,
        'hprice': int(item.get('hprice', 0) or 0),
        'mallName': item.get('mallName', ''),
        'productId': item.get('productId', ''),
        'productType': item.get('productType', 0),
        'brand': item.get('brand', ''),
        'maker': item.get('maker', ''),
        'category1': item.get('category1', ''),
        'category2': item.get('category2', ''),
        'category3': item.get('category3', ''),
        'category4': item.get('category4', ''),
        'source': 'naver',
        'score': calculate_match_score(query, title, image_url),
        'is_used': 'ì¤‘ê³ ' in title.lower() or item.get('productType') in [4, 5, 6],
    }
    return result, 'passed'


def filter_naver_item(
    item: dict,
    query: str,
    brand: str = None,
    category: str = None,
    min_price: int = None,
    reference_price: int = None,
) -> Optional[dict]:
    """
    ë„¤ì´ë²„ ì‡¼í•‘ ì•„ì´í…œ í•„í„°ë§.
    ëª¨ë“  í•„í„°ë¥¼ í†µê³¼í•˜ë©´ ì •ì œëœ ì•„ì´í…œ ë°˜í™˜, íƒˆë½í•˜ë©´ None ë°˜í™˜.
    """
    result, _ = filter_naver_item_with_reason(item, query, brand, category, min_price, reference_price)
    return result
</file>

<file path="backend/config/settings/prod.py">
from .base import * # base.pyì˜ ëª¨ë“  ì„¤ì •ì„ ê°€ì ¸ì˜´
import dj_database_url
import os

DEBUG = False

# =============================================================================
# 1. Host & Database
# =============================================================================
ALLOWED_HOSTS = [
    'dagu.malchalab.com',                   # ìƒˆë¡œìš´ ì„œë¸Œë„ë©”ì¸ ì¶”ê°€
    'malcha-dagu-7939098a2a2e.herokuapp.com',
    '.malchalab.com',                       # malchalab.comì˜ ëª¨ë“  ì„œë¸Œë„ë©”ì¸ í—ˆìš©
]
# Heroku Postgres ì—°ê²°
DATABASES = {
    'default': dj_database_url.config(conn_max_age=600, ssl_require=True)
}

# =============================================================================
# 2. React Integration (í•µì‹¬)
# =============================================================================
# BASE_DIRì€ 'backend' í´ë”ì…ë‹ˆë‹¤.
# React ë¹Œë“œ í´ë”ëŠ” backendì™€ í˜•ì œ ìœ„ì¹˜ì¸ 'frontend/dist'ì— ìˆìŠµë‹ˆë‹¤.
FRONTEND_DIST = BASE_DIR.parent / 'frontend' / 'dist'

# (1) Template ê²½ë¡œ ì¶”ê°€: Djangoê°€ index.htmlì„ ì°¾ì„ ìˆ˜ ìˆê²Œ í•¨
TEMPLATES[0]['DIRS'] += [FRONTEND_DIST]

# (2) Static ê²½ë¡œ ì¶”ê°€: Djangoê°€ ë¦¬ì•¡íŠ¸ì˜ js, css, assetsë¥¼ ì°¾ì„ ìˆ˜ ìˆê²Œ í•¨
STATICFILES_DIRS += [
    FRONTEND_DIST,
]

# WhiteNoise ì„¤ì • (ì •ì  íŒŒì¼ ì••ì¶• ë° ì„œë¹™)
STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'


# =============================================================================
# 3. Security & SSL
# =============================================================================
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
SECURE_SSL_REDIRECT = True
SECURE_HSTS_SECONDS = 31536000
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True

# Session ë³´ì•ˆ
SESSION_COOKIE_SECURE = True
SESSION_COOKIE_HTTPONLY = True
SESSION_COOKIE_SAMESITE = 'Lax'  # ì™¸ë¶€ ë§í¬ì—ì„œë„ ì„¸ì…˜ ìœ ì§€

# CSRF ë³´ì•ˆ (JavaScriptì—ì„œ ì½ì„ ìˆ˜ ìˆì–´ì•¼ í•¨)
CSRF_COOKIE_SECURE = True
CSRF_COOKIE_HTTPONLY = False  # JSì—ì„œ ì½ì–´ì•¼ í•˜ë¯€ë¡œ False
CSRF_COOKIE_SAMESITE = 'Lax'

X_FRAME_OPTIONS = 'DENY'



# =============================================================================
# 4. Domain & CORS (Heroku í…ŒìŠ¤íŠ¸ìš© ìˆ˜ì •)
# =============================================================================

# [ì£¼ì˜] '.malchalab.com'ìœ¼ë¡œ ê³ ì •í•˜ë©´ í—¤ë¡œì¿  ì£¼ì†Œì—ì„œ ë¡œê·¸ì¸ì´ ì•ˆ ë©ë‹ˆë‹¤.
# í—¤ë¡œì¿  í…ŒìŠ¤íŠ¸ ì¤‘ì—ëŠ” ì£¼ì„ ì²˜ë¦¬í•˜ì—¬ í˜„ì¬ ë„ë©”ì¸(herokuapp.com)ì„ ë”°ë¥´ê²Œ í•©ë‹ˆë‹¤.
COOKIE_DOMAIN = '.malchalab.com'

SESSION_COOKIE_DOMAIN = '.malchalab.com'  # ì•ì— ì (.) í•„ìˆ˜!
CSRF_COOKIE_DOMAIN = '.malchalab.com'
SIMPLE_JWT['AUTH_COOKIE_DOMAIN'] = COOKIE_DOMAIN

# SIMPLE_JWT ì„¤ì • ì—…ë°ì´íŠ¸
# SIMPLE_JWT['AUTH_COOKIE_DOMAIN'] = COOKIE_DOMAIN <-- ì£¼ì„ ì²˜ë¦¬

SIMPLE_JWT['AUTH_COOKIE_SECURE'] = True
# SESSION_COOKIE_DOMAIN = COOKIE_DOMAIN <-- ì£¼ì„ ì²˜ë¦¬
# CSRF_COOKIE_DOMAIN = COOKIE_DOMAIN    <-- ì£¼ì„ ì²˜ë¦¬

# CORS í—ˆìš© ë„ë©”ì¸ (í—¤ë¡œì¿  ì£¼ì†Œ í¬í•¨)
CORS_ALLOWED_ORIGINS = [
    'https://malchalab.com',
    'https://dagu.malchalab.com',
    'https://malcha-dagu-7939098a2a2e.herokuapp.com', # ì´ê±° ê¼­ ìˆì–´ì•¼ 400 ì—ëŸ¬ ì•ˆ ë‚¨
]
CORS_ALLOW_CREDENTIALS = True
CSRF_TRUSTED_ORIGINS = CORS_ALLOWED_ORIGINS


# =============================================================================
# 5. Redis (Heroku)
# =============================================================================
REDIS_URL = env('REDIS_URL', default=None)

if REDIS_URL:
    CACHES = {
        'default': {
            'BACKEND': 'django_redis.cache.RedisCache',
            'LOCATION': REDIS_URL,
            'OPTIONS': {
                'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            }
        }
    }


# =============================================================================
# 6. Logging (Heroku)
# =============================================================================
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '[{levelname}] {asctime} {name} {module}.{funcName}: {message}',
            'style': '{',
        },
        'simple': {
            'format': '[{levelname}] {message}',
            'style': '{',
        },
    },
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
            'formatter': 'verbose',
        },
    },
    'root': {
        'handlers': ['console'],
        'level': 'INFO',
    },
    'loggers': {
        'django': {
            'handlers': ['console'],
            'level': 'INFO',
            'propagate': False,
        },
        'dagu': {
            'handlers': ['console'],
            'level': 'DEBUG',  # Dagu ì•±ì€ DEBUG ë ˆë²¨ë¡œ ìƒì„¸í•˜ê²Œ
            'propagate': False,
        },
    },
}
</file>

<file path="backend/dagu/services/search.py">
"""
Search Aggregator Service for MALCHA-DAGU.

Combines Naver Shopping API results with user-posted listings.
"""

from __future__ import annotations

import logging
from typing import Any

from django.db import models
from django.utils import timezone

from ..config import CategoryConfig
from ..filters import calculate_match_score, filter_user_item, filter_user_item_by_brand
from ..models import Instrument, UserItem, SearchMissLog
from .naver import NaverShoppingService
from .utils import (
    normalize_search_term,
    tokenize_query,
    expand_query_with_aliases,
    find_best_matching_instruments,
    extract_brand,
    normalize_brand,
    is_known_brand,
)

logger = logging.getLogger(__name__)


class SearchAggregatorService:
    """
    ë„¤ì´ë²„ ì‡¼í•‘ + DB ìœ ì € ë§¤ë¬¼ í†µí•© ê²€ìƒ‰ ì„œë¹„ìŠ¤.

    Flow:
        1. DBì—ì„œ ê²€ìƒ‰ì–´ì™€ ë§¤ì¹­ë˜ëŠ” Instrument ì°¾ê¸° (ìŠ¤ì½”ì–´ ê¸°ë°˜)
        2. ë§¤ì¹­ëœ ì•…ê¸° ì •ë³´ë¡œ ë„¤ì´ë²„ API ê²€ìƒ‰ ìµœì í™”
        3. ìœ ì € ë“±ë¡ ë§¤ë¬¼ ê²€ìƒ‰ (ë§¤ì¹­ëœ ì•…ê¸° ìš°ì„ )
        4. ê°€ê²©ìˆœ ë³‘í•© ì •ë ¬

    Usage:
        >>> service = SearchAggregatorService()
        >>> result = service.search("BOSS DS-1", display=20)
    """

    def __init__(self) -> None:
        self.naver_service = NaverShoppingService()

    def search(self, query: str, display: int = 20) -> dict[str, Any]:
        """
        í†µí•© ê²€ìƒ‰ ìˆ˜í–‰.

        Args:
            query: ê²€ìƒ‰ì–´
            display: ê²°ê³¼ ê°œìˆ˜

        Returns:
            {
                'query': str,
                'total_count': int,
                'reference': { ... },  # ì‹ í’ˆ ê¸°ì¤€ê°€ ì •ë³´
                'items': [ ... ],      # ê°€ê²©ìˆœ í†µí•© ê²°ê³¼
                'naver_items': [ ... ],
                'user_items': [ ... ],
            }
        """
        # ë¸Œëœë“œ/ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ (utils í†µí•© í•¨ìˆ˜ ì‚¬ìš©)
        brand = extract_brand(query)
        category = self._detect_category(query)


        # Step 1: DBì—ì„œ ë§¤ì¹­ ì•…ê¸° ì°¾ê¸°
        matching_instruments, best_match = self._find_matching_instruments(query)
        # Step 2: ë„¤ì´ë²„ ê²€ìƒ‰ (ìµœì í™”ëœ ì¿¼ë¦¬)
        search_query, brand, category = self._build_search_query(
            query, best_match, brand, category
        )
        logger.error(f"ì¿¼ë¦¬ëŠ”='{best_match[0]}', brand={brand}, category={category}")
        # ì‹ í’ˆ ê¸°ì¤€ê°€ ê°€ì ¸ì˜¤ê¸° (ê°€ê²© í•„í„°ë§ìš©)
        reference_price = None
        if best_match:
            reference_price = best_match[0].reference_price
        naver_items = self.naver_service.search(
            query=search_query,
            display=display,
            brand=brand,
            category=category,
            reference_price=reference_price,
        )


        # Step 3: ìœ ì € ë§¤ë¬¼ ê²€ìƒ‰ (ë™ì¼ í•„í„° ì ìš©)
        user_items, reference_info = self._search_user_items(
            query, matching_instruments, best_match, display, category
        )

        # Step 4: ê°€ê²©ìˆœ + ì—°ì¥ ìš°ì„ ìˆœìœ„ ë³‘í•©
        all_items = naver_items + user_items
        # ì •ë ¬: 1) ê°€ê²© ì˜¤ë¦„ì°¨ìˆœ, 2) ì—°ì¥ëœ ë§¤ë¬¼ ìš°ì„  (extended_at ìˆìœ¼ë©´ 0, ì—†ìœ¼ë©´ 1)
        all_items.sort(key=lambda x: (
            x.get('lprice', 0),
            0 if x.get('extended_at') else 1
        ))

        logger.error(
            f"ê²€ìƒ‰ ì™„ë£Œ: ë„¤ì´ë²„({len(naver_items)}) + "
            f"ìœ ì €({len(user_items)}) = ì´({len(all_items)})"
        )

        # ë§¤ì¹­ëœ ì•…ê¸° ì •ë³´ (ë§¤ë¬¼ ë“±ë¡ìš©)
        matched_instrument = None
        if best_match:
            inst = best_match[0]
            matched_instrument = {
                'id': str(inst.id),
                'name': inst.name,
                'brand': inst.brand,
                'category': inst.category,
            }
        else:
            # DB ë¯¸ë§¤ì¹­ ê²€ìƒ‰ì–´ ë¡œê¹… (ìì£¼ ê²€ìƒ‰ë˜ì§€ë§Œ DBì— ì—†ëŠ” ì•…ê¸° ì¶”ì )
            SearchMissLog.log_miss(query)

        return {
            'query': query,
            'search_query': search_query,  # ì •ê·œí™”ëœ ê²€ìƒ‰ì–´ (ì™¸ë¶€ ë§í¬ìš©)
            'total_count': len(all_items),
            'reference': reference_info,
            'matched_instrument': matched_instrument,  # ë§¤ë¬¼ ë“±ë¡ìš© ì•…ê¸° ì •ë³´
            'items': all_items,
            'naver_items': naver_items,
            'user_items': user_items,
        }

    def search_with_cache(self, query: str, display: int, cache, cache_ttl: int) -> dict[str, Any]:
        """
        ë„¤ì´ë²„ ê²°ê³¼ë§Œ ìºì‹±í•˜ê³  ìœ ì € ë§¤ë¬¼ì€ ì‹¤ì‹œê°„ ì¡°íšŒí•˜ëŠ” ê²€ìƒ‰.
        
        Args:
            query: ê²€ìƒ‰ì–´
            display: ê²°ê³¼ ê°œìˆ˜
            cache: Django cache instance
            cache_ttl: ìºì‹œ TTL (ì´ˆ)
        
        Returns:
            search() ë©”ì„œë“œì™€ ë™ì¼í•œ í˜•ì‹
        """
        # ë¸Œëœë“œ/ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ
        brand = extract_brand(query)
        category = self._detect_category(query)

        # Step 1: DBì—ì„œ ë§¤ì¹­ ì•…ê¸° ì°¾ê¸°
        matching_instruments, best_match = self._find_matching_instruments(query)
        
        # Step 2: ë„¤ì´ë²„ ê²€ìƒ‰ìš© ì¿¼ë¦¬ ìƒì„±
        search_query, brand, category = self._build_search_query(
            query, best_match, brand, category
        )
        logger.error(f"ì¿¼ë¦¬ëŠ”='{best_match[0] if best_match else query}', brand={brand}, category={category}")
        
        # ì‹ í’ˆ ê¸°ì¤€ê°€
        reference_price = best_match[0].reference_price if best_match else None
        
        # Step 3: ë„¤ì´ë²„ ê²°ê³¼ ì¡°íšŒ (ìºì‹± ì ìš©)
        naver_cache_key = f"naver:{search_query.lower()}:{display}:{brand or ''}:{category or ''}"
        naver_items = cache.get(naver_cache_key)
        
        if naver_items is None:
            # ìºì‹œ ë¯¸ìŠ¤: ë„¤ì´ë²„ API í˜¸ì¶œ
            naver_items = self.naver_service.search(
                query=search_query,
                display=display,
                brand=brand,
                category=category,
                reference_price=reference_price,
            )
            cache.set(naver_cache_key, naver_items, cache_ttl)
            logger.debug(f"[Naver Cache SET] {naver_cache_key} (TTL: {cache_ttl}s)")
        else:
            logger.debug(f"[Naver Cache HIT] {naver_cache_key}")

        # Step 4: ìœ ì € ë§¤ë¬¼ ì‹¤ì‹œê°„ ì¡°íšŒ (ìºì‹± ì—†ìŒ)
        user_items, reference_info = self._search_user_items(
            query, matching_instruments, best_match, display, category
        )

        # Step 5: ê°€ê²©ìˆœ + ì—°ì¥ ìš°ì„ ìˆœìœ„ ë³‘í•©
        all_items = naver_items + user_items
        all_items.sort(key=lambda x: (
            x.get('lprice', 0),
            0 if x.get('extended_at') else 1
        ))

        logger.info(
            f"ê²€ìƒ‰ ì™„ë£Œ: ë„¤ì´ë²„({len(naver_items)}) + "
            f"ìœ ì €({len(user_items)}) = ì´({len(all_items)})"
        )

        # ë§¤ì¹­ëœ ì•…ê¸° ì •ë³´ (ë§¤ë¬¼ ë“±ë¡ìš©)
        matched_instrument = None
        if best_match:
            inst = best_match[0]
            matched_instrument = {
                'id': str(inst.id),
                'name': inst.name,
                'brand': inst.brand,
                'category': inst.category,
            }
        else:
            # DB ë¯¸ë§¤ì¹­ ê²€ìƒ‰ì–´ ë¡œê¹…
            SearchMissLog.log_miss(query)

        return {
            'query': query,
            'search_query': search_query,
            'total_count': len(all_items),
            'reference': reference_info,
            'matched_instrument': matched_instrument,
            'items': all_items,
            'naver_items': naver_items,
            'user_items': user_items,
        }

    def _detect_category(self, query: str) -> str | None:
        """
        ê²€ìƒ‰ì–´ì—ì„œ ì¹´í…Œê³ ë¦¬ ì¶”ë¡ .
        
        Returns:
            ì¹´í…Œê³ ë¦¬ ë¬¸ìì—´ ë˜ëŠ” None (í™•ì‹  ì—†ìŒ)
        """
        query_lower = query.lower()

        bass_keywords = getattr(CategoryConfig, 'BASS_KEYWORDS', [])
        pedal_keywords = getattr(CategoryConfig, 'PEDAL_KEYWORDS', [])
        amp_keywords = getattr(CategoryConfig, 'AMP_KEYWORDS', [])
        acoustic_keywords = getattr(CategoryConfig, 'ACOUSTIC_KEYWORDS', [])
        mic_keywords = getattr(CategoryConfig, 'MIC_KEYWORDS', [])

        if any(kw in query_lower for kw in bass_keywords):
            return 'bass'
        if any(kw in query_lower for kw in pedal_keywords):
            return 'effect'  # DB: 'effect' = ì´í™í„°
        if any(kw in query_lower for kw in amp_keywords):
            return 'amp'
        if any(kw in query_lower for kw in acoustic_keywords):
            return 'acoustic'
        if any(kw in query_lower for kw in mic_keywords):
            return 'mic'

        # í™•ì‹ í•  ìˆ˜ ì—†ìœ¼ë©´ None ë°˜í™˜ (DB ì¹´í…Œê³ ë¦¬ ìš°ì„  ì‚¬ìš©í•˜ë„ë¡)
        return None

    def _find_matching_instruments(
        self,
        query: str,
    ) -> tuple[list[Instrument], tuple[Instrument, float] | None]:
        """
        DBì—ì„œ ë§¤ì¹­ ì•…ê¸° ì°¾ê¸° (ìŠ¤ë§ˆíŠ¸ ë§¤ì¹­).

        Returns:
            (matching_instruments, best_match)
        """
        query_tokens = tokenize_query(query)
        expanded_queries = expand_query_with_aliases(query)

        # ë¸Œëœë“œ ì •ê·œí™” (íœë” â†’ fender)
        normalized_query = normalize_brand(query)
        brand = extract_brand(query)

        # í›„ë³´ í•„í„° êµ¬ì„±
        candidate_filter = models.Q()

        # ì›ë³¸ í† í°ìœ¼ë¡œ ê²€ìƒ‰
        for token in query_tokens:
            candidate_filter |= models.Q(name__icontains=token)
            candidate_filter |= models.Q(brand__icontains=token)

        # ë³„ì¹­ í™•ì¥ìœ¼ë¡œ ê²€ìƒ‰ (ìŠ¤íŠ¸ë« â†’ Stratocaster)
        for expanded in expanded_queries:
            candidate_filter |= models.Q(name__icontains=expanded)
            candidate_filter |= models.Q(brand__icontains=expanded)
            for token in expanded.split():
                if len(token) > 1:
                    candidate_filter |= models.Q(name__icontains=token)

        # ë¸Œëœë“œë¡œ ì§ì ‘ ê²€ìƒ‰ (íœë” â†’ fender ë³€í™˜ë¨)
        if brand:
            candidate_filter |= models.Q(brand__iexact=brand)
            candidate_filter |= models.Q(brand__icontains=brand)

        query_lower = query.lower().strip()
        candidate_filter |= models.Q(name__icontains=query_lower)
        candidate_filter |= models.Q(brand__icontains=query_lower)

        logger.debug(f"ë³„ì¹­ í™•ì¥: {query} -> {expanded_queries}")

        # í›„ë³´ ì¡°íšŒ (Unknown ë¸Œëœë“œ ì œì™¸)
        candidates = Instrument.objects.filter(
            candidate_filter
        ).exclude(
            brand__iexact='unknown'
        )[:50]

        logger.debug(f"í›„ë³´ ì•…ê¸° {candidates.count()}ê°œ ì¡°íšŒë¨")

        # ìŠ¤ì½”ì–´ë§ ê¸°ë°˜ ë§¤ì¹­
        scored_matches = find_best_matching_instruments(
            query=query,
            instruments_qs=candidates,
            min_score=0.3,
        )

        matching_instruments = [inst for inst, _ in scored_matches[:10]]
        best_match = scored_matches[0] if scored_matches else None

        if best_match:
            logger.info(
                f"[DB ë§¤ì¹­] '{query}' -> "
                f"'{best_match[0].brand} {best_match[0].name}' "
                f"(score={best_match[1]:.2f})"
            )

        return matching_instruments, best_match

    def _build_search_query(
        self,
        original_query: str,
        best_match: tuple[Instrument, float] | None,
        brand: str | None,
        detected_category: str | None,
    ) -> tuple[str, str | None, str | None]:
        """
        ë„¤ì´ë²„ ê²€ìƒ‰ìš© ìµœì í™”ëœ ì¿¼ë¦¬ ìƒì„±.

        Args:
            detected_category: ê²€ìƒ‰ì–´ì—ì„œ ê°ì§€ëœ ì¹´í…Œê³ ë¦¬ (None = í™•ì‹  ì—†ìŒ)

        Returns:
            (search_query, brand, category)
        """
        search_query = original_query
        category = detected_category  # ê²€ìƒ‰ì–´ ê¸°ë°˜ ì¹´í…Œê³ ë¦¬ (Noneì¼ ìˆ˜ ìˆìŒ)

        # ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë¸Œëœë“œ ì¶”ì¶œ (ìˆìœ¼ë©´ ì¡´ì¤‘)
        user_brand = extract_brand(original_query)

        if best_match and best_match[1] >= 0.5:
            instrument = best_match[0]

            # ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë¸Œëœë“œì™€ DB ë¸Œëœë“œê°€ ë‹¤ë¥´ë©´ â†’ ì‚¬ìš©ì ë¸Œëœë“œ ì¡´ì¤‘
            if user_brand and user_brand.lower() != instrument.brand.lower():
                # [Fix] ì‚¬ìš©ì ë¸Œëœë“œê°€ ì´ë¯¸ ëª¨ë¸ëª…ì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´, ë¸Œëœë“œê°€ ì•„ë‹ˆë¼ ëª¨ë¸ëª…ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŒ
                # ì˜ˆ: "sm57" ê²€ìƒ‰ -> brand='sm57' (ì˜¤íƒ), name='sm57' -> ì´ ê²½ìš° DB ë¸Œëœë“œ 'Shure'ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨
                if user_brand.lower() in instrument.name.lower():
                    search_query = f"{instrument.brand} {instrument.name}"
                    brand = instrument.brand.lower() if instrument.brand else brand
                    logger.info(f"[ì˜¤íƒ ë³´ì •] '{user_brand}'ëŠ” ëª¨ë¸ëª…ì„ -> DB ë¸Œëœë“œ '{brand}' ì‚¬ìš©")
                else:
                    # ì§„ì§œ ë‹¤ë¥¸ ë¸Œëœë“œì¸ ê²½ìš° (ì˜ˆ: Squier vs Fender)
                    search_query = f"{user_brand} {instrument.name}"
                    brand = user_brand.lower()
                    logger.info(f"[ì¿¼ë¦¬ ë³€í™˜] '{original_query}' -> '{search_query}' (ì‚¬ìš©ì ë¸Œëœë“œ ìœ ì§€)")
            else:
                search_query = f"{instrument.brand} {instrument.name}"
                brand = instrument.brand.lower() if instrument.brand else brand
                logger.info(f"[ì¿¼ë¦¬ ë³€í™˜] '{original_query}' -> '{search_query}'")

            # ì¹´í…Œê³ ë¦¬ ê²°ì •: DB ì •ë³´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ê²€ìƒ‰ì–´ ê°ì§€ ê²°ê³¼ ì‚¬ìš©
            if instrument.category:
                # 1ìˆœìœ„: DB Instrument ì¹´í…Œê³ ë¦¬ (ê°€ì¥ ì‹ ë¢°)
                category = instrument.category
                logger.info(f"[ì¹´í…Œê³ ë¦¬] DB ê¸°ë°˜: {category}")
            elif detected_category is not None:
                # 2ìˆœìœ„: ê²€ìƒ‰ì–´ì—ì„œ ê°ì§€ëœ ì¹´í…Œê³ ë¦¬
                category = detected_category
                logger.debug(f"[ì¹´í…Œê³ ë¦¬] ê²€ìƒ‰ì–´ ê¸°ë°˜: {category} (DB ì •ë³´ ì—†ìŒ)")
        else:
            # í•œê¸€ ë¸Œëœë“œ -> ì˜ë¬¸ ì¹˜í™˜
            search_query = normalize_brand(original_query)

            # ëª¨ë¸ëª… ë³„ì¹­ë„ í™•ì¥ (ìŠ¤íŠ¸ë« -> Stratocaster ë“±)
            tokens = search_query.split()
            expanded_tokens = []
            for token in tokens:
                expanded = expand_query_with_aliases(token)
                alias = next((e for e in expanded if e.lower() != token.lower()), None)
                expanded_tokens.append(alias if alias else token)
            search_query = ' '.join(expanded_tokens)
            logger.info(f"[ì¿¼ë¦¬ í™•ì¥] '{original_query}' -> '{search_query}'")

        logger.info(f"ê²€ìƒ‰ ì‹œì‘: '{search_query}' (ë¸Œëœë“œ: {brand}, ì¹´í…Œê³ ë¦¬: {category})")

        return search_query, brand, category

    def _search_user_items(
        self,
        query: str,
        matching_instruments: list[Instrument],
        best_match: tuple[Instrument, float] | None,
        display: int,
        category: str = None,
    ) -> tuple[list[dict], dict | None]:
        """
        ìœ ì € ë§¤ë¬¼ ê²€ìƒ‰.

        Returns:
            (user_items, reference_info)
        """
        now = timezone.now()

        # 1. ì¿¼ë¦¬ë¥¼ í† í°ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ AND ì¡°ê±´ìœ¼ë¡œ ê²€ìƒ‰
        # ëª¨ë“  í† í°ì´ title/brand/name ì¤‘ í•˜ë‚˜ì— í¬í•¨ë˜ì–´ì•¼ ê²°ê³¼ì— í¬í•¨
        query_tokens = [t.lower() for t in query.split() if len(t) > 1]
        
        if query_tokens:
            # AND ê¸°ë°˜ í•„í„° êµ¬ì„±
            q_filter = models.Q()
            for i, token in enumerate(query_tokens):
                token_condition = (
                    models.Q(title__icontains=token) |
                    models.Q(instrument__name__icontains=token) |
                    models.Q(instrument__brand__icontains=token)
                )
                if i == 0:
                    q_filter = token_condition
                else:
                    q_filter &= token_condition  # AND ê²°í•©
        else:
            # í† í°ì´ ì—†ìœ¼ë©´ ì „ì²´ queryë¡œ ê²€ìƒ‰
            q_filter = models.Q(instrument__name__icontains=query) | \
                       models.Q(instrument__brand__icontains=query) | \
                       models.Q(title__icontains=query)

        # best_matchê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì•…ê¸°ì˜ ë§¤ë¬¼ë„ ì¶”ê°€ (ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì•…ê¸°ë§Œ)
        if best_match and best_match[1] >= 0.8:  # ì ìˆ˜ 0.8 ì´ìƒë§Œ
            q_filter |= models.Q(instrument=best_match[0])

        # ë¶€ëª¨-ìì‹ ê³„ì¸µí˜• ê²€ìƒ‰: best_matchê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì•…ê¸°ì˜ ìì‹ë“¤ë„ í¬í•¨
        if best_match and best_match[1] >= 0.8:
            parent_instrument = best_match[0]
            descendants = parent_instrument.get_all_descendants()
            if descendants:
                q_filter |= models.Q(instrument__in=descendants)
                logger.info(
                    f"[ê³„ì¸µí˜• ê²€ìƒ‰] '{parent_instrument}' í•˜ìœ„ ì•…ê¸° {len(descendants)}ê°œ í¬í•¨"
                )

        logger.info(f"UserItem search filter: {q_filter}")

        user_items_qs = UserItem.objects.filter(
            q_filter,
            # is_active=True,         # ìœ ì € ìš”ì²­ìœ¼ë¡œ í™œì„± ì²´í¬ í•´ì œ
            # is_under_review=False,  # ìœ ì € ìš”ì²­ìœ¼ë¡œ ê²€í†  ì²´í¬ í•´ì œ
            # expired_at__gt=now,     # ë§Œë£Œ ì²´í¬ í•´ì œ
        ).select_related('instrument')[:display * 2]
        
        logger.info(f"Found {user_items_qs.count()} user items")

        # ë”•ì…”ë„ˆë¦¬ ë³€í™˜ + í•„í„°ë§ ì œê±° (ìœ ì € ë§¤ë¬¼ì€ í•„í„°ë§í•˜ì§€ ì•ŠìŒ)
        user_items = []
        reference_info = None

        for item in user_items_qs:
            title = item.title or str(item.instrument)

            # [í•„í„° 1] ë¸Œëœë“œ í•„í„°ë§ - ê²€ìƒ‰ ë¸Œëœë“œì™€ ë§¤ë¬¼ ë¸Œëœë“œ ë¶ˆì¼ì¹˜ ì‹œ ì œì™¸
            if not filter_user_item_by_brand(query, item.instrument.brand):
                continue

            if len(user_items) >= display:
                break

            user_items.append({
                'id': str(item.id),
                'title': title,
                'link': item.link,
                'image': item.instrument.image_url,
                'lprice': item.price,
                'source': item.source,
                'source_display': item.get_source_display(),
                'discount_rate': item.discount_rate,
                'instrument_id': str(item.instrument.id),
                'instrument_name': item.instrument.name,
                'instrument_brand': item.instrument.brand,
                'score': calculate_match_score(query, title, item.instrument.image_url),
                'extended_at': item.extended_at.isoformat() if item.extended_at else None,
                'report_count': item.report_count,
            })

            # ì‹ í’ˆ ê¸°ì¤€ê°€ ì •ë³´ (ì²« ë²ˆì§¸ ë§¤ë¬¼ ê¸°ì¤€)
            if reference_info is None and item.instrument.reference_price > 0:
                reference_info = {
                    'name': str(item.instrument),
                    'price': item.instrument.reference_price,
                    'image_url': item.instrument.image_url,
                }

        # ê¸°ì¤€ê°€ ë³´ì™„ (best_match ë˜ëŠ” DB ê²€ìƒ‰)
        reference_info = self._get_reference_info(
            reference_info, best_match, query
        )

        return user_items, reference_info

    def _get_reference_info(
        self,
        existing_ref: dict | None,
        best_match: tuple[Instrument, float] | None,
        query: str,
    ) -> dict | None:
        """ì‹ í’ˆ ê¸°ì¤€ê°€ ì •ë³´ ì¡°íšŒ"""
        if existing_ref:
            return existing_ref

        # best_match ìš°ì„ 
        if best_match:
            instrument = best_match[0]
            if instrument.reference_price > 0:
                return {
                    'name': str(instrument),
                    'price': instrument.reference_price,
                    'image_url': instrument.image_url,
                }

        # DB ê²€ìƒ‰ fallback
        instrument = Instrument.objects.filter(
            models.Q(name__icontains=query) |
            models.Q(brand__icontains=query)
        ).first()

        if instrument and instrument.reference_price > 0:
            return {
                'name': str(instrument),
                'price': instrument.reference_price,
                'image_url': instrument.image_url,
            }

        return None
</file>

<file path="frontend/src/components/ItemCard.tsx">
/**
 * Item Card Component
 *
 * Features:
 * - ê°€ê²© ë° í• ì¸ìœ¨ í‘œì‹œ
 * - ì¶œì²˜ ë±ƒì§€
 * - Layout ì• ë‹ˆë©”ì´ì…˜ (ìˆœìœ„ ë³€ê²½ ì‹œ)
 * - í´ë¦­ ì‹œ ë§í¬ ì´ë™
 * - ì‹ ê³ í•˜ê¸° / ê°€ê²© ì—…ë°ì´íŠ¸ ë²„íŠ¼ (ìœ ì € ë§¤ë¬¼ë§Œ)
 */

import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import type { NaverItem, MergedUserItem, ReportReason } from '../types';
import { REPORT_REASON_LABELS } from '../types';

interface ItemCardProps {
    item: NaverItem | MergedUserItem;
    rank?: number;
    referencePrice?: number;
    onClick?: () => void;
    isOwner?: boolean;
    isLoggedIn?: boolean;
    onExtend?: () => void;
    onReport?: (reason: ReportReason, detail?: string) => void;
    onUpdatePrice?: (newPrice: number) => void;
    onClickDelete?: () => void;
}

// ì¶œì²˜ë³„ ìŠ¤íƒ€ì¼
const SOURCE_STYLES: Record<string, { bg: string; text: string; label: string }> = {
    naver: { bg: 'bg-green-100', text: 'text-green-700', label: 'ë„¤ì´ë²„' },
    mule: { bg: 'bg-blue-100', text: 'text-blue-700', label: 'ë®¬' },
    bunjang: { bg: 'bg-red-100', text: 'text-red-700', label: 'ë²ˆê°œì¥í„°' },
    joonggonara: { bg: 'bg-green-100', text: 'text-green-700', label: 'ì¤‘ê³ ë‚˜ë¼' },
    danggn: { bg: 'bg-orange-100', text: 'text-orange-700', label: 'ë‹¹ê·¼' },
    other: { bg: 'bg-stone-100', text: 'text-stone-700', label: 'ê¸°íƒ€' },
};

function formatPrice(price: number): string {
    return new Intl.NumberFormat('ko-KR').format(price);
}

function calculateDiscount(price: number, referencePrice: number): number {
    if (referencePrice <= 0) return 0;
    return Math.round((1 - price / referencePrice) * 100);
}

function isValidUrl(url: string): boolean {
    /**
     * URL í”„ë¡œí† ì½œ ê²€ì¦ (XSS ë°©ì§€)
     * javascript:, data:, vbscript: ë“± ìœ„í—˜í•œ í”„ë¡œí† ì½œ ì°¨ë‹¨
     */
    try {
        const parsed = new URL(url);
        return ['http:', 'https:'].includes(parsed.protocol);
    } catch {
        return false;
    }
}

// ê¸°íƒ€ í”¼í¬ ìˆœìœ„ ì•„ì´ì½˜
function PickIcon({ rank }: { rank: number }) {
    const colors = {
        1: { fill: '#FFD700', stroke: '#B8860B', text: '#8B4513' }, // ê³¨ë“œ
        2: { fill: '#C0C0C0', stroke: '#808080', text: '#404040' }, // ì‹¤ë²„
        3: { fill: '#CD7F32', stroke: '#8B4513', text: '#FFFFFF' }, // ë¸Œë¡ ì¦ˆ
    };
    const color = colors[rank as 1 | 2 | 3] || colors[3];

    return (
        <svg viewBox="0 0 100 100" className="w-8 h-8 drop-shadow-md">
            {/* í”¼í¬ ëª¸í†µ */}
            <path
                d="M 50 98 C 85 80, 95 30, 85 15 C 75 5, 25 5, 15 15 C 5 30, 15 80, 50 98 Z"
                fill={color.fill}
                stroke={color.stroke}
                strokeWidth="3"
            />
            {/* ìˆœìœ„ ìˆ«ì */}
            <text
                x="50"
                y="55"
                textAnchor="middle"
                fill={color.text}
                fontSize="32"
                fontWeight="bold"
                fontFamily="system-ui, sans-serif"
            >
                {rank}
            </text>
        </svg>
    );
}

export default function ItemCard({
    item,
    rank,
    referencePrice,
    onClick,
    isOwner,
    isLoggedIn,
    onExtend,
    onReport,
    onUpdatePrice,
    onClickDelete,
}: ItemCardProps) {
    const [showReportModal, setShowReportModal] = useState(false);
    const [showPriceModal, setShowPriceModal] = useState(false);
    const [reportReason, setReportReason] = useState<ReportReason>('wrong_price');
    const [newPrice, setNewPrice] = useState(item.lprice.toString());

    const source = item.source || 'other';
    const sourceStyle = SOURCE_STYLES[source] || SOURCE_STYLES.other;
    const mallName = 'mallName' in item ? item.mallName : ('source_display' in item ? item.source_display : '');

    // ìœ ì € ë§¤ë¬¼ì¸ì§€ í™•ì¸ (id í•„ë“œ ì¡´ì¬ ì—¬ë¶€ë¡œ íŒë‹¨)
    const isUserItem = 'id' in item && source !== 'naver';

    // í• ì¸ìœ¨ ê³„ì‚°
    const discount = 'discount_rate' in item
        ? item.discount_rate
        : referencePrice
            ? calculateDiscount(item.lprice, referencePrice)
            : 0;

    // ì´ë¯¸ì§€ URL
    const imageUrl = 'image' in item ? item.image : '';

    const handleExtend = (e: React.MouseEvent) => {
        e.stopPropagation();
        onExtend?.();
    };

    const handleReportClick = (e: React.MouseEvent) => {
        e.stopPropagation();
        // ë¡œê·¸ì¸ ì—†ì´ë„ ì‹ ê³  ê°€ëŠ¥ (ì„¸ì…˜ ê¸°ë°˜)
        setShowReportModal(true);
    };

    const handleReportSubmit = () => {
        onReport?.(reportReason);
        setShowReportModal(false);
    };

    const handlePriceClick = (e: React.MouseEvent) => {
        e.stopPropagation();
        if (!isLoggedIn) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }
        setNewPrice(item.lprice.toString());
        setShowPriceModal(true);
    };

    const handlePriceSubmit = () => {
        const price = parseInt(newPrice.replace(/,/g, ''), 10);
        if (isNaN(price) || price <= 0) {
            alert('ìœ íš¨í•œ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        onUpdatePrice?.(price);
        setShowPriceModal(false);
    };

    return (
        <>
            <motion.div
                layout
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -20 }}
                whileHover={{ scale: 1.02, y: -4 }}
                whileTap={{ scale: 0.98 }}
                onClick={() => { }} // Remove handler, use Link overlay
                className="
                    relative flex flex-col p-0 bg-white rounded-2xl sm:rounded-[32px]
                    transition-all duration-300
                    hover:-translate-y-2
                    shadow-[0_10px_40px_-10px_rgba(0,0,0,0.08)]
                    hover:shadow-[0_20px_50px_-12px_rgba(0,0,0,0.12)]
                    group h-full
                "
            >
                {/* 
                  [SEO & Security] 
                  ì§ì ‘ì ì¸ <a> íƒœê·¸ ì‚¬ìš© (ë„¤ì´ë²„ ë³´ì•ˆ ì •ì±…/ëª¨ë°”ì¼ ì´ìŠˆ í•´ê²°)
                  referrerPolicy="no-referrer-when-downgrade" ì¶”ê°€
                  XSS ë°©ì§€: http/https í”„ë¡œí† ì½œë§Œ í—ˆìš©
                */}
                {isValidUrl(item.link) ? (
                    <a
                        href={item.link}
                        target="_blank"
                        rel="noopener noreferrer"
                        referrerPolicy="no-referrer-when-downgrade"
                        className="absolute inset-0 z-10 rounded-2xl sm:rounded-[32px]"
                        aria-label="ìƒí’ˆ í˜ì´ì§€ë¡œ ì´ë™"
                        onClick={onClick}
                    />
                ) : (
                    <div
                        className="absolute inset-0 z-10 rounded-2xl sm:rounded-[32px] cursor-not-allowed"
                        title="ì˜ëª»ëœ ë§í¬ì…ë‹ˆë‹¤"
                    />
                )}

                {/* ì´ë¯¸ì§€ (Top Half Cover) */}
                <div className="w-full h-36 sm:h-56 relative overflow-hidden bg-stone-50 rounded-t-2xl sm:rounded-t-[32px]">
                    {imageUrl ? (
                        <img
                            src={imageUrl}
                            alt={item.title}
                            className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                            loading="lazy"
                            onError={(e) => {
                                (e.target as HTMLImageElement).src = 'https://via.placeholder.com/300x200?text=No+Image';
                            }}
                        />
                    ) : (
                        <div className={`
                            w-full h-full flex flex-col items-center justify-center relative overflow-hidden 
                            transition-colors duration-300
                            ${source === 'mule' ? 'bg-blue-50 group-hover:bg-blue-100' :
                                source === 'bunjang' ? 'bg-red-50 group-hover:bg-red-100' :
                                    source === 'danggn' ? 'bg-orange-50 group-hover:bg-orange-100' :
                                        source === 'joonggonara' ? 'bg-green-50 group-hover:bg-green-100' :
                                            'bg-stone-50 group-hover:bg-stone-100'}
                        `}>
                            {/* ë°°ê²½ ë°ì½”ë ˆì´ì…˜ */}
                            <div className="absolute inset-0 opacity-10 bg-[radial-gradient(circle_at_50%_120%,currentColor_0%,transparent_50%)]" />

                            {/* í…ìŠ¤íŠ¸ (ì†ŒìŠ¤ë³„ ì˜ì–´ ì´ë¦„) */}
                            <div className={`
                                text-4xl sm:text-5xl font-black tracking-tighter z-10 select-none
                                ${source === 'mule' ? 'text-blue-200' :
                                    source === 'bunjang' ? 'text-red-200' :
                                        source === 'danggn' ? 'text-orange-200' :
                                            source === 'joonggonara' ? 'text-green-200' :
                                                'text-stone-200'}
                            `}>
                                {source === 'mule' ? 'MULE' :
                                    source === 'bunjang' ? 'BUNJANG' :
                                        source === 'danggn' ? 'DAANGN' :
                                            source === 'joonggonara' ? 'NAVER' :
                                                'GUITAR'}
                            </div>
                        </div>
                    )}
                    {/* ì¶œì²˜ ë±ƒì§€ (Overlay) */}
                    <span
                        className={`
                            absolute top-4 left-4 px-3 py-1.5 rounded-full text-xs font-bold tracking-wide shadow-sm
                            backdrop-blur-md bg-white/90 ${sourceStyle.text}
                        `}
                    >
                        {sourceStyle.label}
                    </span>

                    {/* ìˆœìœ„ (Overlay) */}
                    {rank && rank <= 3 && (
                        <div className="absolute top-4 right-4 z-10 drop-shadow-md">
                            <PickIcon rank={rank} />
                        </div>
                    )}
                </div>

                {/* ì •ë³´ (Padding) */}
                <div className="flex-1 flex flex-col p-3 sm:p-6">
                    {/* ìƒë‹¨: ì œëª© */}
                    <div className="mb-2 sm:mb-4">
                        <h3 className="text-sm sm:text-lg font-bold text-stone-800 line-clamp-2 leading-snug group-hover:text-matcha-700 transition-colors">
                            {item.title}
                        </h3>
                    </div>

                    {/* í•˜ë‹¨: ê°€ê²© + í• ì¸ìœ¨ */}
                    <div className="flex items-end justify-between mt-auto">
                        <div>
                            <div className="flex items-baseline gap-1">
                                <p className="text-lg sm:text-3xl font-black text-stone-900 tracking-tight">
                                    {formatPrice(item.lprice)}<span className="text-xs sm:text-base font-bold text-stone-400 ml-0.5 sm:ml-1">ì›</span>
                                </p>
                            </div>

                            {discount > 0 && (
                                <p className="text-xs text-stone-500 mt-0.5">
                                    ì‹ í’ˆ ëŒ€ë¹„ <span className="text-matcha-600 font-bold">{discount}%</span> ì €ë ´
                                </p>
                            )}
                            {/* ì¶œì²˜ & íŒë§¤ì²˜ & ë°°ì†¡ì •ë³´ */}
                            <div className="flex items-center gap-2 mb-1 flex-wrap">
                                <span className={`px-2 py-0.5 rounded text-[11px] font-medium ${sourceStyle.bg} ${sourceStyle.text}`}>
                                    {sourceStyle.label}
                                </span>
                                {/* íŒë§¤ì²˜ (ë„¤ì´ë²„ë§Œ í‘œì‹œ) */}
                                {source === 'naver' && mallName && (
                                    <span className="text-xs text-stone-500 font-medium">
                                        {mallName}
                                    </span>
                                )}
                                {/* ë¬´ë£Œë°°ì†¡ ë°°ì§€ (ë„¤ì´ë²„ ì•„ì´í…œì— ì„ì˜ ì ìš© or ì¡°ê±´ë¶€) */}
                                {source === 'naver' && (
                                    <span className="px-1.5 py-0.5 rounded bg-stone-100 text-stone-500 text-[10px]">
                                        ë¬´ë£Œë°°ì†¡
                                    </span>
                                )}
                            </div>

                            {/* ê°€ê²© disclaimer (ë„¤ì´ë²„ ì•„ì´í…œë§Œ) */}
                            {source === 'naver' && (
                                <p className="text-[10px] text-stone-400 mt-0.5">
                                    * ê°€ê²©ì´ ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                                </p>
                            )}
                        </div>

                        {/* ë²„íŠ¼ë“¤ - z-20ìœ¼ë¡œ ë§í¬ ìœ„ì— ë°°ì¹˜ */}
                        <div className="relative z-20 flex items-center gap-2">
                            {/* ì—°ì¥ ë²„íŠ¼ (ë³¸ì¸ ë§¤ë¬¼ë§Œ) */}
                            {isOwner && (
                                <button
                                    onClick={handleExtend}
                                    className="px-3 py-1.5 rounded-full bg-matcha-100 text-matcha-700 text-xs font-semibold hover:bg-matcha-200 transition-colors"
                                >
                                    ì—°ì¥
                                </button>
                            )}

                            {/* ìœ ì € ë§¤ë¬¼: ê°€ê²© ì—…ë°ì´íŠ¸ ë²„íŠ¼ (íŒŒë€ìƒ‰) */}
                            {isUserItem && !isOwner && onUpdatePrice && (
                                <button
                                    onClick={handlePriceClick}
                                    className="w-8 h-8 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center hover:bg-blue-200 transition-colors"
                                    title="ê°€ê²© ì—…ë°ì´íŠ¸"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                            )}

                            {/* ìœ ì € ë§¤ë¬¼: ì‹ ê³  ë²„íŠ¼ (ì£¼í™©ìƒ‰) */}
                            {isUserItem && !isOwner && onReport && (
                                <button
                                    onClick={handleReportClick}
                                    className="w-8 h-8 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center hover:bg-orange-200 transition-colors"
                                    title="ì‹ ê³ í•˜ê¸°"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                </button>
                            )}

                            {/* ë³¸ì¸ ë§¤ë¬¼: ì‚­ì œ ë²„íŠ¼ (ë¹¨ê°„ìƒ‰) */}
                            {isOwner && onClickDelete && (
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        onClickDelete();
                                    }}
                                    className="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center hover:bg-red-200 transition-colors"
                                    title="ì‚­ì œí•˜ê¸°"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            )}

                            {/* í™”ì‚´í‘œ ì•„ì´ì½˜ */}
                            <div className="w-8 h-8 rounded-full bg-stone-50 flex items-center justify-center text-stone-400 group-hover:bg-matcha-50 group-hover:text-matcha-600 transition-colors">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 5l7 7-7 7" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </motion.div>

            {/* ì‹ ê³  ëª¨ë‹¬ */}
            <AnimatePresence>
                {showReportModal && (
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
                        onClick={() => setShowReportModal(false)}
                    >
                        <motion.div
                            initial={{ scale: 0.9, opacity: 0 }}
                            animate={{ scale: 1, opacity: 1 }}
                            exit={{ scale: 0.9, opacity: 0 }}
                            className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-xl"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <h3 className="text-lg font-bold text-stone-800 mb-4">ğŸš¨ ì‹ ê³ í•˜ê¸°</h3>
                            <div className="space-y-2 mb-4">
                                {(Object.keys(REPORT_REASON_LABELS) as ReportReason[]).map((reason) => (
                                    <label
                                        key={reason}
                                        className={`flex items-center gap-2 p-3 rounded-lg cursor-pointer transition-colors ${reportReason === reason ? 'bg-red-50 border-red-200 border' : 'bg-stone-50 hover:bg-stone-100'
                                            }`}
                                    >
                                        <input
                                            type="radio"
                                            name="report-reason"
                                            value={reason}
                                            checked={reportReason === reason}
                                            onChange={() => setReportReason(reason)}
                                            className="accent-red-500"
                                        />
                                        <span className="text-sm text-stone-700">{REPORT_REASON_LABELS[reason]}</span>
                                    </label>
                                ))}
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setShowReportModal(false)}
                                    className="flex-1 py-2 rounded-lg bg-stone-100 text-stone-600 font-medium hover:bg-stone-200 transition-colors"
                                >
                                    ì·¨ì†Œ
                                </button>
                                <button
                                    onClick={handleReportSubmit}
                                    className="flex-1 py-2 rounded-lg bg-red-500 text-white font-medium hover:bg-red-600 transition-colors"
                                >
                                    ì‹ ê³ 
                                </button>
                            </div>
                        </motion.div>
                    </motion.div>
                )}
            </AnimatePresence>

            {/* ê°€ê²© ì—…ë°ì´íŠ¸ ëª¨ë‹¬ */}
            <AnimatePresence>
                {showPriceModal && (
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
                        onClick={() => setShowPriceModal(false)}
                    >
                        <motion.div
                            initial={{ scale: 0.9, opacity: 0 }}
                            animate={{ scale: 1, opacity: 1 }}
                            exit={{ scale: 0.9, opacity: 0 }}
                            className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-xl"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <h3 className="text-lg font-bold text-stone-800 mb-4">ğŸ’° ê°€ê²© ì—…ë°ì´íŠ¸</h3>
                            <p className="text-sm text-stone-500 mb-4">
                                ê°€ê²©ì´ ë³€ë™ë˜ì—ˆë‚˜ìš”? ìƒˆ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.
                            </p>
                            <div className="relative mb-4">
                                <input
                                    type="text"
                                    value={newPrice}
                                    onChange={(e) => setNewPrice(e.target.value.replace(/[^0-9]/g, ''))}
                                    className="w-full px-4 py-3 rounded-lg border border-stone-200 focus:border-matcha-400 focus:ring-2 focus:ring-matcha-100 outline-none text-lg"
                                    placeholder="ê°€ê²© ì…ë ¥"
                                />
                                <span className="absolute right-4 top-1/2 -translate-y-1/2 text-stone-400">ì›</span>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setShowPriceModal(false)}
                                    className="flex-1 py-2 rounded-lg bg-stone-100 text-stone-600 font-medium hover:bg-stone-200 transition-colors"
                                >
                                    ì·¨ì†Œ
                                </button>
                                <button
                                    onClick={handlePriceSubmit}
                                    className="flex-1 py-2 rounded-lg bg-matcha-500 text-white font-medium hover:bg-matcha-600 transition-colors"
                                >
                                    ì—…ë°ì´íŠ¸
                                </button>
                            </div>
                        </motion.div>
                    </motion.div>
                )}
            </AnimatePresence>
        </>
    );
}
</file>

<file path="backend/dagu/views.py">
"""
API Views for MALCHA-DAGU.
"""

import logging

from django.core.cache import cache
from django.db import models, transaction
from django.db.models import F
from django.utils import timezone

logger = logging.getLogger(__name__)
from rest_framework import status, viewsets
from rest_framework.decorators import action, api_view
from rest_framework.permissions import AllowAny, IsAdminUser, IsAuthenticated, IsAuthenticatedOrReadOnly
from rest_framework.response import Response
from rest_framework.throttling import ScopedRateThrottle, UserRateThrottle
from rest_framework.views import APIView

from .models import Instrument, ItemClick, ItemReport, SearchQuery, UserItem
from .permissions import IsOwnerOrReadOnly
from .serializers import (
    AIDescriptionRequestSerializer,
    AIDescriptionResponseSerializer,
    InstrumentSerializer,
    SearchResultSerializer,
    UserItemCreateSerializer,
    UserItemSerializer,
)
from .services import SearchAggregatorService
# from .services import AIDescriptionService  # ì„ì‹œ ë¹„í™œì„±í™”


# =============================================================================
# Auth Check API (SSO)
# =============================================================================

class AuthCheckView(APIView):
    """
    SSO ì¸ì¦ ìƒíƒœ í™•ì¸ API.
    HttpOnly ì¿ í‚¤ëŠ” JSì—ì„œ ì½ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ì„œë²„ì—ì„œ í™•ì¸.

    GET /api/auth/check/
    """
    permission_classes = [AllowAny]

    def get(self, request):
        if request.user and request.user.is_authenticated:
            return Response({
                'is_authenticated': True,
                'user_id': request.user.id,
                'username': request.user.username,
            })
        return Response({
            'is_authenticated': False,
        })


# =============================================================================
# Search API
# =============================================================================

class SearchView(APIView):
    """
    í†µí•© ê²€ìƒ‰ API.
    ë„¤ì´ë²„ ì‡¼í•‘ + DB ìœ ì € ë§¤ë¬¼ì„ ê°€ê²©ìˆœìœ¼ë¡œ ë³‘í•©.

    GET /api/search/?q={ê²€ìƒ‰ì–´}&display={ê°œìˆ˜}

    ìºì‹± ì „ëµ:
    - ë„¤ì´ë²„ API ê²°ê³¼ë§Œ ìºì‹± (3ë¶„)
    - ìœ ì € ë§¤ë¬¼ì€ í•­ìƒ ì‹¤ì‹œê°„ DB ì¡°íšŒ (ì¦‰ì‹œ ë°˜ì˜)
    """
    permission_classes = [AllowAny]  # ì¸ì¦ ì—†ì´ ê²€ìƒ‰ ê°€ëŠ¥
    throttle_classes = [ScopedRateThrottle]
    throttle_scope = 'search'

    CACHE_TTL = 60 * 3  # 3ë¶„ (ë„¤ì´ë²„ ê²°ê³¼ë§Œ ìºì‹±)

    def get(self, request):
        query = request.query_params.get('q', '').strip()

        if not query:
            return Response(
                {'error': 'ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'},
                status=status.HTTP_400_BAD_REQUEST
            )

        # ê²€ìƒ‰ì–´ ê¸¸ì´ ì œí•œ (XSS/Injection ë°©ì§€)
        if len(query) > 200:
            return Response(
                {'error': 'ê²€ìƒ‰ì–´ëŠ” 200ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.'},
                status=status.HTTP_400_BAD_REQUEST
            )

        # display íŒŒë¼ë¯¸í„° ê²€ì¦
        try:
            display = int(request.query_params.get('display', 20))
        except (ValueError, TypeError):
            display = 20
        display = min(max(display, 1), 100)  # 1~100 ë²”ìœ„ ì œí•œ

        # í†µí•© ê²€ìƒ‰ ìˆ˜í–‰ (ë„¤ì´ë²„ëŠ” ìºì‹±, ìœ ì € ë§¤ë¬¼ì€ ì‹¤ì‹œê°„)
        try:
            service = SearchAggregatorService()
            result = service.search_with_cache(query, display, cache, self.CACHE_TTL)
        except Exception as e:
            logger.exception(f"Search error for query '{query}': {e}")
            return Response(
                {'error': 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

        # ê²€ìƒ‰ì–´ ì¶”ì  (ì„œë¹„ìŠ¤ì—ì„œ ì •ê·œí™”ëœ ì¿¼ë¦¬ ì‚¬ìš©)
        effective_query = result.get('query', query)
        self._track_search_query(effective_query)

        serializer = SearchResultSerializer(result)
        response_data = serializer.data

        return Response(response_data)

    def _track_search_query(self, query: str):
        """ê²€ìƒ‰ì–´ ì¹´ìš´íŠ¸ ì¦ê°€ (ì¤‘ë³µ ì‹œ ì—…ë°ì´íŠ¸)"""
        try:
            normalized = query.strip().lower()
            if len(normalized) < 2:
                return  # ë„ˆë¬´ ì§§ì€ ê²€ìƒ‰ì–´ ë¬´ì‹œ

            obj, created = SearchQuery.objects.get_or_create(
                query__iexact=normalized,
                defaults={'query': query}
            )
            if not created:
                # ê²€ìƒ‰ íšŸìˆ˜ ì¦ê°€ + ìµœê·¼ ê²€ìƒ‰ ì‹œê°„ ê°±ì‹ 
                # + ë””ìŠ¤í”Œë ˆì´ìš© ì¿¼ë¦¬(ëŒ€ì†Œë¬¸ì)ë¥¼ ìµœì‹ ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (ì˜ˆ: fender -> Fender)
                SearchQuery.objects.filter(pk=obj.pk).update(
                    search_count=F('search_count') + 1,
                    last_searched_at=timezone.now(),
                    query=query  # ìµœì‹  ì¼€ì´ì‹± ë°˜ì˜
                )
        except Exception as e:
            logger.warning(f"Failed to track search query: {e}")


class PopularSearchView(APIView):
    """
    ì¸ê¸° ê²€ìƒ‰ì–´(íŠ¸ë Œë”©) API.
    ìµœê·¼ í´ë¦­ ìˆ˜ ê¸°ë°˜ "ì§€ê¸ˆ ëœ¨ëŠ”" ì•…ê¸° ë°˜í™˜.

    GET /api/popular-searches/?limit=4

    íŠ¸ë Œë”© ë¡œì§:
    1ì‹œê°„ ë‚´ í´ë¦­ ë§ì€ ìˆœ â†’ ë°ì´í„° ë¶€ì¡± ì‹œ 24ì‹œê°„ í™•ì¥ â†’ ê·¸ë˜ë„ ë¶€ì¡± ì‹œ ê²€ìƒ‰ íšŸìˆ˜ fallback
    """
    permission_classes = [AllowAny]

    def get(self, request):
        from datetime import timedelta
        from django.db.models import Count
        from .services.utils import normalize_brand, normalize_search_term

        # íŒŒë¼ë¯¸í„°
        try:
            limit = int(request.query_params.get('limit', 4))
        except (ValueError, TypeError):
            limit = 4
        limit = min(max(limit, 1), 10)  # 1~10 ë²”ìœ„

        terms = []
        seen_normalized = set()  # ì¤‘ë³µ ì œê±°ìš© (ì •ê·œí™”ëœ í‚¤)

        def add_term(term):
            """ê²€ìƒ‰ì–´ ì¶”ê°€ í•¨ìˆ˜ (ì¤‘ë³µ ì²´í¬ ë° limit í™•ì¸)"""
            if len(terms) >= limit:
                return False
            
            if not term:
                return True

            # ì •ê·œí™”í•˜ì—¬ ì¤‘ë³µ ì²´í¬ (ì˜ˆ: "íœë”" -> "fender")
            # ë¸Œëœë“œëª… í†µì¼ + ì†Œë¬¸ì/ê³µë°±ì œê±°
            normalized = normalize_search_term(normalize_brand(term))
            
            if normalized not in seen_normalized:
                terms.append(term)
                seen_normalized.add(normalized)
            
            return True

        # 1ë‹¨ê³„: ì‹¤ì œ ê²€ìƒ‰ íšŸìˆ˜ ìš°ì„  (ìµœê·¼ 7ì¼)
        # - ì‚¬ìš©ìê°€ ì‹¤ì œë¡œ ì…ë ¥í•œ "ì˜ë„"ê°€ ê°€ì¥ ì •í™•í•¨
        week_ago = timezone.now() - timedelta(days=7)
        popular_searches = SearchQuery.objects.filter(
            last_searched_at__gte=week_ago
        ).order_by('-search_count')[:limit * 3]

        for sq in popular_searches:
            add_term(sq.query)

        # 2ë‹¨ê³„: ë°ì´í„° ë¶€ì¡± ì‹œ ìµœê·¼ í´ë¦­ëœ ë§¤ë¬¼ (ë³´ì¡°)
        # - ê²€ìƒ‰ ë°ì´í„°ê°€ ì—†ì„ ë•Œ íŠ¸ë Œë”© ë§¤ë¬¼ë¡œ ë³´ì™„
        if len(terms) < limit:
            day_ago = timezone.now() - timedelta(hours=24)
            recent_clicks = UserItem.objects.filter(
                clicks__clicked_at__gte=day_ago,
                is_active=True,
            ).annotate(
                click_count=Count('clicks')
            ).order_by('-click_count')[:limit * 3]

            for item in recent_clicks:
                # ë¸Œëœë“œ + ì´ë¦„ ì¡°í•©
                term_candidate = f"{item.instrument.brand} {item.instrument.name}"
                add_term(term_candidate)

        # 3ë‹¨ê³„: ìµœì¢… fallback - ê¸°ë³¸ê°’
        defaults = ['íœë” ìŠ¤íŠ¸ë«', 'ê¹ìŠ¨ ë ˆìŠ¤í´', 'í…Œì¼ëŸ¬ ì–´ì¿ ìŠ¤í‹±', 'ì•¼ë§ˆí•˜ THR']
        for d in defaults:
            add_term(d)

        return Response({'terms': terms[:limit]})


# =============================================================================
# Instrument ViewSet (CRUD)
# =============================================================================

class InstrumentViewSet(viewsets.ModelViewSet):
    """
    ì•…ê¸° ë§ˆìŠ¤í„° CRUD API.

    GET    /api/instruments/          - ëª©ë¡ (ëª¨ë‘ í—ˆìš©)
    POST   /api/instruments/          - ìƒì„± (ê´€ë¦¬ìë§Œ)
    GET    /api/instruments/{id}/     - ìƒì„¸ (ëª¨ë‘ í—ˆìš©)
    PUT    /api/instruments/{id}/     - ìˆ˜ì • (ê´€ë¦¬ìë§Œ)
    DELETE /api/instruments/{id}/     - ì‚­ì œ (ê´€ë¦¬ìë§Œ)
    """
    queryset = Instrument.objects.all()
    serializer_class = InstrumentSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]

    def get_permissions(self):
        """ì•¡ì…˜ë³„ ê¶Œí•œ ë¶„ê¸°"""
        if self.action in ['create', 'update', 'partial_update', 'destroy']:
            return [IsAdminUser()]
        return [AllowAny()]
    
    def get_queryset(self):
        queryset = super().get_queryset()
        
        # í•„í„°ë§ ì˜µì…˜
        brand = self.request.query_params.get('brand')
        category = self.request.query_params.get('category')
        search = self.request.query_params.get('search')
        
        if brand:
            queryset = queryset.filter(brand__icontains=brand)
        if category:
            queryset = queryset.filter(category=category)
        if search:
            # ê²€ìƒ‰ì–´ë¥¼ ê³µë°±ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ê° ë‹¨ì–´ê°€ ë¸Œëœë“œë‚˜ ì´ë¦„ ì¤‘ í•˜ë‚˜ì— í¬í•¨ë˜ì–´ì•¼ í•¨ (AND ì¡°ê±´)
            # ì˜ˆ: "fender strat" -> (brand="fender" OR name="fender") AND (brand="strat" OR name="strat")
            search_terms = search.split()
            for term in search_terms:
                queryset = queryset.filter(
                    models.Q(name__icontains=term) |
                    models.Q(brand__icontains=term)
                )
        
        return queryset


# =============================================================================
# UserItem ViewSet (CRUD + Click Tracking)
# =============================================================================

class CreateItemThrottle(UserRateThrottle):
    """ë§¤ë¬¼ ë“±ë¡ ìŠ¤íŒ¸ ë°©ì§€ (ë¶„ë‹¹ 10íšŒë¡œ ì™„í™”)"""
    rate = '10/min'


class UserItemViewSet(viewsets.ModelViewSet):
    """
    ìœ ì € ë§¤ë¬¼ CRUD API.

    GET    /api/items/              - ëª©ë¡ (ëª¨ë‘ í—ˆìš©)
    POST   /api/items/              - ìƒì„± (ë¡œê·¸ì¸ í•„ìˆ˜, Rate Limit: 3/min)
    GET    /api/items/{id}/         - ìƒì„¸ (ëª¨ë‘ í—ˆìš©)
    PUT    /api/items/{id}/         - ìˆ˜ì • (ë³¸ì¸ë§Œ, IDOR ë°©ì§€)
    DELETE /api/items/{id}/         - ì‚­ì œ (ë³¸ì¸ë§Œ, IDOR ë°©ì§€)
    POST   /api/items/{id}/click/   - í´ë¦­ ì¶”ì  (ëª¨ë‘ í—ˆìš©)
    """

    queryset = UserItem.objects.filter(is_active=True, is_under_review=False)
    permission_classes = [IsOwnerOrReadOnly]

    def get_permissions(self):
        """ì•¡ì…˜ë³„ ê¶Œí•œ ë¶„ê¸°"""
        if self.action in ['create', 'update', 'partial_update', 'destroy']:
            return [IsAuthenticated(), IsOwnerOrReadOnly()]
        return [AllowAny()]
    
    def get_throttles(self):
        """ì•¡ì…˜ë³„ Throttle ë¶„ê¸°"""
        if self.action == 'create':
            return [CreateItemThrottle()]
        return super().get_throttles()
    
    def get_serializer_class(self):
        if self.action == 'create':
            return UserItemCreateSerializer
        return UserItemSerializer
    
    def get_queryset(self):
        queryset = super().get_queryset()
        
        # ë§Œë£Œëœ í•­ëª© ì œì™¸
        now = timezone.now()
        queryset = queryset.filter(expired_at__gt=now)
        
        # í•„í„°ë§ ì˜µì…˜
        instrument_id = self.request.query_params.get('instrument')
        source = self.request.query_params.get('source')
        min_price = self.request.query_params.get('min_price')
        max_price = self.request.query_params.get('max_price')
        
        if instrument_id:
            queryset = queryset.filter(instrument_id=instrument_id)
        if source:
            queryset = queryset.filter(source=source)
        if min_price:
            try:
                min_price_int = int(min_price)
                if min_price_int < 0:
                    raise ValueError("min_price must be positive")
                queryset = queryset.filter(price__gte=min_price_int)
            except (ValueError, TypeError):
                from rest_framework.exceptions import ValidationError
                raise ValidationError({'min_price': f'ìœ íš¨í•˜ì§€ ì•Šì€ ê°’: {min_price}'})
        if max_price:
            try:
                max_price_int = int(max_price)
                if max_price_int < 0:
                    raise ValueError("max_price must be positive")
                queryset = queryset.filter(price__lte=max_price_int)
            except (ValueError, TypeError):
                from rest_framework.exceptions import ValidationError
                raise ValidationError({'max_price': f'ìœ íš¨í•˜ì§€ ì•Šì€ ê°’: {max_price}'})
        
        return queryset.select_related('instrument')

    def create(self, request, *args, **kwargs):
        logger.debug(f"UserItemViewSet.create called with data: {request.data}")
        response = super().create(request, *args, **kwargs)
        logger.debug(f"create success, response: {response.data}")
        # ìºì‹œ ë¬´íš¨í™” ë¶ˆí•„ìš”: ìœ ì € ë§¤ë¬¼ì€ í•­ìƒ ì‹¤ì‹œê°„ DB ì¡°íšŒë¨
        return response

    def perform_create(self, serializer):
        """
        ë§¤ë¬¼ ìƒì„± ì‹œ ì•…ê¸° ì •ë³´ë¥¼ ì—°ê²°í•˜ê³  ì œëª©ì„ í‘œì¤€í™”í•©ë‹ˆë‹¤.
        - ë§í¬ ê²€ì¦ ë° ì¤‘ë³µ ì²´í¬ëŠ” Serializerì—ì„œ ì²˜ë¦¬ë¨
        - ì•…ê¸° ë§¤ì¹­ ë° ì œëª© í‘œì¤€í™” ë¡œì§ì€ item_serviceë¡œ ìœ„ì„
        """
        from rest_framework.exceptions import ValidationError
        from .services.item_service import resolve_and_standardize_item

        title = serializer.validated_data.get('title', '').strip()
        instrument_id = serializer.validated_data.get('instrument')
        
        # [Refactor] ì„œë¹„ìŠ¤ ë ˆì´ì–´ ìœ„ì„: ë§¤ì¹­ëœ ì•…ê¸° ì°¾ê¸° ë° ì œëª© í‘œì¤€í™”
        instrument, standardized_title = resolve_and_standardize_item(title, instrument_id)
        
        # ì•…ê¸° ë¯¸ë°œê²¬ ì‹œ ë“±ë¡ ì°¨ë‹¨
        if not instrument:
            raise ValidationError({
                'title': 'í•´ë‹¹í•˜ëŠ” ì•…ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ ê²°ê³¼ í˜ì´ì§€ì—ì„œ ë“±ë¡í•´ì£¼ì„¸ìš”.'
            })

        # owner_id ì„¤ì •
        owner_id = self.request.user.id if self.request.user.is_authenticated else None
        
        # ì €ì¥ (í‘œì¤€í™”ëœ ì œëª© ì ìš©)
        serializer.save(
            instrument=instrument, 
            owner_id=owner_id, 
            title=standardized_title
        )

    @action(detail=True, methods=['post'])
    def extend(self, request, pk=None):
        """
        ìœ íš¨ê¸°ê°„ ì—°ì¥ API (ë³¸ì¸ ë§¤ë¬¼ë§Œ)
        - JWT user_idë¡œ ì†Œìœ ì ê²€ì¦
        - expired_at 72ì‹œê°„ ì—°ì¥
        - extended_at ê¸°ë¡ (ìš°ì„ ìˆœìœ„ìš©)
        """
        item = self.get_object()

        # ì†Œìœ ì ê²€ì¦ (JWT user_id vs owner_id)
        if not request.user.is_authenticated or item.owner_id != request.user.id:
            return Response(
                {'error': 'ë³¸ì¸ ë§¤ë¬¼ë§Œ ì—°ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.'},
                status=status.HTTP_403_FORBIDDEN
            )

        with transaction.atomic():
            item.expired_at = timezone.now() + timezone.timedelta(hours=72)
            item.extended_at = timezone.now()
            item.save(update_fields=['expired_at', 'extended_at'])

        serializer = self.get_serializer(item)
        return Response(serializer.data)

    @action(detail=True, methods=['post'])
    def click(self, request, pk=None):
        """
        í´ë¦­ ì¶”ì  API.
        - click_count ì¦ê°€ (Atomic Updateë¡œ ë™ì‹œì„± ë¬¸ì œ ë°©ì§€)
        - expired_at 12ì‹œê°„ ì—°ì¥
        - ItemClick ë¡œê·¸ ê¸°ë¡ (íŠ¸ë Œë”© ê³„ì‚°ìš©)
        """
        item = self.get_object()

        with transaction.atomic():
            # Atomic updateë¡œ click_count ì¦ê°€
            UserItem.objects.filter(pk=pk).update(
                click_count=F('click_count') + 1,
                expired_at=timezone.now() + timezone.timedelta(hours=12),
            )
            # í´ë¦­ ë¡œê·¸ ì €ì¥ (íŠ¸ë Œë”© ê³„ì‚°ìš©)
            ItemClick.objects.create(item=item)

        # ê°±ì‹ ëœ ë°ì´í„° ë°˜í™˜
        item.refresh_from_db()
        serializer = self.get_serializer(item)
        return Response(serializer.data)

    @action(detail=True, methods=['post'])
    def report(self, request, pk=None):
        """
        í—ˆìœ„ ë§¤ë¬¼ ì‹ ê³  API (ë¡œê·¸ì¸ ë¶ˆí•„ìš”, ì„¸ì…˜ ê¸°ë°˜)
        - ë¡œê·¸ì¸ ìœ ì €: reporter_idë¡œ ì¤‘ë³µ ì²´í¬
        - ë¹„ë¡œê·¸ì¸ ìœ ì €: session_keyë¡œ ì¤‘ë³µ ì²´í¬
        - 'wrong_price' 3íšŒ ì´ìƒ â†’ ìë™ ì‚­ì œ (is_active=False)
        - ê¸°íƒ€ ì‚¬ìœ  3íšŒ ì´ìƒ â†’ ê²€í†  ì¤‘ ìƒíƒœ
        """
        item = self.get_object()

        # ì„¸ì…˜ í‚¤ í™•ë³´ (ì—†ìœ¼ë©´ ìƒì„±)
        if not request.session.session_key:
            request.session.create()
        session_key = request.session.session_key

        # ë³¸ì¸ ë§¤ë¬¼ ì‹ ê³  ë°©ì§€ (ë¡œê·¸ì¸ ìœ ì €ë§Œ)
        if request.user.is_authenticated and item.owner_id == request.user.id:
            return Response(
                {'error': 'ë³¸ì¸ ë§¤ë¬¼ì€ ì‹ ê³ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'},
                status=status.HTTP_400_BAD_REQUEST
            )

        reason = request.data.get('reason', 'other')
        detail = request.data.get('detail', '')

        # ìœ íš¨í•œ ì‚¬ìœ ì¸ì§€ í™•ì¸
        valid_reasons = [choice[0] for choice in ItemReport.REASON_CHOICES]
        if reason not in valid_reasons:
            reason = 'other'

        # ì¤‘ë³µ ì‹ ê³  ì²´í¬
        if request.user.is_authenticated:
            exists = ItemReport.objects.filter(
                item=item, reporter_id=request.user.id
            ).exists()
        else:
            exists = ItemReport.objects.filter(
                item=item, session_key=session_key
            ).exists()

        if exists:
            return Response(
                {'error': 'ì´ë¯¸ ì‹ ê³ í•œ ë§¤ë¬¼ì…ë‹ˆë‹¤.'},
                status=status.HTTP_400_BAD_REQUEST
            )

        try:
            with transaction.atomic():
                # ì‹ ê³  ìƒì„±
                ItemReport.objects.create(
                    item=item,
                    reporter_id=request.user.id if request.user.is_authenticated else None,
                    session_key=session_key if not request.user.is_authenticated else None,
                    reason=reason,
                    detail=detail[:500]
                )

                # ì‹ ê³  íšŸìˆ˜ ì¦ê°€
                UserItem.objects.filter(pk=pk).update(
                    report_count=F('report_count') + 1
                )
                item.refresh_from_db()

                # 'wrong_price' 3íšŒ ì´ìƒ â†’ ìë™ ì‚­ì œ
                wrong_price_count = ItemReport.objects.filter(
                    item=item, reason='wrong_price'
                ).count()

                is_deleted = False
                if wrong_price_count >= 3:
                    item.is_active = False
                    item.save(update_fields=['is_active'])
                    is_deleted = True
                    logger.info(f"Item {pk} auto-deleted (wrong_price count: {wrong_price_count})")
                # ê¸°íƒ€ ì‚¬ìœ  3íšŒ ì´ìƒ â†’ ê²€í†  ì¤‘
                elif item.report_count >= 3:
                    item.is_under_review = True
                    item.save(update_fields=['is_under_review'])
                    logger.info(f"Item {pk} marked for review (report_count: {item.report_count})")

            return Response({
                'message': 'ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.' + (' í•´ë‹¹ ë§¤ë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' if is_deleted else ''),
                'report_count': item.report_count,
                'is_under_review': item.is_under_review,
                'is_deleted': is_deleted
            })

        except Exception as e:
            logger.exception(f"Report error for item {pk}: {e}")
            return Response(
                {'error': 'ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

    @action(detail=True, methods=['post'])
    def update_price(self, request, pk=None):
        """
        ê°€ê²© ì—…ë°ì´íŠ¸ API (ë¡œê·¸ì¸ í•„ìˆ˜)
        - ê°€ê²© ë³€ë™ ì‚¬í•­ì„ ìœ ì €ê°€ ì§ì ‘ ìˆ˜ì •
        - ì–´ë·°ì§• ë°©ì§€ë¥¼ ìœ„í•´ ë¡œê·¸ì¸ í•„ìˆ˜
        """
        if not request.user.is_authenticated:
            return Response(
                {'error': 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'},
                status=status.HTTP_401_UNAUTHORIZED
            )

        item = self.get_object()

        try:
            new_price = int(request.data.get('price', 0))
        except (ValueError, TypeError):
            return Response(
                {'error': 'ìœ íš¨í•œ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'},
                status=status.HTTP_400_BAD_REQUEST
            )

        if new_price <= 0:
            return Response(
                {'error': 'ê°€ê²©ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.'},
                status=status.HTTP_400_BAD_REQUEST
            )

        if new_price > 100_000_000:  # 1ì–µì› ì œí•œ
            return Response(
                {'error': 'ê°€ê²©ì´ ë„ˆë¬´ ë†’ìŠµë‹ˆë‹¤.'},
                status=status.HTTP_400_BAD_REQUEST
            )

        # ê°€ê²© ì—…ë°ì´íŠ¸ (ëˆ„ê°€ ìˆ˜ì •í–ˆëŠ”ì§€ ë¡œê¹…)
        old_price = item.price
        item.price = new_price
        item.save(update_fields=['price', 'updated_at'])

        logger.info(
            f"Price updated for item {pk}: {old_price} -> {new_price} "
            f"by user {request.user.id}"
        )

        serializer = self.get_serializer(item)
        return Response(serializer.data)


# =============================================================================
# AI Description API (ì„ì‹œ ë¹„í™œì„±í™”)
# =============================================================================

# class AIDescriptionView(APIView):
#     """
#     AI ì•…ê¸° ì„¤ëª… ìƒì„± API.
#     í• ë£¨ì‹œë„¤ì´ì…˜ ë°©ì§€ í”„ë¡¬í”„íŠ¸ ì ìš©.
#
#     POST /api/ai/describe/
#     {
#         "model_name": "DS-1",
#         "brand": "BOSS",
#         "category": "effect"
#     }
#     """
#
#     def post(self, request):
#         serializer = AIDescriptionRequestSerializer(data=request.data)
#         serializer.is_valid(raise_exception=True)
#
#         data = serializer.validated_data
#
#         service = AIDescriptionService()
#         result = service.generate_description(
#             model_name=data['model_name'],
#             brand=data['brand'],
#             category=data['category'],
#         )
#
#         response_serializer = AIDescriptionResponseSerializer(result)
#         return Response(response_serializer.data)
</file>

<file path="frontend/src/pages/SearchResultPage.tsx">
/**
 * Search Result Page Component
 * 
 * Features:
 * - ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ (Staggered Animation)
 * - ë§¤ë¬¼ ë“±ë¡ ë²„íŠ¼ (API ì—°ë™ + ìë™ ì†ŒìŠ¤ ê°ì§€)
 * - React Query ìºì‹± ë° ìë™ ê°±ì‹ 
 */

import { useState, useEffect } from 'react';
import { useSearchParams, useNavigate } from 'react-router-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { useQueryClient } from '@tanstack/react-query';
import { AxiosError } from 'axios';
import SearchBar from '../components/SearchBar';
import MatchaBounceLoader from '../components/MatchaBounceLoader';
import ItemCard from '../components/ItemCard';
import CategoryHeader from '../components/CategoryHeader';
import { useSearch, useTrackItemClick, useCreateUserItem, useExtendUserItem, useReportItem, useUpdateItemPrice, useDeleteUserItem } from '../hooks/useSearch';
import { useAuth } from '../hooks/useAuth';
import type { NaverItem, MergedUserItem, ReportReason } from '../types';

// API ì—ëŸ¬ ì‘ë‹µ íƒ€ì…
interface ApiErrorResponse {
    [key: string]: string | string[];
}

// ì†ŒìŠ¤ ìë™ ê°ì§€ í—¬í¼
const SOURCE_LABELS: Record<string, string> = {
    mule: 'ë®¬ (Mule)',
    joonggonara: 'ì¤‘ê³ ë‚˜ë¼',
    danggn: 'ë‹¹ê·¼ë§ˆì¼“',
    bunjang: 'ë²ˆê°œì¥í„°',
    other: 'ê¸°íƒ€ ì‚¬ì´íŠ¸'
};

const SOURCE_COLORS: Record<string, string> = {
    mule: 'bg-blue-50 text-blue-700 border-blue-200',
    joonggonara: 'bg-green-50 text-green-700 border-green-200',
    danggn: 'bg-orange-50 text-orange-700 border-orange-200',
    bunjang: 'bg-red-50 text-red-700 border-red-200',
    other: 'bg-stone-50 text-stone-600 border-stone-200'
};

function detectSource(url: string): string {
    const lower = url.toLowerCase();
    if (lower.includes('mule.co.kr')) return 'mule';
    if (lower.includes('joonggonara') || (lower.includes('cafe.naver.com') && lower.includes('joon'))) return 'joonggonara';
    if (lower.includes('daangn.com') || lower.includes('danggn')) return 'danggn';
    if (lower.includes('bunjang.co.kr')) return 'bunjang';
    return 'other';
}

const MIN_LOADING_TIME = 3400;

// ë¡œê·¸ì¸ URL ìƒì„± (ë¡œì»¬/í”„ë¡œë•ì…˜ í™˜ê²½ ê°ì§€)
const getLoginUrl = () => {
    const currentUrl = window.location.href;
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

    if (isLocalhost) {
        // ë¡œì»¬ ê°œë°œ: ë§ì°¨ í”„ë¡ íŠ¸ì—”ë“œ ë¡œê·¸ì¸ í˜ì´ì§€ (í˜„ì¬ í˜ì´ì§€ë¡œ ëŒì•„ì˜¤ê¸°)
        return `http://localhost:5173/login?redirect_uri=${encodeURIComponent(currentUrl)}`;
    }
    // í”„ë¡œë•ì…˜: ë§ì°¨ í”„ë¡œë•ì…˜ ë¡œê·¸ì¸
    return `https://malchalab.com/login?redirect_uri=${encodeURIComponent(currentUrl)}`;
};

export default function SearchResultPage() {
    const [searchParams] = useSearchParams();
    const navigate = useNavigate();
    const query = searchParams.get('q') || '';

    const [showLoader, setShowLoader] = useState(true);
    const [minTimeElapsed, setMinTimeElapsed] = useState(false);
    const [showRegisterModal, setShowRegisterModal] = useState(false);

    // SSO ì¸ì¦ ìƒíƒœ í™•ì¸
    const { isLoggedIn } = useAuth();

    // React Queryë¡œ ê²€ìƒ‰
    const { data, isLoading, isError, error } = useSearch(query, {
        enabled: query.length > 0,
    });

    // í´ë¦­ ì¶”ì 
    const trackClick = useTrackItemClick();

    // ì—°ì¥ ê¸°ëŠ¥
    const extendItem = useExtendUserItem();

    // ì‹ ê³  ê¸°ëŠ¥
    const reportItem = useReportItem();

    // ê°€ê²© ì—…ë°ì´íŠ¸ ê¸°ëŠ¥
    const updatePrice = useUpdateItemPrice();

    // ì‚­ì œ ê¸°ëŠ¥
    const deleteUserItem = useDeleteUserItem();

    const handleDeleteItem = (itemId: number | string) => {
        if (window.confirm('ì •ë§ ì´ ë§¤ë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            deleteUserItem.mutate(String(itemId), {
                onSuccess: () => {
                    alert('ë§¤ë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                },
                onError: () => {
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }
    };



    // ìµœì†Œ ë¡œë”© ì‹œê°„ ë³´ì¥
    useEffect(() => {
        if (!query) return;
        setShowLoader(true);
        setMinTimeElapsed(false);
        const timer = setTimeout(() => setMinTimeElapsed(true), MIN_LOADING_TIME);
        return () => clearTimeout(timer);
    }, [query]);

    useEffect(() => {
        if (!isLoading && minTimeElapsed) {
            setShowLoader(false);
        }
    }, [isLoading, minTimeElapsed]);

    // ì •ê·œí™”ëœ ê²€ìƒ‰ì–´ëŠ” ì™¸ë¶€ ë§í¬ìš©ìœ¼ë¡œë§Œ ì‚¬ìš© (URL ì—…ë°ì´íŠ¸ ì‹œ ì¬ê²€ìƒ‰ ë°œìƒí•˜ë¯€ë¡œ ì œê±°)
    const externalSearchQuery = data?.search_query || query;

    const handleSearch = (newQuery: string) => {
        navigate(`/search?q=${encodeURIComponent(newQuery)}`);
    };

    const handleItemClick = (item: NaverItem | MergedUserItem) => {
        if ('id' in item && item.source !== 'naver') {
            trackClick.mutate(item.id);
        }
    };

    const handleExtendItem = (itemId: string) => {
        extendItem.mutate(itemId, {
            onSuccess: () => {
                alert('ë§¤ë¬¼ì´ 72ì‹œê°„ ì—°ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            },
            onError: (err: unknown) => {
                const axiosErr = err as AxiosError<{ error?: string }>;
                const statusCode = axiosErr.response?.status;
                const serverMsg = axiosErr.response?.data?.error;

                if (statusCode === 401) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\nì—°ì¥ì€ ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
                } else if (statusCode === 403) {
                    alert('ë³¸ì¸ ë§¤ë¬¼ë§Œ ì—°ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                } else if (statusCode === 404) {
                    alert('ë§¤ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì´ë¯¸ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë§¤ë¬¼ì…ë‹ˆë‹¤.');
                } else if (statusCode === 500) {
                    alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } else if (!axiosErr.response) {
                    alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                } else {
                    alert(serverMsg || 'ì—°ì¥ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            },
        });
    };

    const handleReportItem = (itemId: string, reason: ReportReason) => {
        reportItem.mutate({ id: itemId, reason }, {
            onSuccess: (data) => {
                if (data.is_deleted) {
                    alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nê°€ê²© ì˜¤ë¥˜ ì‹ ê³ ê°€ ëˆ„ì ë˜ì–´ í•´ë‹¹ ë§¤ë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else if (data.is_under_review) {
                    alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\ní•´ë‹¹ ë§¤ë¬¼ì€ ê²€í†  ëŒ€ê¸° ì¤‘ìœ¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nê°ì‚¬í•©ë‹ˆë‹¤!');
                }
            },
            onError: (err: unknown) => {
                const axiosErr = err as AxiosError<{ error?: string }>;
                const statusCode = axiosErr.response?.status;
                const serverMsg = axiosErr.response?.data?.error;

                // ìƒíƒœ ì½”ë“œë³„ ìƒì„¸ ë©”ì‹œì§€
                if (statusCode === 400) {
                    if (serverMsg?.includes('ì´ë¯¸ ì‹ ê³ ')) {
                        alert('ì´ë¯¸ ì‹ ê³ í•œ ë§¤ë¬¼ì…ë‹ˆë‹¤.\nê°™ì€ ë§¤ë¬¼ì€ í•œ ë²ˆë§Œ ì‹ ê³ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    } else if (serverMsg?.includes('ë³¸ì¸ ë§¤ë¬¼')) {
                        alert('ë³¸ì¸ ë§¤ë¬¼ì€ ì‹ ê³ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    } else {
                        alert(serverMsg || 'ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.');
                    }
                } else if (statusCode === 404) {
                    alert('ë§¤ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì´ë¯¸ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë§¤ë¬¼ì…ë‹ˆë‹¤.');
                } else if (statusCode === 500) {
                    alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } else if (!axiosErr.response) {
                    alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                } else {
                    alert(serverMsg || 'ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            },
        });
    };

    const handleUpdatePrice = (itemId: string, newPrice: number) => {
        updatePrice.mutate({ id: itemId, price: newPrice }, {
            onSuccess: () => {
                alert('ê°€ê²©ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\nê°ì‚¬í•©ë‹ˆë‹¤!');
            },
            onError: (err: unknown) => {
                const axiosErr = err as AxiosError<{ error?: string }>;
                const statusCode = axiosErr.response?.status;
                const serverMsg = axiosErr.response?.data?.error;

                // ìƒíƒœ ì½”ë“œë³„ ìƒì„¸ ë©”ì‹œì§€
                if (statusCode === 400) {
                    if (serverMsg?.includes('ìœ íš¨í•œ ê°€ê²©')) {
                        alert('ìœ íš¨í•œ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n0ë³´ë‹¤ í° ìˆ«ìë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
                    } else if (serverMsg?.includes('ë„ˆë¬´ ë†’')) {
                        alert('ê°€ê²©ì´ ë„ˆë¬´ ë†’ìŠµë‹ˆë‹¤.\n1ì–µì› ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    } else {
                        alert(serverMsg || 'ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.');
                    }
                } else if (statusCode === 401) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\nê°€ê²© ì—…ë°ì´íŠ¸ëŠ” ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
                } else if (statusCode === 404) {
                    alert('ë§¤ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì´ë¯¸ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë§¤ë¬¼ì…ë‹ˆë‹¤.');
                } else if (statusCode === 500) {
                    alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } else if (!axiosErr.response) {
                    alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                } else {
                    alert(serverMsg || 'ê°€ê²© ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            },
        });
    };

    // ì†Œìœ ì ì—¬ë¶€ í™•ì¸ (is_owner í•„ë“œê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ false)
    const isItemOwner = (item: NaverItem | MergedUserItem): boolean => {
        if (!isLoggedIn) return false;
        // UserItemSerializerì—ì„œ is_owner í•„ë“œ ì œê³µ ì‹œ ì‚¬ìš©
        if ('is_owner' in item) return (item as { is_owner: boolean }).is_owner;
        return false;
    };

    if (!query) {
        navigate('/');
        return null;
    }

    const allItems = data?.items || [];

    return (
        <div className="min-h-screen">
            <MatchaBounceLoader isVisible={showLoader} />

            {!showLoader && (
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ duration: 0.4 }}
                >
                    {/* í—¤ë” */}
                    <header className="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-stone-200 shadow-sm">
                        <div className="max-w-7xl mx-auto px-3 sm:px-4 py-2 sm:py-3">
                            <div className="flex items-center gap-3 sm:gap-6">
                                <motion.button
                                    onClick={() => navigate('/')}
                                    className="text-2xl sm:text-4xl font-black text-matcha-600 tracking-tighter shrink-0 flex items-center gap-1.5"
                                    whileHover={{ scale: 1.05 }}
                                    whileTap={{ scale: 0.95 }}
                                >
                                    <span className="text-xl sm:text-3xl">ğŸµ</span>
                                    DAGU
                                    <span className="text-xs sm:text-sm font-bold text-matcha-500 ml-0.5 -mt-3 rotate-12">
                                        beta
                                    </span>
                                </motion.button>
                                <div className="flex-1 max-w-2xl">
                                    <SearchBar
                                        onSearch={handleSearch}
                                        isLoading={isLoading}
                                        initialValue={query}
                                        placeholder="ë‹¤ë¥¸ ì•…ê¸° ê²€ìƒ‰"
                                        hideHint={true}
                                    />
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* ë©”ì¸ Container (Grid Layout) */}
                    <main className="max-w-7xl mx-auto px-3 sm:px-4 py-4 sm:py-8 grid lg:grid-cols-[1fr_280px] gap-4 sm:gap-8 items-start">

                        {/* Left Column: Results */}
                        <div className="min-w-0">
                            {/* Title & Count */}
                            <div className="mb-4 sm:mb-6">
                                {data?.taxonomy ? (
                                    <CategoryHeader taxonomy={data.taxonomy} />
                                ) : (
                                    <>
                                        <h1 className="text-xl sm:text-3xl font-bold text-stone-800 tracking-tight">
                                            "<span className="text-matcha-600">{query}</span>" ê²€ìƒ‰ ê²°ê³¼
                                        </h1>
                                        {data && (
                                            <p className="text-sm sm:text-base text-stone-500 mt-1 sm:mt-2 font-medium">
                                                ì´ {data.total_count}ê°œì˜ ë§¤ë¬¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤
                                            </p>
                                        )}
                                    </>
                                )}
                            </div>

                            {/* Mobile External Search Buttons (Visible only on < lg) */}
                            <div className="lg:hidden mb-8">
                                <ExternalSearchButtons query={externalSearchQuery} vertical={false} />
                            </div>

                            {/* ì—ëŸ¬ */}
                            {isError && (
                                <div className="text-center py-12 bg-red-50 rounded-2xl border border-red-100 mb-8">
                                    <p className="text-4xl mb-4">ğŸ˜µ</p>
                                    <p className="text-red-700 font-medium">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>
                                    <p className="text-red-500 text-sm mt-2">
                                        {error instanceof Error ? error.message : 'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”'}
                                    </p>
                                </div>
                            )}

                            {/* ê²°ê³¼ ì—†ìŒ */}
                            {data && data.total_count === 0 && (
                                <div className="text-center py-16 bg-stone-50 rounded-2xl border border-dashed border-stone-300 mb-8">
                                    <p className="text-4xl mb-4 opacity-50">ğŸ¸</p>
                                    <p className="text-stone-600 font-medium">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                    <p className="text-stone-400 text-sm mt-2">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì‹œë„í•´ë³´ì„¸ìš”</p>
                                </div>
                            )}

                            {/* ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ */}
                            {allItems.length > 0 && (
                                <motion.div
                                    className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6"
                                    variants={{
                                        hidden: { opacity: 0 },
                                        show: {
                                            opacity: 1,
                                            transition: {
                                                staggerChildren: 0.1
                                            }
                                        }
                                    }}
                                    initial="hidden"
                                    animate="show"
                                >
                                    {allItems.map((item, index) => (
                                        <motion.div
                                            key={`item-${index}-${'id' in item ? item.id : item.productId}`}
                                            variants={{
                                                hidden: { opacity: 0, y: 20 },
                                                show: { opacity: 1, y: 0 }
                                            }}
                                        >
                                            <ItemCard
                                                item={item}
                                                rank={index + 1}
                                                referencePrice={data?.reference?.price}
                                                onClick={() => handleItemClick(item)}
                                                isOwner={isItemOwner(item)}
                                                isLoggedIn={isLoggedIn}
                                                onExtend={'id' in item ? () => handleExtendItem(item.id) : undefined}
                                                onReport={'id' in item && item.source !== 'naver' ? (reason) => handleReportItem(item.id, reason) : undefined}
                                                onUpdatePrice={'id' in item && item.source !== 'naver' ? (price) => handleUpdatePrice(item.id, price) : undefined}
                                                onClickDelete={'id' in item && item.source !== 'naver' ? () => handleDeleteItem(item.id) : undefined}
                                            />
                                        </motion.div>
                                    ))}
                                </motion.div>
                            )}
                        </div>

                        {/* Right Column: Sticky Sidebar (Visible only on >= lg) */}
                        <aside className="hidden lg:block h-full">
                            <div className="sticky top-24 space-y-4">
                                <div className="p-4 bg-stone-50 rounded-2xl border border-stone-100">
                                    <h3 className="text-sm font-bold text-stone-500 mb-3 uppercase tracking-wider">ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì—ì„œ ì°¾ê¸°</h3>
                                    <ExternalSearchButtons query={externalSearchQuery} vertical={true} />
                                </div>
                                {/* PCìš© ë§¤ë¬¼ë“±ë¡ ë²„íŠ¼ */}
                                <button
                                    onClick={() => {
                                        if (!isLoggedIn) {
                                            window.location.href = getLoginUrl();
                                            return;
                                        }
                                        setShowRegisterModal(true);
                                    }}
                                    className="
                                        flex items-center justify-between px-5 py-4
                                        rounded-xl bg-matcha-100 text-matcha-700
                                        hover:bg-matcha-200 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-matcha-200/50
                                        transition-all duration-200 group w-full
                                    "
                                >
                                    <span className="font-bold text-base">ë§¤ë¬¼ë“±ë¡</span>
                                    <svg className="w-4 h-4 opacity-70 group-hover:translate-x-0.5 group-hover:opacity-100 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4.5v15m7.5-7.5h-15" />
                                    </svg>
                                </button>
                            </div>
                        </aside>

                    </main>

                    {/* FAB (ë§¤ë¬¼ ë“±ë¡) - ëª¨ë°”ì¼ì—ì„œë§Œ í‘œì‹œ (PCëŠ” ì‚¬ì´ë“œë°”ì— ìˆìŒ) */}
                    <motion.button
                        onClick={() => {
                            if (!isLoggedIn) {
                                window.location.href = getLoginUrl();
                                return;
                            }
                            setShowRegisterModal(true);
                        }}
                        className="
                            lg:hidden
                            fixed bottom-8 right-8 z-50
                            px-5 py-3 rounded-full
                            bg-matcha-500 text-white
                            shadow-[0_4px_0_0_#16a34a]
                            flex items-center justify-center gap-2
                            hover:bg-matcha-600 active:shadow-[0_2px_0_0_#16a34a] active:translate-y-[2px]
                            transition-all duration-150
                        "
                        initial={{ scale: 0, rotate: 90 }}
                        animate={{ scale: 1, rotate: 0 }}
                        whileHover={{ scale: 1.05 }}
                        whileTap={{ scale: 0.95 }}
                    >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth={2.5} viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        <span className="font-bold text-sm">ë§¤ë¬¼ë“±ë¡</span>
                    </motion.button>
                </motion.div>
            )}

            {/* ë§¤ë¬¼ ë“±ë¡ ëª¨ë‹¬ */}
            <AnimatePresence>
                {showRegisterModal && (
                    <RegisterModal
                        query={query}
                        matchedInstrument={data?.matched_instrument}
                        onClose={() => setShowRegisterModal(false)}
                    />
                )}
            </AnimatePresence>

            {/* í‘¸í„° */}
            <footer className="mt-12 py-6 text-center text-xs text-stone-400 border-t border-stone-100">
                <p>* ë„¤ì´ë²„ì‡¼í•‘ ê°€ê²© ì •ë³´ëŠ” ì‹¤ì‹œê°„ ì¡°íšŒ ê²°ê³¼ì´ë©°, ì‹¤ì œ íŒë§¤ê°€ì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </footer>
        </div>
    );
}

const ExternalSearchButtons = ({ query, vertical }: { query: string, vertical: boolean }) => (
    <div className={`grid ${vertical ? 'grid-cols-1 gap-3' : 'grid-cols-3 gap-2'}`}>
        {/* Mule */}
        <a
            href={`https://www.mule.co.kr/bbs/market/sell?qf=title&qs=${encodeURIComponent(query.slice(0, 20))}&sb=wdate&sd=desc`}
            target="_blank"
            rel="noopener noreferrer"
            className={`
                flex items-center ${vertical ? 'justify-between px-5 py-4' : 'justify-center gap-1 px-2 py-3'} 
                rounded-xl bg-blue-100 text-blue-700
                hover:bg-blue-200 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-blue-200/50
                transition-all duration-200 group
            `}
        >
            <span className={`font-bold ${vertical ? 'text-base' : 'text-sm sm:text-base'}`}>Mule</span>
            <svg className="w-4 h-4 opacity-70 group-hover:translate-x-0.5 group-hover:opacity-100 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        </a>

        {/* Reverb */}
        <a
            href={`https://reverb.com/marketplace?query=${encodeURIComponent(query)}`}
            target="_blank"
            rel="noopener noreferrer"
            className={`
                flex items-center ${vertical ? 'justify-between px-5 py-4' : 'justify-center gap-1 px-2 py-3'} 
                rounded-xl bg-yellow-100 text-yellow-700
                hover:bg-yellow-200 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-yellow-200/50
                transition-all duration-200 group
            `}
        >
            <span className={`font-bold ${vertical ? 'text-base' : 'text-sm sm:text-base'}`}>Reverb</span>
            <svg className="w-4 h-4 opacity-70 group-hover:translate-x-0.5 group-hover:opacity-100 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        </a>

        {/* Digimart */}
        <a
            href={`https://www.digimart.net/search?keywordAnd=${query.replace(/ /g, '+')}`}
            target="_blank"
            rel="noopener noreferrer"
            className={`
                flex items-center ${vertical ? 'justify-between px-5 py-4' : 'justify-center gap-1 px-2 py-3'} 
                rounded-xl bg-red-100 text-red-700
                hover:bg-red-200 hover:-translate-y-0.5 hover:shadow-lg hover:shadow-red-200/50
                transition-all duration-200 group
            `}
        >
            <span className={`font-bold ${vertical ? 'text-base' : 'text-sm sm:text-base'}`}>Digimart</span>
            <svg className="w-4 h-4 opacity-70 group-hover:translate-x-0.5 group-hover:opacity-100 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        </a>
    </div>
);

interface RegisterModalProps {
    query: string;
    matchedInstrument?: {
        id: string;
        name: string;
        brand: string;
    } | null;
    onClose: () => void;
}

// ë§¤ë¬¼ ë“±ë¡ ëª¨ë‹¬
function RegisterModal({ query, matchedInstrument, onClose }: RegisterModalProps) {
    const [price, setPrice] = useState('');
    const [link, setLink] = useState('');
    const [detectedSource, setDetectedSource] = useState('other');

    // ë§í¬ ì…ë ¥ ì‹œ ì†ŒìŠ¤ ê°ì§€
    useEffect(() => {
        setDetectedSource(detectSource(link));
    }, [link]);

    // API Hook
    const createUserItem = useCreateUserItem();
    const deleteUserItem = useDeleteUserItem();
    const queryClient = useQueryClient();

    const handleDeleteItem = (id: number | string) => {
        if (window.confirm('ì •ë§ ì´ ë§¤ë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            deleteUserItem.mutate(String(id), {
                onSuccess: () => {
                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                },
                onError: () => {
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();

        // 1. ë§í¬ URL ë³´ì • (http/https ì—†ìœ¼ë©´ ì¶”ê°€)
        let finalLink = link.trim();
        if (finalLink && !finalLink.match(/^https?:\/\//)) {
            finalLink = `https://${finalLink}`;
        }

        // 2. ìµœì¢… ì†ŒìŠ¤ ê²°ì •
        const finalSource = detectSource(finalLink);

        createUserItem.mutate({
            instrument: matchedInstrument?.id ? Number(matchedInstrument.id) : undefined,
            title: query,
            price: Number(price),
            link: finalLink,
            source: finalSource
        }, {
            onSuccess: () => {
                // ê²€ìƒ‰ ê²°ê³¼ ì¦‰ì‹œ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
                queryClient.refetchQueries({ queryKey: ['search'] });

                const sourceName = SOURCE_LABELS[finalSource] || 'ë“±ë¡ëœ ë§¤ë¬¼';
                alert(`${sourceName} ë§¤ë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¸`);
                onClose();
            },
            onError: (err: Error) => {
                const error = err as AxiosError<ApiErrorResponse>;
                console.error('Failed to register item:', error);

                // [ì¶”ê°€] 429 Too Many Requests ì²˜ë¦¬
                if (error.response?.status === 429) {
                    alert('ë„ˆë¬´ ë§ì€ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„(ì•½ 1ë¶„ ë’¤) ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    return;
                }

                let errorMsg = 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                try {
                    const data = error.response?.data;
                    if (data) {
                        // JSON ë¬¸ìì—´ë¡œ ë³€í™˜ í›„ íŒŒì‹±
                        const jsonStr = JSON.stringify(data);
                        if (jsonStr.includes('ì•…ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤') || jsonStr.includes('í•´ë‹¹í•˜ëŠ” ì•…ê¸°')) {
                            errorMsg = 'ë“±ë¡ëœ ì•…ê¸° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì •í™•í•œ ì•…ê¸° ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰í•œ í›„ ë“±ë¡í•´ì£¼ì„¸ìš”.\n(ì˜ˆ: "íœë” ìŠ¤íŠ¸ë«" â†’ "Fender Stratocaster")';
                        } else if (jsonStr.includes('ì´ë¯¸ ë“±ë¡ëœ')) {
                            errorMsg = 'ì´ë¯¸ ë“±ë¡ëœ ë§¤ë¬¼ì…ë‹ˆë‹¤.';
                        } else if (jsonStr.includes('í—ˆìš©ë˜ì§€ ì•Šì€')) {
                            errorMsg = 'í—ˆìš©ë˜ì§€ ì•Šì€ ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤.\n(ë®¬, ë²ˆê°œì¥í„°, ë‹¹ê·¼ë§ˆì¼“, ì¤‘ê³ ë‚˜ë¼ë§Œ ë“±ë¡ ê°€ëŠ¥)';
                        } else {
                            // ëª¨ë“  ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ì¶œ
                            const messages: string[] = [];
                            Object.values(data).forEach(value => {
                                if (Array.isArray(value)) {
                                    messages.push(...value.map(v => String(v)));
                                } else if (typeof value === 'string') {
                                    messages.push(value);
                                }
                            });
                            errorMsg = messages.join('\n') || 'ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                        }
                    }
                } catch {
                    errorMsg = error.message || 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                }
                alert(errorMsg);
            }
        });
    };

    return (
        <motion.div
            className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
        >
            <motion.div
                className="w-full max-w-md bg-white rounded-2xl shadow-2xl p-6"
                initial={{ scale: 0.9, y: 20 }}
                animate={{ scale: 1, y: 0 }}
                exit={{ scale: 0.9, y: 20 }}
                onClick={(e) => e.stopPropagation()}
            >
                <div className="flex items-center justify-between mb-4">
                    <h2 className="text-xl font-bold text-stone-800">ë§¤ë¬¼ ë“±ë¡</h2>
                    <button
                        onClick={onClose}
                        className="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-500 hover:bg-stone-200"
                    >
                        âœ•
                    </button>
                </div>

                {/* ì•…ê¸°ëª… í‘œì‹œ (ìë™) */}



                <form onSubmit={handleSubmit} className="space-y-4">
                    {/* ê°€ê²© */}
                    <div>
                        <label className="block text-sm font-medium text-stone-700 mb-1.5">
                            ê°€ê²© (ì›)
                        </label>
                        <input
                            type="number"
                            value={price}
                            onChange={(e) => setPrice(e.target.value)}
                            className="w-full px-4 py-3 rounded-xl border border-stone-200 focus:border-matcha-400 focus:ring-2 focus:ring-matcha-100 outline-none transition-all"
                            placeholder="ì˜ˆ: 850000"
                            required
                        />
                    </div>

                    {/* ë§í¬ */}
                    <div>
                        <label className="block text-sm font-medium text-stone-700 mb-1.5">
                            ë§¤ë¬¼ ë§í¬
                        </label>
                        <input
                            type="text"
                            value={link}
                            onChange={(e) => setLink(e.target.value)}
                            className="w-full px-4 py-3 rounded-xl border border-stone-200 focus:border-matcha-400 focus:ring-2 focus:ring-matcha-100 outline-none transition-all"
                            placeholder="ì˜ˆ: mule.co.kr/..."
                            required
                        />

                        {/* URL ê°ì§€ ê²°ê³¼ í‘œì‹œ */}
                        {link.length > 5 && (
                            <motion.div
                                initial={{ opacity: 0, y: -5 }}
                                animate={{ opacity: 1, y: 0 }}
                                className={`mt-2 flex items-center gap-2 text-sm p-3 rounded-xl border ${SOURCE_COLORS[detectedSource]}`}
                            >
                                <span className="text-lg">
                                    {detectedSource === 'other' ? 'ğŸ”—' : 'âœ…'}
                                </span>
                                <span className="font-bold">
                                    {detectedSource === 'other'
                                        ? 'ì¶œì²˜ë¥¼ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (ê¸°íƒ€ë¡œ ë“±ë¡ë©ë‹ˆë‹¤)'
                                        : `${SOURCE_LABELS[detectedSource]} ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!`}
                                </span>
                            </motion.div>
                        )}
                    </div>

                    {/* ë²„íŠ¼ */}
                    <div className="flex gap-3 pt-2">
                        <button
                            type="button"
                            onClick={onClose}
                            className="flex-1 py-3 rounded-xl border border-stone-200 text-stone-600 font-medium hover:bg-stone-50 transition-colors"
                        >
                            ì·¨ì†Œ
                        </button>
                        <button
                            type="submit"
                            disabled={createUserItem.isPending}
                            className={`flex-1 py-3 rounded-xl text-white font-bold transition-all shadow-md active:scale-95 disabled:opacity-50 ${detectedSource !== 'other'
                                ? 'bg-matcha-600 hover:bg-matcha-700 hover:shadow-lg'
                                : 'bg-stone-500 hover:bg-stone-600'
                                }`}
                        >
                            {createUserItem.isPending ? 'ë“±ë¡ ì¤‘...' : 'ë“±ë¡í•˜ê¸°'}
                        </button>
                    </div>
                </form>
            </motion.div>
        </motion.div>
    );
}
</file>

</files>
