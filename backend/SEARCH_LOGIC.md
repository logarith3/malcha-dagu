# DAGU 검색 로직 문서

## 개요
DAGU 검색 시스템은 **Instrument(악기) 중심**으로 동작합니다.  
사용자가 모델명이나 브랜드를 검색하면, DB에서 매칭되는 악기를 먼저 찾고,  
그 악기의 정확한 브랜드+모델명으로 네이버 API를 검색합니다.

---

## 검색 흐름

```
사용자 입력: "ds-1" 또는 "boss ds-1" 또는 "보스 ds-1"
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 1. DB Instrument 검색                                    │
│    - name 또는 brand에 검색어 포함된 악기 찾기            │
│    - 'Unknown' 브랜드는 제외                             │
│    - 예: 'ds-1' → DB에서 'BOSS DS-1' 악기 발견           │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 2. 검색어 결정                                           │
│    - 매칭된 악기 있음 → "{브랜드} {모델명}" 사용          │
│      예: "BOSS DS-1"                                     │
│    - 매칭 없음 → 원본 검색어 사용 (한글→영어 변환)        │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 3. 네이버 API 검색                                       │
│    - 결정된 검색어로 네이버 쇼핑 검색                     │
│    - 필터링 적용:                                        │
│      • 가격 필터 (페달: 5만원+, 기타: 20만원+)            │
│      • 블랙리스트 (부품, 케이스 등 제외)                  │
│      • 브랜드 무결성 체크                                 │
│      • 카테고리 체크                                      │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 4. 유저 매물 검색 (UserItem)                             │
│    - 매칭된 Instrument의 UserItem들 직접 조회            │
│    - 또는 검색어로 제목/브랜드 검색                       │
│    - 블랙리스트 필터만 적용 (가격 필터 없음)              │
└─────────────────────────────────────────────────────────┘
                    ↓
            네이버 결과 + 유저 매물 종합 → 가격순 정렬 → 반환
```

---

## 핵심 파일

| 파일 | 역할 |
|------|------|
| `services.py` | 검색 로직 메인 (SearchAggregatorService) |
| `config.py` | 설정값 (가격, 블랙리스트, 브랜드 매핑 등) |
| `filters.py` | 필터링 함수들 (가격, 블랙리스트, 브랜드 등) |
| `models.py` | Instrument, UserItem 모델 정의 |

---

## 주요 설정 (config.py)

### 가격 필터
- `MIN_PRICE_KRW = 200000` (악기: 20만원 이상)
- `MIN_PRICE_PEDAL = 50000` (페달: 5만원 이상)

### 카테고리 인식 키워드
- `PEDAL_KEYWORDS`: boss, ds-1, overdrive, distortion 등
- `AMP_KEYWORDS`: amp, cabinet, head, combo 등
- `ACOUSTIC_KEYWORDS`: acoustic, martin, taylor 등

### 한글 브랜드 매핑
```python
BRAND_NAME_MAPPING = {
    '펜더': 'fender',
    '깁슨': 'gibson',
    '보스': 'boss',
    '마샬': 'marshall',
    # ...
}
```

---

## 검색 예시

| 사용자 입력 | DB 매칭 | 네이버 검색어 | 결과 |
|-------------|---------|---------------|------|
| `ds-1` | BOSS DS-1 | "BOSS DS-1" | 페달 결과 ✅ |
| `boss ds-1` | BOSS DS-1 | "BOSS DS-1" | 페달 결과 ✅ |
| `보스 ds-1` | BOSS DS-1 | "boss DS-1" | 페달 결과 ✅ |
| `stratocaster` | (미등록) | "stratocaster" | 기타 결과 ✅ |

---

## 새 악기 추가 방법

1. Django Admin에서 **Instrument** 추가
2. 브랜드, 모델명, 카테고리, 기준가 입력
3. 자동으로 검색에 반영됨 (코드 수정 불필요)

---

## 캐싱

- 네이버 API 결과는 **1시간** 캐싱
- 캐시 키: 정규화된 검색어 + display 수
- 필터링은 매 요청마다 적용
